<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="TargetTrader - Professionelles Trading-Tagebuch mit dynamischen Tageszielen, Buffer-System und Positions-Skalierung">
    <meta name="keywords" content="Trading, Tagebuch, Journal, Tagesziel, Forex, CFD, Gold, Silber">
    <meta name="author" content="TargetTrader">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TargetTrader">
    <meta name="application-name" content="TargetTrader">
    <meta name="theme-color" content="#0f1419">
    <meta name="msapplication-TileColor" content="#0f1419">
    <meta name="msapplication-navbutton-color" content="#00d4aa">
    
    <title>TargetTrader - Trading Target Tracker</title>
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="assets/favicon-48.png">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        :root{--bg:#0f1419;--card:#1e2736;--card-hover:#252f3f;--border:#2d3748;--text:#fff;--muted:#9ca3af;--dark:#6b7280;--blue:#3b82f6;--green:#10b981;--gold:#fbbf24;--red:#ef4444;--orange:#f59e0b;--purple:#8b5cf6;--accent:#00d4aa;--header-bg:linear-gradient(135deg,#1e2736,#1a2332);--safe-top:env(safe-area-inset-top);--safe-bottom:env(safe-area-inset-bottom)}
        [data-theme="light"]{--bg:#f8fafc;--card:#ffffff;--card-hover:#f1f5f9;--border:#e2e8f0;--text:#1e293b;--muted:#64748b;--dark:#94a3b8;--accent:#059669;--header-bg:linear-gradient(135deg,#ffffff,#f1f5f9)}
        [data-theme="light"] .header{border-color:#cbd5e1;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1)}
        [data-theme="light"] .header-brand h1{color:var(--text)}
        [data-theme="light"] .sl-tp-box.stop{background:var(--card);border-left:3px solid #ef4444;color:var(--text)}
        [data-theme="light"] .sl-tp-box.tp{background:var(--card);border-left:3px solid #10b981;color:var(--text)}
        [data-theme="light"] .sl-tp-box.target{background:var(--card);border-left:3px solid #00d4aa;color:var(--text)}
        [data-theme="light"] .sl-tp-label{color:var(--muted)}
        [data-theme="light"] .sl-tp-value{color:var(--text)}
        [data-theme="light"] .sl-tp-dist{color:var(--muted)}
        [data-theme="light"] .tab.active{background:#0284c7}
        [data-theme="light"] .card-blue{border-color:#0284c7;background:linear-gradient(135deg,rgba(2,132,199,0.1),transparent)}
        [data-theme="light"] .card-green{border-color:#059669;background:linear-gradient(135deg,rgba(5,150,105,0.1),transparent)}
        [data-theme="light"] .card-gold{border-color:#d97706;background:linear-gradient(135deg,rgba(217,119,6,0.1),transparent)}
        [data-theme="light"] .card-purple{border-color:#7c3aed;background:linear-gradient(135deg,rgba(124,58,237,0.1),transparent)}
        [data-theme="light"] .week-day{background:#f8fafc}
        [data-theme="light"] .circle-progress .bg{stroke:#e2e8f0}
        body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:12px;padding-top:calc(12px + var(--safe-top));padding-bottom:calc(80px + var(--safe-bottom))}
        .container{max-width:1200px;margin:0 auto}
        .header{background:var(--header-bg);border-radius:16px;padding:16px 20px;margin-bottom:16px;border:1px solid var(--blue);display:grid;grid-template-columns:auto 1fr auto;gap:20px;align-items:center}
        .header-left{display:flex;align-items:center;gap:12px}
        .header-left img{width:48px;height:48px}
        .header-brand h1{font-size:1.1rem;font-weight:700;color:var(--text);line-height:1.2}
        .header-brand h1 span{color:var(--accent)}
        .header-brand p{color:var(--muted);font-size:0.7rem;margin-top:2px}
        .header-center{text-align:center}
        .header-date{color:var(--text);font-size:1rem;font-weight:600}
        .header-separator{height:2px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:8px 0}
        .header-right{display:flex;align-items:center;gap:12px;justify-content:flex-end}
        .header-balance{color:var(--green);font-size:1.2rem;font-weight:700}
        .header-balance-sub{color:var(--muted);font-size:0.7rem}
        .sync-status{display:flex;align-items:center;gap:6px;font-size:0.75rem;color:var(--muted)}
        .sync-dot{width:8px;height:8px;border-radius:50%}
        .sync-dot.online{background:var(--green)}
        .sync-dot.offline{background:var(--orange)}
        .sync-dot.syncing{background:var(--blue);animation:pulse 1s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .theme-toggle{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px;cursor:pointer;font-size:1rem;transition:all 0.2s}
        .theme-toggle:hover{background:var(--card-hover)}
        .user-badge{display:flex;align-items:center;gap:8px;background:var(--card);padding:6px 12px;border-radius:20px;font-size:0.8rem;cursor:pointer;border:1px solid var(--border)}
        .user-badge:hover{background:var(--card-hover)}
        .user-avatar{width:24px;height:24px;border-radius:50%;background:var(--blue);display:flex;align-items:center;justify-content:center;font-size:0.7rem}
        .tabs{display:flex;gap:6px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px}
        .tabs::-webkit-scrollbar{display:none}
        .tab{padding:10px 14px;background:var(--card);border:1px solid var(--border);border-radius:10px;color:var(--muted);cursor:pointer;font-weight:500;font-size:0.8rem;white-space:nowrap;transition:all 0.2s}
        .tab:hover{background:var(--card-hover)}
        .tab.active{background:var(--blue);color:white;border-color:var(--blue)}
        .tab-content{display:none;animation:fadeIn 0.3s}
        .tab-content.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .grid{display:grid;gap:12px;margin-bottom:12px}
        .grid-2{grid-template-columns:repeat(2,1fr)}
        .grid-3{grid-template-columns:repeat(3,1fr)}
        .grid-4{grid-template-columns:repeat(4,1fr)}
        .card{background:var(--card);border-radius:12px;padding:16px;border:1px solid var(--border);margin-bottom:12px}
        .card-dark{background:var(--bg)}
        .card-blue{border-color:var(--blue);background:linear-gradient(135deg,rgba(59,130,246,0.1),transparent)}
        .card-gold{border-color:var(--gold);background:linear-gradient(135deg,rgba(251,191,36,0.1),transparent)}
        .card-green{border-color:var(--green);background:linear-gradient(135deg,rgba(16,185,129,0.1),transparent)}
        .card-red{border-color:var(--red);background:linear-gradient(135deg,rgba(239,68,68,0.1),transparent)}
        .card-purple{border-color:var(--purple);background:linear-gradient(135deg,rgba(139,92,246,0.1),transparent)}
        .card-title{font-size:0.85rem;color:var(--muted);margin-bottom:12px;display:flex;align-items:center;gap:8px}
        .card-title span{font-size:1rem}
        .stat-box{text-align:center;padding:12px 8px}
        .stat-label{color:var(--muted);font-size:0.7rem;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
        .stat-value{font-size:1.15rem;font-weight:700}
        .stat-sub{color:var(--dark);font-size:0.7rem;margin-top:2px}
        .form-group{margin-bottom:14px}
        .form-group label{display:block;color:var(--muted);font-size:0.8rem;margin-bottom:6px;font-weight:500}
        .form-input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);font-size:0.9rem;transition:border-color 0.2s}
        .form-input:focus{outline:none;border-color:var(--blue)}
        .form-input.highlight{border-color:var(--gold);background:rgba(251,191,36,0.05)}
        .form-error{color:var(--red);font-size:0.75rem;margin-top:4px}
        select.form-input{cursor:pointer}
        .btn{padding:10px 20px;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:0.9rem;transition:all 0.2s;display:inline-flex;align-items:center;justify-content:center;gap:6px}
        .btn:active{transform:scale(0.98)}
        .btn:disabled{opacity:0.6;cursor:not-allowed}
        .btn-primary{background:var(--blue);color:white}
        .btn-primary:hover:not(:disabled){background:#2563eb}
        .btn-success{background:var(--green);color:white}
        .btn-danger{background:var(--red);color:white}
        .lang-btn{background:var(--card);border:2px solid var(--border);padding:12px;font-size:0.9rem;transition:all 0.2s}
        .lang-btn:hover{border-color:var(--blue);background:var(--card-hover)}
        .lang-btn.active{border-color:var(--green);background:rgba(16,185,129,0.15);color:var(--green)}
        
        /* Tooltip System */
        [data-tooltip]{position:relative;cursor:help}
        [data-tooltip]::after{content:attr(data-tooltip);position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%);background:var(--dark);color:white;padding:8px 12px;border-radius:8px;font-size:0.75rem;white-space:nowrap;max-width:250px;white-space:normal;text-align:center;opacity:0;visibility:hidden;transition:all 0.2s;z-index:9999;box-shadow:0 4px 12px rgba(0,0,0,0.3);pointer-events:none}
        [data-tooltip]::before{content:'';position:absolute;bottom:calc(100% + 2px);left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:var(--dark);opacity:0;visibility:hidden;transition:all 0.2s;z-index:9999}
        [data-tooltip]:hover::after,[data-tooltip]:hover::before{opacity:1;visibility:visible}
        [data-tooltip].tooltip-right::after{left:auto;right:0;transform:none}
        [data-tooltip].tooltip-left::after{left:0;right:auto;transform:none}
        .form-label-help{display:inline-flex;align-items:center;gap:6px}
        .help-icon{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;background:var(--border);border-radius:50%;font-size:0.65rem;color:var(--muted);cursor:help}
        .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--muted)}
        .btn-sm{padding:6px 12px;font-size:0.8rem}
        .btn-block{width:100%}
        .btn-add{width:100%;padding:14px;background:var(--card);border:2px dashed var(--border);color:var(--muted);font-size:0.9rem}
        .btn-add:hover{border-color:var(--blue);color:var(--blue)}
        .auth-container{max-width:400px;margin:60px auto;padding:0 20px}
        .auth-card{background:var(--card);border-radius:16px;padding:32px;border:1px solid var(--border);text-align:center}
        .auth-logo{font-size:3rem;margin-bottom:16px}
        .auth-title{font-size:1.5rem;font-weight:700;margin-bottom:8px}
        .auth-subtitle{color:var(--muted);font-size:0.9rem;margin-bottom:24px}
        .auth-tabs{display:flex;margin-bottom:24px;background:var(--bg);border-radius:8px;padding:4px}
        .auth-tab{flex:1;padding:10px;background:none;border:none;color:var(--muted);cursor:pointer;border-radius:6px;font-weight:500}
        .auth-tab.active{background:var(--blue);color:white}
        .auth-divider{display:flex;align-items:center;gap:12px;margin:20px 0;color:var(--muted);font-size:0.8rem}
        .auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border)}
        .auth-footer{margin-top:20px;font-size:0.8rem;color:var(--muted)}
        .auth-footer a{color:var(--blue);text-decoration:none}
        .btn-google{background:white;color:#333;border:1px solid #ddd;width:100%;display:flex;align-items:center;justify-content:center;gap:10px}
        .btn-google:hover{background:#f5f5f5}
        .btn-google svg{width:18px;height:18px}
        .rec-card{padding:14px;margin-bottom:10px;border-radius:10px;position:relative}
        .rec-card.medium{background:linear-gradient(135deg,rgba(251,191,36,0.15),rgba(251,191,36,0.05));border:1px solid var(--gold)}
        .rec-card.info{background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(16,185,129,0.05));border:1px solid var(--green)}
        .rec-card.low{background:linear-gradient(135deg,rgba(59,130,246,0.15),rgba(59,130,246,0.05));border:1px solid var(--blue)}
        .rec-header{display:flex;align-items:center;gap:10px;margin-bottom:6px}
        .rec-icon{font-size:1.3rem}
        .rec-title{font-weight:600;font-size:0.95rem}
        .rec-message{color:var(--muted);font-size:0.85rem;line-height:1.4}
        .rec-dismiss{position:absolute;top:10px;right:10px;background:none;border:none;color:var(--dark);cursor:pointer;font-size:1.1rem}
        .week-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin:12px 0}
        .week-day{text-align:center;padding:10px 6px;background:var(--bg);border-radius:8px;border:1px solid var(--border)}
        .week-day.today{border-color:var(--blue)}
        .week-day.profit{border-color:var(--green);background:rgba(16,185,129,0.1)}
        .week-day.loss{border-color:var(--red);background:rgba(239,68,68,0.1)}
        .week-day-name{font-size:0.7rem;color:var(--dark);margin-bottom:4px}
        .week-day-value{font-size:0.9rem;font-weight:600}
        .week-day-value.positive{color:var(--green)}
        .week-day-value.negative{color:var(--red)}
        .week-day-value.empty{color:var(--dark)}
        .progress-container{margin:12px 0}
        .progress-header{display:flex;justify-content:space-between;margin-bottom:6px;font-size:0.8rem}
        .progress-bar{background:var(--bg);border-radius:10px;height:12px;overflow:hidden;border:1px solid var(--border)}
        .progress-fill{height:100%;border-radius:10px;transition:width 0.5s ease}
        .progress-fill.green{background:linear-gradient(90deg,var(--green),#34d399)}
        .progress-fill.blue{background:linear-gradient(90deg,var(--blue),#60a5fa)}
        .progress-fill.gold{background:linear-gradient(90deg,var(--gold),#fcd34d)}
        .circle-progress{position:relative;width:120px;height:120px;margin:0 auto;flex-shrink:0}
        .circle-progress svg{transform:rotate(-90deg);width:100%;height:100%}
        .circle-progress .bg{fill:none;stroke:var(--border);stroke-width:10}
        .circle-progress .progress{fill:none;stroke-width:10;stroke-linecap:round;transition:stroke-dashoffset 0.5s ease, stroke 0.3s ease}
        .circle-progress .progress.green{stroke:var(--green)}
        .circle-progress .progress.blue{stroke:var(--blue)}
        .circle-progress .progress.gold{stroke:var(--gold)}
        .circle-progress .progress.purple{stroke:var(--purple)}
        .circle-progress .progress.gradient{stroke:url(#progressGradient)}
        .circle-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
        .circle-value{font-size:1.4rem;font-weight:700;line-height:1.2}
        .circle-label{font-size:0.7rem;color:var(--muted)}
        .progress-grid{display:grid;grid-template-columns:120px 1fr;gap:20px;align-items:center}
        .progress-grid-compact{display:grid;grid-template-columns:auto 1fr;gap:16px;align-items:center}
        .progress-details{display:flex;flex-direction:column;gap:8px}
        .progress-details-compact{display:grid;grid-template-columns:1fr 1fr;gap:6px 12px;width:100%;font-size:0.85rem}
        .progress-details-compact .detail-item{display:flex;flex-direction:column;text-align:center;padding:6px;background:var(--bg);border-radius:6px}
        .progress-details-compact .detail-label{font-size:0.7rem;color:var(--muted)}
        .progress-details-compact .detail-value{font-weight:600;font-size:0.9rem}
        .progress-detail-row{display:flex;justify-content:space-between;font-size:0.9rem}
        .progress-detail-row .label{color:var(--muted)}
        .progress-detail-row .value{font-weight:600}
        .progress-detail-row .value.green{color:var(--green)}
        .progress-detail-row .value.gold{color:var(--gold)}
        .progress-detail-row .value.blue{color:var(--blue)}
        .tomorrow-hint{margin-top:12px;padding:8px;background:var(--bg);border-radius:8px;border:1px solid var(--border);text-align:center;font-size:0.8rem}
        .mini-chart{height:120px;display:flex;align-items:flex-end;gap:4px;padding:10px 0}
        .mini-chart-bar{flex:1;border-radius:4px 4px 0 0;transition:all 0.3s;min-height:4px;position:relative}
        .mini-chart-bar.positive{background:linear-gradient(180deg,var(--green),#059669)}
        .mini-chart-bar.negative{background:linear-gradient(180deg,var(--red),#dc2626)}
        .mini-chart-bar.neutral{background:var(--border)}
        .mini-chart-label{position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);font-size:0.65rem;color:var(--muted);white-space:nowrap}
        .mini-chart-value{position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:0.7rem;font-weight:600;white-space:nowrap}
        .equity-line{height:120px;position:relative;margin-top:20px;width:100%;overflow:hidden}
        .equity-line svg{width:100%;height:100%;display:block}
        .equity-line .line{fill:none;stroke:var(--green);stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
        .equity-line .area{fill:url(#equityGradient);opacity:0.3}
        .equity-line .dot{fill:var(--green);stroke:var(--card);stroke-width:2}
        .equity-line .grid-line{stroke:var(--border);stroke-width:1;stroke-dasharray:4}
        
        /* Professional Chart Styles */
        .chart-container{position:relative}
        .chart-container svg{display:block}
        .chart-grid{stroke:var(--border);stroke-width:0.5;opacity:0.5}
        .chart-axis{stroke:var(--border);stroke-width:1}
        .chart-label{fill:var(--muted);font-size:9px;font-family:inherit}
        .chart-value{fill:var(--text);font-size:10px;font-weight:600;font-family:inherit}
        .chart-line{fill:none;stroke-width:2.5;stroke-linecap:round;stroke-linejoin:round;filter:drop-shadow(0 0 3px rgba(0,212,170,0.4))}
        .chart-area{opacity:0.15}
        .chart-dot{transition:all 0.2s ease;cursor:pointer}
        .chart-dot:hover{transform:scale(1.3)}
        .chart-dot-ring{fill:none;stroke-width:2;opacity:0}
        .chart-dot:hover .chart-dot-ring{opacity:1}
        .chart-tooltip{position:absolute;background:var(--dark);color:white;padding:8px 12px;border-radius:8px;font-size:0.75rem;pointer-events:none;opacity:0;transition:opacity 0.2s;z-index:100;white-space:nowrap;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        .chart-tooltip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:var(--dark)}
        .chart-legend{display:flex;justify-content:center;gap:20px;margin-top:12px;font-size:0.8rem}
        .chart-legend-item{display:flex;align-items:center;gap:6px}
        .chart-legend-dot{width:10px;height:10px;border-radius:50%}
        @keyframes chartDraw{from{stroke-dashoffset:1000}to{stroke-dashoffset:0}}
        .chart-line-animated{stroke-dasharray:1000;animation:chartDraw 1.5s ease-out forwards}
        .equity-labels{display:flex;justify-content:space-between;font-size:0.7rem;color:var(--muted);margin-top:8px}
        .streak-container{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
        .streak-box{text-align:center;padding:16px;background:var(--bg);border-radius:10px;border:1px solid var(--border);overflow:hidden}
        .streak-value{font-size:2rem;font-weight:700;line-height:1}
        .streak-label{font-size:0.75rem;color:var(--muted);margin-top:4px}
        .streak-fire{color:var(--orange)}
        .streak-ice{color:var(--blue)}
        .position-card{border-left:4px solid var(--gold)}
        .position-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .position-info{display:flex;align-items:center;gap:10px}
        .position-icon{display:flex;align-items:center;justify-content:center}
        .position-symbol{font-weight:700;font-size:1.1rem}
        .position-name{color:var(--dark);font-size:0.8rem}
        .position-pl-value{font-size:1.2rem;font-weight:700}
        .sl-tp-row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
        .sl-tp-box{padding:10px;border-radius:8px;text-align:center;background:var(--card);border:1px solid var(--border)}
        .sl-tp-box.stop{border-left:3px solid #ef4444}
        .sl-tp-box.tp{border-left:3px solid #10b981}
        .sl-tp-box.target{border-left:3px solid #00d4aa}
        .sl-tp-label{font-size:0.7rem;color:var(--muted);margin-bottom:4px;display:flex;align-items:center;justify-content:center;gap:4px}
        .sl-tp-value{font-size:1rem;font-weight:700}
        .sl-tp-dist{font-size:0.7rem;opacity:0.7;margin-top:2px}
        .instrument-card{display:flex;align-items:center;gap:12px;padding:14px;cursor:pointer;transition:all 0.2s;border-radius:10px;margin-bottom:8px;background:var(--bg)}
        .instrument-card:hover{background:var(--card-hover)}
        .instrument-card.inactive{opacity:0.5}
        .instrument-icon{font-size:2rem;width:50px;text-align:center}
        .instrument-info{flex:1}
        .instrument-symbol{font-weight:700;font-size:1rem}
        .instrument-name{color:var(--muted);font-size:0.8rem}
        .instrument-factor{font-size:0.85rem;font-weight:600}
        .instrument-status{text-align:right}
        .inst-tab{background:var(--bg);border:1px solid var(--border);color:var(--text)}
        .inst-tab.active{background:var(--accent);color:var(--bg);border-color:var(--accent)}
        .inst-tab:hover:not(.active){background:var(--card-hover)}
        .toggle-btn{padding:4px 10px;border-radius:6px;font-size:0.75rem;cursor:pointer;border:1px solid var(--border);background:var(--bg);color:var(--muted);transition:all 0.2s}
        .toggle-btn.active{background:var(--green);color:var(--bg);border-color:var(--green)}
        .lot-config-row{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--bg);border-radius:8px;margin-bottom:8px}
        .calibrated{color:var(--green)}
        .not-calibrated{color:var(--orange)}
        table{width:100%;border-collapse:collapse;font-size:0.85rem}
        th{padding:10px 8px;text-align:left;color:var(--muted);background:var(--bg);border-bottom:1px solid var(--border);font-weight:500}
        td{padding:10px 8px;border-bottom:1px solid var(--border)}
        tr:hover{background:var(--card-hover)}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px}
        .modal-overlay.show{display:flex}
        .modal{background:var(--card);border-radius:16px;padding:24px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;border:1px solid var(--border)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .modal-title{font-size:1.1rem;font-weight:700}
        .modal-close{background:none;border:none;color:var(--muted);font-size:1.5rem;cursor:pointer}
        .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);padding:12px 24px;border-radius:10px;font-weight:600;background:var(--green);color:white;opacity:0;transition:all 0.3s;z-index:2000;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,0.3)}
        .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
        .toast.error{background:var(--red)}
        .toast.warning{background:var(--orange)}
        .toast.info{background:var(--blue)}
        .loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px}
        .spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .text-green{color:var(--green)}
        .text-accent{color:var(--accent)}
        .text-red{color:var(--red)}
        .text-gold{color:var(--gold)}
        .text-purple{color:var(--purple)}
        .text-blue{color:var(--blue)}
        .text-muted{color:var(--muted)}
        .text-center{text-align:center}
        .text-right{text-align:right}
        .font-bold{font-weight:700}
        .mt-2{margin-top:8px}
        .mt-3{margin-top:12px}
        .mb-2{margin-bottom:8px}
        .mb-3{margin-bottom:12px}
        .hidden{display:none!important}
        
        /* ============================================================
           RESPONSIVE DESIGN - Mobile First
           ============================================================ */
        
        /* Tablets & Small Laptops (768px - 1024px) */
        @media(max-width:1024px){
            .grid-4{grid-template-columns:repeat(2,1fr)}
            .container{padding:0 12px}
        }
        
        /* Tablets Portrait (max 768px) */
        @media(max-width:768px){
            .grid-4,.grid-3{grid-template-columns:repeat(2,1fr)}
            .sl-tp-row{grid-template-columns:1fr}
            .header{grid-template-columns:1fr;gap:12px;text-align:center}
            .header-left{justify-content:center}
            .header-right{justify-content:center;flex-wrap:wrap}
            .header-center{order:-1}
            .progress-grid-compact{display:flex;flex-direction:column;align-items:center;gap:16px}
            .progress-details-compact{grid-template-columns:repeat(2,1fr);width:100%}
            .circle-progress{width:100px;height:100px}
            .circle-progress svg{width:100px;height:100px}
            .circle-center{font-size:0.9rem}
            .stat-box{padding:12px}
            .stat-value{font-size:1.3rem}
            .card{padding:12px}
            body{padding:12px;padding-bottom:90px}
        }
        
        /* Mobile Landscape & Large Phones (max 640px) */
        @media(max-width:640px){
            .grid-4{grid-template-columns:1fr 1fr}
            .grid-3{grid-template-columns:1fr}
            .grid-2{grid-template-columns:1fr}
            .tabs{gap:2px;font-size:0.7rem}
            .tab{padding:8px 6px;min-width:auto}
            .tab .i{display:none}
            .header-balance{font-size:1.5rem}
            .header-balance-sub{font-size:0.7rem}
            .stat-value{font-size:1.1rem}
            .stat-label{font-size:0.7rem}
            .stat-sub{font-size:0.65rem}
            .card-title{font-size:0.85rem}
            .week-day{padding:6px 2px}
            .week-day-name{font-size:0.6rem}
            .week-day-value{font-size:0.75rem}
            .circle-progress{width:80px;height:80px}
            .circle-progress svg{width:80px;height:80px}
            .circle-value{font-size:1rem}
            .circle-label{font-size:0.6rem}
            .detail-item{padding:4px 0}
            .detail-label{font-size:0.7rem}
            .detail-value{font-size:0.8rem}
            table{font-size:0.75rem}
            th,td{padding:6px 4px}
            .btn{padding:10px 16px;font-size:0.85rem}
            .btn-sm{padding:6px 10px;font-size:0.75rem}
            .form-input{padding:10px;font-size:0.9rem}
            .modal{padding:16px;margin:10px;max-height:85vh}
            .modal-title{font-size:1rem}
        }
        
        /* Small Phones (max 480px) */
        @media(max-width:480px){
            body{padding:8px;padding-bottom:85px}
            .container{padding:0}
            .header{padding:12px}
            .header-logo{width:32px;height:32px}
            .header-balance{font-size:1.3rem}
            .tabs{margin-bottom:12px;padding:0 4px}
            .tab{padding:6px 4px;font-size:0.65rem}
            .card{padding:10px;border-radius:10px}
            .card-title{font-size:0.8rem;margin-bottom:8px}
            .stat-box{padding:10px}
            .stat-value{font-size:1rem}
            .grid-4,.grid-3,.grid-2{gap:8px}
            .progress-grid-compact{gap:12px}
            .circle-progress{width:70px;height:70px}
            .circle-progress svg{width:70px;height:70px}
            .circle-value{font-size:0.9rem}
            .progress-details-compact{gap:4px}
            .detail-item{padding:3px 0}
            .week-grid{gap:4px}
            .week-day{padding:4px 2px;border-radius:6px}
            .rec-card{padding:10px}
            .rec-title{font-size:0.85rem}
            .rec-message{font-size:0.75rem}
            table{font-size:0.7rem}
            th,td{padding:4px 2px}
            .btn-block{padding:12px}
        }
        
        /* Very Small Phones (max 360px) */
        @media(max-width:360px){
            body{padding:6px;padding-bottom:80px}
            .header-balance{font-size:1.1rem}
            .tab{padding:5px 3px;font-size:0.6rem}
            .stat-value{font-size:0.9rem}
            .card{padding:8px}
            .circle-progress svg{width:60px;height:60px}
            .form-group label{font-size:0.8rem}
        }
        
        /* Fix overflow issues */
        .card{overflow:visible}
        .stat-box{overflow:visible;word-break:break-word}
        #mini-equity-chart,#full-equity-chart,#monthly-chart,#weekday-chart{overflow:hidden;width:100%}
        #mini-equity-chart svg,#full-equity-chart svg{max-width:100%;height:auto}
        table{width:100%;table-layout:auto}
        .progress-details-compact{overflow:hidden}
        .detail-value{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        
        /* TT Icon System */
        .i{display:inline-flex;align-items:center;justify-content:center;vertical-align:middle;flex-shrink:0}.i svg{width:100%;height:100%}.i-16{width:16px;height:16px}.i-18{width:18px;height:18px}.i-20{width:20px;height:20px}.i-24{width:24px;height:24px}.i-32{width:32px;height:32px}
    </style>
</head>
<body>
    <div id="loading-screen" class="loading"><div class="spinner"></div><p class="text-muted mt-3">Laden...</p></div>
    
    <div id="auth-screen" class="auth-container hidden">
        <div class="auth-card">
            <div class="auth-logo">
                <svg width="80" height="80" viewBox="0 0 64 64" fill="none">
                    <circle cx="32" cy="32" r="30" stroke="#00d4aa" stroke-width="2" fill="none"/>
                    <line x1="32" y1="2" x2="32" y2="26" stroke="#00d4aa" stroke-width="0.75" opacity="0.5"/>
                    <line x1="32" y1="38" x2="32" y2="62" stroke="#00d4aa" stroke-width="0.75" opacity="0.5"/>
                    <line x1="2" y1="32" x2="26" y2="32" stroke="#00d4aa" stroke-width="0.75" opacity="0.5"/>
                    <line x1="38" y1="32" x2="62" y2="32" stroke="#00d4aa" stroke-width="0.75" opacity="0.5"/>
                    <line x1="32" y1="2" x2="32" y2="8" stroke="#00d4aa" stroke-width="2.5"/>
                    <line x1="32" y1="56" x2="32" y2="62" stroke="#00d4aa" stroke-width="2.5"/>
                    <line x1="2" y1="32" x2="8" y2="32" stroke="#00d4aa" stroke-width="2.5"/>
                    <line x1="56" y1="32" x2="62" y2="32" stroke="#00d4aa" stroke-width="2.5"/>
                    <circle cx="32" cy="32" r="6" stroke="#00d4aa" stroke-width="1" fill="none" opacity="0.6"/>
                    <circle cx="32" cy="32" r="2.5" fill="#00d4aa"/>
                    <line x1="10.5" y1="37" x2="10.5" y2="50" stroke="#00d4aa" stroke-width="1.5"/><rect x="8" y="40" width="5" height="8" fill="#00d4aa"/>
                    <line x1="18.5" y1="28" x2="18.5" y2="46" stroke="#00d4aa" stroke-width="1.5"/><rect x="16" y="32" width="5" height="12" fill="#00d4aa"/>
                    <line x1="26.5" y1="33" x2="26.5" y2="47" stroke="#ef4444" stroke-width="1.5"/><rect x="24" y="36" width="5" height="8" fill="#ef4444"/>
                    <line x1="34.5" y1="30" x2="34.5" y2="48" stroke="#00d4aa" stroke-width="1.5"/><rect x="32" y="34" width="5" height="12" fill="#00d4aa"/>
                    <line x1="42.5" y1="37" x2="42.5" y2="50" stroke="#ef4444" stroke-width="1.5"/><rect x="40" y="40" width="5" height="8" fill="#ef4444"/>
                    <line x1="50.5" y1="10" x2="50.5" y2="36" stroke="#00d4aa" stroke-width="1.5"/><rect x="48" y="16" width="5" height="18" fill="#00d4aa"/>
                </svg>
            </div>
            <h1 class="auth-title" data-i18n="appName">Trading Target Tracker</h1>
            <p class="auth-subtitle">Multi-Asset Portfolio & Risk Management</p>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')" data-i18n="login">Anmelden</button>
                <button class="auth-tab" onclick="showAuthTab('register')" data-i18n="register">Registrieren</button>
            </div>
            <div id="login-form">
                <div class="form-group"><input type="email" id="login-email" class="form-input" data-placeholder="emailPlaceholder" placeholder="Email-Adresse"></div>
                <div class="form-group"><input type="password" id="login-password" class="form-input" data-placeholder="passwordPlaceholder" placeholder="Passwort"></div>
                <div id="login-error" class="form-error hidden"></div>
                <button class="btn btn-primary btn-block" onclick="loginWithEmail()" id="login-btn" data-i18n="login">Anmelden</button>
            </div>
            <div id="register-form" class="hidden">
                <div class="form-group"><input type="text" id="register-name" class="form-input" data-placeholder="namePlaceholder" placeholder="Name"></div>
                <div class="form-group"><input type="email" id="register-email" class="form-input" data-placeholder="emailPlaceholder" placeholder="Email-Adresse"></div>
                <div class="form-group"><input type="password" id="register-password" class="form-input" data-placeholder="passwordMinPlaceholder" placeholder="Passwort (min. 6 Zeichen)"></div>
                <div id="register-error" class="form-error hidden"></div>
                <button class="btn btn-primary btn-block" onclick="registerWithEmail()" id="register-btn" data-i18n="createAccount">Konto erstellen</button>
            </div>
            <div class="auth-divider" data-i18n="or">oder</div>
            <button class="btn btn-google" onclick="loginWithGoogle()">
                <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                <span data-i18n="loginWithGoogle">Mit Google anmelden</span>
            </button>
            <div class="auth-footer">
                <p><span data-i18n="or">Oder</span> <a href="#" onclick="continueOffline()" data-i18n="continueWithoutLogin">ohne Anmeldung fortfahren</a></p>
                <p class="mt-2" style="font-size:0.7rem;" data-i18n="dataStoredLocally">Daten werden lokal gespeichert (kein Cloud-Sync)</p>
            </div>
        </div>
    </div>

    <div id="main-app" class="container hidden">
        <div class="header">
            <div class="header-left">
                <svg width="48" height="48" viewBox="0 0 64 64" fill="none" class="header-logo">
                    <circle cx="32" cy="32" r="30" stroke="var(--accent, #00d4aa)" stroke-width="2" fill="none"/>
                    <line x1="32" y1="2" x2="32" y2="26" stroke="var(--accent, #00d4aa)" stroke-width="0.75" opacity="0.5"/>
                    <line x1="32" y1="38" x2="32" y2="62" stroke="var(--accent, #00d4aa)" stroke-width="0.75" opacity="0.5"/>
                    <line x1="2" y1="32" x2="26" y2="32" stroke="var(--accent, #00d4aa)" stroke-width="0.75" opacity="0.5"/>
                    <line x1="38" y1="32" x2="62" y2="32" stroke="var(--accent, #00d4aa)" stroke-width="0.75" opacity="0.5"/>
                    <line x1="32" y1="2" x2="32" y2="8" stroke="var(--accent, #00d4aa)" stroke-width="2.5"/>
                    <line x1="32" y1="56" x2="32" y2="62" stroke="var(--accent, #00d4aa)" stroke-width="2.5"/>
                    <line x1="2" y1="32" x2="8" y2="32" stroke="var(--accent, #00d4aa)" stroke-width="2.5"/>
                    <line x1="56" y1="32" x2="62" y2="32" stroke="var(--accent, #00d4aa)" stroke-width="2.5"/>
                    <circle cx="32" cy="32" r="6" stroke="var(--accent, #00d4aa)" stroke-width="1" fill="none" opacity="0.6"/>
                    <circle cx="32" cy="32" r="2.5" fill="var(--accent, #00d4aa)"/>
                    <line x1="10.5" y1="37" x2="10.5" y2="50" stroke="var(--accent, #00d4aa)" stroke-width="1.5"/><rect x="8" y="40" width="5" height="8" fill="var(--accent, #00d4aa)"/>
                    <line x1="18.5" y1="28" x2="18.5" y2="46" stroke="var(--accent, #00d4aa)" stroke-width="1.5"/><rect x="16" y="32" width="5" height="12" fill="var(--accent, #00d4aa)"/>
                    <line x1="26.5" y1="33" x2="26.5" y2="47" stroke="#ef4444" stroke-width="1.5"/><rect x="24" y="36" width="5" height="8" fill="#ef4444"/>
                    <line x1="34.5" y1="30" x2="34.5" y2="48" stroke="var(--accent, #00d4aa)" stroke-width="1.5"/><rect x="32" y="34" width="5" height="12" fill="var(--accent, #00d4aa)"/>
                    <line x1="42.5" y1="37" x2="42.5" y2="50" stroke="#ef4444" stroke-width="1.5"/><rect x="40" y="40" width="5" height="8" fill="#ef4444"/>
                    <line x1="50.5" y1="10" x2="50.5" y2="36" stroke="var(--accent, #00d4aa)" stroke-width="1.5"/><rect x="48" y="16" width="5" height="18" fill="var(--accent, #00d4aa)"/>
                </svg>
                <div class="header-brand">
                    <h1>Target<span>Trader</span></h1>
                    <p>Hit your daily targets</p>
                </div>
            </div>
            <div class="header-center">
                <div class="header-date" id="header-date">-</div>
                <div class="header-separator"></div>
            </div>
            <div class="header-right">
                <div style="text-align:right;">
                    <div class="header-balance" id="header-balance">€0,00</div>
                    <div class="header-balance-sub" id="header-balance-sub">+€0,00 gesamt</div>
                </div>
                <div class="sync-status"><div class="sync-dot" id="sync-dot"></div><span id="sync-status-text" data-i18n="offline">Offline</span></div>
                <button class="theme-toggle" onclick="toggleTheme()" data-tooltip="" data-tip="themeToggle" id="theme-btn"><span class="i i-20"><svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="6" stroke="currentColor" stroke-width="1.5"/><line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="16" y1="26" x2="16" y2="30" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="2" y1="16" x2="6" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="26" y1="16" x2="30" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="6.1" y1="6.1" x2="8.9" y2="8.9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="23.1" y1="23.1" x2="25.9" y2="25.9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="6.1" y1="25.9" x2="8.9" y2="23.1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="23.1" y1="8.9" x2="25.9" y2="6.1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg></span></button>
                <div class="user-badge" onclick="openUserMenu()">
                    <div class="user-avatar" id="user-avatar">?</div>
                    <span id="user-name">Gast</span>
                </div>
            </div>
        </div>
        <div class="tabs" id="main-tabs">
            <button class="tab active" data-tab="dashboard"><span class="i i-18"><svg viewBox="0 0 32 32" fill="none"><rect x="3" y="3" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.5"/><rect x="18" y="3" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.5"/><rect x="3" y="18" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.5"/><circle cx="23.5" cy="23.5" r="5.5" stroke="currentColor" stroke-width="1.5"/><circle cx="23.5" cy="23.5" r="2" fill="currentColor"/></svg></span> <span data-i18n="tabDashboard">Dashboard</span></button>
            <button class="tab" data-tab="positions"><span class="i i-18"><svg viewBox="0 0 32 32" fill="none"><rect x="4" y="6" width="24" height="20" rx="2" stroke="currentColor" stroke-width="1.5"/><line x1="4" y1="12" x2="28" y2="12" stroke="currentColor" stroke-width="1.5"/><line x1="12" y1="12" x2="12" y2="26" stroke="currentColor" stroke-width="1.5"/><circle cx="22" cy="19" r="4" stroke="currentColor" stroke-width="1.5" opacity="0.6"/><circle cx="22" cy="19" r="1.5" fill="currentColor"/></svg></span> <span data-i18n="tabPositions">Positionen</span></button>
            <button class="tab" data-tab="entry"><span class="i i-18"><svg viewBox="0 0 32 32" fill="none"><rect x="6" y="4" width="20" height="24" rx="2" stroke="currentColor" stroke-width="1.5"/><line x1="10" y1="10" x2="22" y2="10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="10" y1="16" x2="22" y2="16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="10" y1="22" x2="16" y2="22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><circle cx="22" cy="22" r="3" stroke="currentColor" stroke-width="1.5"/><circle cx="22" cy="22" r="1" fill="currentColor"/></svg></span> <span data-i18n="tabEntry">Eintrag</span></button>
            <button class="tab" data-tab="performance"><span class="i i-18"><svg viewBox="0 0 32 32" fill="none"><path d="M4 26L10 18L16 22L22 14L28 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="28" cy="6" r="4" stroke="currentColor" stroke-width="1.5"/><circle cx="28" cy="6" r="1.5" fill="currentColor"/><circle cx="4" cy="26" r="2" fill="currentColor"/></svg></span> <span data-i18n="tabPerformance">Performance</span></button>
            <button class="tab" data-tab="instruments"><span class="i i-18"><svg viewBox="0 0 32 32" fill="none"><rect x="4" y="8" width="8" height="16" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="20" y="4" width="8" height="24" rx="1" stroke="currentColor" stroke-width="1.5"/><line x1="8" y1="4" x2="8" y2="8" stroke="currentColor" stroke-width="1.5"/><line x1="8" y1="24" x2="8" y2="28" stroke="currentColor" stroke-width="1.5"/><line x1="24" y1="1" x2="24" y2="4" stroke="currentColor" stroke-width="1.5"/><line x1="24" y1="28" x2="24" y2="31" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="16" r="3" stroke="currentColor" stroke-width="1.5" opacity="0.5"/></svg></span> <span data-i18n="tabInstruments">Instrumente</span></button>
            <button class="tab" data-tab="history"><span class="i i-18"><svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="1.5"/><polyline points="16 8 16 16 22 20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 16H1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M6 8L4 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg></span> <span data-i18n="tabHistory">Historie</span></button>
            <button class="tab" data-tab="settings"><span class="i i-18"><svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="6" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="16" r="2" fill="currentColor"/><path d="M16 3V7M16 25V29M3 16H7M25 16H29" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M6.8 6.8L9.6 9.6M22.4 22.4L25.2 25.2M6.8 25.2L9.6 22.4M22.4 9.6L25.2 6.8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg></span> <span data-i18n="tabSettings">Settings</span></button>
        </div>
        <div id="dashboard" class="tab-content active">
            <div class="grid grid-4" id="dashboard-stats"></div>
            <div id="recommendations-container"></div>
            <div class="card card-blue">
                <div class="card-title"><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><rect x="4" y="6" width="24" height="22" rx="2" stroke="currentColor" stroke-width="1.5"/><line x1="4" y1="12" x2="28" y2="12" stroke="currentColor" stroke-width="1.5"/><line x1="10" y1="3" x2="10" y2="9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="22" y1="3" x2="22" y2="9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="16" cy="20" r="4" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="20" r="1.5" fill="currentColor"/></svg></span> <span data-i18n="thisWeekKW">Diese Woche (KW</span> <span id="week-number">-</span>)</div>
                <div class="week-grid" id="week-grid"></div>
                <div class="progress-container">
                    <div class="progress-header"><span><span data-i18n="weekTarget">Wochenziel</span>: <span id="week-target">€0</span></span><span id="week-progress-pct">0%</span></div>
                    <div class="progress-bar"><div class="progress-fill green" id="week-progress-fill" style="width:0%"></div></div>
                </div>
            </div>
            <div class="grid grid-2">
                <div class="card card-green">
                    <div class="card-title" data-tip="todayProgress" data-tooltip=""><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="16" r="6" stroke="currentColor" stroke-width="1.5" opacity="0.6"/><circle cx="16" cy="16" r="2" fill="currentColor"/><line x1="16" y1="1" x2="16" y2="6" stroke="currentColor" stroke-width="2"/><line x1="16" y1="26" x2="16" y2="31" stroke="currentColor" stroke-width="2"/><line x1="1" y1="16" x2="6" y2="16" stroke="currentColor" stroke-width="2"/><line x1="26" y1="16" x2="31" y2="16" stroke="currentColor" stroke-width="2"/></svg></span> <span data-i18n="todayProgress">Heutiger Fortschritt</span> <span class="help-icon">?</span></div>
                    <div id="today-progress-content"></div>
                </div>
                <div class="card card-purple">
                    <div class="card-title" data-tip="buffer" data-tooltip=""><span class="i i-20" style="color:#fbbf24"><svg viewBox="0 0 32 32" fill="none"><path d="M16 2L4 8V16C4 22.63 9.37 28 16 28S28 22.63 28 16V8L16 2Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><circle cx="16" cy="15" r="5" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="15" r="2" fill="currentColor"/><line x1="16" y1="8" x2="16" y2="11" stroke="currentColor" stroke-width="1.5"/><line x1="16" y1="19" x2="16" y2="22" stroke="currentColor" stroke-width="1.5"/></svg></span> <span data-i18n="bufferReserve">Reserve / Buffer</span> <span class="help-icon">?</span></div>
                    <div id="buffer-content"></div>
                    <div id="buffer-history" class="mt-2" style="font-size:0.8rem;color:var(--muted);"></div>
                </div>
            </div>
            <div class="grid grid-2">
                <div class="card"><div class="card-title" data-tip="openPositions" data-tooltip=""><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><rect x="4" y="6" width="24" height="20" rx="2" stroke="currentColor" stroke-width="1.5"/><line x1="4" y1="12" x2="28" y2="12" stroke="currentColor" stroke-width="1.5"/><line x1="12" y1="12" x2="12" y2="26" stroke="currentColor" stroke-width="1.5"/><circle cx="22" cy="19" r="4" stroke="currentColor" stroke-width="1.5" opacity="0.6"/><circle cx="22" cy="19" r="1.5" fill="currentColor"/></svg></span> <span data-i18n="openPositions">Offene Positionen</span> <span class="help-icon">?</span></div><div id="dashboard-positions"></div></div>
                <div class="card card-green"><div class="card-title" data-tip="closedToday" data-tooltip=""><span class="i i-20" style="color:#10b981"><svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="1.5"/><polyline points="10 16 14 20 22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span> <span data-i18n="closedToday">Heute geschlossen</span> <span class="help-icon">?</span></div><div id="dashboard-closed-trades"></div><button class="btn btn-sm btn-ghost mt-2" onclick="openClosedTradeModal()" data-i18n="addClosedTrade">+ Trade erfassen</button></div>
            </div>
            <div class="card" id="lot-sizing-widget" style="display:none;"><div class="card-title" data-tip="lotSizing" data-tooltip=""><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><rect x="4" y="4" width="10" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/><rect x="18" y="4" width="10" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/><rect x="4" y="18" width="10" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/><rect x="18" y="18" width="10" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/><circle cx="9" cy="9" r="2" fill="currentColor"/><circle cx="23" cy="9" r="2" fill="currentColor"/><circle cx="9" cy="23" r="2" fill="currentColor"/><circle cx="23" cy="23" r="2" fill="currentColor"/></svg></span> <span data-i18n="recommendedLotSize">Empfohlene Lotgröße</span> <span class="help-icon">?</span></div><div id="lot-sizing-content"></div></div>
            <div class="grid grid-2">
                <div class="card"><div class="card-title" data-tip="equityCurve" data-tooltip=""><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><path d="M4 26L10 18L16 22L22 14L28 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="28" cy="6" r="4" stroke="currentColor" stroke-width="1.5"/><circle cx="28" cy="6" r="1.5" fill="currentColor"/><circle cx="4" cy="26" r="2" fill="currentColor"/></svg></span> <span data-i18n="equityCurve7">Equity Curve (7 Tage)</span> <span class="help-icon">?</span></div><div id="mini-equity-chart"></div></div>
                <div class="card"><div class="card-title" data-tip="streak" data-tooltip=""><span class="i i-20" style="color:#fbbf24"><svg viewBox="0 0 32 32" fill="none"><path d="M16 2C16 2 20 8 20 14C20 18 18 20 16 22C14 20 12 18 12 14C12 8 16 2 16 2Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M16 22C16 22 18 24 18 27C18 29 17 30 16 30S14 29 14 27C14 24 16 22 16 22Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><circle cx="16" cy="14" r="2" fill="currentColor"/></svg></span> <span data-i18n="streakStats">Streak & Statistiken</span> <span class="help-icon">?</span></div><div id="streak-stats"></div></div>
            </div>
            <div class="card"><div class="card-title"><span class="i i-20" style="color:#fbbf24"><svg viewBox="0 0 32 32" fill="none"><path d="M10 4H22V12C22 17.52 17.52 22 12 22H10V4Z" stroke="currentColor" stroke-width="1.5"/><path d="M22 6H26C27.1 6 28 6.9 28 8V10C28 12.21 26.21 14 24 14H22" stroke="currentColor" stroke-width="1.5"/><path d="M10 6H6C4.9 6 4 6.9 4 8V10C4 12.21 5.79 14 8 14H10" stroke="currentColor" stroke-width="1.5"/><path d="M12 22V26H20V22" stroke="currentColor" stroke-width="1.5"/><line x1="8" y1="28" x2="24" y2="28" stroke="currentColor" stroke-width="1.5"/></svg></span> <span data-i18n="nextMilestones">Nächste Meilensteine</span></div><div class="grid grid-4" id="milestones"></div></div>
        </div>
        <div id="positions" class="tab-content">
            <div class="grid grid-4" id="position-stats"></div>
            <div id="positions-list"></div>
            <button class="btn btn-add" onclick="openAddPositionModal()" data-i18n="addPosition">+ Neue Position hinzufügen</button>
            <div class="card card-green mt-3"><div class="card-title" data-tip="closedToday" data-tooltip=""><span class="i i-20" style="color:#10b981"><svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="1.5"/><polyline points="10 16 14 20 22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span> <span data-i18n="closedToday">Heute geschlossen</span> <span class="help-icon">?</span></div><div id="positions-closed-trades"></div><button class="btn btn-sm btn-ghost mt-2" onclick="openClosedTradeModal()" data-i18n="addClosedTrade">+ Trade erfassen</button></div>
            <div class="card card-gold mt-3"><div class="card-title"><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><rect x="10" y="10" width="18" height="18" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M22 10V6C22 4.9 21.1 4 20 4H6C4.9 4 4 4.9 4 6V20C4 21.1 4.9 22 6 22H10" stroke="currentColor" stroke-width="1.5"/></svg></span> <span data-i18n="quickCopy">Quick Copy</span></div><div class="grid grid-2" id="quick-copy-list"></div></div>
        </div>
        <div id="entry" class="tab-content">
            <div class="card">
                <div class="card-title"><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><rect x="6" y="4" width="20" height="24" rx="2" stroke="currentColor" stroke-width="1.5"/><line x1="10" y1="10" x2="22" y2="10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="10" y1="16" x2="22" y2="16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="10" y1="22" x2="16" y2="22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><circle cx="22" cy="22" r="3" stroke="currentColor" stroke-width="1.5"/><circle cx="22" cy="22" r="1" fill="currentColor"/></svg></span> <span data-i18n="dailyEntry">Täglicher Eintrag</span></div>
                <div id="entry-intraday-hint"></div>
                <div class="grid grid-2">
                    <div class="form-group"><label data-i18n="date">Datum</label><input type="date" id="entry-date" class="form-input"></div>
                    <div class="form-group"><label data-i18n="newBalance">Neuer Kontostand (€) *</label><input type="number" step="0.01" id="entry-balance" class="form-input" placeholder="z.B. 15365.00"></div>
                </div>
                <div class="grid grid-3">
                    <div class="form-group"><label data-tip="realizedPL" data-tooltip=""><span data-i18n="realizedPL">Realisierter P/L (€)</span> <span class="help-icon">?</span></label><input type="number" step="0.01" id="entry-realized" class="form-input" placeholder="0.00"></div>
                    <div class="form-group"><label data-tip="unrealizedPL" data-tooltip=""><span data-i18n="unrealizedPL">Unrealisierter P/L (€)</span> <span class="help-icon">?</span></label><input type="number" step="0.01" id="entry-unrealized" class="form-input" placeholder="0.00"></div>
                    <div class="form-group"><label data-i18n="numTrades">Anzahl Trades</label><input type="number" id="entry-trades" class="form-input" placeholder="0"></div>
                </div>
                <div class="form-group"><label data-tip="mood" data-tooltip=""><span data-i18n="mood">Stimmung</span> <span class="help-icon">?</span></label><select id="entry-mood" class="form-input"><option value="great" data-i18n="moodGreat">Hervorragend</option><option value="good" data-i18n="moodGood">Gut</option><option value="neutral" selected data-i18n="moodNeutral">Neutral</option><option value="bad" data-i18n="moodBad">Schlecht</option></select></div>
                <div class="form-group"><label data-i18n="notes">Notizen</label><textarea id="entry-notes" class="form-input" rows="2" placeholder="z.B. Gold Breakout..."></textarea></div>
                <div id="entry-preview" class="card card-dark hidden"></div>
                <button class="btn btn-success btn-block mt-2" onclick="saveEntry()" data-i18n="saveEntry">Eintrag speichern</button>
            </div>
        </div>
        <div id="performance" class="tab-content">
            <div class="grid grid-3">
                <div class="card card-green"><div class="stat-box"><div class="stat-label" data-i18n="thisWeek">Diese Woche</div><div class="stat-value" id="perf-week">€0</div><div class="stat-sub" id="perf-week-pct">0%</div></div></div>
                <div class="card card-blue"><div class="stat-box"><div class="stat-label" data-i18n="thisMonth">Dieser Monat</div><div class="stat-value" id="perf-month">€0</div><div class="stat-sub" id="perf-month-pct">0%</div></div></div>
                <div class="card card-gold"><div class="stat-box"><div class="stat-label" data-i18n="total">Gesamt</div><div class="stat-value" id="perf-total">€0</div><div class="stat-sub" id="perf-total-pct">0%</div></div></div>
            </div>
            <div class="card"><div class="card-title"><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><path d="M4 26L10 18L16 22L22 14L28 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="28" cy="6" r="4" stroke="currentColor" stroke-width="1.5"/><circle cx="28" cy="6" r="1.5" fill="currentColor"/><circle cx="4" cy="26" r="2" fill="currentColor"/></svg></span> <span data-i18n="equityCurve">Equity Curve (Gesamtverlauf)</span></div><div id="full-equity-chart"></div></div>
            <div class="grid grid-2">
                <div class="card"><div class="card-title"><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><rect x="4" y="18" width="6" height="10" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="13" y="12" width="6" height="16" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="22" y="4" width="6" height="24" rx="1" stroke="currentColor" stroke-width="1.5"/><circle cx="25" cy="8" r="2" stroke="currentColor" stroke-width="1.5"/><circle cx="25" cy="8" r="0.75" fill="currentColor"/></svg></span> <span data-i18n="monthlyOverview">Monatsübersicht</span></div><div id="monthly-chart"></div></div>
                <div class="card"><div class="card-title"><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><rect x="4" y="6" width="24" height="22" rx="2" stroke="currentColor" stroke-width="1.5"/><line x1="4" y1="12" x2="28" y2="12" stroke="currentColor" stroke-width="1.5"/><line x1="10" y1="3" x2="10" y2="9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="22" y1="3" x2="22" y2="9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="16" cy="20" r="4" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="20" r="1.5" fill="currentColor"/></svg></span> <span data-i18n="weekdayAnalysis">Wochentags-Analyse</span></div><div id="weekday-chart"></div></div>
            </div>
            <div class="card"><div class="card-title"><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><rect x="4" y="18" width="6" height="10" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="13" y="12" width="6" height="16" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="22" y="4" width="6" height="24" rx="1" stroke="currentColor" stroke-width="1.5"/><circle cx="25" cy="8" r="2" stroke="currentColor" stroke-width="1.5"/><circle cx="25" cy="8" r="0.75" fill="currentColor"/></svg></span> <span data-i18n="statistics">Statistiken</span></div><div class="grid grid-4" id="performance-stats"></div></div>
            <div class="card"><div class="card-title"><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><path d="M4 26L12 20L18 24L24 16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M24 16L28 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-dasharray="2 2"/><circle cx="28" cy="10" r="3" stroke="currentColor" stroke-width="1.5"/><circle cx="28" cy="10" r="1" fill="currentColor"/><circle cx="4" cy="26" r="2" fill="currentColor"/></svg></span> <span data-i18n="projection">Ziel-Projektion</span></div><div id="projection-content"></div></div>
        </div>
        <div id="instruments" class="tab-content">
            <div class="card">
                <div class="card-title"><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><polygon points="16 4 28 14 24 28 8 28 4 14" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><circle cx="16" cy="17" r="5" stroke="currentColor" stroke-width="1.5"/></svg></span> <span data-i18n="instruments">Instrumente</span></div>
                <div class="instrument-tabs" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:15px;">
                    <button class="btn btn-sm inst-tab active" onclick="switchInstrumentTab('metals')" data-tab="metals">🥇 <span data-i18n="metals">Metalle</span></button>
                    <button class="btn btn-sm inst-tab" onclick="switchInstrumentTab('indices')" data-tab="indices">📊 <span data-i18n="indices">Indizes</span></button>
                    <button class="btn btn-sm inst-tab" onclick="switchInstrumentTab('commodities')" data-tab="commodities">🛢️ <span data-i18n="commodities">Rohstoffe</span></button>
                    <button class="btn btn-sm inst-tab" onclick="switchInstrumentTab('forex')" data-tab="forex">💱 <span data-i18n="forex">Forex</span></button>
                    <button class="btn btn-sm inst-tab" onclick="switchInstrumentTab('stocks')" data-tab="stocks">📈 <span data-i18n="stocks">Aktien</span></button>
                    <button class="btn btn-sm inst-tab" onclick="switchInstrumentTab('custom')" data-tab="custom">➕ <span data-i18n="custom">Custom</span></button>
                </div>
                <div id="instruments-content"></div>
            </div>
            <div class="card"><div class="card-title" data-tip="lotSizing" data-tooltip=""><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><rect x="4" y="4" width="10" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/><rect x="18" y="4" width="10" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/><rect x="4" y="18" width="10" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/><rect x="18" y="18" width="10" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/></svg></span> <span data-i18n="activeLotSizes">Aktive Lot-Konfiguration</span> <span class="help-icon">?</span></div><div id="active-lot-config"></div></div>
        </div>
        <div id="history" class="tab-content">
            <div class="card"><div class="card-title"><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="1.5"/><polyline points="16 8 16 16 22 20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 16H1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M6 8L4 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg></span> <span data-i18n="tradingHistory">Trading Historie</span></div><div style="overflow-x:auto;"><table><thead><tr><th data-i18n="date">Datum</th><th style="text-align:right" data-i18n="start">Start</th><th style="text-align:right" data-i18n="end">Ende</th><th style="text-align:right">P/L</th><th style="text-align:center" data-i18n="target">Ziel</th><th style="text-align:center" data-i18n="mood">Stimmung</th><th></th></tr></thead><tbody id="history-table"></tbody></table></div></div>
        </div>
        <div id="settings" class="tab-content">
            <div class="card card-blue" id="cloud-sync-card"><div class="card-title"><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><path d="M8 24C4.69 24 2 21.31 2 18C2 15.2 3.9 12.9 6.5 12.2C7.2 8.7 10.3 6 14 6C17.1 6 19.8 7.9 21 10.5H22C25.9 10.5 29 13.6 29 17.5C29 21.1 26.3 24 22.8 24H8Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><circle cx="16" cy="17" r="3" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="17" r="1" fill="currentColor"/></svg></span> <span data-i18n="cloudSync">Cloud-Sync</span></div><div id="cloud-sync-content"></div></div>
            <div class="card"><div class="card-title"><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="1.5"/><line x1="16" y1="6" x2="16" y2="8" stroke="currentColor" stroke-width="2"/><line x1="16" y1="24" x2="16" y2="26" stroke="currentColor" stroke-width="2"/><path d="M12 12H18C19.66 12 21 13.34 21 15S19.66 18 18 18H12V12Z" stroke="currentColor" stroke-width="1.5"/><path d="M12 18H19C20.66 18 22 19.34 22 21S20.66 24 19 24H12V18Z" stroke="currentColor" stroke-width="1.5"/><line x1="12" y1="10" x2="12" y2="26" stroke="currentColor" stroke-width="1.5"/></svg></span> <span data-i18n="capitalGoals">Kapital & Ziele</span></div><div class="grid grid-3"><div class="form-group"><label data-tip="startCapital" data-tooltip=""><span data-i18n="startCapital">Startkapital (€)</span> <span class="help-icon">?</span></label><input type="number" step="0.01" id="set-start-capital" class="form-input"></div><div class="form-group"><label data-tip="currentBalance" data-tooltip=""><span data-i18n="currentBalance">Aktueller Stand (€)</span> <span class="help-icon">?</span></label><input type="number" step="0.01" id="set-current-balance" class="form-input"></div><div class="form-group"><label data-tip="targetCapital" data-tooltip=""><span data-i18n="targetCapital">Zielkapital (€)</span> <span class="help-icon">?</span></label><input type="number" step="0.01" id="set-target-capital" class="form-input"></div></div></div>
            <div class="card"><div class="card-title"><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><rect x="4" y="18" width="6" height="10" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="13" y="12" width="6" height="16" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="22" y="4" width="6" height="24" rx="1" stroke="currentColor" stroke-width="1.5"/><circle cx="25" cy="8" r="2" stroke="currentColor" stroke-width="1.5"/><circle cx="25" cy="8" r="0.75" fill="currentColor"/></svg></span> <span data-i18n="riskManagement">Risk Management</span></div><div class="grid grid-4"><div class="form-group"><label data-tip="dailyTarget" data-tooltip=""><span data-i18n="dailyTarget">Tagesziel (%)</span> <span class="help-icon">?</span></label><input type="number" step="0.01" id="set-daily-target" class="form-input"></div><div class="form-group"><label data-tip="riskPerTrade" data-tooltip=""><span data-i18n="riskPerTrade">Risiko/Trade (%)</span> <span class="help-icon">?</span></label><input type="number" step="0.01" id="set-risk-per-trade" class="form-input"></div><div class="form-group"><label data-tip="maxDailyLoss" data-tooltip=""><span data-i18n="maxDailyLoss">Max. Tagesverlust (%)</span> <span class="help-icon">?</span></label><input type="number" step="0.01" id="set-max-daily-loss" class="form-input"></div><div class="form-group"><label data-tip="rRRatio" data-tooltip=""><span data-i18n="rrRatio">Risk:Reward</span> <span class="help-icon">?</span></label><input type="number" step="0.1" id="set-rr-ratio" class="form-input"></div></div></div>
            <div class="card"><div class="card-title"><span class="i i-20" style="color:#fbbf24"><svg viewBox="0 0 32 32" fill="none"><path d="M16 2L4 8V16C4 22.63 9.37 28 16 28S28 22.63 28 16V8L16 2Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><circle cx="16" cy="15" r="5" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="15" r="2" fill="currentColor"/><line x1="16" y1="8" x2="16" y2="11" stroke="currentColor" stroke-width="1.5"/><line x1="16" y1="19" x2="16" y2="22" stroke="currentColor" stroke-width="1.5"/></svg></span> <span data-i18n="bufferSystem">Buffer-System</span></div><div class="grid grid-2"><div class="form-group"><label data-tip="bufferEnabled" data-tooltip=""><span data-i18n="bufferEnabled">Buffer aktiviert</span> <span class="help-icon">?</span></label><select id="set-buffer-enabled" class="form-input"><option value="true" data-i18n="yes">Ja</option><option value="false" data-i18n="no">Nein</option></select></div><div class="form-group"><label data-tip="maxBufferDays" data-tooltip=""><span data-i18n="maxBufferDays">Max. Buffer (Tage)</span> <span class="help-icon">?</span></label><input type="number" id="set-buffer-max-days" class="form-input"></div></div></div>
            <div class="card"><div class="card-title" data-tip="lotSizing" data-tooltip=""><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><rect x="4" y="4" width="10" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/><rect x="18" y="4" width="10" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/><rect x="4" y="18" width="10" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/><rect x="18" y="18" width="10" height="10" rx="2" stroke="currentColor" stroke-width="1.5"/><circle cx="9" cy="9" r="2" fill="currentColor"/><circle cx="23" cy="9" r="2" fill="currentColor"/><circle cx="9" cy="23" r="2" fill="currentColor"/><circle cx="23" cy="23" r="2" fill="currentColor"/></svg></span> <span data-i18n="lotSizing">Positions-Skalierung</span> <span class="help-icon">?</span></div><div class="grid grid-2"><div class="form-group"><label data-tip="lotSizingEnabled" data-tooltip=""><span data-i18n="lotSizingEnabled">Aktiviert</span> <span class="help-icon">?</span></label><select id="set-lot-sizing-enabled" class="form-input" onchange="updateLotSizingPreview()"><option value="true" data-i18n="yes">Ja</option><option value="false" data-i18n="no">Nein</option></select></div><div class="form-group"><label data-tip="baseBalance" data-tooltip=""><span data-i18n="baseBalance">Basis-Kontostand</span> <span class="help-icon">?</span></label><input type="number" id="set-base-balance" class="form-input" placeholder="15000" oninput="updateLotSizingPreview()"></div></div><p class="text-muted" style="font-size:0.75rem;margin:8px 0;" data-i18n="lotSizingHint">Lot-Größen werden pro Instrument im Instrumente-Tab konfiguriert.</p><div id="lot-sizing-preview" style="margin-top:10px;padding:10px;background:var(--bg);border-radius:8px;font-size:0.8rem;"></div></div>
            <button class="btn btn-primary btn-block mb-3" onclick="saveSettings()" data-i18n="saveSettings">Einstellungen speichern</button>
            <div class="card"><div class="card-title"><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><rect x="4" y="4" width="24" height="24" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M8 4V12H24V4" stroke="currentColor" stroke-width="1.5"/><rect x="10" y="16" width="12" height="8" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="20" r="2" fill="currentColor"/></svg></span> <span data-i18n="backupRestore">Backup & Restore</span></div><div class="grid grid-2"><button class="btn btn-ghost btn-block" onclick="exportData()" data-i18n="export">Exportieren</button><label class="btn btn-ghost btn-block" style="cursor:pointer;"><span data-i18n="import">Importieren</span><input type="file" accept=".json" onchange="importData(event)" style="display:none;"></label></div></div>
            <div class="card card-blue"><div class="card-title"><span>📄</span> <span data-i18n="pdfReport">PDF Bericht</span></div><p class="text-muted mb-2" style="font-size:0.85rem;" data-i18n="pdfDescription">Exportiere einen Performance-Bericht als PDF</p><button class="btn btn-primary btn-block" onclick="exportPDF()" data-i18n="createPdf">📄 PDF Bericht erstellen</button></div>
            <div class="card"><div class="card-title"><span>🌍</span> <span data-i18n="language">Sprache</span></div><div class="grid grid-3"><button class="btn lang-btn" onclick="setLanguage('de')" id="lang-de">🇩🇪 Deutsch</button><button class="btn lang-btn" onclick="setLanguage('en')" id="lang-en">🇬🇧 English</button><button class="btn lang-btn" onclick="setLanguage('es')" id="lang-es">🇪🇸 Español</button></div></div>
            <div class="card card-red"><div class="card-title"><span class="i i-20" style="color:#ef4444"><svg viewBox="0 0 32 32" fill="none"><path d="M16 4L30 28H2L16 4Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><line x1="16" y1="12" x2="16" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="16" cy="23" r="1.5" fill="currentColor"/></svg></span> <span data-i18n="dangerZone">Gefahrenzone</span></div><button class="btn btn-danger" onclick="resetAllData()" data-i18n="deleteAll">Alle Daten löschen</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="user-modal"><div class="modal" style="max-width:350px;"><div class="modal-header"><h3 class="modal-title">👤 <span data-i18n="user">Benutzer</span></h3><button class="modal-close" onclick="closeModal('user-modal')">&times;</button></div><div id="user-modal-content"></div></div></div>
    <div class="modal-overlay" id="calibration-modal"><div class="modal"><div class="modal-header"><h3 class="modal-title" data-i18n="calibrationTitle">🔧 Instrument kalibrieren</h3><button class="modal-close" onclick="closeModal('calibration-modal')">&times;</button></div><div id="calibration-content"></div></div></div>
    <div class="modal-overlay" id="position-modal"><div class="modal"><div class="modal-header"><h3 class="modal-title"><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><rect x="4" y="6" width="24" height="20" rx="2" stroke="currentColor" stroke-width="1.5"/><line x1="4" y1="12" x2="28" y2="12" stroke="currentColor" stroke-width="1.5"/><line x1="12" y1="12" x2="12" y2="26" stroke="currentColor" stroke-width="1.5"/><circle cx="22" cy="19" r="4" stroke="currentColor" stroke-width="1.5" opacity="0.6"/><circle cx="22" cy="19" r="1.5" fill="currentColor"/></svg></span> <span data-i18n="addPositionTitle">Position hinzufügen</span></h3><button class="modal-close" onclick="closeModal('position-modal')">&times;</button></div><div class="form-group"><label data-i18n="instrument">Instrument</label><select id="pos-instrument" class="form-input" onchange="updatePositionRecommendation()"></select></div><div id="pos-lot-recommendation" style="display:none;background:rgba(0,212,170,0.1);border:1px solid rgba(0,212,170,0.3);border-radius:8px;padding:10px 12px;margin-bottom:12px;"><div style="display:flex;justify-content:space-between;align-items:center;"><div><div style="font-size:0.75rem;color:var(--muted);" data-i18n="recommendedLotSize">Empfohlene Lotgröße</div><div style="font-size:1.1rem;font-weight:700;color:var(--accent);" id="pos-recommended-lots">--</div></div><button type="button" class="btn btn-sm" style="background:var(--accent);color:var(--bg);" onclick="applyRecommendedLots()" data-i18n="apply">Übernehmen</button></div></div><div class="grid grid-2"><div class="form-group"><label data-tip="positionSize" data-tooltip="" data-i18n="size">Position Size</label><input type="number" step="1" id="pos-size" class="form-input"></div><div class="form-group"><label data-tip="direction" data-tooltip="" data-i18n="direction">Richtung</label><select id="pos-direction" class="form-input"><option value="long" data-i18n="long">Long</option><option value="short" data-i18n="short">Short</option></select></div></div><div class="grid grid-2"><div class="form-group"><label data-tip="avgPrice" data-tooltip="" data-i18n="avgPrice">Avg. Einstiegspreis</label><input type="number" step="0.00001" id="pos-avg-price" class="form-input"></div><div class="form-group"><label data-tip="currentPrice" data-tooltip="" data-i18n="currentPrice">Aktueller Preis</label><input type="number" step="0.00001" id="pos-current-price" class="form-input"></div></div><button class="btn btn-success btn-block" onclick="savePosition()" data-i18n="positionSave">Position speichern</button></div></div>
    
    <!-- Closed Trade Modal -->
    <div class="modal-overlay" id="closed-trade-modal"><div class="modal" style="max-width:380px;"><div class="modal-header"><h3 class="modal-title"><span class="i i-20" style="color:#10b981"><svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="1.5"/><polyline points="10 16 14 20 22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span> <span data-i18n="addClosedTrade">Trade erfassen</span></h3><button class="modal-close" onclick="closeModal('closed-trade-modal')">&times;</button></div><div class="form-group"><label data-i18n="instrument">Instrument</label><select id="ct-instrument" class="form-input"></select></div><div class="form-group"><label>P/L (€)</label><input type="number" step="0.01" id="ct-pl" class="form-input" placeholder="z.B. 125.50 oder -45.00"></div><div class="form-group"><label data-i18n="notes">Notiz (optional)</label><input type="text" id="ct-note" class="form-input" placeholder="z.B. TP1 erreicht"></div><button class="btn btn-success btn-block" onclick="saveClosedTrade()">Trade erfassen</button></div></div>
    
    <!-- Custom Instrument Modal -->
    <div class="modal-overlay" id="custom-instrument-modal"><div class="modal" style="max-width:450px;"><div class="modal-header"><h3 class="modal-title"><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="1.5"/><line x1="16" y1="10" x2="16" y2="22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="10" y1="16" x2="22" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg></span> <span data-i18n="addCustomInstrument">Custom Instrument</span></h3><button class="modal-close" onclick="closeModal('custom-instrument-modal')">&times;</button></div>
        <div class="grid grid-2">
            <div class="form-group"><label data-i18n="symbol">Symbol</label><input type="text" id="ci-symbol" class="form-input" placeholder="z.B. BTCUSD"></div>
            <div class="form-group"><label data-i18n="name">Name</label><input type="text" id="ci-name" class="form-input" placeholder="z.B. Bitcoin"></div>
        </div>
        <div class="grid grid-2">
            <div class="form-group"><label data-i18n="color">Farbe</label><input type="color" id="ci-color" class="form-input" value="#00d4aa" style="height:40px;padding:4px;"></div>
            <div class="form-group"><label data-i18n="priceDecimals">Preisdezimalen</label><input type="number" id="ci-decimals" class="form-input" value="2" min="0" max="8"></div>
        </div>
        <div class="grid grid-2">
            <div class="form-group"><label data-i18n="lotStep">Lot-Schritte</label><input type="number" id="ci-lot-step" class="form-input" value="1" min="0.01" step="0.01"></div>
            <div class="form-group"><label data-i18n="baseLotSize">Basis-Lots</label><input type="number" id="ci-base-lots" class="form-input" value="1" min="0.01"></div>
        </div>
        <div class="form-group"><label data-i18n="standardSize">Standard Size (für Kalibrierung)</label><input type="number" id="ci-standard-size" class="form-input" value="1"></div>
        <button class="btn btn-success btn-block" onclick="saveCustomInstrument()" data-i18n="saveInstrument">Instrument speichern</button>
    </div></div>
    
    <div id="toast" class="toast"></div>
    
    <!-- Migration Modal -->
    <div class="modal-overlay" id="migration-modal">
        <div class="modal" style="max-width:420px;">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="dataConflictTitle">📦 Lokale Daten gefunden</h3>
            </div>
            <div id="migration-content">
                <p style="margin-bottom:12px;"><span data-i18n="dataConflictText">Auf diesem Gerät gibt es</span> <strong data-i18n="localData">lokale Daten</strong>:</p>
                <div class="card card-dark mb-3" id="migration-summary"></div>
                
                <div class="card card-gold mb-3" style="padding:12px;">
                    <p style="font-size:0.85rem; margin-bottom:8px;"><strong data-i18n="whatToDo">Was möchtest du tun?</strong></p>
                    <p style="font-size:0.8rem; color:var(--muted); line-height:1.4;">
                        • <strong data-i18n="uploadLocal">⬆️ Lokale hochladen</strong> = <span data-i18n="syncToCloud">Diese Daten in die Cloud speichern</span><br>
                        • <strong data-i18n="loadCloud">⬇️ Cloud laden</strong> = <span data-i18n="loadCloudDesc">Daten aus der Cloud holen</span>
                    </p>
                </div>
                
                <div class="grid grid-2" style="gap:12px;">
                    <button class="btn btn-success btn-block" onclick="migrateLocalData()" data-i18n="uploadLocal">⬆️ Lokale hochladen</button>
                    <button class="btn btn-primary btn-block" onclick="skipMigration()" data-i18n="loadCloud">⬇️ Cloud laden</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Onboarding Modal -->
    <div class="modal-overlay" id="onboarding-modal">
        <div class="modal" style="max-width:450px;">
            <div class="modal-header">
                <h3 class="modal-title"><span class="i i-24" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><path d="M16 4C16 4 8 10 8 20C8 24 10 28 16 28S24 24 24 20C24 10 16 4 16 4Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><circle cx="16" cy="16" r="4" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="16" r="1.5" fill="currentColor"/><path d="M8 20L4 24M24 20L28 24" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg></span> <span data-i18n="welcomeTitle">Willkommen bei Trading Target Tracker!</span></h3>
            </div>
            <div id="onboarding-content">
                <p style="margin-bottom:16px; color:var(--muted);" data-i18n="setupSubtitle">Bitte gib deine Startparameter ein:</p>
                
                <div class="form-group">
                    <label data-i18n="onboardStart">Anfangskapital (€)</label>
                    <input type="number" id="onboard-start-capital" class="form-input highlight" placeholder="z.B. 10000" step="0.01">
                </div>
                
                <div class="form-group">
                    <label data-i18n="onboardTarget">Zielkapital (€)</label>
                    <input type="number" id="onboard-target-capital" class="form-input highlight" placeholder="z.B. 1000000" step="0.01">
                </div>
                
                <div class="form-group">
                    <label data-i18n="startDate">Startdatum</label>
                    <input type="date" id="onboard-start-date" class="form-input highlight">
                </div>
                
                <div class="form-group">
                    <label data-i18n="onboardDaily">Tagesziel (%)</label>
                    <input type="number" id="onboard-daily-target" class="form-input" value="0.5" step="0.01">
                    <small class="text-muted" data-i18n="onboardRecommended">Empfohlen: 1.0 - 1.5%</small>
                </div>
                
                <div class="card card-dark mb-3" id="onboard-preview" style="display:none;">
                    <div class="card-title"><span class="i i-20" style="color:var(--accent)"><svg viewBox="0 0 32 32" fill="none"><rect x="4" y="18" width="6" height="10" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="13" y="12" width="6" height="16" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="22" y="4" width="6" height="24" rx="1" stroke="currentColor" stroke-width="1.5"/><circle cx="25" cy="8" r="2" stroke="currentColor" stroke-width="1.5"/><circle cx="25" cy="8" r="0.75" fill="currentColor"/></svg></span> <span data-i18n="calculation">Berechnung</span></div>
                    <div id="onboard-calc"></div>
                </div>
                
                <button class="btn btn-success btn-block" onclick="completeOnboarding()" data-i18n="startNow">Starten</button>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================================
        // TARGETTRADER ICON SYSTEM v1.0
        // ============================================================
        const I={
            dashboard:'<svg viewBox="0 0 32 32" fill="none"><rect x="3" y="3" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.5"/><rect x="18" y="3" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.5"/><rect x="3" y="18" width="11" height="11" rx="2" stroke="currentColor" stroke-width="1.5"/><circle cx="23.5" cy="23.5" r="5.5" stroke="currentColor" stroke-width="1.5"/><circle cx="23.5" cy="23.5" r="2" fill="currentColor"/></svg>',
            target:'<svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="16" r="6" stroke="currentColor" stroke-width="1.5" opacity="0.6"/><circle cx="16" cy="16" r="2" fill="currentColor"/><line x1="16" y1="1" x2="16" y2="6" stroke="currentColor" stroke-width="2"/><line x1="16" y1="26" x2="16" y2="31" stroke="currentColor" stroke-width="2"/><line x1="1" y1="16" x2="6" y2="16" stroke="currentColor" stroke-width="2"/><line x1="26" y1="16" x2="31" y2="16" stroke="currentColor" stroke-width="2"/></svg>',
            positions:'<svg viewBox="0 0 32 32" fill="none"><rect x="4" y="6" width="24" height="20" rx="2" stroke="currentColor" stroke-width="1.5"/><line x1="4" y1="12" x2="28" y2="12" stroke="currentColor" stroke-width="1.5"/><line x1="12" y1="12" x2="12" y2="26" stroke="currentColor" stroke-width="1.5"/><circle cx="22" cy="19" r="4" stroke="currentColor" stroke-width="1.5" opacity="0.6"/><circle cx="22" cy="19" r="1.5" fill="currentColor"/></svg>',
            entry:'<svg viewBox="0 0 32 32" fill="none"><rect x="6" y="4" width="20" height="24" rx="2" stroke="currentColor" stroke-width="1.5"/><line x1="10" y1="10" x2="22" y2="10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="10" y1="16" x2="22" y2="16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="10" y1="22" x2="16" y2="22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><circle cx="22" cy="22" r="3" stroke="currentColor" stroke-width="1.5"/><circle cx="22" cy="22" r="1" fill="currentColor"/></svg>',
            perf:'<svg viewBox="0 0 32 32" fill="none"><path d="M4 26L10 18L16 22L22 14L28 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="28" cy="6" r="4" stroke="currentColor" stroke-width="1.5"/><circle cx="28" cy="6" r="1.5" fill="currentColor"/><circle cx="4" cy="26" r="2" fill="currentColor"/></svg>',
            instr:'<svg viewBox="0 0 32 32" fill="none"><rect x="4" y="8" width="8" height="16" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="20" y="4" width="8" height="24" rx="1" stroke="currentColor" stroke-width="1.5"/><line x1="8" y1="4" x2="8" y2="8" stroke="currentColor" stroke-width="1.5"/><line x1="8" y1="24" x2="8" y2="28" stroke="currentColor" stroke-width="1.5"/><line x1="24" y1="1" x2="24" y2="4" stroke="currentColor" stroke-width="1.5"/><line x1="24" y1="28" x2="24" y2="31" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="16" r="3" stroke="currentColor" stroke-width="1.5" opacity="0.5"/></svg>',
            history:'<svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="1.5"/><polyline points="16 8 16 16 22 20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 16H1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M6 8L4 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
            settings:'<svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="6" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="16" r="2" fill="currentColor"/><path d="M16 3V7M16 25V29M3 16H7M25 16H29" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M6.8 6.8L9.6 9.6M22.4 22.4L25.2 25.2M6.8 25.2L9.6 22.4M22.4 9.6L25.2 6.8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
            stats:'<svg viewBox="0 0 32 32" fill="none"><rect x="4" y="18" width="6" height="10" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="13" y="12" width="6" height="16" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="22" y="4" width="6" height="24" rx="1" stroke="currentColor" stroke-width="1.5"/><circle cx="25" cy="8" r="2" stroke="currentColor" stroke-width="1.5"/><circle cx="25" cy="8" r="0.75" fill="currentColor"/></svg>',
            balance:'<svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="1.5"/><line x1="16" y1="6" x2="16" y2="8" stroke="currentColor" stroke-width="2"/><line x1="16" y1="24" x2="16" y2="26" stroke="currentColor" stroke-width="2"/><path d="M12 12H18C19.66 12 21 13.34 21 15S19.66 18 18 18H12V12Z" stroke="currentColor" stroke-width="1.5"/><path d="M12 18H19C20.66 18 22 19.34 22 21S20.66 24 19 24H12V18Z" stroke="currentColor" stroke-width="1.5"/><line x1="12" y1="10" x2="12" y2="26" stroke="currentColor" stroke-width="1.5"/></svg>',
            buffer:'<svg viewBox="0 0 32 32" fill="none"><path d="M16 2L4 8V16C4 22.63 9.37 28 16 28S28 22.63 28 16V8L16 2Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><circle cx="16" cy="15" r="5" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="15" r="2" fill="currentColor"/><line x1="16" y1="8" x2="16" y2="11" stroke="currentColor" stroke-width="1.5"/><line x1="16" y1="19" x2="16" y2="22" stroke="currentColor" stroke-width="1.5"/></svg>',
            streak:'<svg viewBox="0 0 32 32" fill="none"><path d="M16 2C16 2 20 8 20 14C20 18 18 20 16 22C14 20 12 18 12 14C12 8 16 2 16 2Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M16 22C16 22 18 24 18 27C18 29 17 30 16 30S14 29 14 27C14 24 16 22 16 22Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><circle cx="16" cy="14" r="2" fill="currentColor"/></svg>',
            cloud:'<svg viewBox="0 0 32 32" fill="none"><path d="M8 24C4.69 24 2 21.31 2 18C2 15.2 3.9 12.9 6.5 12.2C7.2 8.7 10.3 6 14 6C17.1 6 19.8 7.9 21 10.5H22C25.9 10.5 29 13.6 29 17.5C29 21.1 26.3 24 22.8 24H8Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><circle cx="16" cy="17" r="3" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="17" r="1" fill="currentColor"/></svg>',
            proj:'<svg viewBox="0 0 32 32" fill="none"><path d="M4 26L12 20L18 24L24 16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M24 16L28 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-dasharray="2 2"/><circle cx="28" cy="10" r="3" stroke="currentColor" stroke-width="1.5"/><circle cx="28" cy="10" r="1" fill="currentColor"/><circle cx="4" cy="26" r="2" fill="currentColor"/></svg>',
            gold:'<svg viewBox="0 0 32 32" fill="none"><polygon points="16 4 28 14 24 28 8 28 4 14" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><circle cx="16" cy="17" r="5" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="17" r="2" fill="currentColor"/><line x1="16" y1="10" x2="16" y2="13" stroke="currentColor" stroke-width="1.5"/><line x1="16" y1="21" x2="16" y2="24" stroke="currentColor" stroke-width="1.5"/></svg>',
            moodG:'<svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="1.5"/><circle cx="11" cy="13" r="1.5" fill="currentColor"/><circle cx="21" cy="13" r="1.5" fill="currentColor"/><path d="M10 20C10 20 12 24 16 24S22 20 22 20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
            moodO:'<svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="1.5"/><circle cx="11" cy="13" r="1.5" fill="currentColor"/><circle cx="21" cy="13" r="1.5" fill="currentColor"/><path d="M11 20C11 20 13 22 16 22S21 20 21 20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
            moodN:'<svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="1.5"/><circle cx="11" cy="13" r="1.5" fill="currentColor"/><circle cx="21" cy="13" r="1.5" fill="currentColor"/><line x1="10" y1="21" x2="22" y2="21" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
            moodB:'<svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="1.5"/><circle cx="11" cy="13" r="1.5" fill="currentColor"/><circle cx="21" cy="13" r="1.5" fill="currentColor"/><path d="M10 24C10 24 12 20 16 20S22 24 22 24" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
            sun:'<svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="6" stroke="currentColor" stroke-width="1.5"/><line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="16" y1="26" x2="16" y2="30" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="2" y1="16" x2="6" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="26" y1="16" x2="30" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="6.1" y1="6.1" x2="8.9" y2="8.9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="23.1" y1="23.1" x2="25.9" y2="25.9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="6.1" y1="25.9" x2="8.9" y2="23.1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="23.1" y1="8.9" x2="25.9" y2="6.1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
            moon:'<svg viewBox="0 0 32 32" fill="none"><path d="M28 18.3C26.8 19.4 25.2 20 23.5 20C19.4 20 16 16.6 16 12.5C16 10.8 16.6 9.2 17.7 8C10.5 8.9 5 14.9 5 22C5 29.2 11.3 30 16 30C23.1 30 28 24.5 28 18.3Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><circle cx="21" cy="10" r="2" stroke="currentColor" stroke-width="1.5"/><circle cx="26" cy="6" r="1" fill="currentColor"/></svg>',
            lock:'<svg viewBox="0 0 32 32" fill="none"><rect x="6" y="14" width="20" height="14" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M10 14V10C10 6.69 12.69 4 16 4S22 6.69 22 10V14" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="21" r="2" fill="currentColor"/></svg>',
            rocket:'<svg viewBox="0 0 32 32" fill="none"><path d="M16 4C16 4 8 10 8 20C8 24 10 28 16 28S24 24 24 20C24 10 16 4 16 4Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><circle cx="16" cy="16" r="4" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="16" r="1.5" fill="currentColor"/><path d="M8 20L4 24M24 20L28 24" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
            bulb:'<svg viewBox="0 0 32 32" fill="none"><path d="M12 26H20M13 28H19" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M12 22V20C8 18 6 14 6 10C6 4.48 10.48 0 16 0S26 4.48 26 10C26 14 24 18 20 20V22H12Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round" transform="translate(0, 2)"/><circle cx="16" cy="12" r="3" stroke="currentColor" stroke-width="1.5"/></svg>',
            check:'<svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="1.5"/><polyline points="10 16 14 20 22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
            warn:'<svg viewBox="0 0 32 32" fill="none"><path d="M16 4L30 28H2L16 4Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><line x1="16" y1="12" x2="16" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="16" cy="23" r="1.5" fill="currentColor"/></svg>',
            trash:'<svg viewBox="0 0 32 32" fill="none"><path d="M6 8H26L24 28H8L6 8Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><line x1="4" y1="8" x2="28" y2="8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M12 8V5C12 4 13 3 14 3H18C19 3 20 4 20 5V8" stroke="currentColor" stroke-width="1.5"/><line x1="12" y1="13" x2="12" y2="23" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="16" y1="13" x2="16" y2="23" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><line x1="20" y1="13" x2="20" y2="23" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
            edit:'<svg viewBox="0 0 32 32" fill="none"><path d="M22 4L28 10L12 26H6V20L22 4Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><line x1="18" y1="8" x2="24" y2="14" stroke="currentColor" stroke-width="1.5"/></svg>',
            stop:'<svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="1.5"/><line x1="10" y1="16" x2="22" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>',
            eye:'<svg viewBox="0 0 32 32" fill="none"><path d="M2 16C2 16 7 6 16 6C25 6 30 16 30 16C30 16 25 26 16 26C7 26 2 16 2 16Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><circle cx="16" cy="16" r="5" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="16" r="2" fill="currentColor"/></svg>',
            sync:'<svg viewBox="0 0 32 32" fill="none"><path d="M4 16C4 9.37 9.37 4 16 4C20.42 4 24.27 6.35 26.38 9.88" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M28 16C28 22.63 22.63 28 16 28C11.58 28 7.73 25.65 5.62 22.12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><polyline points="22 10 27 10 27 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><polyline points="10 22 5 22 5 27" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>',
            silver:'<svg viewBox="0 0 32 32" fill="none"><polygon points="16 4 28 14 24 28 8 28 4 14" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><circle cx="16" cy="17" r="5" stroke="currentColor" stroke-width="1.5"/><path d="M14 15L18 19M18 15L14 19" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>',
            platinum:'<svg viewBox="0 0 32 32" fill="none"><polygon points="16 4 28 14 24 28 8 28 4 14" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><text x="16" y="21" text-anchor="middle" font-size="10" font-weight="bold" fill="currentColor">Pt</text></svg>',
            palladium:'<svg viewBox="0 0 32 32" fill="none"><polygon points="16 4 28 14 24 28 8 28 4 14" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><text x="16" y="21" text-anchor="middle" font-size="10" font-weight="bold" fill="currentColor">Pd</text></svg>',
            index:'<svg viewBox="0 0 32 32" fill="none"><path d="M4 26L10 18L16 22L22 12L28 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="28" cy="6" r="3" stroke="currentColor" stroke-width="1.5"/><rect x="4" y="4" width="4" height="22" rx="1" stroke="currentColor" stroke-width="1.5" opacity="0.3"/></svg>',
            oil:'<svg viewBox="0 0 32 32" fill="none"><path d="M10 12C10 12 8 16 8 20C8 24.42 11.58 28 16 28S24 24.42 24 20C24 16 22 12 22 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M12 12L16 4L20 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="16" cy="20" r="3" stroke="currentColor" stroke-width="1.5"/></svg>',
            gas:'<svg viewBox="0 0 32 32" fill="none"><path d="M12 28V18C12 15.79 13.79 14 16 14S20 15.79 20 18V28" stroke="currentColor" stroke-width="1.5"/><path d="M8 28H24" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M16 14V8" stroke="currentColor" stroke-width="1.5"/><circle cx="16" cy="6" r="2" stroke="currentColor" stroke-width="1.5"/><path d="M10 22L14 22M18 22L22 22" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/></svg>',
            forex:'<svg viewBox="0 0 32 32" fill="none"><circle cx="12" cy="16" r="8" stroke="currentColor" stroke-width="1.5"/><circle cx="20" cy="16" r="8" stroke="currentColor" stroke-width="1.5"/><text x="10" y="19" font-size="7" font-weight="bold" fill="currentColor">$</text><text x="21" y="19" font-size="7" font-weight="bold" fill="currentColor">€</text></svg>',
            stock:'<svg viewBox="0 0 32 32" fill="none"><rect x="4" y="8" width="24" height="18" rx="2" stroke="currentColor" stroke-width="1.5"/><path d="M8 18L12 14L16 17L20 11L24 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="20" cy="11" r="2" stroke="currentColor" stroke-width="1.5"/><line x1="4" y1="12" x2="28" y2="12" stroke="currentColor" stroke-width="1" opacity="0.3"/></svg>',
            plus:'<svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="1.5"/><line x1="16" y1="10" x2="16" y2="22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="10" y1="16" x2="22" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>'
        };
        const ic=(n,s=20,c)=>{const map={'🥇':'gold','🥈':'gold','⚪':'gold','🔘':'gold','📊':'stats'};const key=map[n]||n;return `<span class="i i-${s}" style="${c?'color:'+c+';':''}width:${s}px;height:${s}px">${I[key]||I.gold||''}</span>`;};

        // ============================================================
        // SUPABASE CONFIG
        // ============================================================
        const SUPABASE_URL = 'https://dxlrljzxyxlmcbndjuze.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4bHJsanp4eXhsbWNibmRqdXplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MzE0MTEsImV4cCI6MjA4NDQwNzQxMX0.PS7YyRI5AQLTJd9TXzYQLxliN-NsXQ3o2W_nZRVFSg4';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ============================================================
        // DATA
        // ============================================================
        const STORAGE_KEY = 'trading-tracker-pro-v5';
        const VERSION = '4.4.6';
        
        // ============================================================
        // INTERNATIONALIZATION (i18n)
        // ============================================================
        const LANG = {
            de: {
                // === GENERAL ===
                appName: 'Trading Target Tracker',
                currency: 'EUR',
                loading: 'Laden...',
                save: 'Speichern',
                cancel: 'Abbrechen',
                delete: 'Löschen',
                edit: 'Bearbeiten',
                close: 'Schließen',
                yes: 'Ja',
                no: 'Nein',
                or: 'oder',
                of: 'von',
                to: 'bis',
                from: 'von',
                total: 'Gesamt',
                later: 'Später',
                help: 'Hilfe',
                update: 'Aktualisieren',
                install: 'Installieren',
                updateAvailable: 'Neue Version verfügbar!',
                installApp: 'TargetTrader installieren',
                installAppDesc: 'Schneller Zugriff vom Homescreen',
                installIosHint: 'Tippe auf Teilen ⬆ dann "Zum Home-Bildschirm"',
                keyboardShortcuts: 'Tastaturkürzel',
                targetReached: 'Tagesziel erreicht!',
                scaling: 'Skalierung',
                
                // === TABS ===
                tabDashboard: 'Dashboard',
                tabPositions: 'Positionen',
                tabEntry: 'Eintrag',
                tabPerformance: 'Performance',
                tabInstruments: 'Instrumente',
                tabHistory: 'Historie',
                tabSettings: 'Einstellungen',
                
                // === DASHBOARD ===
                balance: 'Kontostand',
                todayPL: 'Heute P/L',
                weekProgress: 'Woche',
                reserve: 'Reserve',
                todayProgress: 'Heutiger Fortschritt',
                bufferReserve: 'Reserve / Buffer',
                days: 'Tage',
                day: 'Tag',
                progress: 'Fortschritt',
                targetToday: 'Tagesziel heute',
                targetTomorrow: 'Tagesziel morgen',
                realized: 'Realisiert',
                unrealized: 'Unrealisiert',
                remaining: 'Verbleibend',
                weekTarget: 'Wochenziel',
                weekRealized: 'Woche realisiert',
                thisWeekKW: 'Diese Woche (KW',
                capacity: 'Kapazität',
                maximum: 'Maximum',
                minimum: 'Minimum',
                current: 'Aktuell',
                equityCurve7: 'Equity Curve (7 Tage)',
                streakStats: 'Streak & Statistiken',
                
                // === STATS ===
                currentStreak: 'Aktuelle Serie',
                maxStreak: 'Beste Serie',
                hitRate: 'Trefferquote',
                targetHit: 'Ziel erreicht',
                targetMissed: 'Ziel verfehlt',
                bestDay: 'Bester Tag',
                worstDay: 'Schlechtester Tag',
                tradingDays: 'Handelstage',
                profitDays: 'Gewinn-Tage',
                lossDays: 'Verlust-Tage',
                winRate: 'Erfolgsquote',
                avgDailyPL: 'Ø Tages-P/L',
                profitLoss: 'Gewinn/Verlust',
                daysWithTarget: 'Tage mit Ziel',
                
                // === POSITIONS ===
                openPositions: 'Offene Positionen',
                noPositions: 'Keine offenen Positionen',
                closedToday: 'Heute geschlossen',
                noClosedTrades: 'Keine Trades geschlossen',
                addClosedTrade: '+ Trade erfassen',
                closedTradeAdded: 'Trade erfasst',
                closedTradeRemoved: 'Trade entfernt',
                intradayRealized: 'Intraday realisiert',
                addPosition: '+ Neue Position hinzufügen',
                instrument: 'Instrument',
                direction: 'Richtung',
                long: 'Long',
                short: 'Short',
                size: 'Position Size',
                avgPrice: 'Avg. Einstiegspreis',
                currentPrice: 'Aktueller Preis',
                positionAdded: 'Position hinzugefügt',
                positionRemoved: 'Position entfernt',
                positionSave: 'Position speichern',
                quickCopy: 'Quick Copy',
                slTpCalculator: 'SL/TP Rechner',
                stopLoss: 'Stop-Loss',
                takeProfit: 'Take-Profit',
                pips: 'Pips',
                closePosition: 'Position schließen',
                
                // === ENTRY ===
                dailyEntry: 'Täglicher Eintrag',
                date: 'Datum',
                newBalance: 'Neuer Kontostand (€) *',
                realizedPL: 'Realisierter P/L (€)',
                unrealizedPL: 'Unrealisierter P/L (€)',
                numTrades: 'Anzahl Trades',
                mood: 'Stimmung',
                moodGreat: 'Hervorragend',
                moodGood: 'Gut',
                moodNeutral: 'Neutral',
                moodBad: 'Schlecht',
                notes: 'Notizen',
                notesPlaceholder: 'z.B. Gold Breakout...',
                balancePlaceholder: 'z.B. 15365.00',
                saveEntry: 'Eintrag speichern',
                entryRequired: 'Bitte Kontostand eingeben',
                entryOverwrite: 'Eintrag überschreiben?',
                entryDelete: 'Eintrag löschen?',
                preview: 'Vorschau',
                targetReachedYes: 'Ziel erreicht',
                targetReachedNo: 'Unter Ziel',
                
                // === PERFORMANCE ===
                thisWeek: 'Diese Woche',
                thisMonth: 'Dieser Monat',
                statistics: 'Statistiken',
                projection: 'Ziel-Projektion',
                equityCurve: 'Equity Curve (Gesamtverlauf)',
                monthlyOverview: 'Monatsübersicht',
                weekdayAnalysis: 'Wochentags-Analyse',
                remainingDays: 'Handelstage',
                remainingMonths: 'Ca. Monate',
                remainingYears: 'Ca. Jahre',
                progressToTarget: 'Fortschritt zum Ziel',
                minData: 'Mindestens 2 Tage Daten benötigt',
                noData: 'Noch keine Daten',
                avgPerWeekday: 'Ø Gewinn/Verlust pro Wochentag (Anzahl Trades)',
                plLast7Days: 'P/L letzte 7 Tage',
                
                // === INSTRUMENTS ===
                metals: 'Edelmetalle',
                stocks: 'Aktien',
                comingSoon: 'Kommt bald',
                calibrated: '✓ Kalibriert',
                notCalibrated: 'Nicht kalibriert',
                calibrate: 'Instrument kalibrieren',
                calibrateFirst: 'Bitte erst Instrument kalibrieren',
                calibrationTitle: '🔧 Instrument kalibrieren',
                plFactor: 'P/L Faktor',
                
                // === HISTORY ===
                tradingHistory: 'Trading Historie',
                start: 'Start',
                end: 'Ende',
                target: 'Ziel',
                noEntries: 'Noch keine Einträge',
                
                // === SETTINGS ===
                capitalGoals: 'Kapital & Ziele',
                startCapital: 'Startkapital (€)',
                currentBalance: 'Aktueller Stand (€)',
                targetCapital: 'Zielkapital (€)',
                riskManagement: 'Risk Management',
                dailyTarget: 'Tagesziel (%)',
                riskPerTrade: 'Risiko/Trade (%)',
                maxDailyLoss: 'Max. Tagesverlust (%)',
                rrRatio: 'Risk:Reward',
                bufferSystem: 'Buffer-System',
                bufferEnabled: 'Buffer aktiviert',
                maxBufferDays: 'Max. Buffer (Tage)',
                saveSettings: 'Einstellungen speichern',
                settingsSaved: 'Einstellungen gespeichert',
                
                // === BACKUP ===
                backupRestore: 'Backup & Restore',
                export: 'Exportieren',
                import: 'Importieren',
                backupCreated: 'Backup erstellt',
                imported: 'Importiert',
                invalidFile: 'Ungültige Datei',
                overwriteData: 'Alle Daten überschreiben?',
                
                // === PDF ===
                pdfReport: 'PDF Bericht',
                pdfDescription: 'Exportiere einen Performance-Bericht als PDF',
                createPdf: '📄 PDF Bericht erstellen',
                pdfCreated: 'PDF erstellt',
                
                // === LANGUAGE ===
                language: 'Sprache',
                
                // === DANGER ZONE ===
                dangerZone: 'Gefahrenzone',
                deleteAll: 'Alle Daten löschen',
                deleteConfirm1: 'ALLE DATEN LÖSCHEN?',
                deleteConfirm2: 'Wirklich sicher?',
                deleted: 'Gelöscht',
                
                // === CLOUD/AUTH ===
                cloudSync: 'Cloud-Sync',
                cloudConnected: 'Cloud verbunden',
                offline: 'Offline',
                offlineMode: 'Offline-Modus',
                login: 'Anmelden',
                logout: 'Abmelden',
                loggedOut: 'Abgemeldet',
                createAccount: 'Konto erstellen',
                email: 'E-Mail',
                password: 'Passwort',
                emailPlaceholder: 'deine@email.com',
                passwordPlaceholder: 'Passwort',
                orContinueWith: 'Oder weiter mit',
                continueOffline: 'Offline fortfahren',
                confirmEmail: 'Bitte bestätige deine Email',
                accountCreated: 'Konto erstellt!',
                loginSuccess: 'Erfolgreich angemeldet!',
                loginFailed: 'Anmeldung fehlgeschlagen',
                loginSubtitle: 'Anmelden für Sync auf allen Geräten',
                useCloud: 'Cloud verwenden',
                useLocal: 'Lokal verwenden',
                syncToCloud: 'Diese Daten in die Cloud speichern',
                migrateToCloud: 'In Cloud migrieren',
                localData: 'Lokale Daten',
                cloudData: 'Cloud-Daten',
                dataConflict: 'Datenkonflikt',
                entries: 'Einträge',
                
                // === MILESTONES ===
                nextMilestones: 'Nächste Meilensteine',
                
                // === RECOMMENDATIONS ===
                recommendations: 'Empfehlungen',
                
                // === WEEKDAYS ===
                mon: 'Mo', tue: 'Di', wed: 'Mi', thu: 'Do', fri: 'Fr', sat: 'Sa', sun: 'So',
                monday: 'Montag', tuesday: 'Dienstag', wednesday: 'Mittwoch', thursday: 'Donnerstag', friday: 'Freitag',
                
                // === MONTHS ===
                jan: 'Jan', feb: 'Feb', mar: 'Mär', apr: 'Apr', may: 'Mai', jun: 'Jun',
                jul: 'Jul', aug: 'Aug', sep: 'Sep', oct: 'Okt', nov: 'Nov', dec: 'Dez',
                
                // === ONBOARDING ===
                welcome: 'Willkommen!',
                setupAccount: 'Richte dein Trading-Konto ein',
                setupSubtitle: 'Bitte gib deine Startparameter ein:',
                onboardStart: 'Startkapital (€)',
                onboardTarget: 'Zielkapital (€)',
                onboardDaily: 'Tagesziel (%)',
                onboardRecommended: 'Empfohlen: 1.0 - 1.5%',
                calculation: 'Berechnung',
                startNow: 'Starten',
                day1Target: 'Tagesziel (Tag 1):',
                daysToGoal: 'Tage bis zum Ziel:',
                
                // === VALIDATION ===
                targetMustBeHigher: 'Zielkapital muss größer als Anfangskapital sein',
                weekTargetReached: 'Wochenziel erreicht!',
                pleaseEnterStartCapital: 'Bitte Anfangskapital eingeben',
                pleaseEnterStartDate: 'Bitte Startdatum eingeben',
                fillAllFields: 'Bitte alle Felder ausfüllen',
                setupComplete: 'Setup abgeschlossen!',
                migrationSuccess: 'Daten erfolgreich migriert! 🎉',
                migrationError: 'Fehler bei Migration',
                
                // === TOOLTIPS - DASHBOARD ===
                tipBalance: 'Dein aktueller Kontostand inkl. aller offenen Positionen.',
                tipTodayPL: 'Heutiger Gewinn oder Verlust aus geschlossenen und offenen Trades.',
                tipWeekProgress: 'Prozent des wöchentlichen Gewinnziels bereits erreicht.',
                tipReserve: 'Angesammelter Buffer aus Übergewinnen - dein Sicherheitspolster.',
                tipTodayProgress: 'Zeigt wie viel vom heutigen Tagesziel bereits erreicht wurde.',
                tipBuffer: 'Der Buffer sammelt Gewinne über dem Tagesziel als Reserve für Verlustphasen.',
                tipEquityCurve: 'Visualisiert die Entwicklung deines Kontostands über die Zeit.',
                tipStreak: 'Anzahl aufeinanderfolgender Tage, an denen das Tagesziel erreicht wurde.',
                tipWeekGrid: 'Übersicht der täglichen P/L für die aktuelle Handelswoche.',
                
                // === TOOLTIPS - STATS ===
                tipCurrentStreak: 'Aktuelle Serie von Tagen mit erreichtem Tagesziel.',
                tipMaxStreak: 'Deine längste Serie von erfolgreichen Tagen.',
                tipHitRate: 'Prozentsatz der Tage, an denen du dein Tagesziel erreicht hast.',
                tipBestDay: 'Dein profitabelster Handelstag bisher.',
                tipWorstDay: 'Dein verlustreichster Handelstag bisher.',
                tipTradingDays: 'Gesamtzahl der Tage mit Trading-Aktivität.',
                tipWinRate: 'Verhältnis von profitablen zu nicht-profitablen Tagen.',
                tipAvgDailyPL: 'Durchschnittlicher täglicher Gewinn/Verlust über alle Handelstage.',
                
                // === TOOLTIPS - POSITIONS ===
                tipOpenPositions: 'Deine aktuell offenen Trades. Der unrealisierte P/L ändert sich mit dem Markt.',
                tipClosedToday: 'Heute geschlossene Trades. Diese zählen zum realisierten Tagesgewinn.',
                tipPositionSize: 'Anzahl der Einheiten (Lots, Kontrakte, Unzen).',
                tipAvgPrice: 'Durchschnittlicher Einstiegspreis deiner Position.',
                tipCurrentPrice: 'Aktueller Marktpreis für die P/L Berechnung.',
                tipDirection: 'Long = Kauf (Gewinn bei steigenden Kursen), Short = Verkauf (Gewinn bei fallenden Kursen).',
                tipSL: 'Stop-Loss Preis - automatischer Verkauf zur Verlustbegrenzung.',
                tipTP: 'Take-Profit Preis - automatischer Verkauf zur Gewinnmitnahme.',
                
                // === TOOLTIPS - ENTRY ===
                tipRealizedPL: 'Bereits geschlossene Trades - tatsächlicher Gewinn/Verlust des Tages.',
                tipUnrealizedPL: 'Noch offene Positionen - kann sich bis Tagesende noch ändern.',
                tipMood: 'Deine Trading-Stimmung hilft bei der späteren Analyse deiner Performance.',
                tipNotes: 'Notiere wichtige Beobachtungen, Setups oder Learnings des Tages.',
                tipNewBalance: 'Der exakte Kontostand bei deinem Broker am Ende des Handelstages.',
                
                // === TOOLTIPS - SETTINGS ===
                tipStartCapital: 'Dein anfängliches Trading-Kapital. Basis für alle Berechnungen und Prozentangaben.',
                tipCurrentBalance: 'Aktueller Kontostand bei deinem Broker.',
                tipTargetCapital: 'Dein finanzielles Ziel. Bei Erreichen ist die Trading-Challenge geschafft!',
                tipDailyTarget: 'Tägliches Gewinnziel in Prozent. 1-1.5% ist realistisch für Daytrading.',
                tipRiskPerTrade: 'Maximales Risiko pro einzelnem Trade. 1-2% wird von Profis empfohlen.',
                tipMaxDailyLoss: 'Stop-Trading Grenze - höre auf zu traden wenn dieser Verlust erreicht wird.',
                tipRRRatio: 'Risk-Reward Verhältnis. 2:1 bedeutet doppelter Gewinn bei gleichem Risiko.',
                tipBufferEnabled: 'Aktiviert das Buffer-System das Übergewinne als Reserve für schlechte Tage sammelt.',
                tipMaxBufferDays: 'Maximale Anzahl Tage, die der Buffer als Reserve abdecken kann.',
                
                // === TOOLTIPS - PERFORMANCE ===
                tipMonthlyChart: 'Zeigt den Gesamtgewinn/-verlust pro Monat als Balkendiagramm.',
                tipWeekdayAnalysis: 'Analysiert an welchen Wochentagen du am besten/schlechtesten tradest.',
                tipProjection: 'Berechnet wie lange du bei aktuellem Tempo bis zum Ziel brauchst.',
                tipProgressBar: 'Visueller Fortschritt zum Erreichen deines Zielkapitals.',
                
                // === LOT SIZING ===
                lotSizing: 'Positions-Skalierung',
                recommendedLotSize: 'Empfohlene Lotgröße',
                tipLotSizing: 'Automatische Anpassung der Lotgröße basierend auf deinem Kontostand. Skaliert proportional mit dem Tagesziel.',
                lotSizingEnabled: 'Skalierung aktiv',
                tipLotSizingEnabled: 'Aktiviert die automatische Skalierung der Positionsgrößen mit wachsendem Kontostand.',
                baseBalance: 'Basis-Kontostand',
                tipBaseBalance: 'Der Kontostand, bei dem du deine Basis-Lotgröße normalerweise tradest.',
                baseLotSize: 'Basis-Lots',
                tipBaseLotSize: 'Deine Standard-Lotgröße beim Basis-Kontostand (für Gold in ganzen Zahlen).',
                basis: 'Basis',
                scaling: 'Skalierung',
                apply: 'Übernehmen',
                lotSizingDisabled: 'Positions-Skalierung deaktiviert',
                lotSizingHint: 'Lot-Größen werden pro Instrument im Instrumente-Tab konfiguriert.',
                lotSizingPreviewTitle: 'Vorschau (Gold/Silber)',
                
                // === INSTRUMENTS ===
                instruments: 'Instrumente',
                indices: 'Indizes',
                commodities: 'Rohstoffe',
                forex: 'Forex',
                custom: 'Custom',
                active: 'Aktiv',
                inactive: 'Inaktiv',
                addCustomInstrument: 'Custom Instrument hinzufügen',
                noCustomInstruments: 'Keine Custom Instrumente. Klicke auf + um eines hinzuzufügen.',
                activeLotSizes: 'Aktive Lot-Konfiguration',
                noActiveInstruments: 'Keine aktiven kalibrierten Instrumente.',
                scaleFactor: 'Skalierungsfaktor',
                recommended: 'Empfohlen',
                lotConfiguration: 'Lot-Konfiguration',
                atBalance: 'bei Kontostand',
                globalSetting: 'Globale Einstellung',
                lotStep: 'Lot-Schritte',
                plFactorCalibration: 'P/L Faktor Kalibrierung',
                saveConfiguration: 'Konfiguration speichern',
                deleteInstrument: 'Instrument löschen',
                symbol: 'Symbol',
                priceDecimals: 'Preisdezimalen',
                standardSize: 'Standard Size',
                saveInstrument: 'Instrument speichern',
                symbolNameRequired: 'Symbol und Name sind erforderlich',
                instrumentExists: 'Ein Instrument mit diesem Symbol existiert bereits',
                added: 'hinzugefügt',
                deleted: 'gelöscht',
                
                // === ADDITIONAL MISSING ===
                register: 'Registrieren',
                namePlaceholder: 'Name',
                passwordMinPlaceholder: 'Passwort (min. 6 Zeichen)',
                loginWithGoogle: 'Mit Google anmelden',
                continueWithoutLogin: 'ohne Anmeldung fortfahren',
                dataStoredLocally: 'Daten werden lokal gespeichert (kein Cloud-Sync)',
                user: 'Benutzer',
                addPositionTitle: 'Position hinzufügen',
                calibrationTitle: '🔧 Instrument kalibrieren',
                welcomeTitle: 'Willkommen bei Trading Target Tracker!',
                startDate: 'Startdatum',
                equityCurve7: 'Equity Curve (7 Tage)',
                streakStats: 'Streak & Statistiken',
                positionSave: 'Position speichern',
                trades: 'Trades',
                pl: 'P/L',
                stillToReach: 'Noch zu erreichen',
                atCurrentRate: 'Bei aktuellem Tempo',
                tradingDaysRemaining: 'Handelstage verbleibend',
                noActivePositions: 'Keine aktiven Positionen',
                toTarget: 'vom Ziel',
                
                // === ADDITIONAL DYNAMIC TEXTS ===
                reached: 'Erreicht',
                surplus: 'Überschuss',
                stillOpen: 'Noch offen',
                tomorrow: 'Morgen',
                dailyTargetLabel: 'Tagesziel',
                profit: 'Gewinn',
                loss: 'Verlust',
                stillMissing: 'Noch fehlend',
                vsTarget: 'vs. Ziel',
                atSize: 'bei Größe',
                avgPriceShort: 'Ø Preis',
                perDollar: 'pro Dollar',
                calcFactor: 'Berechneter Faktor',
                enterValues: 'Werte eingeben',
                enterNewPrice: 'Neuen Preis eingeben',
                lastCalibration: 'Letzte Kalibrierung',
                lastPrice: 'Letzter Preis',
                saveFactor: 'Faktor speichern',
                removePosition: 'Position entfernen',
                removeHint: 'Klicken zum Entfernen',
                noBufferActivity: 'Noch keine Buffer-Aktivität',
                avgPerWeekday: 'Ø pro Wochentag',
                loginError: 'Anmeldung fehlgeschlagen',
                registerError: 'Registrierung fehlgeschlagen',
                loggingIn: 'Anmelden...',
                registering: 'Registrieren...',
                guest: 'Gast',
                totalLabel: 'gesamt',
                themeToggle: 'Design wechseln',
                dataConflictTitle: '📦 Lokale Daten gefunden',
                dataConflictText: 'Auf diesem Gerät gibt es',
                whatToDo: 'Was möchtest du tun?',
                uploadLocal: '⬆️ Lokale hochladen',
                loadCloud: '⬇️ Cloud laden',
                phase: 'Phase',
                lockedFeature: 'Kommt bald',
                loadCloudDesc: 'Daten aus der Cloud holen',
                syncNow: 'Jetzt synchronisieren',
                offlineModeDesc: 'Offline-Modus - Daten nur lokal gespeichert.',
                enableCloudSync: 'Cloud-Sync aktivieren',
                entrySaved: 'Eintrag gespeichert',
                months: 'Mon.',
                
                // === MORE MISSING ===
                reached: 'Erreicht!',
                surplus: 'Überschuss',
                stillOpen: 'Noch offen',
                tomorrow: 'Morgen',
                noBufferActivity: 'Keine Buffer-Aktivität',
                stillMissing: 'noch',
                new: 'Neu',
                vsTarget: 'vs. Ziel',
                avgWeekdayPL: 'Ø pro Wochentag',
                weekdayCount: 'Anzahl Trades',
                started: 'Gestartet',
                currentValue: 'Aktuell',
                plToday: 'P/L heute',
                plTotal: 'P/L gesamt',
                remove: 'Entfernen',
                removePosition: 'Position entfernen?',
                removeHint: 'Hinweis: Falls du diese Position geschlossen hast, stelle sicher dass der Gewinn/Verlust bereits im heutigen Tageseintrag erfasst wurde.',
                calibrateFactor: 'Berechneter Faktor',
                plPerDollar: 'P/L pro $1 Bewegung',
                saveFactor: 'Faktor speichern',
                enterValues: 'Werte aus IBKR Screenshot eingeben',
                avgPriceShort: 'Average Price',
                lastPrice: 'Current/Last Price',
                calcFactor: 'Berechneter Faktor',
                remainingTxt: 'Verbleibend',
                approxMonths: 'Mon.',
                targetLabel: 'Ziel',
                lastCalibration: 'Letzte Kalibrierung',
                atSize: 'Bei',
                perDollar: 'pro $1',
                units: 'Einheiten',
                calibrated: '✓ Kalibriert',
                notCalibrated: 'Nicht kalibriert',
                plFactor: 'Faktor',
                enterNewPrice: 'Neuer Preis:',
                profit: 'Gewinn',
                loss: 'Verlust'
            },
            en: {
                // === GENERAL ===
                appName: 'Trading Target Tracker',
                currency: 'EUR',
                loading: 'Loading...',
                save: 'Save',
                cancel: 'Cancel',
                delete: 'Delete',
                edit: 'Edit',
                close: 'Close',
                yes: 'Yes',
                no: 'No',
                or: 'or',
                of: 'of',
                to: 'to',
                from: 'from',
                total: 'Total',
                later: 'Later',
                help: 'Help',
                update: 'Update',
                install: 'Install',
                updateAvailable: 'New version available!',
                installApp: 'Install TargetTrader',
                installAppDesc: 'Quick access from homescreen',
                installIosHint: 'Tap Share ⬆ then "Add to Home Screen"',
                keyboardShortcuts: 'Keyboard Shortcuts',
                targetReached: 'Daily target reached!',
                scaling: 'Scaling',
                
                // === TABS ===
                tabDashboard: 'Dashboard',
                tabPositions: 'Positions',
                tabEntry: 'Entry',
                tabPerformance: 'Performance',
                tabInstruments: 'Instruments',
                tabHistory: 'History',
                tabSettings: 'Settings',
                
                // === DASHBOARD ===
                balance: 'Balance',
                todayPL: 'Today P/L',
                weekProgress: 'Week',
                reserve: 'Reserve',
                todayProgress: 'Today\'s Progress',
                bufferReserve: 'Reserve / Buffer',
                days: 'Days',
                day: 'Day',
                progress: 'Progress',
                targetToday: 'Today\'s Target',
                targetTomorrow: 'Tomorrow\'s Target',
                realized: 'Realized',
                unrealized: 'Unrealized',
                remaining: 'Remaining',
                weekTarget: 'Week Target',
                weekRealized: 'Week Realized',
                thisWeekKW: 'This Week (CW',
                capacity: 'Capacity',
                maximum: 'Maximum',
                minimum: 'Minimum',
                current: 'Current',
                equityCurve7: 'Equity Curve (7 Days)',
                streakStats: 'Streak & Statistics',
                
                // === STATS ===
                currentStreak: 'Current Streak',
                maxStreak: 'Best Streak',
                hitRate: 'Hit Rate',
                targetHit: 'Target Hit',
                targetMissed: 'Target Missed',
                bestDay: 'Best Day',
                worstDay: 'Worst Day',
                tradingDays: 'Trading Days',
                profitDays: 'Profit Days',
                lossDays: 'Loss Days',
                winRate: 'Win Rate',
                avgDailyPL: 'Avg. Daily P/L',
                profitLoss: 'Profit/Loss',
                daysWithTarget: 'Days with Target',
                
                // === POSITIONS ===
                openPositions: 'Open Positions',
                noPositions: 'No open positions',
                closedToday: 'Closed Today',
                noClosedTrades: 'No trades closed',
                addClosedTrade: '+ Log Trade',
                closedTradeAdded: 'Trade logged',
                closedTradeRemoved: 'Trade removed',
                intradayRealized: 'Intraday realized',
                addPosition: '+ Add New Position',
                instrument: 'Instrument',
                direction: 'Direction',
                long: 'Long',
                short: 'Short',
                size: 'Position Size',
                avgPrice: 'Avg. Entry Price',
                currentPrice: 'Current Price',
                positionAdded: 'Position added',
                positionRemoved: 'Position removed',
                positionSave: 'Save Position',
                quickCopy: 'Quick Copy',
                slTpCalculator: 'SL/TP Calculator',
                stopLoss: 'Stop-Loss',
                takeProfit: 'Take-Profit',
                pips: 'Pips',
                closePosition: 'Close Position',
                
                // === ENTRY ===
                dailyEntry: 'Daily Entry',
                date: 'Date',
                newBalance: 'New Balance (€) *',
                realizedPL: 'Realized P/L (€)',
                unrealizedPL: 'Unrealized P/L (€)',
                numTrades: 'Number of Trades',
                mood: 'Mood',
                moodGreat: 'Excellent',
                moodGood: 'Good',
                moodNeutral: 'Neutral',
                moodBad: 'Bad',
                notes: 'Notes',
                notesPlaceholder: 'e.g. Gold breakout...',
                balancePlaceholder: 'e.g. 15365.00',
                saveEntry: 'Save Entry',
                entryRequired: 'Please enter balance',
                entryOverwrite: 'Overwrite entry?',
                entryDelete: 'Delete entry?',
                preview: 'Preview',
                targetReachedYes: 'Target reached',
                targetReachedNo: 'Under target',
                
                // === PERFORMANCE ===
                thisWeek: 'This Week',
                thisMonth: 'This Month',
                statistics: 'Statistics',
                projection: 'Target Projection',
                equityCurve: 'Equity Curve (Full History)',
                monthlyOverview: 'Monthly Overview',
                weekdayAnalysis: 'Weekday Analysis',
                remainingDays: 'Trading Days',
                remainingMonths: 'Est. Months',
                remainingYears: 'Est. Years',
                progressToTarget: 'Progress to Target',
                minData: 'Minimum 2 days of data required',
                noData: 'No data yet',
                avgPerWeekday: 'Avg. profit/loss per weekday (number of trades)',
                plLast7Days: 'P/L Last 7 Days',
                
                // === INSTRUMENTS ===
                metals: 'Precious Metals',
                stocks: 'Stocks',
                comingSoon: 'Coming soon',
                calibrated: '✓ Calibrated',
                notCalibrated: 'Not calibrated',
                calibrate: 'Calibrate Instrument',
                calibrateFirst: 'Please calibrate instrument first',
                calibrationTitle: '🔧 Calibrate Instrument',
                plFactor: 'P/L Factor',
                
                // === HISTORY ===
                tradingHistory: 'Trading History',
                start: 'Start',
                end: 'End',
                target: 'Target',
                noEntries: 'No entries yet',
                
                // === SETTINGS ===
                capitalGoals: 'Capital & Goals',
                startCapital: 'Start Capital (€)',
                currentBalance: 'Current Balance (€)',
                targetCapital: 'Target Capital (€)',
                riskManagement: 'Risk Management',
                dailyTarget: 'Daily Target (%)',
                riskPerTrade: 'Risk/Trade (%)',
                maxDailyLoss: 'Max. Daily Loss (%)',
                rrRatio: 'Risk:Reward',
                bufferSystem: 'Buffer System',
                bufferEnabled: 'Buffer Enabled',
                maxBufferDays: 'Max. Buffer (Days)',
                saveSettings: 'Save Settings',
                settingsSaved: 'Settings saved',
                
                // === BACKUP ===
                backupRestore: 'Backup & Restore',
                export: 'Export',
                import: 'Import',
                backupCreated: 'Backup created',
                imported: 'Imported',
                invalidFile: 'Invalid file',
                overwriteData: 'Overwrite all data?',
                
                // === PDF ===
                pdfReport: 'PDF Report',
                pdfDescription: 'Export a performance report as PDF',
                createPdf: '📄 Create PDF Report',
                pdfCreated: 'PDF created',
                
                // === LANGUAGE ===
                language: 'Language',
                
                // === DANGER ZONE ===
                dangerZone: 'Danger Zone',
                deleteAll: 'Delete All Data',
                deleteConfirm1: 'DELETE ALL DATA?',
                deleteConfirm2: 'Are you sure?',
                deleted: 'Deleted',
                
                // === CLOUD/AUTH ===
                cloudSync: 'Cloud Sync',
                cloudConnected: 'Cloud connected',
                offline: 'Offline',
                offlineMode: 'Offline Mode',
                login: 'Login',
                logout: 'Logout',
                loggedOut: 'Logged out',
                createAccount: 'Create Account',
                email: 'Email',
                password: 'Password',
                emailPlaceholder: 'your@email.com',
                passwordPlaceholder: 'Password',
                orContinueWith: 'Or continue with',
                continueOffline: 'Continue Offline',
                confirmEmail: 'Please confirm your email',
                accountCreated: 'Account created!',
                loginSuccess: 'Successfully logged in!',
                loginFailed: 'Login failed',
                loginSubtitle: 'Login to sync across all devices',
                useCloud: 'Use Cloud',
                useLocal: 'Use Local',
                syncToCloud: 'Sync this data to cloud',
                migrateToCloud: 'Migrate to Cloud',
                localData: 'Local Data',
                cloudData: 'Cloud Data',
                dataConflict: 'Data Conflict',
                entries: 'Entries',
                
                // === MILESTONES ===
                nextMilestones: 'Next Milestones',
                
                // === RECOMMENDATIONS ===
                recommendations: 'Recommendations',
                
                // === WEEKDAYS ===
                mon: 'Mon', tue: 'Tue', wed: 'Wed', thu: 'Thu', fri: 'Fri', sat: 'Sat', sun: 'Sun',
                monday: 'Monday', tuesday: 'Tuesday', wednesday: 'Wednesday', thursday: 'Thursday', friday: 'Friday',
                
                // === MONTHS ===
                jan: 'Jan', feb: 'Feb', mar: 'Mar', apr: 'Apr', may: 'May', jun: 'Jun',
                jul: 'Jul', aug: 'Aug', sep: 'Sep', oct: 'Oct', nov: 'Nov', dec: 'Dec',
                
                // === ONBOARDING ===
                welcome: 'Welcome!',
                setupAccount: 'Set up your trading account',
                setupSubtitle: 'Please enter your start parameters:',
                onboardStart: 'Start Capital (€)',
                onboardTarget: 'Target Capital (€)',
                onboardDaily: 'Daily Target (%)',
                onboardRecommended: 'Recommended: 1.0 - 1.5%',
                calculation: 'Calculation',
                startNow: 'Start',
                day1Target: 'Daily Target (Day 1):',
                daysToGoal: 'Days to goal:',
                
                // === VALIDATION ===
                targetMustBeHigher: 'Target capital must be higher than start capital',
                weekTargetReached: 'Weekly target reached!',
                pleaseEnterStartCapital: 'Please enter start capital',
                pleaseEnterStartDate: 'Please enter start date',
                fillAllFields: 'Please fill all fields',
                setupComplete: 'Setup complete!',
                migrationSuccess: 'Data migrated successfully! 🎉',
                migrationError: 'Migration error',
                
                // === TOOLTIPS - DASHBOARD ===
                tipBalance: 'Your current account balance including all open positions.',
                tipTodayPL: 'Today\'s profit or loss from closed and open trades.',
                tipWeekProgress: 'Percentage of weekly profit target already achieved.',
                tipReserve: 'Accumulated buffer from excess profits - your safety cushion.',
                tipTodayProgress: 'Shows how much of today\'s daily target has been achieved.',
                tipBuffer: 'The buffer collects profits above the daily target as reserve for loss phases.',
                tipEquityCurve: 'Visualizes the development of your account balance over time.',
                tipStreak: 'Number of consecutive days where daily target was achieved.',
                tipWeekGrid: 'Overview of daily P/L for the current trading week.',
                
                // === TOOLTIPS - STATS ===
                tipCurrentStreak: 'Current series of days with achieved daily target.',
                tipMaxStreak: 'Your longest series of successful days.',
                tipHitRate: 'Percentage of days where you hit your daily target.',
                tipBestDay: 'Your most profitable trading day so far.',
                tipWorstDay: 'Your biggest loss trading day so far.',
                tipTradingDays: 'Total number of days with trading activity.',
                tipWinRate: 'Ratio of profitable to non-profitable days.',
                tipAvgDailyPL: 'Average daily profit/loss across all trading days.',
                
                // === TOOLTIPS - POSITIONS ===
                tipOpenPositions: 'Your currently open trades. Unrealized P/L changes with the market.',
                tipClosedToday: 'Trades closed today. These count towards your realized daily profit.',
                tipPositionSize: 'Number of units (lots, contracts, ounces).',
                tipAvgPrice: 'Average entry price of your position.',
                tipCurrentPrice: 'Current market price for P/L calculation.',
                tipDirection: 'Long = Buy (profit on rising prices), Short = Sell (profit on falling prices).',
                tipSL: 'Stop-Loss price - automatic sell to limit losses.',
                tipTP: 'Take-Profit price - automatic sell to secure profits.',
                
                // === TOOLTIPS - ENTRY ===
                tipRealizedPL: 'Already closed trades - actual profit/loss of the day.',
                tipUnrealizedPL: 'Still open positions - can still change until end of day.',
                tipMood: 'Your trading mood helps analyze your performance later.',
                tipNotes: 'Note important observations, setups or learnings of the day.',
                tipNewBalance: 'The exact account balance at your broker at end of trading day.',
                
                // === TOOLTIPS - SETTINGS ===
                tipStartCapital: 'Your initial trading capital. Basis for all calculations and percentages.',
                tipCurrentBalance: 'Current account balance at your broker.',
                tipTargetCapital: 'Your financial goal. Trading challenge completed when reached!',
                tipDailyTarget: 'Daily profit target in percent. 1-1.5% is realistic for day trading.',
                tipRiskPerTrade: 'Maximum risk per single trade. 1-2% is recommended by professionals.',
                tipMaxDailyLoss: 'Stop-trading limit - stop trading when this loss is reached.',
                tipRRRatio: 'Risk-Reward ratio. 2:1 means double profit for same risk.',
                tipBufferEnabled: 'Enables buffer system that collects excess profits as reserve for bad days.',
                tipMaxBufferDays: 'Maximum number of days the buffer can cover as reserve.',
                
                // === TOOLTIPS - PERFORMANCE ===
                tipMonthlyChart: 'Shows total profit/loss per month as bar chart.',
                tipWeekdayAnalysis: 'Analyzes on which weekdays you trade best/worst.',
                tipProjection: 'Calculates how long until you reach your goal at current pace.',
                tipProgressBar: 'Visual progress towards reaching your target capital.',
                
                // === LOT SIZING ===
                lotSizing: 'Position Scaling',
                recommendedLotSize: 'Recommended Lot Size',
                tipLotSizing: 'Automatic lot size adjustment based on your account balance. Scales proportionally with daily target.',
                lotSizingEnabled: 'Scaling Active',
                tipLotSizingEnabled: 'Enables automatic position size scaling as your account grows.',
                baseBalance: 'Base Balance',
                tipBaseBalance: 'The account balance at which you normally trade your base lot size.',
                baseLotSize: 'Base Lots',
                tipBaseLotSize: 'Your standard lot size at the base balance (whole numbers for gold).',
                basis: 'Base',
                scaling: 'Scaling',
                apply: 'Apply',
                lotSizingDisabled: 'Position scaling disabled',
                lotSizingHint: 'Lot sizes are configured per instrument in the Instruments tab.',
                lotSizingPreviewTitle: 'Preview (Gold/Silver)',
                
                // === INSTRUMENTS ===
                instruments: 'Instruments',
                indices: 'Indices',
                commodities: 'Commodities',
                forex: 'Forex',
                custom: 'Custom',
                active: 'Active',
                inactive: 'Inactive',
                addCustomInstrument: 'Add Custom Instrument',
                noCustomInstruments: 'No custom instruments. Click + to add one.',
                activeLotSizes: 'Active Lot Configuration',
                noActiveInstruments: 'No active calibrated instruments.',
                scaleFactor: 'Scale Factor',
                recommended: 'Recommended',
                lotConfiguration: 'Lot Configuration',
                atBalance: 'at balance',
                globalSetting: 'Global Setting',
                lotStep: 'Lot Steps',
                plFactorCalibration: 'P/L Factor Calibration',
                saveConfiguration: 'Save Configuration',
                deleteInstrument: 'Delete Instrument',
                symbol: 'Symbol',
                priceDecimals: 'Price Decimals',
                standardSize: 'Standard Size',
                saveInstrument: 'Save Instrument',
                symbolNameRequired: 'Symbol and name are required',
                instrumentExists: 'An instrument with this symbol already exists',
                added: 'added',
                deleted: 'deleted',
                
                // === ADDITIONAL MISSING ===
                register: 'Register',
                namePlaceholder: 'Name',
                passwordMinPlaceholder: 'Password (min. 6 characters)',
                loginWithGoogle: 'Sign in with Google',
                continueWithoutLogin: 'continue without login',
                dataStoredLocally: 'Data stored locally (no cloud sync)',
                user: 'User',
                addPositionTitle: 'Add Position',
                calibrationTitle: '🔧 Calibrate Instrument',
                welcomeTitle: 'Welcome to Trading Target Tracker!',
                startDate: 'Start Date',
                equityCurve7: 'Equity Curve (7 Days)',
                streakStats: 'Streak & Statistics',
                positionSave: 'Save Position',
                trades: 'Trades',
                pl: 'P/L',
                stillToReach: 'Still to reach',
                atCurrentRate: 'At current rate',
                tradingDaysRemaining: 'Trading days remaining',
                noActivePositions: 'No active positions',
                toTarget: 'of target',
                
                // === ADDITIONAL DYNAMIC TEXTS ===
                reached: 'Reached',
                surplus: 'Surplus',
                stillOpen: 'Still open',
                tomorrow: 'Tomorrow',
                dailyTargetLabel: 'Daily Target',
                profit: 'Profit',
                loss: 'Loss',
                stillMissing: 'Still missing',
                vsTarget: 'vs. Target',
                atSize: 'at size',
                avgPriceShort: 'Avg. Price',
                perDollar: 'per dollar',
                calcFactor: 'Calculated Factor',
                enterValues: 'Enter values',
                enterNewPrice: 'Enter new price',
                lastCalibration: 'Last Calibration',
                lastPrice: 'Last Price',
                saveFactor: 'Save Factor',
                removePosition: 'Remove Position',
                removeHint: 'Click to remove',
                noBufferActivity: 'No buffer activity yet',
                avgPerWeekday: 'Avg. per weekday',
                loginError: 'Login failed',
                registerError: 'Registration failed',
                loggingIn: 'Logging in...',
                registering: 'Registering...',
                guest: 'Guest',
                totalLabel: 'total',
                themeToggle: 'Toggle theme',
                dataConflictTitle: '📦 Local Data Found',
                dataConflictText: 'This device has',
                whatToDo: 'What would you like to do?',
                uploadLocal: '⬆️ Upload Local',
                loadCloud: '⬇️ Load Cloud',
                phase: 'Phase',
                lockedFeature: 'Coming soon',
                loadCloudDesc: 'Load data from cloud',
                syncNow: 'Sync now',
                offlineModeDesc: 'Offline mode - data stored locally only.',
                enableCloudSync: 'Enable Cloud Sync',
                entrySaved: 'Entry saved',
                months: 'Mon.',
                
                // === MORE MISSING ===
                reached: 'Reached!',
                surplus: 'Surplus',
                stillOpen: 'Still open',
                tomorrow: 'Tomorrow',
                noBufferActivity: 'No buffer activity',
                stillMissing: 'still',
                new: 'New',
                vsTarget: 'vs. Target',
                avgWeekdayPL: 'Avg. per weekday',
                weekdayCount: 'Number of trades',
                started: 'Started',
                currentValue: 'Current',
                plToday: 'P/L today',
                plTotal: 'P/L total',
                remove: 'Remove',
                removePosition: 'Remove position?',
                removeHint: 'Note: If you closed this position, make sure the profit/loss is already recorded in today\'s daily entry.',
                calibrateFactor: 'Calculated factor',
                plPerDollar: 'P/L per $1 movement',
                saveFactor: 'Save Factor',
                enterValues: 'Enter values from IBKR screenshot',
                avgPriceShort: 'Average Price',
                lastPrice: 'Current/Last Price',
                calcFactor: 'Calculated Factor',
                remainingTxt: 'Remaining',
                approxMonths: 'months',
                targetLabel: 'Target',
                lastCalibration: 'Last calibration',
                atSize: 'At',
                perDollar: 'per $1',
                units: 'units',
                calibrated: '✓ Calibrated',
                notCalibrated: 'Not calibrated',
                plFactor: 'Factor',
                enterNewPrice: 'New price:',
                profit: 'Profit',
                loss: 'Loss'
            },
            es: {
                // === GENERAL ===
                appName: 'Trading Target Tracker',
                currency: 'EUR',
                loading: 'Cargando...',
                save: 'Guardar',
                cancel: 'Cancelar',
                delete: 'Eliminar',
                edit: 'Editar',
                close: 'Cerrar',
                yes: 'Sí',
                no: 'No',
                or: 'o',
                of: 'de',
                to: 'hasta',
                from: 'desde',
                total: 'Total',
                later: 'Después',
                help: 'Ayuda',
                update: 'Actualizar',
                install: 'Instalar',
                updateAvailable: '¡Nueva versión disponible!',
                installApp: 'Instalar TargetTrader',
                installAppDesc: 'Acceso rápido desde la pantalla de inicio',
                installIosHint: 'Toca Compartir ⬆ luego "Añadir a inicio"',
                keyboardShortcuts: 'Atajos de teclado',
                targetReached: '¡Objetivo diario alcanzado!',
                scaling: 'Escalado',
                
                // === TABS ===
                tabDashboard: 'Panel',
                tabPositions: 'Posiciones',
                tabEntry: 'Entrada',
                tabPerformance: 'Rendimiento',
                tabInstruments: 'Instrumentos',
                tabHistory: 'Historial',
                tabSettings: 'Ajustes',
                
                // === DASHBOARD ===
                balance: 'Saldo',
                todayPL: 'Hoy P/L',
                weekProgress: 'Semana',
                reserve: 'Reserva',
                todayProgress: 'Progreso de Hoy',
                bufferReserve: 'Reserva / Buffer',
                days: 'Días',
                day: 'Día',
                progress: 'Progreso',
                targetToday: 'Objetivo de Hoy',
                targetTomorrow: 'Objetivo de Mañana',
                realized: 'Realizado',
                unrealized: 'No Realizado',
                remaining: 'Restante',
                weekTarget: 'Objetivo Semanal',
                weekRealized: 'Semana Realizada',
                thisWeekKW: 'Esta Semana (Sem',
                capacity: 'Capacidad',
                maximum: 'Máximo',
                minimum: 'Mínimo',
                current: 'Actual',
                equityCurve7: 'Curva de Capital (7 Días)',
                streakStats: 'Racha y Estadísticas',
                
                // === STATS ===
                currentStreak: 'Racha Actual',
                maxStreak: 'Mejor Racha',
                hitRate: 'Tasa de Éxito',
                targetHit: 'Objetivo Alcanzado',
                targetMissed: 'Objetivo Fallado',
                bestDay: 'Mejor Día',
                worstDay: 'Peor Día',
                tradingDays: 'Días de Trading',
                profitDays: 'Días con Ganancia',
                lossDays: 'Días con Pérdida',
                winRate: 'Tasa de Éxito',
                avgDailyPL: 'P/L Diario Prom.',
                profitLoss: 'Ganancia/Pérdida',
                daysWithTarget: 'Días con Objetivo',
                
                // === POSITIONS ===
                openPositions: 'Posiciones Abiertas',
                noPositions: 'Sin posiciones abiertas',
                closedToday: 'Cerradas Hoy',
                noClosedTrades: 'Sin trades cerrados',
                addClosedTrade: '+ Registrar Trade',
                closedTradeAdded: 'Trade registrado',
                closedTradeRemoved: 'Trade eliminado',
                intradayRealized: 'Intraday realizado',
                addPosition: '+ Añadir Posición',
                instrument: 'Instrumento',
                direction: 'Dirección',
                long: 'Largo',
                short: 'Corto',
                size: 'Tamaño',
                avgPrice: 'Precio Promedio',
                currentPrice: 'Precio Actual',
                positionAdded: 'Posición añadida',
                positionRemoved: 'Posición eliminada',
                positionSave: 'Guardar Posición',
                quickCopy: 'Copia Rápida',
                slTpCalculator: 'Calculadora SL/TP',
                stopLoss: 'Stop-Loss',
                takeProfit: 'Take-Profit',
                pips: 'Pips',
                closePosition: 'Cerrar Posición',
                
                // === ENTRY ===
                dailyEntry: 'Entrada Diaria',
                date: 'Fecha',
                newBalance: 'Nuevo Saldo (€) *',
                realizedPL: 'P/L Realizado (€)',
                unrealizedPL: 'P/L No Realizado (€)',
                numTrades: 'Número de Trades',
                mood: 'Estado de Ánimo',
                moodGreat: 'Excelente',
                moodGood: 'Bueno',
                moodNeutral: 'Neutral',
                moodBad: 'Malo',
                notes: 'Notas',
                notesPlaceholder: 'ej. Ruptura del oro...',
                balancePlaceholder: 'ej. 15365.00',
                saveEntry: 'Guardar Entrada',
                entryRequired: 'Por favor ingrese el saldo',
                entryOverwrite: '¿Sobrescribir entrada?',
                entryDelete: '¿Eliminar entrada?',
                preview: 'Vista Previa',
                targetReachedYes: 'Objetivo alcanzado',
                targetReachedNo: 'Bajo objetivo',
                
                // === PERFORMANCE ===
                thisWeek: 'Esta Semana',
                thisMonth: 'Este Mes',
                statistics: 'Estadísticas',
                projection: 'Proyección de Objetivo',
                equityCurve: 'Curva de Capital (Completa)',
                monthlyOverview: 'Resumen Mensual',
                weekdayAnalysis: 'Análisis por Día',
                remainingDays: 'Días de Trading',
                remainingMonths: 'Meses Aprox.',
                remainingYears: 'Años Aprox.',
                progressToTarget: 'Progreso al Objetivo',
                minData: 'Mínimo 2 días de datos requeridos',
                noData: 'Sin datos aún',
                avgPerWeekday: 'Prom. ganancia/pérdida por día (número de trades)',
                plLast7Days: 'P/L Últimos 7 Días',
                
                // === INSTRUMENTS ===
                metals: 'Metales Preciosos',
                stocks: 'Acciones',
                comingSoon: 'Próximamente',
                calibrated: '✓ Calibrado',
                notCalibrated: 'No calibrado',
                calibrate: 'Calibrar Instrumento',
                calibrateFirst: 'Por favor calibre el instrumento primero',
                calibrationTitle: '🔧 Calibrar Instrumento',
                plFactor: 'Factor P/L',
                
                // === HISTORY ===
                tradingHistory: 'Historial de Trading',
                start: 'Inicio',
                end: 'Fin',
                target: 'Objetivo',
                noEntries: 'Sin entradas aún',
                
                // === SETTINGS ===
                capitalGoals: 'Capital y Objetivos',
                startCapital: 'Capital Inicial (€)',
                currentBalance: 'Saldo Actual (€)',
                targetCapital: 'Capital Objetivo (€)',
                riskManagement: 'Gestión de Riesgo',
                dailyTarget: 'Objetivo Diario (%)',
                riskPerTrade: 'Riesgo/Trade (%)',
                maxDailyLoss: 'Pérdida Máx. Diaria (%)',
                rrRatio: 'Riesgo:Beneficio',
                bufferSystem: 'Sistema de Buffer',
                bufferEnabled: 'Buffer Activado',
                maxBufferDays: 'Máx. Buffer (Días)',
                saveSettings: 'Guardar Ajustes',
                settingsSaved: 'Ajustes guardados',
                
                // === BACKUP ===
                backupRestore: 'Respaldo y Restaurar',
                export: 'Exportar',
                import: 'Importar',
                backupCreated: 'Respaldo creado',
                imported: 'Importado',
                invalidFile: 'Archivo inválido',
                overwriteData: '¿Sobrescribir todos los datos?',
                
                // === PDF ===
                pdfReport: 'Informe PDF',
                pdfDescription: 'Exportar un informe de rendimiento como PDF',
                createPdf: '📄 Crear Informe PDF',
                pdfCreated: 'PDF creado',
                
                // === LANGUAGE ===
                language: 'Idioma',
                
                // === DANGER ZONE ===
                dangerZone: 'Zona de Peligro',
                deleteAll: 'Eliminar Todos los Datos',
                deleteConfirm1: '¿ELIMINAR TODOS LOS DATOS?',
                deleteConfirm2: '¿Está seguro?',
                deleted: 'Eliminado',
                
                // === CLOUD/AUTH ===
                cloudSync: 'Sincronización Cloud',
                cloudConnected: 'Cloud conectado',
                offline: 'Sin conexión',
                offlineMode: 'Modo Sin Conexión',
                login: 'Iniciar Sesión',
                logout: 'Cerrar Sesión',
                loggedOut: 'Sesión cerrada',
                createAccount: 'Crear Cuenta',
                email: 'Correo',
                password: 'Contraseña',
                emailPlaceholder: 'tu@email.com',
                passwordPlaceholder: 'Contraseña',
                orContinueWith: 'O continuar con',
                continueOffline: 'Continuar Sin Conexión',
                confirmEmail: 'Por favor confirma tu email',
                accountCreated: '¡Cuenta creada!',
                loginSuccess: '¡Sesión iniciada!',
                loginFailed: 'Error de inicio de sesión',
                loginSubtitle: 'Inicia sesión para sincronizar en todos los dispositivos',
                useCloud: 'Usar Nube',
                useLocal: 'Usar Local',
                syncToCloud: 'Sincronizar datos a la nube',
                migrateToCloud: 'Migrar a la Nube',
                localData: 'Datos Locales',
                cloudData: 'Datos en la Nube',
                dataConflict: 'Conflicto de Datos',
                entries: 'Entradas',
                
                // === MILESTONES ===
                nextMilestones: 'Próximos Hitos',
                
                // === RECOMMENDATIONS ===
                recommendations: 'Recomendaciones',
                
                // === WEEKDAYS ===
                mon: 'Lun', tue: 'Mar', wed: 'Mié', thu: 'Jue', fri: 'Vie', sat: 'Sáb', sun: 'Dom',
                monday: 'Lunes', tuesday: 'Martes', wednesday: 'Miércoles', thursday: 'Jueves', friday: 'Viernes',
                
                // === MONTHS ===
                jan: 'Ene', feb: 'Feb', mar: 'Mar', apr: 'Abr', may: 'May', jun: 'Jun',
                jul: 'Jul', aug: 'Ago', sep: 'Sep', oct: 'Oct', nov: 'Nov', dec: 'Dic',
                
                // === ONBOARDING ===
                welcome: '¡Bienvenido!',
                setupAccount: 'Configura tu cuenta de trading',
                setupSubtitle: 'Por favor ingresa tus parámetros iniciales:',
                onboardStart: 'Capital Inicial (€)',
                onboardTarget: 'Capital Objetivo (€)',
                onboardDaily: 'Objetivo Diario (%)',
                onboardRecommended: 'Recomendado: 1.0 - 1.5%',
                calculation: 'Cálculo',
                startNow: 'Comenzar',
                day1Target: 'Objetivo Diario (Día 1):',
                daysToGoal: 'Días hasta la meta:',
                
                // === VALIDATION ===
                targetMustBeHigher: 'El capital objetivo debe ser mayor que el inicial',
                weekTargetReached: '¡Objetivo semanal alcanzado!',
                pleaseEnterStartCapital: 'Por favor ingrese el capital inicial',
                pleaseEnterStartDate: 'Por favor ingrese la fecha de inicio',
                fillAllFields: 'Por favor complete todos los campos',
                setupComplete: '¡Configuración completa!',
                migrationSuccess: '¡Datos migrados exitosamente! 🎉',
                migrationError: 'Error de migración',
                
                // === TOOLTIPS - DASHBOARD ===
                tipBalance: 'Tu saldo actual incluyendo todas las posiciones abiertas.',
                tipTodayPL: 'Ganancia o pérdida de hoy de trades cerrados y abiertos.',
                tipWeekProgress: 'Porcentaje del objetivo semanal ya alcanzado.',
                tipReserve: 'Buffer acumulado de ganancias extra - tu colchón de seguridad.',
                tipTodayProgress: 'Muestra cuánto del objetivo diario se ha alcanzado.',
                tipBuffer: 'El buffer acumula ganancias sobre el objetivo como reserva para días de pérdida.',
                tipEquityCurve: 'Visualiza la evolución de tu saldo a lo largo del tiempo.',
                tipStreak: 'Número de días consecutivos donde se alcanzó el objetivo diario.',
                tipWeekGrid: 'Resumen del P/L diario para la semana de trading actual.',
                
                // === TOOLTIPS - STATS ===
                tipCurrentStreak: 'Serie actual de días con objetivo diario alcanzado.',
                tipMaxStreak: 'Tu serie más larga de días exitosos.',
                tipHitRate: 'Porcentaje de días donde alcanzaste tu objetivo diario.',
                tipBestDay: 'Tu día de trading más rentable hasta ahora.',
                tipWorstDay: 'Tu día de mayor pérdida hasta ahora.',
                tipTradingDays: 'Número total de días con actividad de trading.',
                tipWinRate: 'Relación de días rentables a no rentables.',
                tipAvgDailyPL: 'Ganancia/pérdida diaria promedio en todos los días.',
                
                // === TOOLTIPS - POSITIONS ===
                tipOpenPositions: 'Tus operaciones abiertas actualmente. El P/L no realizado cambia con el mercado.',
                tipClosedToday: 'Operaciones cerradas hoy. Estas cuentan para tu ganancia diaria realizada.',
                tipPositionSize: 'Número de unidades (lotes, contratos, onzas).',
                tipAvgPrice: 'Precio promedio de entrada de tu posición.',
                tipCurrentPrice: 'Precio actual del mercado para cálculo de P/L.',
                tipDirection: 'Largo = Compra (ganancia en subidas), Corto = Venta (ganancia en bajadas).',
                tipSL: 'Precio Stop-Loss - venta automática para limitar pérdidas.',
                tipTP: 'Precio Take-Profit - venta automática para asegurar ganancias.',
                
                // === TOOLTIPS - ENTRY ===
                tipRealizedPL: 'Trades ya cerrados - ganancia/pérdida real del día.',
                tipUnrealizedPL: 'Posiciones aún abiertas - pueden cambiar hasta fin del día.',
                tipMood: 'Tu estado de ánimo ayuda a analizar tu rendimiento después.',
                tipNotes: 'Anota observaciones importantes, setups o aprendizajes del día.',
                tipNewBalance: 'El saldo exacto en tu broker al final del día de trading.',
                
                // === TOOLTIPS - SETTINGS ===
                tipStartCapital: 'Tu capital inicial de trading. Base para todos los cálculos.',
                tipCurrentBalance: 'Saldo actual de la cuenta en tu broker.',
                tipTargetCapital: '¡Tu meta financiera. Desafío completado al alcanzarlo!',
                tipDailyTarget: 'Objetivo de ganancia diaria en porcentaje. 1-1.5% es realista.',
                tipRiskPerTrade: 'Riesgo máximo por operación. 1-2% es recomendado por profesionales.',
                tipMaxDailyLoss: 'Límite de stop-trading - deja de operar al alcanzar esta pérdida.',
                tipRRRatio: 'Relación Riesgo-Beneficio. 2:1 significa el doble de ganancia.',
                tipBufferEnabled: 'Activa el sistema de buffer que acumula ganancias extra como reserva.',
                tipMaxBufferDays: 'Número máximo de días que el buffer puede cubrir como reserva.',
                
                // === TOOLTIPS - PERFORMANCE ===
                tipMonthlyChart: 'Muestra la ganancia/pérdida total por mes como gráfico de barras.',
                tipWeekdayAnalysis: 'Analiza en qué días de la semana tradeas mejor/peor.',
                tipProjection: 'Calcula cuánto tiempo hasta alcanzar tu meta al ritmo actual.',
                tipProgressBar: 'Progreso visual hacia alcanzar tu capital objetivo.',
                
                // === LOT SIZING ===
                lotSizing: 'Escalado de Posiciones',
                recommendedLotSize: 'Tamaño de Lote Recomendado',
                tipLotSizing: 'Ajuste automático del tamaño de lote basado en tu saldo. Escala proporcionalmente con el objetivo diario.',
                lotSizingEnabled: 'Escalado Activo',
                tipLotSizingEnabled: 'Activa el escalado automático del tamaño de posición a medida que crece tu cuenta.',
                baseBalance: 'Saldo Base',
                tipBaseBalance: 'El saldo de cuenta con el que normalmente operas tu tamaño base de lote.',
                baseLotSize: 'Lotes Base',
                tipBaseLotSize: 'Tu tamaño de lote estándar en el saldo base (números enteros para oro).',
                basis: 'Base',
                scaling: 'Escalado',
                apply: 'Aplicar',
                lotSizingDisabled: 'Escalado de posiciones desactivado',
                lotSizingHint: 'Los tamaños de lote se configuran por instrumento en la pestaña Instrumentos.',
                lotSizingPreviewTitle: 'Vista previa (Oro/Plata)',
                
                // === INSTRUMENTS ===
                instruments: 'Instrumentos',
                indices: 'Índices',
                commodities: 'Materias Primas',
                forex: 'Forex',
                custom: 'Personalizado',
                active: 'Activo',
                inactive: 'Inactivo',
                addCustomInstrument: 'Añadir Instrumento Personalizado',
                noCustomInstruments: 'Sin instrumentos personalizados. Haz clic en + para añadir uno.',
                activeLotSizes: 'Configuración de Lotes Activos',
                noActiveInstruments: 'Sin instrumentos activos calibrados.',
                scaleFactor: 'Factor de Escala',
                recommended: 'Recomendado',
                lotConfiguration: 'Configuración de Lotes',
                atBalance: 'en saldo',
                globalSetting: 'Configuración Global',
                lotStep: 'Pasos de Lote',
                plFactorCalibration: 'Calibración Factor P/L',
                saveConfiguration: 'Guardar Configuración',
                deleteInstrument: 'Eliminar Instrumento',
                symbol: 'Símbolo',
                priceDecimals: 'Decimales de Precio',
                standardSize: 'Tamaño Estándar',
                saveInstrument: 'Guardar Instrumento',
                symbolNameRequired: 'Símbolo y nombre son requeridos',
                instrumentExists: 'Ya existe un instrumento con este símbolo',
                added: 'añadido',
                deleted: 'eliminado',
                
                // === ADDITIONAL MISSING ===
                register: 'Registrarse',
                namePlaceholder: 'Nombre',
                passwordMinPlaceholder: 'Contraseña (mín. 6 caracteres)',
                loginWithGoogle: 'Iniciar con Google',
                continueWithoutLogin: 'continuar sin iniciar sesión',
                dataStoredLocally: 'Datos guardados localmente (sin sincronización)',
                user: 'Usuario',
                addPositionTitle: 'Añadir Posición',
                calibrationTitle: '🔧 Calibrar Instrumento',
                welcomeTitle: '¡Bienvenido a Trading Target Tracker!',
                startDate: 'Fecha de Inicio',
                equityCurve7: 'Curva de Capital (7 Días)',
                streakStats: 'Racha y Estadísticas',
                positionSave: 'Guardar Posición',
                trades: 'Trades',
                pl: 'P/L',
                stillToReach: 'Aún por alcanzar',
                atCurrentRate: 'Al ritmo actual',
                tradingDaysRemaining: 'Días de trading restantes',
                noActivePositions: 'Sin posiciones activas',
                toTarget: 'del objetivo',
                
                // === ADDITIONAL DYNAMIC TEXTS ===
                reached: 'Alcanzado',
                surplus: 'Excedente',
                stillOpen: 'Aún abierto',
                tomorrow: 'Mañana',
                dailyTargetLabel: 'Objetivo Diario',
                profit: 'Ganancia',
                loss: 'Pérdida',
                stillMissing: 'Aún faltante',
                vsTarget: 'vs. Objetivo',
                atSize: 'en tamaño',
                avgPriceShort: 'Precio Prom.',
                perDollar: 'por dólar',
                calcFactor: 'Factor Calculado',
                enterValues: 'Ingresar valores',
                enterNewPrice: 'Ingresar nuevo precio',
                lastCalibration: 'Última Calibración',
                lastPrice: 'Último Precio',
                saveFactor: 'Guardar Factor',
                removePosition: 'Eliminar Posición',
                removeHint: 'Clic para eliminar',
                noBufferActivity: 'Sin actividad de buffer aún',
                avgPerWeekday: 'Prom. por día',
                loginError: 'Error de inicio de sesión',
                registerError: 'Error de registro',
                loggingIn: 'Iniciando sesión...',
                registering: 'Registrando...',
                guest: 'Invitado',
                totalLabel: 'total',
                themeToggle: 'Cambiar tema',
                dataConflictTitle: '📦 Datos Locales Encontrados',
                dataConflictText: 'Este dispositivo tiene',
                whatToDo: '¿Qué deseas hacer?',
                uploadLocal: '⬆️ Subir Locales',
                loadCloud: '⬇️ Cargar Nube',
                phase: 'Fase',
                lockedFeature: 'Próximamente',
                loadCloudDesc: 'Cargar datos de la nube',
                syncNow: 'Sincronizar ahora',
                offlineModeDesc: 'Modo sin conexión - datos guardados localmente.',
                enableCloudSync: 'Activar sincronización',
                entrySaved: 'Entrada guardada',
                months: 'Meses',
                
                // === MORE MISSING ===
                reached: '¡Alcanzado!',
                surplus: 'Excedente',
                stillOpen: 'Aún abierto',
                tomorrow: 'Mañana',
                noBufferActivity: 'Sin actividad de buffer',
                stillMissing: 'faltan',
                new: 'Nuevo',
                vsTarget: 'vs. Objetivo',
                avgWeekdayPL: 'Prom. por día',
                weekdayCount: 'Número de trades',
                started: 'Iniciado',
                currentValue: 'Actual',
                plToday: 'P/L hoy',
                plTotal: 'P/L total',
                remove: 'Eliminar',
                removePosition: '¿Eliminar posición?',
                removeHint: 'Nota: Si cerraste esta posición, asegúrate de que la ganancia/pérdida ya esté registrada en la entrada diaria de hoy.',
                calibrateFactor: 'Factor calculado',
                plPerDollar: 'P/L por movimiento de $1',
                saveFactor: 'Guardar Factor',
                enterValues: 'Ingresa valores del screenshot de IBKR',
                avgPriceShort: 'Precio Promedio',
                lastPrice: 'Precio Actual/Último',
                calcFactor: 'Factor Calculado',
                remainingTxt: 'Restante',
                approxMonths: 'meses',
                targetLabel: 'Objetivo',
                lastCalibration: 'Última calibración',
                atSize: 'Con',
                perDollar: 'por $1',
                units: 'unidades',
                calibrated: '✓ Calibrado',
                notCalibrated: 'No calibrado',
                plFactor: 'Factor',
                enterNewPrice: 'Nuevo precio:',
                profit: 'Ganancia',
                loss: 'Pérdida'
            }
        };
        
        let currentLang = localStorage.getItem('trading-tracker-lang') || 'de';
        function t(key) { return LANG[currentLang]?.[key] || LANG.de[key] || key; }
        function tt(key) { return t('tip' + key.charAt(0).toUpperCase() + key.slice(1)); }
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('trading-tracker-lang', lang);
            render();
            renderTabs();
            updateTooltips();
        }
        
        function updateTooltips() {
            document.querySelectorAll('[data-tip]').forEach(el => {
                const key = el.getAttribute('data-tip');
                el.setAttribute('data-tooltip', tt(key));
            });
        }
        
        const INSTRUMENT_LIBRARY = {
            metals: [
                { id: 'xauusd', symbol: 'XAUUSD', name: 'Gold', icon: 'gold', color: '#fbbf24', priceDecimals: 2, calculationType: 'factor', standardSize: 5, lotStep: 1, defaultBaseLots: 1 },
                { id: 'xagusd', symbol: 'XAGUSD', name: 'Silber', icon: 'silver', color: '#9ca3af', priceDecimals: 4, calculationType: 'factor', standardSize: 50, lotStep: 10, defaultBaseLots: 50 },
                { id: 'xptusd', symbol: 'XPTUSD', name: 'Platin', icon: 'platinum', color: '#e5e7eb', priceDecimals: 2, calculationType: 'factor', standardSize: 5, lotStep: 1, defaultBaseLots: 1 },
                { id: 'xpdusd', symbol: 'XPDUSD', name: 'Palladium', icon: 'palladium', color: '#6b7280', priceDecimals: 2, calculationType: 'factor', standardSize: 1, lotStep: 1, defaultBaseLots: 1 }
            ],
            indices: [
                { id: 'us500', symbol: 'US500', name: 'S&P 500', icon: 'index', color: '#3b82f6', priceDecimals: 2, calculationType: 'factor', standardSize: 1, lotStep: 1, defaultBaseLots: 1 },
                { id: 'us100', symbol: 'US100', name: 'NASDAQ 100', icon: 'index', color: '#8b5cf6', priceDecimals: 2, calculationType: 'factor', standardSize: 1, lotStep: 1, defaultBaseLots: 1 },
                { id: 'ger40', symbol: 'GER40', name: 'DAX 40', icon: 'index', color: '#ef4444', priceDecimals: 2, calculationType: 'factor', standardSize: 1, lotStep: 1, defaultBaseLots: 1 },
                { id: 'us30', symbol: 'US30', name: 'Dow Jones', icon: 'index', color: '#f59e0b', priceDecimals: 2, calculationType: 'factor', standardSize: 1, lotStep: 1, defaultBaseLots: 1 }
            ],
            commodities: [
                { id: 'wti', symbol: 'USOIL', name: 'WTI Crude Oil', icon: 'oil', color: '#1f2937', priceDecimals: 2, calculationType: 'factor', standardSize: 100, lotStep: 10, defaultBaseLots: 10 },
                { id: 'brent', symbol: 'UKOIL', name: 'Brent Crude', icon: 'oil', color: '#374151', priceDecimals: 2, calculationType: 'factor', standardSize: 100, lotStep: 10, defaultBaseLots: 10 },
                { id: 'natgas', symbol: 'NATGAS', name: 'Natural Gas', icon: 'gas', color: '#06b6d4', priceDecimals: 3, calculationType: 'factor', standardSize: 1000, lotStep: 100, defaultBaseLots: 100 }
            ],
            forex: [
                { id: 'eurusd', symbol: 'EURUSD', name: 'EUR/USD', icon: 'forex', color: '#2563eb', priceDecimals: 5, calculationType: 'pips', pipValue: 10, lotStep: 0.1, defaultBaseLots: 0.5 },
                { id: 'gbpusd', symbol: 'GBPUSD', name: 'GBP/USD', icon: 'forex', color: '#dc2626', priceDecimals: 5, calculationType: 'pips', pipValue: 10, lotStep: 0.1, defaultBaseLots: 0.5 },
                { id: 'usdjpy', symbol: 'USDJPY', name: 'USD/JPY', icon: 'forex', color: '#ea580c', priceDecimals: 3, calculationType: 'pips', pipValue: 9.1, lotStep: 0.1, defaultBaseLots: 0.5 }
            ],
            stocks: [
                { id: 'aapl', symbol: 'AAPL', name: 'Apple', icon: 'stock', color: '#6b7280', priceDecimals: 2, calculationType: 'shares', lotStep: 1, defaultBaseLots: 10 },
                { id: 'tsla', symbol: 'TSLA', name: 'Tesla', icon: 'stock', color: '#ef4444', priceDecimals: 2, calculationType: 'shares', lotStep: 1, defaultBaseLots: 5 },
                { id: 'nvda', symbol: 'NVDA', name: 'NVIDIA', icon: 'stock', color: '#22c55e', priceDecimals: 2, calculationType: 'shares', lotStep: 1, defaultBaseLots: 5 },
                { id: 'msft', symbol: 'MSFT', name: 'Microsoft', icon: 'stock', color: '#0ea5e9', priceDecimals: 2, calculationType: 'shares', lotStep: 1, defaultBaseLots: 5 }
            ]
        };
        const DEFAULT_DATA = {
            version: VERSION,
            settings: { 
                accountCurrency: 'EUR', 
                broker: 'IBKR', 
                startCapital: 0, 
                currentBalance: 0, 
                targetCapital: 0, 
                dailyTargetPercent: 0.5, 
                riskPerTradePercent: 2.0, 
                maxDailyLossPercent: 3.0, 
                rrRatio: 2, 
                tradingDaysPerWeek: 5, 
                weekStartDay: 1,
                startDate: null,
                onboardingComplete: false,
                // Lot Sizing
                baseLotSize: 1,
                baseBalanceForLots: 15000,
                lotSizingEnabled: true
            },
            instruments: {},
            positions: [],
            dailyLogs: [],
            intradayClosedTrades: [], // {id, instrumentId, pl, note, closedAt, date}
            buffer: { currentBuffer: 0, history: [], settings: { enabled: true, autoUse: true, maxBufferDays: 10 } },
            dismissedRecommendations: []
        };
        let data = JSON.parse(JSON.stringify(DEFAULT_DATA));
        let currentUser = null;
        let isOnline = navigator.onLine;
        let localDataBeforeLogin = null; // Speichert lokale Daten vor Login

        // ============================================================
        // INIT
        // ============================================================
        async function init() {
            loadTheme();
            const { data: { session } } = await db.auth.getSession();
            if (session) {
                currentUser = session.user;
                await loadUserData();
                cleanupOldIntradayTrades();
                showMainApp();
            } else {
                const offline = localStorage.getItem('trading-tracker-offline-mode');
                if (offline === 'true') { loadLocalData(); cleanupOldIntradayTrades(); showMainApp(); }
                else { showAuthScreen(); }
            }
            db.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session) { 
                    currentUser = session.user;
                    updateUserBadge();
                    // Prüfe ob Cloud bereits Daten hat
                    const cloudHasData = await checkCloudHasData();
                    // Prüfe ob lokale Daten vorhanden
                    const localData = getLocalDataForMigration();
                    
                    if (localData.hasData) {
                        // Lokale Daten gefunden
                        localDataBeforeLogin = localData;
                        localDataBeforeLogin.cloudHasData = cloudHasData;
                        showMigrationModal(localData, cloudHasData);
                    } else {
                        // Keine lokalen Daten → einfach Cloud laden
                        await loadUserData(); 
                        showMainApp();
                    }
                }
                else if (event === 'SIGNED_OUT') { currentUser = null; showAuthScreen(); }
            });
            window.addEventListener('online', () => { isOnline = true; updateSyncStatus(); if (currentUser) syncToCloud(); });
            window.addEventListener('offline', () => { isOnline = false; updateSyncStatus(); });
        }
        
        async function checkCloudHasData() {
            if (!currentUser) return false;
            try {
                // Prüfe ob daily_logs oder instruments existieren
                const { data: logs } = await db.from('daily_logs').select('id').eq('user_id', currentUser.id).limit(1);
                const { data: instruments } = await db.from('instruments').select('id').eq('user_id', currentUser.id).limit(1);
                return (logs && logs.length > 0) || (instruments && instruments.length > 0);
            } catch (e) {
                console.error('Check cloud error:', e);
                return false;
            }
        }
        
        function getLocalDataForMigration() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return { hasData: false };
                const parsed = JSON.parse(saved);
                const calibratedInstruments = Object.values(parsed.instruments || {}).filter(i => i.isCalibrated);
                const positions = parsed.positions || [];
                const dailyLogs = parsed.dailyLogs || [];
                const hasData = calibratedInstruments.length > 0 || positions.length > 0 || dailyLogs.length > 0;
                return {
                    hasData,
                    data: parsed,
                    summary: {
                        instruments: calibratedInstruments.length,
                        positions: positions.length,
                        dailyLogs: dailyLogs.length,
                        buffer: parsed.buffer?.currentBuffer || 0
                    }
                };
            } catch (e) { return { hasData: false }; }
        }
        
        function showMigrationModal(localData, cloudHasData) {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('auth-screen').classList.add('hidden');
            
            const cloudHint = cloudHasData 
                ? `<div class="card card-blue mb-3" style="padding:10px;"><p style="font-size:0.85rem;margin:0;">${ic('cloud',16)} <strong>Die Cloud hat bereits Daten!</strong><br><span style="font-size:0.8rem;color:var(--muted);">Wenn du auf einem anderen Gerät schon Daten eingegeben hast, klicke "Cloud laden".</span></p></div>`
                : `<div class="card card-dark mb-3" style="padding:10px;"><p style="font-size:0.85rem;margin:0;color:var(--muted);">${ic('cloud',16)} Die Cloud ist leer. Klicke "Lokale hochladen" um diese Daten zu synchronisieren.</p></div>`;
            
            document.getElementById('migration-summary').innerHTML = `
                <div style="font-size:0.9rem;">
                    <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);"><span>${ic('instr',16)} Kalibrierte Instrumente:</span><strong>${localData.summary.instruments}</strong></div>
                    <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);"><span>${ic('positions',16)} Offene Positionen:</span><strong>${localData.summary.positions}</strong></div>
                    <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);"><span>${ic('history',16)} Tageseinträge:</span><strong>${localData.summary.dailyLogs}</strong></div>
                    <div style="display:flex;justify-content:space-between;padding:6px 0;"><span>${ic('buffer',16,'#fbbf24')} Buffer:</span><strong>${fmt(localData.summary.buffer)}</strong></div>
                </div>
                ${cloudHint}
            `;
            openModal('migration-modal');
        }
        
        async function migrateLocalData() {
            if (!localDataBeforeLogin || !currentUser) return;
            
            closeModal('migration-modal');
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('loading-screen').querySelector('p').textContent = 'Migriere Daten...';
            
            try {
                const localData = localDataBeforeLogin.data;
                console.log('Starting migration with:', localData);
                
                // 1. Profile/Settings migrieren (inkl. Buffer)
                console.log('Migrating buffer:', localData.buffer?.currentBuffer);
                const { error: profileError } = await db.from('profiles').update({
                    start_capital: localData.settings?.startCapital,
                    current_balance: localData.settings?.currentBalance,
                    target_capital: localData.settings?.targetCapital,
                    daily_target_percent: localData.settings?.dailyTargetPercent,
                    risk_per_trade_percent: localData.settings?.riskPerTradePercent,
                    max_daily_loss_percent: localData.settings?.maxDailyLossPercent,
                    rr_ratio: localData.settings?.rrRatio,
                    trading_days_per_week: localData.settings?.tradingDaysPerWeek,
                    buffer_enabled: localData.buffer?.settings?.enabled,
                    buffer_max_days: localData.buffer?.settings?.maxBufferDays,
                    buffer_current: localData.buffer?.currentBuffer || 0,
                    start_date: localData.settings?.startDate,
                    onboarding_complete: localData.settings?.onboardingComplete
                }).eq('id', currentUser.id);
                if (profileError) console.error('Profile error:', profileError);
                
                // 2. Instrumente migrieren
                for (const [id, inst] of Object.entries(localData.instruments || {})) {
                    if (inst.isCalibrated && inst.plFactor) {
                        console.log('Migrating instrument:', inst.symbol, inst.plFactor);
                        // Erst löschen falls vorhanden, dann neu einfügen
                        await db.from('instruments').delete().eq('user_id', currentUser.id).eq('symbol', inst.symbol);
                        const { error } = await db.from('instruments').insert({
                            user_id: currentUser.id,
                            symbol: inst.symbol,
                            name: inst.name,
                            asset_class: 'metal',
                            icon: inst.icon,
                            color: inst.color,
                            price_decimals: inst.priceDecimals,
                            calculation_type: inst.calculationType,
                            pl_factor: inst.plFactor,
                            standard_size: inst.standardSize,
                            is_calibrated: true,
                            last_calibrated: inst.lastCalibrated,
                            calibration_data: inst.calibrationData
                        });
                        if (error) console.error('Instrument insert error:', error);
                    }
                }
                
                // 3. Daily Logs migrieren
                console.log('Migrating daily logs:', localData.dailyLogs?.length);
                for (const log of (localData.dailyLogs || [])) {
                    const { error } = await db.from('daily_logs').upsert({
                        user_id: currentUser.id,
                        date: log.date,
                        starting_balance: log.startingBalance,
                        ending_balance: log.endingBalance,
                        realized_pl: log.realizedPL,
                        unrealized_pl: log.unrealizedPL,
                        daily_target: log.dailyTarget,
                        variance: log.variance,
                        variance_percent: log.variancePercent,
                        days_equivalent: log.daysEquivalent,
                        target_hit: log.targetHit,
                        trades_count: log.tradesCount,
                        mood: log.mood,
                        notes: log.notes
                    }, { onConflict: 'user_id,date' });
                    if (error) console.error('Daily log error:', error);
                }
                
                // 4. Positionen migrieren
                console.log('Migrating positions:', localData.positions?.length);
                for (const pos of (localData.positions || [])) {
                    const inst = localData.instruments?.[pos.instrumentId];
                    const { error } = await db.from('positions').insert({
                        user_id: currentUser.id,
                        instrument_symbol: inst?.symbol || pos.instrumentId?.toUpperCase() || 'UNKNOWN',
                        size: pos.size,
                        avg_price: pos.avgPrice,
                        current_price: pos.currentPrice || pos.avgPrice,
                        direction: pos.direction || 'long',
                        is_active: pos.active !== false,
                        open_date: pos.openDate
                    });
                    if (error) console.error('Position insert error:', error);
                }
                
                // Lokale Daten übernehmen
                data = deepMerge(DEFAULT_DATA, localData);
                localStorage.removeItem('trading-tracker-offline-mode');
                
                showMainApp();
                showToast('Daten erfolgreich migriert! 🎉');
                
            } catch (e) {
                console.error('Migration error:', e);
                showToast('Fehler bei Migration', 'error');
                await loadUserData();
                showMainApp();
            }
            
            localDataBeforeLogin = null;
        }
        
        function skipMigration() {
            closeModal('migration-modal');
            localDataBeforeLogin = null;
            // Lokale Daten löschen damit beim nächsten Login kein Dialog mehr kommt
            localStorage.removeItem(STORAGE_KEY);
            data = JSON.parse(JSON.stringify(DEFAULT_DATA));
            loadUserData().then(() => showMainApp());
            showToast('Lokale Daten gelöscht - Cloud wird geladen', 'info');
        }
        
        function showAuthScreen() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }
        function showMainApp() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            initializeInstruments();
            updateSyncStatus();
            updateUserBadge();
            render();
            document.getElementById('entry-date').valueAsDate = new Date();
            
            // Prüfe ob Onboarding nötig
            if (!data.settings.onboardingComplete && data.settings.startCapital === 0) {
                showOnboarding();
            }
        }
        
        function showOnboarding() {
            document.getElementById('onboard-start-date').valueAsDate = new Date();
            
            // Live-Berechnung bei Eingabe
            ['onboard-start-capital', 'onboard-target-capital', 'onboard-daily-target'].forEach(id => {
                document.getElementById(id)?.addEventListener('input', updateOnboardingPreview);
            });
            
            openModal('onboarding-modal');
        }
        
        function updateOnboardingPreview() {
            const startCapital = parseFloat(document.getElementById('onboard-start-capital').value) || 0;
            const targetCapital = parseFloat(document.getElementById('onboard-target-capital').value) || 0;
            const dailyTargetPct = parseFloat(document.getElementById('onboard-daily-target').value) || 1;
            
            const preview = document.getElementById('onboard-preview');
            const calc = document.getElementById('onboard-calc');
            
            if (startCapital > 0 && targetCapital > startCapital && dailyTargetPct > 0) {
                const dailyTarget = startCapital * (dailyTargetPct / 100);
                const toGo = targetCapital - startCapital;
                const tradingDays = Math.ceil(Math.log(targetCapital / startCapital) / Math.log(1 + dailyTargetPct / 100));
                const months = (tradingDays / 21).toFixed(1);
                const years = (tradingDays / 252).toFixed(1);
                
                preview.style.display = 'block';
                calc.innerHTML = `
                    <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);">
                        <span>Tagesziel (Tag 1):</span>
                        <strong class="text-green">${fmt(dailyTarget)}</strong>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);">
                        <span>Noch zu erreichen:</span>
                        <strong>${fmt(toGo)}</strong>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);">
                        <span>Geschätzte Handelstage:</span>
                        <strong>${tradingDays}</strong>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:6px 0;">
                        <span>Geschätzte Dauer:</span>
                        <strong>${months} Monate (${years} Jahre)</strong>
                    </div>
                `;
            } else {
                preview.style.display = 'none';
            }
        }
        
        async function completeOnboarding() {
            const startCapital = parseFloat(document.getElementById('onboard-start-capital').value);
            const targetCapital = parseFloat(document.getElementById('onboard-target-capital').value);
            const startDate = document.getElementById('onboard-start-date').value;
            const dailyTargetPct = parseFloat(document.getElementById('onboard-daily-target').value);
            
            if (!startCapital || startCapital <= 0) {
                showToast('Bitte Anfangskapital eingeben', 'error');
                return;
            }
            if (!targetCapital || targetCapital <= startCapital) {
                showToast('Zielkapital muss größer als Anfangskapital sein', 'error');
                return;
            }
            if (!startDate) {
                showToast('Bitte Startdatum eingeben', 'error');
                return;
            }
            
            data.settings.startCapital = startCapital;
            data.settings.currentBalance = startCapital;
            data.settings.targetCapital = targetCapital;
            data.settings.startDate = startDate;
            data.settings.dailyTargetPercent = dailyTargetPct || 0.5;
            data.settings.onboardingComplete = true;
            
            saveData();
            closeModal('onboarding-modal');
            render();
            showToast('Setup abgeschlossen!');
        }

        // ============================================================
        // AUTH
        // ============================================================
        function showAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach((t,i) => t.classList.toggle('active', (tab==='login'?i===0:i===1)));
            document.getElementById('login-form').classList.toggle('hidden', tab !== 'login');
            document.getElementById('register-form').classList.toggle('hidden', tab !== 'register');
        }
        async function loginWithEmail() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            const btn = document.getElementById('login-btn');
            if (!email || !password) { errorEl.textContent = 'Bitte Email und Passwort eingeben'; errorEl.classList.remove('hidden'); return; }
            btn.disabled = true; btn.textContent = 'Anmelden...'; errorEl.classList.add('hidden');
            try {
                const { error } = await db.auth.signInWithPassword({ email, password });
                if (error) throw error;
                localStorage.removeItem('trading-tracker-offline-mode');
                showToast('Erfolgreich angemeldet!');
            } catch (error) {
                errorEl.textContent = error.message === 'Invalid login credentials' ? 'Ungültige Email oder Passwort' : error.message;
                errorEl.classList.remove('hidden');
            } finally { btn.disabled = false; btn.textContent = 'Anmelden'; }
        }
        async function registerWithEmail() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const errorEl = document.getElementById('register-error');
            const btn = document.getElementById('register-btn');
            if (!email || !password) { errorEl.textContent = 'Bitte alle Felder ausfüllen'; errorEl.classList.remove('hidden'); return; }
            if (password.length < 6) { errorEl.textContent = 'Passwort muss min. 6 Zeichen haben'; errorEl.classList.remove('hidden'); return; }
            btn.disabled = true; btn.textContent = 'Erstellen...'; errorEl.classList.add('hidden');
            try {
                const { data: d, error } = await db.auth.signUp({ email, password, options: { data: { full_name: name || email.split('@')[0] } } });
                if (error) throw error;
                localStorage.removeItem('trading-tracker-offline-mode');
                if (d.user && !d.session) showToast('Bitte bestätige deine Email', 'info');
                else showToast('Konto erstellt!');
            } catch (error) { errorEl.textContent = error.message; errorEl.classList.remove('hidden'); }
            finally { btn.disabled = false; btn.textContent = 'Konto erstellen'; }
        }
        async function loginWithGoogle() {
            try { await db.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.origin } }); }
            catch (e) { showToast('Google-Login fehlgeschlagen', 'error'); }
        }
        function continueOffline() { localStorage.setItem('trading-tracker-offline-mode', 'true'); loadLocalData(); showMainApp(); showToast('Offline-Modus', 'info'); }
        async function logout() { await db.auth.signOut(); localStorage.removeItem('trading-tracker-offline-mode'); currentUser = null; data = JSON.parse(JSON.stringify(DEFAULT_DATA)); closeModal('user-modal'); showToast('Abgemeldet'); }

        // ============================================================
        // DATA SYNC
        // ============================================================
        async function loadUserData() {
            if (!currentUser) { loadLocalData(); return; }
            try {
                // Profile laden - wird automatisch vom Trigger erstellt
                const { data: profiles, error: profileError } = await db.from('profiles').select('*').eq('id', currentUser.id);
                const profile = profiles && profiles.length > 0 ? profiles[0] : null;
                
                if (profile) {
                    data.settings = { 
                        accountCurrency: profile.account_currency||'EUR', 
                        broker: profile.broker||'IBKR', 
                        startCapital: parseFloat(profile.start_capital)||0, 
                        currentBalance: parseFloat(profile.current_balance)||0, 
                        targetCapital: parseFloat(profile.target_capital)||0, 
                        dailyTargetPercent: parseFloat(profile.daily_target_percent)||0.5, 
                        riskPerTradePercent: parseFloat(profile.risk_per_trade_percent)||2.0, 
                        maxDailyLossPercent: parseFloat(profile.max_daily_loss_percent)||3.0, 
                        rrRatio: parseFloat(profile.rr_ratio)||2, 
                        tradingDaysPerWeek: profile.trading_days_per_week||5, 
                        weekStartDay: 1, 
                        startDate: profile.start_date, 
                        onboardingComplete: profile.onboarding_complete || false,
                        lotSizingEnabled: profile.lot_sizing_enabled !== false,
                        baseBalanceForLots: parseFloat(profile.base_balance_for_lots) || 15000
                    };
                    data.buffer.settings.enabled = profile.buffer_enabled !== false;
                    data.buffer.settings.maxBufferDays = profile.buffer_max_days || 10;
                    data.buffer.currentBuffer = parseFloat(profile.buffer_current) || 0;
                }
                // Kein INSERT hier - Trigger erstellt das Profil automatisch
                
                const { data: instruments } = await db.from('instruments').select('*').eq('user_id', currentUser.id);
                if (instruments) instruments.forEach(i => { data.instruments[i.symbol.toLowerCase()] = { id: i.symbol.toLowerCase(), symbol: i.symbol, name: i.name, icon: i.icon, color: i.color, priceDecimals: i.price_decimals, calculationType: i.calculation_type, plFactor: i.pl_factor ? parseFloat(i.pl_factor) : null, standardSize: parseFloat(i.standard_size)||1, lotStep: parseFloat(i.lot_step)||1, baseLotSize: parseFloat(i.base_lot_size)||1, isCalibrated: i.is_calibrated, isActive: i.is_active !== false, lastCalibrated: i.last_calibrated, calibrationData: i.calibration_data }; });
                
                const { data: logs } = await db.from('daily_logs').select('*').eq('user_id', currentUser.id).order('date', { ascending: false }).limit(100);
                if (logs) data.dailyLogs = logs.map(l => ({ id: l.id, date: l.date, startingBalance: parseFloat(l.starting_balance)||0, endingBalance: parseFloat(l.ending_balance)||0, realizedPL: parseFloat(l.realized_pl)||0, unrealizedPL: parseFloat(l.unrealized_pl)||0, dailyTarget: parseFloat(l.daily_target)||0, variance: parseFloat(l.variance)||0, variancePercent: parseFloat(l.variance_percent)||0, daysEquivalent: parseFloat(l.days_equivalent)||0, targetHit: l.target_hit, tradesCount: l.trades_count||0, mood: l.mood, notes: l.notes }));
                
                const { data: positions } = await db.from('positions').select('*').eq('user_id', currentUser.id).eq('is_active', true);
                if (positions) data.positions = positions.map(p => ({ id: p.id, instrumentId: p.instrument_symbol?.toLowerCase(), size: parseFloat(p.size), avgPrice: parseFloat(p.avg_price), currentPrice: parseFloat(p.current_price)||parseFloat(p.avg_price), direction: p.direction, active: p.is_active, openDate: p.open_date }));
                
                // Load intraday closed trades (only today's)
                const today = getLocalDateString(new Date());
                const { data: closedTrades } = await db.from('intraday_closed_trades').select('*').eq('user_id', currentUser.id).eq('date', today);
                if (closedTrades) data.intradayClosedTrades = closedTrades.map(t => ({ id: t.id, instrumentId: t.instrument_id, pl: parseFloat(t.pl)||0, note: t.note||'', date: t.date, closedAt: t.closed_at }));
                
                saveLocalData();
            } catch (e) { console.error('Load error:', e); loadLocalData(); showToast('Cloud-Daten nicht geladen', 'warning'); }
        }
        async function syncToCloud() {
            if (!currentUser || !isOnline) return;
            updateSyncStatus('syncing');
            try {
                const { error: profileError } = await db.from('profiles').update({ 
                    email: currentUser.email, 
                    account_currency: data.settings.accountCurrency, 
                    broker: data.settings.broker, 
                    start_capital: data.settings.startCapital, 
                    current_balance: data.settings.currentBalance, 
                    target_capital: data.settings.targetCapital, 
                    daily_target_percent: data.settings.dailyTargetPercent, 
                    risk_per_trade_percent: data.settings.riskPerTradePercent, 
                    max_daily_loss_percent: data.settings.maxDailyLossPercent, 
                    rr_ratio: data.settings.rrRatio, 
                    trading_days_per_week: data.settings.tradingDaysPerWeek, 
                    buffer_enabled: data.buffer.settings.enabled, 
                    buffer_max_days: data.buffer.settings.maxBufferDays, 
                    buffer_current: data.buffer.currentBuffer, 
                    start_date: data.settings.startDate, 
                    onboarding_complete: data.settings.onboardingComplete,
                    lot_sizing_enabled: data.settings.lotSizingEnabled,
                    base_balance_for_lots: data.settings.baseBalanceForLots
                }).eq('id', currentUser.id);
                if (profileError) console.error('Profile sync error:', profileError);
                for (const [id, inst] of Object.entries(data.instruments)) {
                    if (inst.isCalibrated || inst.baseLotSize) await db.from('instruments').upsert({ user_id: currentUser.id, symbol: inst.symbol, name: inst.name, asset_class: 'metal', icon: inst.icon, color: inst.color, price_decimals: inst.priceDecimals, calculation_type: inst.calculationType, pl_factor: inst.plFactor, standard_size: inst.standardSize, lot_step: inst.lotStep, base_lot_size: inst.baseLotSize, is_calibrated: inst.isCalibrated, last_calibrated: inst.lastCalibrated, calibration_data: inst.calibrationData, is_active: inst.isActive }, { onConflict: 'user_id,symbol' });
                }
                updateSyncStatus('online');
            } catch (e) { console.error('Sync error:', e); updateSyncStatus('offline'); }
        }
        async function syncDailyLog(log) {
            if (!currentUser || !isOnline) return;
            try { await db.from('daily_logs').upsert({ user_id: currentUser.id, date: log.date, starting_balance: log.startingBalance, ending_balance: log.endingBalance, realized_pl: log.realizedPL, unrealized_pl: log.unrealizedPL, daily_target: log.dailyTarget, variance: log.variance, variance_percent: log.variancePercent, days_equivalent: log.daysEquivalent, target_hit: log.targetHit, trades_count: log.tradesCount, mood: log.mood, notes: log.notes }, { onConflict: 'user_id,date' }); } catch (e) { console.error(e); }
        }
        async function syncPosition(pos, action = 'upsert') {
            if (!currentUser || !isOnline) return;
            console.log('syncPosition called:', action, pos.id);
            try {
                if (action === 'delete') {
                    await db.from('positions').delete().eq('id', pos.id);
                } else {
                    const posData = { 
                        id: pos.id, 
                        user_id: currentUser.id, 
                        instrument_symbol: data.instruments[pos.instrumentId]?.symbol || pos.instrumentId?.toUpperCase(), 
                        size: pos.size, 
                        avg_price: pos.avgPrice, 
                        current_price: pos.currentPrice, 
                        direction: pos.direction || 'long', 
                        is_active: pos.active !== false, 
                        open_date: pos.openDate 
                    };
                    console.log('Position data to insert:', posData);
                    // Erst löschen, dann neu einfügen (vermeidet Duplikate)
                    console.log('Deleting position:', pos.id);
                    await db.from('positions').delete().eq('id', pos.id);
                    console.log('Inserting position...');
                    const { data: insertedData, error } = await db.from('positions').insert(posData).select();
                    if (error) {
                        console.error('Position INSERT error:', error);
                    } else {
                        console.log('Position inserted successfully:', insertedData);
                    }
                }
            } catch (e) { console.error('Position sync error:', e); }
        }
        
        async function syncBuffer() {
            if (!currentUser || !isOnline) return;
            try {
                await db.from('profiles').update({ 
                    buffer_current: data.buffer.currentBuffer 
                }).eq('id', currentUser.id);
            } catch (e) { console.error('Buffer sync error:', e); }
        }
        
        async function syncClosedTrade(trade, action = 'upsert') {
            if (!currentUser || !isOnline) return;
            try {
                if (action === 'delete') {
                    await db.from('intraday_closed_trades').delete().eq('id', trade.id);
                } else {
                    const tradeData = {
                        id: trade.id,
                        user_id: currentUser.id,
                        instrument_id: trade.instrumentId || null,
                        pl: trade.pl,
                        note: trade.note || '',
                        date: trade.date,
                        closed_at: trade.closedAt
                    };
                    await db.from('intraday_closed_trades').delete().eq('id', trade.id);
                    await db.from('intraday_closed_trades').insert(tradeData);
                }
            } catch (e) { console.error('Closed trade sync error:', e); }
        }
        
        async function syncBufferHistory(entry) {
            if (!currentUser || !isOnline) return;
            try {
                const { error } = await db.from('buffer_history').insert({
                    user_id: currentUser.id,
                    date: entry.date,
                    type: entry.type,
                    amount: entry.amount,
                    reason: entry.reason,
                    balance_after: entry.balanceAfter
                });
                if (error) console.error('Buffer history sync error:', error);
            } catch (e) { console.error('Buffer history sync error:', e); }
        }
        function updateSyncStatus(status) {
            const dot = document.getElementById('sync-dot');
            const text = document.getElementById('sync-status-text');
            if (!dot) return;
            dot.className = 'sync-dot';
            if (!currentUser) { dot.classList.add('offline'); text.textContent = 'Offline-Modus'; }
            else if (status === 'syncing') { dot.classList.add('syncing'); text.textContent = 'Synchronisiere...'; }
            else if (isOnline) { dot.classList.add('online'); text.textContent = 'Cloud verbunden'; }
            else { dot.classList.add('offline'); text.textContent = 'Offline'; }
        }
        function updateUserBadge() {
            const avatar = document.getElementById('user-avatar');
            const name = document.getElementById('user-name');
            if (currentUser) { const n = currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || 'User'; avatar.textContent = n.charAt(0).toUpperCase(); name.textContent = n; }
            else { avatar.textContent = '?'; name.textContent = 'Gast'; }
        }

        // ============================================================
        // LOCAL STORAGE
        // ============================================================
        function loadLocalData() { try { const s = localStorage.getItem(STORAGE_KEY); if (s) data = deepMerge(DEFAULT_DATA, JSON.parse(s)); } catch (e) { console.error(e); } }
        function saveLocalData() { try { data.version = VERSION; localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch (e) { console.error(e); } }
        function saveData() { saveLocalData(); if (currentUser && isOnline) syncToCloud(); }
        function deepMerge(t, s) { const r = { ...t }; for (const k in s) { if (s[k] && typeof s[k] === 'object' && !Array.isArray(s[k])) r[k] = deepMerge(t[k]||{}, s[k]); else r[k] = s[k]; } return r; }
        function initializeInstruments() { 
            // Initialize all instruments from library
            Object.keys(INSTRUMENT_LIBRARY).forEach(category => {
                INSTRUMENT_LIBRARY[category].forEach(i => { 
                    if (!data.instruments[i.id]) {
                        data.instruments[i.id] = { 
                            ...i, 
                            category,
                            plFactor: null, 
                            isCalibrated: false, 
                            lastCalibrated: null, 
                            calibrationData: null,
                            baseLotSize: i.defaultBaseLots || 1,
                            isActive: category === 'metals' // Only metals active by default
                        };
                    } else {
                        // Ensure existing instruments have new fields
                        if (!data.instruments[i.id].category) data.instruments[i.id].category = category;
                        if (!data.instruments[i.id].baseLotSize) data.instruments[i.id].baseLotSize = i.defaultBaseLots || 1;
                        if (data.instruments[i.id].isActive === undefined) data.instruments[i.id].isActive = data.instruments[i.id].isCalibrated || category === 'metals';
                    }
                });
            });
        }

        // ============================================================
        // CALCULATIONS
        // ============================================================
        function getBalance() { if (data.dailyLogs.length > 0) { const s = [...data.dailyLogs].sort((a, b) => b.date.localeCompare(a.date)); return s[0].endingBalance; } return data.settings.currentBalance; }
        function getDailyTarget() { return getBalance() * (data.settings.dailyTargetPercent / 100); }
        function getWeeklyTarget() { return getDailyTarget() * data.settings.tradingDaysPerWeek; }
        function getRiskPerTrade() { return getBalance() * (data.settings.riskPerTradePercent / 100); }
        function getMaxDailyLoss() { return getBalance() * (data.settings.maxDailyLossPercent / 100); }
        function calculatePL(pos) { const inst = data.instruments[pos.instrumentId]; if (!inst || !inst.plFactor) return 0; const diff = pos.direction === 'long' ? pos.currentPrice - pos.avgPrice : pos.avgPrice - pos.currentPrice; return diff * pos.size * inst.plFactor; }
        function calculateStopLimit(pos) { const inst = data.instruments[pos.instrumentId]; if (!inst || !inst.plFactor) return null; const plPerUnit = pos.size * inst.plFactor; const risk = getRiskPerTrade(); const target = getDailyTarget(); const rr = data.settings.rrRatio; const stopD = risk / plPerUnit; const tpDRR = stopD * rr; const tpDT = target / plPerUnit; const isLong = pos.direction === 'long'; return { stopPrice: isLong ? pos.avgPrice - stopD : pos.avgPrice + stopD, tpPriceRR: isLong ? pos.avgPrice + tpDRR : pos.avgPrice - tpDRR, tpPriceTarget: isLong ? pos.avgPrice + tpDT : pos.avgPrice - tpDT, potentialLoss: risk, potentialProfitRR: risk * rr, potentialProfitTarget: target }; }
        
        // Intraday Closed Trades
        function getIntradayPL() {
            const today = getLocalDateString(new Date());
            if (!data.intradayClosedTrades) data.intradayClosedTrades = [];
            return data.intradayClosedTrades.filter(t => t.date === today).reduce((sum, t) => sum + (t.pl || 0), 0);
        }
        function getTodayClosedTrades() {
            const today = getLocalDateString(new Date());
            if (!data.intradayClosedTrades) data.intradayClosedTrades = [];
            return data.intradayClosedTrades.filter(t => t.date === today);
        }
        async function addClosedTrade(instrumentId, pl, note = '') {
            if (!data.intradayClosedTrades) data.intradayClosedTrades = [];
            const trade = { id: 'ct_' + Date.now(), instrumentId, pl: parseFloat(pl) || 0, note, date: getLocalDateString(new Date()), closedAt: new Date().toISOString() };
            data.intradayClosedTrades.push(trade);
            saveData();
            await syncClosedTrade(trade);
            render();
            showToast(t('closedTradeAdded'));
        }
        async function removeClosedTrade(id) {
            if (!data.intradayClosedTrades) return;
            const trade = data.intradayClosedTrades.find(t => t.id === id);
            data.intradayClosedTrades = data.intradayClosedTrades.filter(t => t.id !== id);
            saveData();
            if (trade) await syncClosedTrade(trade, 'delete');
            render();
            showToast(t('closedTradeRemoved'));
        }
        async function cleanupOldIntradayTrades() {
            if (!data.intradayClosedTrades) return;
            const today = getLocalDateString(new Date());
            const oldTrades = data.intradayClosedTrades.filter(t => t.date !== today);
            const before = data.intradayClosedTrades.length;
            data.intradayClosedTrades = data.intradayClosedTrades.filter(t => t.date === today);
            if (data.intradayClosedTrades.length !== before) {
                saveData();
                // Delete old trades from Supabase
                for (const trade of oldTrades) {
                    await syncClosedTrade(trade, 'delete');
                }
            }
        }
        
        function getWeekNumber(d) { const dt = new Date(d); dt.setHours(0,0,0,0); dt.setDate(dt.getDate() + 4 - (dt.getDay()||7)); const ys = new Date(dt.getFullYear(),0,1); return Math.ceil((((dt-ys)/86400000)+1)/7); }
        function getLocalDateString(date) { const y = date.getFullYear(); const m = String(date.getMonth() + 1).padStart(2, '0'); const d = String(date.getDate()).padStart(2, '0'); return `${y}-${m}-${d}`; }
        function getWeekDates(d) { 
            const dt = new Date(d); 
            dt.setHours(12, 0, 0, 0); 
            const day = dt.getDay();
            const diff = dt.getDate() - day + (day === 0 ? -6 : 1); 
            const mon = new Date(dt); 
            mon.setDate(diff); 
            const dates = []; 
            for (let i = 0; i < 5; i++) { 
                const x = new Date(mon); 
                x.setDate(mon.getDate() + i); 
                dates.push(getLocalDateString(x)); 
            } 
            return dates; 
        }
        function getWeeklyData() { 
            const today = new Date(); 
            const todayStr = getLocalDateString(today);
            const dates = getWeekDates(today); 
            const logs = data.dailyLogs.filter(l => dates.includes(l.date)); 
            const logsRealized = logs.reduce((s, l) => s + (l.realizedPL||0), 0);
            // Add intraday PL if today is in current week
            const intradayPL = dates.includes(todayStr) ? getIntradayPL() : 0;
            const realized = logsRealized + intradayPL;
            const target = getWeeklyTarget(); 
            return { weekNumber: getWeekNumber(today), dates, logs, target, realized, variance: realized - target, progressPercent: target > 0 ? (realized / target) * 100 : 0, status: realized >= target ? 'exceeded' : (realized >= target * 0.5 ? 'on_track' : 'behind') }; 
        }
        function processBuffer(realizedPL) { 
            console.log('processBuffer called with realizedPL:', realizedPL);
            if (!data.buffer.settings.enabled) { console.log('Buffer disabled'); return; }
            const target = getDailyTarget(); 
            console.log('Daily target:', target, 'realizedPL > target?', realizedPL > target);
            const max = target * data.buffer.settings.maxBufferDays; 
            const today = getLocalDateString(new Date()); 
            
            if (realizedPL > target) { 
                const surplus = realizedPL - target; 
                const space = max - data.buffer.currentBuffer; 
                const toAdd = Math.min(surplus, space); 
                console.log('Adding to buffer:', toAdd);
                if (toAdd > 0) { 
                    data.buffer.currentBuffer += toAdd; 
                    const entry = { date: today, type: 'add', amount: toAdd, reason: `Überschuss ${formatDate(today)}`, balanceAfter: data.buffer.currentBuffer };
                    data.buffer.history.push(entry); 
                    syncBuffer();
                    syncBufferHistory(entry);
                } 
            } else if (realizedPL < 0 && data.buffer.settings.autoUse) { 
                const loss = Math.abs(realizedPL); 
                const toUse = Math.min(loss, data.buffer.currentBuffer); 
                console.log('Using from buffer:', toUse);
                if (toUse > 0) { 
                    data.buffer.currentBuffer -= toUse; 
                    const entry = { date: today, type: 'use', amount: toUse, reason: `Ausgleich ${formatDate(today)}`, balanceAfter: data.buffer.currentBuffer };
                    data.buffer.history.push(entry); 
                    syncBuffer();
                    syncBufferHistory(entry);
                } 
            } 
        }

        // ============================================================
        // FORMATTING
        // ============================================================
        function fmt(n, d = 2) { return '€' + (n||0).toLocaleString('de-DE', { minimumFractionDigits: d, maximumFractionDigits: d }); }
        function fmtNum(n, d = 2) { return (n||0).toLocaleString('de-DE', { minimumFractionDigits: d, maximumFractionDigits: d }); }
        function fmtPrice(n, inst) { return (n||0).toFixed(inst?.priceDecimals || 2); }
        function fmtPct(n) { return (n||0).toFixed(1) + '%'; }
        
        // Gradient color from red (0%) → yellow (50%) → green (100%)
        function getProgressColor(pct) {
            pct = Math.max(0, Math.min(100, pct));
            const red = { r: 239, g: 68, b: 68 };     // #ef4444
            const yellow = { r: 251, g: 191, b: 36 }; // #fbbf24
            const green = { r: 0, g: 212, b: 170 };   // #00d4aa
            
            let r, g, b;
            if (pct <= 50) {
                const t = pct / 50;
                r = Math.round(red.r + (yellow.r - red.r) * t);
                g = Math.round(red.g + (yellow.g - red.g) * t);
                b = Math.round(red.b + (yellow.b - red.b) * t);
            } else {
                const t = (pct - 50) / 50;
                r = Math.round(yellow.r + (green.r - yellow.r) * t);
                g = Math.round(yellow.g + (green.g - yellow.g) * t);
                b = Math.round(yellow.b + (green.b - yellow.b) * t);
            }
            return `rgb(${r},${g},${b})`;
        }
        
        // Dynamic Lot Sizing - scales lot size proportionally with account balance
        function getRecommendedLotSize(instrumentId = 'xauusd') {
            if (!data.settings.lotSizingEnabled) return null;
            
            const balance = data.settings.currentBalance || data.settings.startCapital || 0;
            const baseBalance = data.settings.baseBalanceForLots || 15000;
            
            if (balance <= 0 || baseBalance <= 0) return null;
            
            // Get instrument-specific settings
            const inst = data.instruments[instrumentId];
            if (!inst) return null;
            
            // Find library entry for defaults
            let libInst = null;
            Object.values(INSTRUMENT_LIBRARY).forEach(category => {
                const found = category.find(i => i.id === instrumentId);
                if (found) libInst = found;
            });
            
            const baseLots = inst.baseLotSize || libInst?.defaultBaseLots || 1;
            const lotStep = inst.lotStep || libInst?.lotStep || 1;
            
            // Calculate scaling factor
            const scaleFactor = balance / baseBalance;
            const rawLots = baseLots * scaleFactor;
            
            // Round to nearest lot step (minimum 1 step)
            const roundedLots = Math.max(lotStep, Math.round(rawLots / lotStep) * lotStep);
            
            return {
                recommended: roundedLots,
                raw: rawLots,
                scaleFactor: scaleFactor,
                lotStep: lotStep,
                baseBalance: baseBalance,
                baseLots: baseLots,
                currentBalance: balance
            };
        }
        function formatDate(s) { if (!s) return '-'; const [y,m,d] = s.split('-'); return `${d}.${m}.${y}`; }
        function getMoodEmoji(m) { const map = { great: 'moodG', good: 'moodO', neutral: 'moodN', bad: 'moodB' }; const colors = { great: '#10b981', good: '#00d4aa', neutral: '#fbbf24', bad: '#ef4444' }; return ic(map[m] || 'moodN', 18, colors[m] || '#fbbf24'); }

        // ============================================================
        // RECOMMENDATIONS
        // ============================================================
        function generateRecommendations() {
            const recs = []; const weekData = getWeeklyData(); const target = getDailyTarget(); const todayLog = data.dailyLogs.find(l => l.date === getLocalDateString(new Date()));
            if (weekData.realized >= weekData.target) recs.push({ id: 'weekly_exceeded', priority: 'medium', icon: 'target', title: 'Wochenziel erreicht!', message: `${fmt(weekData.realized)} von ${fmt(weekData.target)} (+${fmt(weekData.variance)})`, dismissable: true });
            if (todayLog && todayLog.variancePercent > 100) recs.push({ id: 'great_day_'+todayLog.date, priority: 'info', icon: 'rocket', title: 'Hervorragender Tag!', message: `+${todayLog.variancePercent.toFixed(0)}% über Ziel`, dismissable: true });
            const bufferDays = data.buffer.currentBuffer / target;
            if (bufferDays < 2 && data.dailyLogs.length > 5) recs.push({ id: 'buffer_low', priority: 'low', icon: 'balance', title: 'Reserve aufbauen', message: `Reserve deckt nur ${bufferDays.toFixed(1)} Tage`, dismissable: true });
            if (!currentUser && data.dailyLogs.length > 3) recs.push({ id: 'enable_cloud', priority: 'low', icon: 'cloud', title: 'Cloud-Sync aktivieren', message: 'Anmelden für Sync auf allen Geräten', dismissable: true });
            return recs.filter(r => !data.dismissedRecommendations.includes(r.id));
        }
        function dismissRecommendation(id) { data.dismissedRecommendations.push(id); saveData(); render(); }

        // ============================================================
        // RENDER
        // ============================================================
        function render() { renderHeader(); renderDashboard(); renderPositions(); renderClosedTrades(); renderPerformance(); renderInstruments(); renderHistory(); renderSettings(); updateI18n(); updateLangButtons(); updateTooltips(); }
        
        function renderTabs() {
            document.querySelectorAll('.tabs .tab').forEach(tab => {
                const key = tab.querySelector('[data-i18n]');
                if (key) key.textContent = t(key.getAttribute('data-i18n'));
            });
        }
        
        function updateI18n() {
            // Text-Elemente
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (key && t(key) !== key) el.textContent = t(key);
            });
            // Placeholder-Texte
            document.querySelectorAll('[data-placeholder]').forEach(el => {
                const key = el.getAttribute('data-placeholder');
                if (key && t(key) !== key) el.placeholder = t(key);
            });
            // Select Options
            document.querySelectorAll('select option[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (key && t(key) !== key) el.textContent = t(key);
            });
        }
        
        function updateLangButtons() {
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById('lang-' + currentLang);
            if (activeBtn) activeBtn.classList.add('active');
        }
        
        function getLocale() {
            return currentLang === 'de' ? 'de-DE' : currentLang === 'es' ? 'es-ES' : 'en-US';
        }
        
        function renderHeader() { 
            document.getElementById('header-date').textContent = new Date().toLocaleDateString(getLocale(), { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }); 
            document.getElementById('header-balance').textContent = fmt(getBalance()); 
            const totalPL = getBalance() - data.settings.startCapital;
            document.getElementById('header-balance-sub').textContent = (totalPL >= 0 ? '+' : '') + fmt(totalPL) + ' ' + t('total').toLowerCase();
        }
        function renderDashboard() {
            const balance = getBalance(); const target = getDailyTarget(); const weekData = getWeeklyData();
            const todayLog = data.dailyLogs.find(l => l.date === getLocalDateString(new Date()));
            const intradayPL = getIntradayPL();
            const activePos = data.positions.filter(p => p.active);
            const unrealizedPL = activePos.reduce((s, p) => s + calculatePL(p), 0);
            const realizedPL = (todayLog ? todayLog.realizedPL : 0) + intradayPL;
            const todayPL = realizedPL + unrealizedPL; // Combined: realized + unrealized
            const totalPL = balance - data.settings.startCapital;
            document.getElementById('dashboard-stats').innerHTML = `<div class="card stat-box" data-tip="balance" data-tooltip=""><div class="stat-label">${t('balance')} <span class="help-icon">?</span></div><div class="stat-value">${fmt(balance)}</div><div class="stat-sub">${totalPL>=0?'+':''}${fmt(totalPL)} ${t('total').toLowerCase()}</div></div><div class="card stat-box" data-tip="todayPL" data-tooltip=""><div class="stat-label">${t('todayPL')} <span class="help-icon">?</span></div><div class="stat-value ${todayPL>=0?'text-green':'text-red'}">${todayPL>=0?'+':''}${fmt(todayPL)}</div><div class="stat-sub">${t('target')}: ${fmt(target)}</div></div><div class="card stat-box" data-tip="weekProgress" data-tooltip=""><div class="stat-label">${t('thisWeek')} <span class="help-icon">?</span></div><div class="stat-value ${weekData.realized>=0?'text-green':'text-red'}">${fmtPct(weekData.progressPercent)}</div><div class="stat-sub">${fmt(weekData.realized)} / ${fmt(weekData.target)}</div></div><div class="card stat-box" data-tip="reserve" data-tooltip=""><div class="stat-label">${t('reserve')} <span class="help-icon">?</span></div><div class="stat-value text-gold">${fmt(data.buffer.currentBuffer)}</div><div class="stat-sub">${(data.buffer.currentBuffer/target).toFixed(1)} ${t('days')}</div></div>`;
            updateTooltips();
            const recs = generateRecommendations();
            document.getElementById('recommendations-container').innerHTML = recs.length > 0 ? `<div class="card"><div class="card-title">${ic('bulb',20,'#fbbf24')} ${t('recommendations')}</div>${recs.map(r => `<div class="rec-card ${r.priority}">${r.dismissable?`<button class="rec-dismiss" onclick="dismissRecommendation('${r.id}')">&times;</button>`:''}<div class="rec-header"><span class="rec-icon">${ic(r.icon,24)}</span><span class="rec-title">${r.title}</span></div><div class="rec-message">${r.message}</div></div>`).join('')}</div>` : '';
            document.getElementById('week-number').textContent = weekData.weekNumber;
            const dayNames = [t('mon'),t('tue'),t('wed'),t('thu'),t('fri')]; const today = getLocalDateString(new Date());
            document.getElementById('week-grid').innerHTML = weekData.dates.map((d, i) => { const log = weekData.logs.find(l => l.date === d); const pl = log ? log.realizedPL : null; const isToday = d === today; const cls = pl !== null ? (pl >= 0 ? 'profit' : 'loss') : ''; return `<div class="week-day ${cls} ${isToday?'today':''}"><div class="week-day-name">${dayNames[i]}</div><div class="week-day-value ${pl!==null?(pl>=0?'positive':'negative'):'empty'}">${pl!==null?(pl>=0?'+':'')+fmtNum(pl,0):'-'}</div></div>`; }).join('');
            document.getElementById('week-target').textContent = fmt(weekData.target);
            document.getElementById('week-progress-pct').textContent = fmtPct(weekData.progressPercent);
            document.getElementById('week-progress-fill').style.width = Math.min(weekData.progressPercent, 100) + '%';
            
            // Buffer mit Fortschrittsbalken
            const maxBuf = target * data.buffer.settings.maxBufferDays; 
            const bufDays = target > 0 ? data.buffer.currentBuffer / target : 0; 
            const bufPct = maxBuf > 0 ? (data.buffer.currentBuffer / maxBuf) * 100 : 0;
            const displayBufPct = Math.min(bufPct, 100);
            
            // Color based on buffer level
            const getBufferColor = (pct) => {
                if (pct >= 80) return '#10b981'; // Green - healthy
                if (pct >= 50) return '#00d4aa';  // Teal
                if (pct >= 30) return '#fbbf24';  // Yellow - warning
                if (pct >= 10) return '#f59e0b';  // Orange
                return '#ef4444'; // Red - critical
            };
            const bufColor = getBufferColor(bufPct);
            
            document.getElementById('buffer-content').innerHTML = `
                <div style="margin-bottom:16px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <span style="font-size:1.5rem;font-weight:700;color:${bufColor};">${bufDays.toFixed(1)} <span style="font-size:0.85rem;font-weight:400;color:var(--muted);">${t('days')}</span></span>
                        <span style="font-size:0.9rem;color:${bufColor};">${fmtPct(bufPct)}</span>
                    </div>
                    <div style="height:20px;background:var(--bg);border-radius:10px;overflow:hidden;position:relative;border:1px solid var(--border);">
                        <div style="position:absolute;left:0;top:0;bottom:0;width:${displayBufPct}%;background:linear-gradient(90deg,#ef4444 0%,#f59e0b 20%,#fbbf24 40%,#00d4aa 70%,#10b981 100%);background-size:${100/Math.max(displayBufPct,1)*100}% 100%;border-radius:9px;transition:width 0.5s ease;"></div>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    <div style="background:var(--bg);padding:10px;border-radius:8px;text-align:center;">
                        <div style="font-size:0.7rem;color:var(--muted);margin-bottom:2px;">${t('reserve')}</div>
                        <div style="font-size:1rem;font-weight:600;color:#10b981;">${fmt(data.buffer.currentBuffer)}</div>
                    </div>
                    <div style="background:var(--bg);padding:10px;border-radius:8px;text-align:center;">
                        <div style="font-size:0.7rem;color:var(--muted);margin-bottom:2px;">${t('maximum')}</div>
                        <div style="font-size:1rem;font-weight:600;">${fmt(maxBuf)}</div>
                    </div>
                </div>
            `;
            
            const bufHist = data.buffer.history.slice(-3).reverse();
            document.getElementById('buffer-history').innerHTML = bufHist.length > 0 ? bufHist.map(h => `<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border);"><span>${h.type==='add'?'+':'-'} ${h.reason}</span><span class="${h.type==='add'?'text-green':'text-red'}">${h.type==='add'?'+':'-'}${fmt(h.amount)}</span></div>`).join('') : '<span class="text-muted">' + t('noBufferActivity') + '</span>';
            document.getElementById('dashboard-positions').innerHTML = activePos.length > 0 ? `<div class="grid grid-2">${activePos.map(pos => { const inst = data.instruments[pos.instrumentId]; const pl = calculatePL(pos); return `<div class="card card-dark" style="border-left:3px solid ${inst?.color||'#fff'};"><div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-weight:700;">${ic(inst?.icon||'gold',20,inst?.color)} ${inst?.symbol||pos.instrumentId}</span><span class="${pl>=0?'text-green':'text-red'} font-bold">${pl>=0?'+':''}${fmt(pl)}</span></div><div style="font-size:0.8rem;color:var(--muted);margin-top:4px;">${pos.size} × ${pos.direction.toUpperCase()} @ ${fmtPrice(pos.avgPrice, inst)}</div></div>`; }).join('')}</div><div style="text-align:right;margin-top:8px;font-size:0.9rem;">${t('unrealized')}: <span class="${unrealizedPL>=0?'text-green':'text-red'} font-bold">${unrealizedPL>=0?'+':''}${fmt(unrealizedPL)}</span></div>` : '<p class="text-muted">' + t('noPositions') + '</p>';
            const milestones = [25000,50000,100000,250000,500000,1000000].filter(m => m > balance).slice(0, 4);
            document.getElementById('milestones').innerHTML = milestones.map(m => `<div class="card card-dark text-center"><div class="text-gold font-bold">${m>=1000000?(m/1000000)+'M':(m/1000)+'k'}</div><div class="text-muted" style="font-size:0.75rem;">${t('stillMissing')} ${fmt(m-balance)}</div></div>`).join('');
            
            // Lot Sizing Widget - shows all active calibrated instruments
            const lotWidget = document.getElementById('lot-sizing-widget');
            const activeInstruments = Object.values(data.instruments).filter(i => i.isActive && i.isCalibrated);
            
            if (data.settings.lotSizingEnabled && data.settings.baseBalanceForLots > 0 && activeInstruments.length > 0) {
                lotWidget.style.display = '';
                const scaleFactor = (data.settings.currentBalance || data.settings.startCapital) / (data.settings.baseBalanceForLots || 15000);
                
                // Limit display to max 4 instruments, prioritize calibrated ones
                const displayInsts = activeInstruments.slice(0, 4);
                const gridCols = displayInsts.length <= 2 ? '1fr 1fr' : displayInsts.length === 3 ? '1fr 1fr 1fr' : '1fr 1fr 1fr 1fr';
                
                document.getElementById('lot-sizing-content').innerHTML = `
                    <div style="display:grid;grid-template-columns:${gridCols};gap:10px;">
                        ${displayInsts.map(inst => {
                            const lotInfo = getRecommendedLotSize(inst.id);
                            return `
                                <div style="background:var(--bg);padding:10px;border-radius:10px;border-left:3px solid ${inst.color || '#00d4aa'};">
                                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
                                        ${ic(inst.icon || 'gold', 16, inst.color)}
                                        <span style="font-size:0.75rem;color:var(--muted);">${inst.symbol}</span>
                                    </div>
                                    <div style="font-size:1.3rem;font-weight:700;color:var(--accent);">${lotInfo?.recommended || '--'}</div>
                                    <div style="font-size:0.65rem;color:var(--muted);">Lots</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding-top:10px;border-top:1px solid var(--border);font-size:0.75rem;">
                        <span class="text-muted">${t('baseBalance')}: ${fmt(data.settings.baseBalanceForLots || 15000, 0)}</span>
                        <span class="text-accent">×${scaleFactor.toFixed(2)} ${t('scaling')}</span>
                    </div>
                `;
            } else {
                lotWidget.style.display = 'none';
            }
            
            // Heutiger Fortschritt mit Kreisdiagramm
            const todayProgressPct = target > 0 ? Math.min((todayPL / target) * 100, 150) : 0;
            const displayPct = Math.min(todayProgressPct, 100);
            const remaining = target - todayPL;
            const isTargetReached = todayPL >= target;
            
            // Color gradient based on progress
            const getBarColor = (pct) => {
                if (pct >= 100) return '#10b981'; // Green
                if (pct >= 75) return '#00d4aa';  // Teal
                if (pct >= 50) return '#fbbf24';  // Yellow
                if (pct >= 25) return '#f59e0b';  // Orange
                return '#ef4444'; // Red
            };
            const barColor = getBarColor(todayProgressPct);
            
            // Tagesziel morgen (wenn heute erreicht)
            const tomorrowBalance = balance + target;
            const tomorrowTarget = tomorrowBalance * (data.settings.dailyTargetPercent / 100);
            
            document.getElementById('today-progress-content').innerHTML = `
                <div style="margin-bottom:16px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <span style="font-size:0.85rem;color:var(--muted);">${t('progress')}</span>
                        <span style="font-size:1.1rem;font-weight:700;color:${barColor};">
                            ${isTargetReached ? '✓ ' : ''}${fmtPct(todayProgressPct)}
                        </span>
                    </div>
                    <div style="height:24px;background:var(--bg);border-radius:12px;overflow:hidden;position:relative;border:1px solid var(--border);">
                        <div style="position:absolute;left:0;top:0;bottom:0;width:${displayPct}%;background:linear-gradient(90deg,#ef4444 0%,#f59e0b 25%,#fbbf24 50%,#00d4aa 75%,#10b981 100%);background-size:${100/displayPct*100}% 100%;border-radius:11px;transition:width 0.5s ease;${isTargetReached ? 'box-shadow:0 0 12px #10b98166;' : ''}"></div>
                        ${todayProgressPct > 100 ? `<div style="position:absolute;left:100%;top:50%;transform:translate(-50%,-50%);width:3px;height:16px;background:#fff;border-radius:2px;opacity:0.8;"></div>` : ''}
                    </div>
                    ${isTargetReached ? `<div style="text-align:center;margin-top:8px;font-size:0.8rem;color:#10b981;font-weight:600;">🎯 ${t('targetReached') || 'Tagesziel erreicht!'}</div>` : ''}
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                    <div style="background:var(--bg);padding:10px;border-radius:8px;text-align:center;">
                        <div style="font-size:0.7rem;color:var(--muted);margin-bottom:2px;">${t('targetToday')}</div>
                        <div style="font-size:1rem;font-weight:600;">${fmt(target)}</div>
                    </div>
                    <div style="background:var(--bg);padding:10px;border-radius:8px;text-align:center;">
                        <div style="font-size:0.7rem;color:var(--muted);margin-bottom:2px;">${t('realized')}</div>
                        <div style="font-size:1rem;font-weight:600;color:${realizedPL>=0?'#10b981':'#ef4444'};">${realizedPL>=0?'+':''}${fmt(realizedPL)}</div>
                    </div>
                    <div style="background:var(--bg);padding:10px;border-radius:8px;text-align:center;">
                        <div style="font-size:0.7rem;color:var(--muted);margin-bottom:2px;">${t('unrealized')}</div>
                        <div style="font-size:1rem;font-weight:600;color:${unrealizedPL>=0?'#10b981':'#ef4444'};">${unrealizedPL>=0?'+':''}${fmt(unrealizedPL)}</div>
                    </div>
                    <div style="background:var(--bg);padding:10px;border-radius:8px;text-align:center;">
                        <div style="font-size:0.7rem;color:var(--muted);margin-bottom:2px;">${isTargetReached ? t('surplus') : t('stillOpen')}</div>
                        <div style="font-size:1rem;font-weight:600;color:${isTargetReached ? '#10b981' : '#fbbf24'};">${isTargetReached ? '+' : ''}${fmt(Math.abs(remaining))}</div>
                    </div>
                </div>
                <div class="tomorrow-hint">
                    ${ic('proj',14,'var(--accent)')} ${t('targetTomorrow')}: <strong class="text-accent">${fmt(tomorrowTarget)}</strong>
                </div>
            `;
            
            // Mini Equity Chart (letzte 7 Tage)
            renderMiniEquityChart();
            
            // Streak & Statistiken
            renderStreakStats();
        }
        
        function renderMiniEquityChart() {
            const last7 = [...data.dailyLogs].sort((a, b) => a.date.localeCompare(b.date)).slice(-7);
            if (last7.length === 0) {
                document.getElementById('mini-equity-chart').innerHTML = '<p class="text-muted text-center" style="padding:20px;">' + t('noData') + '</p>';
                return;
            }
            
            const values = [last7[0].startingBalance, ...last7.map(l => l.endingBalance)];
            const min = Math.min(...values) * 0.997;
            const max = Math.max(...values) * 1.003;
            const range = max - min || 1;
            
            const labels = ['', ...last7.map(l => {
                const d = new Date(l.date + 'T12:00:00');
                return d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
            })];
            
            const width = 320;
            const height = 140;
            const padding = { top: 20, right: 12, bottom: 28, left: 50 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            const points = values.map((v, i) => {
                const x = padding.left + (i / (values.length - 1 || 1)) * chartWidth;
                const y = padding.top + chartHeight - ((v - min) / range) * chartHeight;
                return { x, y, value: v, label: labels[i] };
            });
            
            // Straight line path
            const linePath = points.map((p, i) => (i === 0 ? 'M' : 'L') + `${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(' ');
            const areaPath = linePath + ` L${points[points.length-1].x},${padding.top + chartHeight} L${padding.left},${padding.top + chartHeight} Z`;
            
            // Y-axis labels (4 values)
            const ySteps = 4;
            const yLabels = Array.from({length: ySteps}, (_, i) => {
                const val = min + (range * i / (ySteps - 1));
                const y = padding.top + chartHeight - (i / (ySteps - 1)) * chartHeight;
                return { val, y };
            });
            
            // Trend color
            const trend = values[values.length-1] >= values[0];
            const lineColor = trend ? '#00d4aa' : '#ef4444';
            const gradId = 'eqGrad' + Date.now();
            
            document.getElementById('mini-equity-chart').innerHTML = `
                <div class="chart-container">
                    <svg width="100%" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet" style="font-family:inherit;">
                        <defs>
                            <linearGradient id="${gradId}" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stop-color="${lineColor}" stop-opacity="0.25"/>
                                <stop offset="70%" stop-color="${lineColor}" stop-opacity="0.05"/>
                                <stop offset="100%" stop-color="${lineColor}" stop-opacity="0"/>
                            </linearGradient>
                            <filter id="lineGlow${gradId}">
                                <feGaussianBlur stdDeviation="1.5" result="blur"/>
                                <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
                            </filter>
                        </defs>
                        
                        <!-- Grid lines -->
                        ${yLabels.map(l => `
                            <line x1="${padding.left}" y1="${l.y.toFixed(1)}" x2="${width - padding.right}" y2="${l.y.toFixed(1)}" stroke="var(--border)" stroke-width="0.5" opacity="0.4"/>
                        `).join('')}
                        
                        <!-- Y-axis labels -->
                        ${yLabels.map(l => `
                            <text x="${padding.left - 6}" y="${l.y + 3}" text-anchor="end" fill="var(--muted)" font-size="9">${(l.val/1000).toFixed(1)}k</text>
                        `).join('')}
                        
                        <!-- Area fill -->
                        <path d="${areaPath}" fill="url(#${gradId})"/>
                        
                        <!-- Main line -->
                        <path d="${linePath}" fill="none" stroke="${lineColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" filter="url(#lineGlow${gradId})"/>
                        
                        <!-- Data points -->
                        ${points.map((p, i) => `
                            <circle cx="${p.x.toFixed(1)}" cy="${p.y.toFixed(1)}" r="3.5" fill="var(--card)" stroke="${lineColor}" stroke-width="1.5"/>
                        `).join('')}
                        
                        <!-- X-axis labels -->
                        ${points.filter((_, i) => i > 0).map(p => `
                            <text x="${p.x.toFixed(1)}" y="${height - 8}" text-anchor="middle" fill="var(--muted)" font-size="8">${p.label}</text>
                        `).join('')}
                    </svg>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;padding:8px 12px;background:var(--bg);border-radius:8px;font-size:0.8rem;">
                    <div><span class="text-muted">${t('start')}:</span> <strong>${fmt(values[0])}</strong></div>
                    <div style="color:${lineColor};font-weight:600;">${trend?'▲':'▼'} ${trend?'+':''}${fmtPct(((values[values.length-1]/values[0])-1)*100)}</div>
                    <div><span class="text-muted">${t('current')}:</span> <strong style="color:${lineColor}">${fmt(values[values.length-1])}</strong></div>
                </div>
            `;
        }
        
        function renderStreakStats() {
            // Berechne Streak
            const sortedLogs = [...data.dailyLogs].sort((a, b) => b.date.localeCompare(a.date));
            let currentStreak = 0;
            let maxStreak = 0;
            let tempStreak = 0;
            
            for (const log of sortedLogs) {
                if (log.targetHit) {
                    tempStreak++;
                    if (tempStreak > maxStreak) maxStreak = tempStreak;
                } else {
                    if (currentStreak === 0 && tempStreak > 0) currentStreak = 0; // Streak gebrochen
                    tempStreak = 0;
                }
                if (currentStreak === 0 && log.targetHit) currentStreak = tempStreak;
            }
            
            // Aktueller Streak (von heute rückwärts)
            currentStreak = 0;
            for (const log of sortedLogs) {
                if (log.targetHit) currentStreak++;
                else break;
            }
            
            // Weitere Stats
            const totalDays = data.dailyLogs.length;
            const targetHitDays = data.dailyLogs.filter(l => l.targetHit).length;
            const hitRate = totalDays > 0 ? (targetHitDays / totalDays) * 100 : 0;
            
            // Bester/schlechtester Tag
            const bestDay = data.dailyLogs.reduce((best, l) => (l.realizedPL || 0) > (best?.realizedPL || -Infinity) ? l : best, null);
            const worstDay = data.dailyLogs.reduce((worst, l) => (l.realizedPL || 0) < (worst?.realizedPL || Infinity) ? l : worst, null);
            
            document.getElementById('streak-stats').innerHTML = `
                <div class="streak-container">
                    <div class="streak-box">
                        <div class="streak-value streak-fire">${currentStreak} ${ic('streak',20,'#fbbf24')}</div>
                        <div class="streak-label">${t('currentStreak')}</div>
                    </div>
                    <div class="streak-box">
                        <div class="streak-value">${maxStreak}</div>
                        <div class="streak-label">${t('maxStreak')}</div>
                    </div>
                    <div class="streak-box">
                        <div class="streak-value text-green">${fmtPct(hitRate)}</div>
                        <div class="streak-label">${t('hitRate')}</div>
                    </div>
                    <div class="streak-box">
                        <div class="streak-value">${targetHitDays}/${totalDays}</div>
                        <div class="streak-label">${t('daysWithTarget')}</div>
                    </div>
                </div>
                ${bestDay ? `
                <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:0.8rem;">
                    <div class="streak-box" style="padding:10px;">
                        <div class="text-green font-bold">+${fmt(bestDay.realizedPL)}</div>
                        <div class="streak-label">${t('bestDay')} (${formatDate(bestDay.date)})</div>
                    </div>
                    <div class="streak-box" style="padding:10px;">
                        <div class="text-red font-bold">${fmt(worstDay?.realizedPL || 0)}</div>
                        <div class="streak-label">${t('worstDay')} (${worstDay ? formatDate(worstDay.date) : '-'})</div>
                    </div>
                </div>
                ` : ''}
            `;
        }
        function renderPositions() {
            const target = getDailyTarget(); const risk = getRiskPerTrade();
            document.getElementById('position-stats').innerHTML = `<div class="card stat-box"><div class="stat-label">${t('dailyTarget')}</div><div class="stat-value text-green">${fmt(target)}</div></div><div class="card stat-box"><div class="stat-label">${t('riskPerTrade')}</div><div class="stat-value text-orange">${fmt(risk)}</div></div><div class="card stat-box"><div class="stat-label">${t('maxDailyLoss')}</div><div class="stat-value text-red">${fmt(getMaxDailyLoss())}</div></div><div class="card stat-box"><div class="stat-label">${t('rrRatio')}</div><div class="stat-value">1:${data.settings.rrRatio}</div></div>`;
            document.getElementById('positions-list').innerHTML = data.positions.length > 0 ? data.positions.map(pos => { const inst = data.instruments[pos.instrumentId]; const pl = calculatePL(pos); const sltp = calculateStopLimit(pos); return `<div class="card position-card" style="border-left-color:${inst?.color||'#fff'};"><div class="position-header"><div class="position-info"><span class="position-icon">${ic(inst?.icon||'gold',24,inst?.color)}</span><div><div class="position-symbol">${inst?.symbol||pos.instrumentId}</div><div class="position-name">${inst?.name||''} | ${pos.size} × ${pos.direction.toUpperCase()}</div></div></div><div class="position-pl"><div class="position-pl-value ${pl>=0?'text-green':'text-red'}">${pl>=0?'+':''}${fmt(pl)}</div><div style="font-size:0.8rem;color:var(--muted);">@ ${fmtPrice(pos.currentPrice, inst)}</div></div></div><div class="grid grid-4" style="font-size:0.85rem;margin-bottom:12px;"><div><span class="text-muted">Avg:</span> ${fmtPrice(pos.avgPrice, inst)}</div><div><span class="text-muted">${t('current')}:</span> ${fmtPrice(pos.currentPrice, inst)}</div><div><span class="text-muted">P/L/$1:</span> ${inst?.plFactor?fmt(pos.size*inst.plFactor):'N/A'}</div><div style="text-align:right;"><button class="btn btn-sm btn-ghost" onclick="updatePositionPrice('${pos.id}')">${ic('edit',14)}</button><button class="btn btn-sm btn-danger" onclick="removePosition('${pos.id}')">×</button></div></div>${sltp?`<div class="sl-tp-row"><div class="sl-tp-box stop"><div class="sl-tp-label">${ic('stop',14,'#ef4444')} ${t('stopLoss')}</div><div class="sl-tp-value">${fmtPrice(sltp.stopPrice, inst)}</div><div class="sl-tp-dist">-${fmt(sltp.potentialLoss)}</div></div><div class="sl-tp-box tp"><div class="sl-tp-label">${ic('check',14,'#10b981')} TP R:R</div><div class="sl-tp-value">${fmtPrice(sltp.tpPriceRR, inst)}</div><div class="sl-tp-dist">+${fmt(sltp.potentialProfitRR)}</div></div><div class="sl-tp-box target"><div class="sl-tp-label">${ic('target',14,'#00d4aa')} TP ${t('target')}</div><div class="sl-tp-value">${fmtPrice(sltp.tpPriceTarget, inst)}</div><div class="sl-tp-dist">+${fmt(sltp.potentialProfitTarget)}</div></div></div>`:'<div class="card card-dark text-center" style="padding:10px;"><span class="text-orange">' + t('notCalibrated') + '</span></div>'}</div>`; }).join('') : '<p class="text-muted text-center" style="padding:20px;">' + t('noPositions') + '</p>';
            const activePos = data.positions.filter(p => p.active);
            document.getElementById('quick-copy-list').innerHTML = activePos.length > 0 ? activePos.map(pos => { const inst = data.instruments[pos.instrumentId]; const sltp = calculateStopLimit(pos); if (!sltp) return ''; return `<div class="card card-dark"><div class="font-bold text-gold mb-2">${ic(inst?.icon||'gold',18,inst?.color)} ${inst?.symbol} (${pos.size})</div><table style="width:100%;font-size:0.85rem;"><tr><td class="text-muted">Avg:</td><td class="text-right">${fmtPrice(pos.avgPrice, inst)}</td></tr><tr><td class="text-red">${t('stopLoss')}:</td><td class="text-right font-bold">${fmtPrice(sltp.stopPrice, inst)}</td></tr><tr><td class="text-green">TP:</td><td class="text-right font-bold">${fmtPrice(sltp.tpPriceRR, inst)}</td></tr></table></div>`; }).join('') : '<p class="text-muted">' + t('noActivePositions') + '</p>';
        }
        function renderPerformance() {
            const weekData = getWeeklyData(); const balance = getBalance(); const start = data.settings.startCapital; const total = balance - start;
            const month = new Date().toISOString().slice(0, 7); const monthLogs = data.dailyLogs.filter(l => l.date.startsWith(month)); const monthPL = monthLogs.reduce((s, l) => s + (l.realizedPL||0), 0);
            document.getElementById('perf-week').textContent = (weekData.realized>=0?'+':'')+fmt(weekData.realized);
            document.getElementById('perf-week-pct').textContent = fmtPct(weekData.progressPercent)+' '+t('target').toLowerCase();
            document.getElementById('perf-month').textContent = (monthPL>=0?'+':'')+fmt(monthPL);
            document.getElementById('perf-month-pct').textContent = monthLogs.length+' '+t('tradingDays');
            document.getElementById('perf-total').textContent = (total>=0?'+':'')+fmt(total);
            document.getElementById('perf-total-pct').textContent = fmtPct((total/start)*100);
            const profit = data.dailyLogs.filter(l => l.realizedPL > 0).length; const loss = data.dailyLogs.filter(l => l.realizedPL < 0).length;
            const winRate = data.dailyLogs.length > 0 ? (profit/data.dailyLogs.length)*100 : 0;
            const avgPL = data.dailyLogs.length > 0 ? data.dailyLogs.reduce((s,l) => s+(l.realizedPL||0), 0)/data.dailyLogs.length : 0;
            document.getElementById('performance-stats').innerHTML = `<div class="stat-box"><div class="stat-label">${t('tradingDays')}</div><div class="stat-value">${data.dailyLogs.length}</div></div><div class="stat-box"><div class="stat-label">${t('profitDays')}/${t('lossDays')}</div><div class="stat-value">${profit}/${loss}</div></div><div class="stat-box"><div class="stat-label">${t('winRate')}</div><div class="stat-value ${winRate>=50?'text-green':'text-red'}">${fmtPct(winRate)}</div></div><div class="stat-box"><div class="stat-label">${t('avgDailyPL')}</div><div class="stat-value ${avgPL>=0?'text-green':'text-red'}">${fmt(avgPL)}</div></div>`;
            
            // Neue Charts rendern
            renderFullEquityChart();
            renderMonthlyChart();
            renderWeekdayChart();
            
            // Exponentielle Projektion (Zinseszins-Effekt)
            const targetCap = data.settings.targetCapital; 
            const dailyRate = data.settings.dailyTargetPercent / 100;
            const remaining = targetCap - balance;
            const todayTarget = getDailyTarget();
            
            // Korrekte exponentielle Formel: Tage = log(Ziel/Aktuell) / log(1+Rate)
            const daysToTarget = balance > 0 && dailyRate > 0 
                ? Math.ceil(Math.log(targetCap / balance) / Math.log(1 + dailyRate))
                : 0;
            const monthsToTarget = (daysToTarget / 21).toFixed(1);
            const yearsToTarget = (daysToTarget / 252).toFixed(1);
            
            document.getElementById('projection-content').innerHTML = `
                <div class="grid grid-2 mb-2">
                    <div class="stat-box"><div class="stat-label">${t('targetToday')}</div><div class="stat-value text-green">${fmt(todayTarget)}</div></div>
                    <div class="stat-box"><div class="stat-label">${t('stillToReach')}</div><div class="stat-value">${fmt(remaining)}</div></div>
                </div>
                <div class="grid grid-3">
                    <div class="stat-box"><div class="stat-label">${t('remainingDays')}</div><div class="stat-value">${daysToTarget}</div></div>
                    <div class="stat-box"><div class="stat-label">${t('remainingMonths')}</div><div class="stat-value">${monthsToTarget}</div></div>
                    <div class="stat-box"><div class="stat-label">${t('remainingYears')}</div><div class="stat-value">${yearsToTarget}</div></div>
                </div>
                <div class="progress-container mt-3">
                    <div class="progress-header"><span>${t('progressToTarget')} (${fmt(targetCap)})</span><span>${fmtPct((balance/targetCap)*100)}</span></div>
                    <div class="progress-bar"><div class="progress-fill blue" style="width:${Math.min((balance/targetCap)*100,100)}%"></div></div>
                </div>`;
        }
        
        function renderFullEquityChart() {
            const logs = [...data.dailyLogs].sort((a, b) => a.date.localeCompare(b.date));
            if (logs.length < 2) {
                document.getElementById('full-equity-chart').innerHTML = '<p class="text-muted text-center" style="padding:30px;">' + t('minData') + '</p>';
                return;
            }
            
            const values = [logs[0].startingBalance, ...logs.map(l => l.endingBalance)];
            const dates = ['', ...logs.map(l => l.date)];
            const min = Math.min(...values) * 0.995;
            const max = Math.max(...values) * 1.005;
            const range = max - min || 1;
            
            const width = 520;
            const height = 200;
            const padding = { top: 20, right: 15, bottom: 35, left: 55 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            const points = values.map((v, i) => {
                const x = padding.left + (i / (values.length - 1)) * chartWidth;
                const y = padding.top + chartHeight - ((v - min) / range) * chartHeight;
                return { x, y, value: v, date: dates[i] };
            });
            
            // Straight line path
            const linePath = points.map((p, i) => (i === 0 ? 'M' : 'L') + `${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(' ');
            const areaPath = linePath + ` L${points[points.length-1].x},${padding.top + chartHeight} L${padding.left},${padding.top + chartHeight} Z`;
            
            // Y-axis labels (5 values)
            const ySteps = 5;
            const yLabels = Array.from({length: ySteps}, (_, i) => {
                const val = min + (range * i / (ySteps - 1));
                const y = padding.top + chartHeight - (i / (ySteps - 1)) * chartHeight;
                return { val, y };
            });
            
            // X-axis labels (max 6)
            const xLabelCount = Math.min(6, points.length);
            const xStep = Math.floor((points.length - 1) / (xLabelCount - 1)) || 1;
            
            // Trend
            const trend = values[values.length-1] >= values[0];
            const lineColor = trend ? '#00d4aa' : '#ef4444';
            const change = values[values.length-1] - values[0];
            const changePct = ((values[values.length-1] / values[0]) - 1) * 100;
            const gradId = 'fullGrad' + Date.now();
            
            document.getElementById('full-equity-chart').innerHTML = `
                <div class="chart-container">
                    <svg width="100%" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet" style="font-family:inherit;">
                        <defs>
                            <linearGradient id="${gradId}" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stop-color="${lineColor}" stop-opacity="0.2"/>
                                <stop offset="60%" stop-color="${lineColor}" stop-opacity="0.05"/>
                                <stop offset="100%" stop-color="${lineColor}" stop-opacity="0"/>
                            </linearGradient>
                            <filter id="glow${gradId}">
                                <feGaussianBlur stdDeviation="1.5" result="blur"/>
                                <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
                            </filter>
                        </defs>
                        
                        <!-- Grid lines -->
                        ${yLabels.map(l => `
                            <line x1="${padding.left}" y1="${l.y.toFixed(1)}" x2="${width - padding.right}" y2="${l.y.toFixed(1)}" stroke="var(--border)" stroke-width="0.5" opacity="0.4"/>
                        `).join('')}
                        
                        <!-- Y-axis labels -->
                        ${yLabels.map(l => `
                            <text x="${padding.left - 8}" y="${l.y + 3}" text-anchor="end" fill="var(--muted)" font-size="10">${(l.val/1000).toFixed(1)}k</text>
                        `).join('')}
                        
                        <!-- Area fill -->
                        <path d="${areaPath}" fill="url(#${gradId})"/>
                        
                        <!-- Main line -->
                        <path d="${linePath}" fill="none" stroke="${lineColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" filter="url(#glow${gradId})"/>
                        
                        <!-- Start point -->
                        <circle cx="${points[0].x.toFixed(1)}" cy="${points[0].y.toFixed(1)}" r="4" fill="var(--card)" stroke="var(--blue)" stroke-width="2"/>
                        
                        <!-- End point -->
                        <circle cx="${points[points.length-1].x.toFixed(1)}" cy="${points[points.length-1].y.toFixed(1)}" r="5" fill="var(--card)" stroke="${lineColor}" stroke-width="2"/>
                        
                        <!-- X-axis labels -->
                        ${points.filter((_, i) => i === 0 || i === points.length - 1 || i % xStep === 0).map(p => {
                            const d = p.date ? new Date(p.date + 'T12:00:00') : null;
                            const label = d ? d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' }) : '';
                            return label ? `<text x="${p.x.toFixed(1)}" y="${height - 10}" text-anchor="middle" fill="var(--muted)" font-size="9">${label}</text>` : '';
                        }).join('')}
                    </svg>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;padding:10px 14px;background:var(--bg);border-radius:8px;font-size:0.85rem;">
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span style="width:10px;height:10px;border-radius:50%;background:var(--blue);"></span>
                        <span class="text-muted">${t('start')}:</span>
                        <strong>${fmt(values[0])}</strong>
                        <span class="text-muted" style="font-size:0.75rem;">(${formatDate(logs[0].date)})</span>
                    </div>
                    <div style="font-weight:700;font-size:1rem;color:${lineColor};">${trend?'▲':'▼'} ${trend?'+':''}${fmtPct(changePct)}</div>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span style="width:10px;height:10px;border-radius:50%;background:${lineColor};"></span>
                        <span class="text-muted">${t('current')}:</span>
                        <strong style="color:${lineColor}">${fmt(values[values.length-1])}</strong>
                    </div>
                </div>
            `;
        }
        
        function renderMonthlyChart() {
            const monthlyData = {};
            data.dailyLogs.forEach(log => {
                const month = log.date.slice(0, 7);
                if (!monthlyData[month]) monthlyData[month] = { pl: 0, days: 0 };
                monthlyData[month].pl += log.realizedPL || 0;
                monthlyData[month].days++;
            });
            
            const months = Object.keys(monthlyData).sort().slice(-6);
            if (months.length === 0) {
                document.getElementById('monthly-chart').innerHTML = '<p class="text-muted text-center" style="padding:20px;">' + t('noData') + '</p>';
                return;
            }
            
            const values = months.map(m => monthlyData[m].pl);
            const maxAbs = Math.max(...values.map(Math.abs), 1);
            const totalPL = values.reduce((a, b) => a + b, 0);
            
            const width = 280;
            const height = 150;
            const barWidth = 32;
            const gap = 12;
            const startX = (width - (months.length * barWidth + (months.length - 1) * gap)) / 2;
            const centerY = height / 2 + 5;
            const maxBarHeight = 45;
            
            document.getElementById('monthly-chart').innerHTML = `
                <div class="chart-container">
                    <svg width="100%" viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet">
                        <defs>
                            <linearGradient id="barGradGreen" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stop-color="var(--green)" stop-opacity="1"/>
                                <stop offset="100%" stop-color="var(--green)" stop-opacity="0.6"/>
                            </linearGradient>
                            <linearGradient id="barGradRed" x1="0" y1="1" x2="0" y2="0">
                                <stop offset="0%" stop-color="var(--red)" stop-opacity="1"/>
                                <stop offset="100%" stop-color="var(--red)" stop-opacity="0.6"/>
                            </linearGradient>
                            <filter id="barShadow">
                                <feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity="0.15"/>
                            </filter>
                        </defs>
                        
                        <!-- Zero line -->
                        <line x1="15" y1="${centerY}" x2="${width - 15}" y2="${centerY}" stroke="var(--border)" stroke-width="1" stroke-dasharray="4"/>
                        
                        <!-- Bars -->
                        ${months.map((m, i) => {
                            const pl = monthlyData[m].pl;
                            const barHeight = Math.max((Math.abs(pl) / maxAbs) * maxBarHeight, 4);
                            const x = startX + i * (barWidth + gap);
                            const y = pl >= 0 ? centerY - barHeight : centerY;
                            const gradient = pl >= 0 ? 'url(#barGradGreen)' : 'url(#barGradRed)';
                            const color = pl >= 0 ? 'var(--green)' : 'var(--red)';
                            const label = new Date(m + '-15T12:00:00').toLocaleDateString('de-DE', { month: 'short' });
                            return `
                                <g filter="url(#barShadow)">
                                    <rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="${gradient}" rx="4" ry="4"/>
                                </g>
                                <text x="${x + barWidth/2}" y="${height - 8}" text-anchor="middle" class="chart-label">${label}</text>
                                <text x="${x + barWidth/2}" y="${pl >= 0 ? y - 6 : y + barHeight + 14}" text-anchor="middle" fill="${color}" font-size="9" font-weight="600">${pl >= 0 ? '+' : ''}${Math.round(pl)}</text>
                            `;
                        }).join('')}
                    </svg>
                </div>
                <div style="text-align:center;margin-top:8px;padding:6px 10px;background:var(--bg);border-radius:6px;font-size:0.8rem;">
                    <span class="text-muted">${t('total')}:</span> 
                    <strong style="color:${totalPL >= 0 ? 'var(--green)' : 'var(--red)'}">${totalPL >= 0 ? '+' : ''}${fmt(totalPL)}</strong>
                </div>
            `;
        }
        
        function renderWeekdayChart() {
            const weekdays = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            const weekdayData = Array(7).fill(null).map(() => ({ total: 0, count: 0 }));
            
            data.dailyLogs.forEach(log => {
                const d = new Date(log.date + 'T12:00:00');
                const day = d.getDay();
                weekdayData[day].total += log.realizedPL || 0;
                weekdayData[day].count++;
            });
            
            const avgData = weekdayData.map((d, i) => ({
                day: weekdays[i],
                avg: d.count > 0 ? d.total / d.count : 0,
                count: d.count
            }));
            
            const tradingDays = avgData.slice(1, 6);
            
            if (tradingDays.every(d => d.count === 0)) {
                document.getElementById('weekday-chart').innerHTML = '<p class="text-muted text-center" style="padding:20px;">' + t('noData') + '</p>';
                return;
            }
            
            const maxAbs = Math.max(...tradingDays.map(d => Math.abs(d.avg)), 1);
            const bestDay = tradingDays.reduce((best, d) => d.avg > best.avg ? d : best, tradingDays[0]);
            
            document.getElementById('weekday-chart').innerHTML = `
                <div style="display:flex;flex-direction:column;gap:10px;">
                    ${tradingDays.map(d => {
                        const pct = d.avg !== 0 ? (d.avg / maxAbs) * 100 : 0;
                        const colorHex = d.avg >= 0 ? '#10b981' : '#ef4444';
                        const widthPct = Math.abs(pct);
                        const isBest = d === bestDay && d.avg > 0;
                        return `
                            <div style="display:flex;align-items:center;gap:10px;${isBest ? 'background:var(--bg);padding:6px 8px;margin:-6px -8px;border-radius:8px;' : ''}">
                                <span style="width:28px;font-size:0.85rem;font-weight:700;${isBest ? 'color:#10b981;' : ''}">${d.day}</span>
                                <div style="flex:1;height:28px;background:var(--bg);border-radius:8px;overflow:hidden;position:relative;border:1px solid var(--border);">
                                    <div style="position:absolute;left:${d.avg >= 0 ? '50%' : `calc(50% - ${widthPct/2}%)`};width:${widthPct/2}%;height:100%;background:linear-gradient(${d.avg >= 0 ? '90deg' : '270deg'},${colorHex},${colorHex}88);border-radius:${d.avg >= 0 ? '0 6px 6px 0' : '6px 0 0 6px'};transition:width 0.3s ease;"></div>
                                    <div style="position:absolute;left:50%;top:0;bottom:0;width:2px;background:var(--border);transform:translateX(-50%);"></div>
                                </div>
                                <span style="width:65px;text-align:right;font-size:0.85rem;font-weight:600;color:${colorHex};">${d.avg >= 0 ? '+' : ''}${fmt(d.avg)}</span>
                                <span style="width:35px;text-align:right;font-size:0.75rem;color:var(--muted);opacity:0.8;">(${d.count}×)</span>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="text-align:center;margin-top:14px;padding:8px;background:var(--bg);border-radius:6px;">
                    <span class="text-muted" style="font-size:0.75rem;">${t('avgPerWeekday')}</span>
                    ${bestDay.avg > 0 ? `<span style="margin-left:8px;font-size:0.75rem;">🏆 <strong>${bestDay.day}</strong></span>` : ''}
                </div>
            `;
        }
        let currentInstrumentTab = 'metals';
        
        function switchInstrumentTab(tab) {
            currentInstrumentTab = tab;
            document.querySelectorAll('.inst-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.inst-tab[data-tab="${tab}"]`)?.classList.add('active');
            renderInstruments();
        }
        
        function renderInstruments() {
            const container = document.getElementById('instruments-content');
            if (!container) return;
            
            if (currentInstrumentTab === 'custom') {
                // Custom instruments tab
                const customInsts = Object.values(data.instruments).filter(i => i.isCustom);
                container.innerHTML = `
                    <button class="btn btn-primary mb-3" onclick="openCustomInstrumentModal()">
                        ${ic('plus',16)} ${t('addCustomInstrument')}
                    </button>
                    ${customInsts.length > 0 ? customInsts.map(inst => renderInstrumentCard(inst)).join('') : 
                        `<p class="text-muted text-center" style="padding:20px;">${t('noCustomInstruments')}</p>`}
                `;
            } else {
                // Library category
                const libInsts = INSTRUMENT_LIBRARY[currentInstrumentTab] || [];
                container.innerHTML = libInsts.map(libInst => {
                    const inst = data.instruments[libInst.id] || { ...libInst, isActive: false };
                    return renderInstrumentCard(inst);
                }).join('');
            }
            
            // Render active lot config
            renderActiveLotConfig();
        }
        
        function renderInstrumentCard(inst) {
            const cal = inst.isCalibrated && inst.plFactor;
            const active = inst.isActive !== false;
            return `
                <div class="instrument-card ${active ? '' : 'inactive'}">
                    <div class="instrument-icon" onclick="openCalibrationModal('${inst.id}')">${ic(inst.icon || 'gold', 32, inst.color)}</div>
                    <div class="instrument-info" onclick="openCalibrationModal('${inst.id}')">
                        <div class="instrument-symbol">${inst.symbol}</div>
                        <div class="instrument-name">${inst.name}</div>
                    </div>
                    <div class="instrument-status" style="display:flex;align-items:center;gap:10px;">
                        <div style="text-align:right;" onclick="openCalibrationModal('${inst.id}')">
                            <div class="instrument-factor ${cal ? 'text-green' : 'text-orange'}">${cal ? fmtNum(inst.plFactor, 4) : '---'}</div>
                            <div style="font-size:0.7rem;" class="${cal ? 'calibrated' : 'not-calibrated'}">${cal ? t('calibrated') : t('notCalibrated')}</div>
                        </div>
                        <button class="toggle-btn ${active ? 'active' : ''}" onclick="toggleInstrumentActive('${inst.id}', event)">
                            ${active ? t('active') : t('inactive')}
                        </button>
                    </div>
                </div>
            `;
        }
        
        function toggleInstrumentActive(id, event) {
            event?.stopPropagation();
            if (data.instruments[id]) {
                data.instruments[id].isActive = !data.instruments[id].isActive;
                saveData();
                renderInstruments();
            }
        }
        
        function renderActiveLotConfig() {
            const container = document.getElementById('active-lot-config');
            if (!container) return;
            
            const activeInsts = Object.values(data.instruments).filter(i => i.isActive && i.isCalibrated);
            if (activeInsts.length === 0) {
                container.innerHTML = `<p class="text-muted">${t('noActiveInstruments')}</p>`;
                return;
            }
            
            const balance = data.settings.currentBalance || data.settings.startCapital;
            const baseBalance = data.settings.baseBalanceForLots || 15000;
            const scaleFactor = baseBalance > 0 ? balance / baseBalance : 1;
            
            container.innerHTML = `
                <div style="font-size:0.8rem;color:var(--muted);margin-bottom:10px;">
                    ${t('scaleFactor')}: <strong class="text-accent">×${scaleFactor.toFixed(2)}</strong> 
                    <span class="text-muted">(${fmt(balance, 0)} / ${fmt(baseBalance, 0)})</span>
                </div>
                ${activeInsts.map(inst => {
                    const lotInfo = getRecommendedLotSize(inst.id);
                    return `
                        <div class="lot-config-row">
                            <div style="display:flex;align-items:center;gap:10px;">
                                ${ic(inst.icon || 'gold', 20, inst.color)}
                                <span style="font-weight:600;">${inst.symbol}</span>
                            </div>
                            <div style="display:flex;align-items:center;gap:15px;">
                                <div style="text-align:center;">
                                    <div style="font-size:0.7rem;color:var(--muted);">${t('baseLots')}</div>
                                    <div style="font-weight:600;">${inst.baseLotSize || 1}</div>
                                </div>
                                <div style="font-size:1.2rem;color:var(--muted);">→</div>
                                <div style="text-align:center;">
                                    <div style="font-size:0.7rem;color:var(--muted);">${t('recommended')}</div>
                                    <div style="font-weight:700;color:var(--accent);font-size:1.1rem;">${lotInfo?.recommended || '--'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }
        function renderHistory() {
            const sorted = [...data.dailyLogs].sort((a, b) => b.date.localeCompare(a.date));
            document.getElementById('history-table').innerHTML = sorted.length > 0 ? sorted.map(log => `<tr><td>${formatDate(log.date)}</td><td class="text-right">${fmt(log.startingBalance)}</td><td class="text-right">${fmt(log.endingBalance)}</td><td class="text-right ${log.realizedPL>=0?'text-green':'text-red'} font-bold">${log.realizedPL>=0?'+':''}${fmt(log.realizedPL)}</td><td class="text-center">${log.targetHit?ic('check',16,'#10b981'):ic('warn',16,'#fbbf24')}</td><td class="text-center">${getMoodEmoji(log.mood)}</td><td class="text-center"><button class="btn btn-sm btn-danger" onclick="deleteLog('${log.id}')">${ic('trash',14)}</button></td></tr>`).join('') : '<tr><td colspan="7" class="text-center text-muted" style="padding:20px;">' + t('noEntries') + '</td></tr>';
        }
        function renderSettings() {
            document.getElementById('set-start-capital').value = data.settings.startCapital;
            document.getElementById('set-current-balance').value = data.settings.currentBalance;
            document.getElementById('set-target-capital').value = data.settings.targetCapital;
            document.getElementById('set-daily-target').value = data.settings.dailyTargetPercent;
            document.getElementById('set-risk-per-trade').value = data.settings.riskPerTradePercent;
            document.getElementById('set-max-daily-loss').value = data.settings.maxDailyLossPercent;
            document.getElementById('set-rr-ratio').value = data.settings.rrRatio;
            document.getElementById('set-buffer-enabled').value = data.buffer.settings.enabled.toString();
            document.getElementById('set-buffer-max-days').value = data.buffer.settings.maxBufferDays;
            // Lot Sizing Settings
            document.getElementById('set-lot-sizing-enabled').value = (data.settings.lotSizingEnabled !== false).toString();
            document.getElementById('set-base-balance').value = data.settings.baseBalanceForLots || 15000;
            updateLotSizingPreview();
            document.getElementById('cloud-sync-content').innerHTML = currentUser ? `<div style="display:flex;align-items:center;gap:12px;"><div class="sync-dot ${isOnline?'online':'offline'}" style="width:12px;height:12px;"></div><div><div class="font-bold">${currentUser.email}</div><div class="text-muted" style="font-size:0.8rem;">${isOnline?t('cloudConnected'):t('offline')}</div></div></div><button class="btn btn-ghost btn-sm mt-3" onclick="syncToCloud()">${ic('sync',16)} ${t('syncNow')}</button>` : `<div class="text-muted mb-2">${t('offlineModeDesc')}</div><button class="btn btn-primary btn-sm" onclick="showAuthScreen()">${ic('cloud',16)} ${t('enableCloudSync')}</button>`;
        }

        // ============================================================
        // ACTIONS
        // ============================================================
        function saveSettings() { data.settings.startCapital = parseFloat(document.getElementById('set-start-capital').value)||0; data.settings.currentBalance = parseFloat(document.getElementById('set-current-balance').value)||0; data.settings.targetCapital = parseFloat(document.getElementById('set-target-capital').value)||0; data.settings.dailyTargetPercent = parseFloat(document.getElementById('set-daily-target').value)||1; data.settings.riskPerTradePercent = parseFloat(document.getElementById('set-risk-per-trade').value)||2; data.settings.maxDailyLossPercent = parseFloat(document.getElementById('set-max-daily-loss').value)||3; data.settings.rrRatio = parseFloat(document.getElementById('set-rr-ratio').value)||2; data.buffer.settings.enabled = document.getElementById('set-buffer-enabled').value === 'true'; data.buffer.settings.maxBufferDays = parseInt(document.getElementById('set-buffer-max-days').value)||10; data.settings.lotSizingEnabled = document.getElementById('set-lot-sizing-enabled').value === 'true'; data.settings.baseBalanceForLots = parseFloat(document.getElementById('set-base-balance').value)||15000; saveData(); render(); showToast(t('settingsSaved')); }
        
        // Lot Sizing Preview in Settings
        function updateLotSizingPreview() {
            const preview = document.getElementById('lot-sizing-preview');
            if (!preview) return;
            const enabled = document.getElementById('set-lot-sizing-enabled')?.value === 'true';
            if (!enabled) {
                preview.innerHTML = `<span class="text-muted">${t('lotSizingDisabled')}</span>`;
                return;
            }
            const baseBalance = parseFloat(document.getElementById('set-base-balance')?.value) || 15000;
            const currentBalance = data.settings.currentBalance || data.settings.startCapital || baseBalance;
            const scaleFactor = currentBalance / baseBalance;
            
            // Show preview for active instruments
            const activeInsts = Object.values(data.instruments).filter(i => i.isActive && i.isCalibrated).slice(0, 4);
            
            if (activeInsts.length === 0) {
                preview.innerHTML = `<span class="text-muted">${t('noActiveInstruments')}</span>`;
                return;
            }
            
            preview.innerHTML = `
                <div style="font-size:0.75rem;color:var(--muted);margin-bottom:8px;">
                    ${t('scaleFactor')}: <strong class="text-accent">×${scaleFactor.toFixed(2)}</strong>
                </div>
                <div style="display:grid;grid-template-columns:repeat(${Math.min(activeInsts.length, 4)},1fr);gap:8px;text-align:center;">
                    ${activeInsts.map(inst => {
                        const baseLots = inst.baseLotSize || 1;
                        const lotStep = inst.lotStep || 1;
                        const recommended = Math.max(lotStep, Math.round((baseLots * scaleFactor) / lotStep) * lotStep);
                        return `<div style="padding:8px;background:var(--card);border-radius:6px;border-left:2px solid ${inst.color || '#00d4aa'};">
                            <div style="font-size:0.7rem;color:var(--muted);">${inst.symbol}</div>
                            <div style="font-size:0.65rem;color:var(--muted);">${baseLots} → </div>
                            <div style="font-weight:700;color:var(--accent);">${recommended}</div>
                        </div>`;
                    }).join('')}
                </div>
            `;
        }
        
        // Position Modal - Update Recommendation
        function updatePositionRecommendation() {
            const instId = document.getElementById('pos-instrument')?.value;
            const recDiv = document.getElementById('pos-lot-recommendation');
            const recLotsSpan = document.getElementById('pos-recommended-lots');
            if (!instId || !data.settings.lotSizingEnabled) {
                if (recDiv) recDiv.style.display = 'none';
                return;
            }
            const lotInfo = getRecommendedLotSize(instId);
            if (lotInfo && recDiv && recLotsSpan) {
                recDiv.style.display = '';
                recLotsSpan.textContent = lotInfo.recommended + ' Lots';
            }
        }
        
        // Position Modal - Apply Recommended Lots
        function applyRecommendedLots() {
            const instId = document.getElementById('pos-instrument')?.value;
            if (!instId) return;
            const lotInfo = getRecommendedLotSize(instId);
            if (lotInfo) {
                document.getElementById('pos-size').value = lotInfo.recommended;
            }
        }
        async function saveEntry() {
            const balanceInput = document.getElementById('entry-balance').value; if (!balanceInput) { showToast(t('entryRequired'), 'error'); return; }
            const newBalance = parseFloat(balanceInput); const prevBalance = getBalance(); const realizedPL = newBalance - prevBalance; const dailyTarget = getDailyTarget();
            const variance = realizedPL - dailyTarget; const variancePercent = dailyTarget > 0 ? (variance / dailyTarget) * 100 : 0; const daysEquivalent = dailyTarget > 0 ? realizedPL / dailyTarget : 0; const entryDate = document.getElementById('entry-date').value;
            const newLog = { id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(), date: entryDate, startingBalance: prevBalance, endingBalance: newBalance, realizedPL, unrealizedPL: parseFloat(document.getElementById('entry-unrealized').value)||0, dailyTarget, variance, variancePercent, daysEquivalent, targetHit: realizedPL >= dailyTarget, tradesCount: parseInt(document.getElementById('entry-trades').value)||0, mood: document.getElementById('entry-mood').value, notes: document.getElementById('entry-notes').value };
            const existingIndex = data.dailyLogs.findIndex(l => l.date === newLog.date);
            if (existingIndex >= 0) { if (!confirm(t('entryOverwrite'))) return; data.dailyLogs[existingIndex] = newLog; }
            else data.dailyLogs.push(newLog);
            processBuffer(realizedPL); data.settings.currentBalance = newBalance;
            saveData(); await syncDailyLog(newLog);
            document.getElementById('entry-balance').value = ''; document.getElementById('entry-realized').value = ''; document.getElementById('entry-unrealized').value = ''; document.getElementById('entry-trades').value = ''; document.getElementById('entry-notes').value = ''; document.getElementById('entry-mood').value = 'neutral'; document.getElementById('entry-preview').classList.add('hidden');
            render(); showToast(t('entrySaved') + ': ' + (realizedPL>=0?'+':'') + fmt(realizedPL));
        }
        async function deleteLog(id) { if (!confirm(t('entryDelete'))) return; data.dailyLogs = data.dailyLogs.filter(l => l.id !== id); saveData(); if (currentUser && isOnline) try { await db.from('daily_logs').delete().eq('id', id); } catch(e){} render(); showToast(t('deleted')); }
        function openAddPositionModal() {
            const calibrated = Object.values(data.instruments).filter(i => i.isCalibrated);
            if (calibrated.length === 0) { showToast(t('calibrateFirst'), 'warning'); return; }
            document.getElementById('pos-instrument').innerHTML = calibrated.map(inst => `<option value="${inst.id}">${inst.symbol} - ${inst.name}</option>`).join('');
            document.getElementById('pos-size').value = ''; document.getElementById('pos-avg-price').value = ''; document.getElementById('pos-current-price').value = ''; document.getElementById('pos-direction').value = 'long';
            openModal('position-modal');
            // Trigger recommendation update after modal opens
            setTimeout(() => updatePositionRecommendation(), 50);
        }
        async function savePosition() {
            const instrumentId = document.getElementById('pos-instrument').value; const size = parseFloat(document.getElementById('pos-size').value); const avgPrice = parseFloat(document.getElementById('pos-avg-price').value); const currentPrice = parseFloat(document.getElementById('pos-current-price').value); const direction = document.getElementById('pos-direction').value;
            if (!instrumentId || !size || !avgPrice || !currentPrice) { showToast('Bitte alle Felder ausfüllen', 'error'); return; }
            const newPos = { id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(), instrumentId, size, avgPrice, currentPrice, direction, openDate: getLocalDateString(new Date()), active: true };
            data.positions.push(newPos); saveData(); await syncPosition(newPos);
            render(); closeModal('position-modal'); showToast(t('positionAdded'));
        }
        function updatePositionPrice(id) { const newPrice = prompt(t('enterNewPrice')); if (newPrice === null) return; const pos = data.positions.find(p => p.id === id); if (pos) { pos.currentPrice = parseFloat(newPrice); saveData(); syncPosition(pos); render(); } }
        async function removePosition(id) { 
            const pos = data.positions.find(p => p.id === id);
            if (!pos) return;
            const inst = data.instruments[pos.instrumentId];
            const pl = calculatePL(pos);
            const plText = pl >= 0 ? `+${fmt(pl)} ${t('profit')}` : `${fmt(pl)} ${t('loss')}`;
            
            const confirmed = confirm(`${t('removePosition')}\n${inst?.symbol || pos.instrumentId}\n\n${t('unrealized')} P/L: ${plText}\n\n${t('removeHint')}`);
            if (!confirmed) return;
            
            data.positions = data.positions.filter(p => p.id !== id); 
            saveData(); 
            await syncPosition(pos, 'delete'); 
            render(); 
            showToast(t('positionRemoved')); 
        }
        
        // Closed Trade Modal Functions
        function openClosedTradeModal() {
            const instruments = Object.values(data.instruments).filter(i => i.isCalibrated);
            const options = instruments.length > 0 
                ? instruments.map(inst => `<option value="${inst.id}">${inst.symbol}</option>`).join('')
                : '<option value="">-- ' + t('instrument') + ' --</option>';
            document.getElementById('ct-instrument').innerHTML = '<option value="">(' + t('instrument') + ')</option>' + options;
            document.getElementById('ct-pl').value = '';
            document.getElementById('ct-note').value = '';
            openModal('closed-trade-modal');
        }
        function saveClosedTrade() {
            const instrumentId = document.getElementById('ct-instrument').value;
            const pl = parseFloat(document.getElementById('ct-pl').value);
            const note = document.getElementById('ct-note').value.trim();
            if (isNaN(pl) || pl === 0) { showToast('P/L eingeben', 'error'); return; }
            
            // Check if target was NOT reached before this trade
            const targetBefore = getDailyTarget();
            const todayLog = data.dailyLogs.find(l => l.date === getLocalDateString(new Date()));
            const intradayBefore = getIntradayPL();
            const plBefore = (todayLog ? todayLog.realizedPL : 0) + intradayBefore;
            const wasTargetReached = plBefore >= targetBefore;
            
            addClosedTrade(instrumentId || null, pl, note);
            
            // Check if target is NOW reached (and wasn't before)
            const intradayAfter = getIntradayPL();
            const plAfter = (todayLog ? todayLog.realizedPL : 0) + intradayAfter;
            if (!wasTargetReached && plAfter >= targetBefore && targetBefore > 0) {
                setTimeout(() => triggerConfetti(), 300);
            }
            
            closeModal('closed-trade-modal');
        }
        function renderClosedTrades() {
            const trades = getTodayClosedTrades();
            const totalPL = getIntradayPL();
            const content = trades.length > 0 
                ? `<div style="max-height:150px;overflow-y:auto;">${trades.map(t => {
                    const inst = t.instrumentId ? data.instruments[t.instrumentId] : null;
                    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);">
                        <div style="display:flex;align-items:center;gap:8px;">
                            ${inst ? ic(inst.icon, 18, inst.color) : ''}
                            <span style="font-size:0.85rem;">${inst?.symbol || t.note || 'Trade'}</span>
                            ${t.note && inst ? `<span class="text-muted" style="font-size:0.75rem;">${t.note}</span>` : ''}
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span class="${t.pl >= 0 ? 'text-green' : 'text-red'} font-bold">${t.pl >= 0 ? '+' : ''}${fmt(t.pl)}</span>
                            <button class="btn btn-sm btn-ghost" onclick="removeClosedTrade('${t.id}')" style="padding:2px 6px;font-size:0.7rem;">×</button>
                        </div>
                    </div>`;
                }).join('')}</div>
                <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);display:flex;justify-content:space-between;">
                    <span class="text-muted">${t('intradayRealized')}:</span>
                    <span class="${totalPL >= 0 ? 'text-green' : 'text-red'} font-bold">${totalPL >= 0 ? '+' : ''}${fmt(totalPL)}</span>
                </div>`
                : `<p class="text-muted" style="padding:10px 0;">${t('noClosedTrades')}</p>`;
            document.getElementById('dashboard-closed-trades').innerHTML = content;
            document.getElementById('positions-closed-trades').innerHTML = content;
            
            // Update entry tab hint
            const entryHint = document.getElementById('entry-intraday-hint');
            if (entryHint) {
                entryHint.innerHTML = trades.length > 0 
                    ? `<div class="card card-green mb-3" style="padding:10px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <span style="font-size:0.85rem;">${ic('check',16,'#10b981')} ${trades.length} Trade${trades.length > 1 ? 's' : ''} ${t('closedToday').toLowerCase()}</span>
                            <span class="${totalPL >= 0 ? 'text-green' : 'text-red'} font-bold">${totalPL >= 0 ? '+' : ''}${fmt(totalPL)}</span>
                        </div>
                    </div>`
                    : '';
            }
        }
        
        function openCalibrationModal(instrumentId) {
            const inst = data.instruments[instrumentId]; if (!inst) return;
            const baseLots = inst.baseLotSize || inst.defaultBaseLots || 1;
            const lotStep = inst.lotStep || 1;
            
            document.getElementById('calibration-content').innerHTML = `
                <div class="card card-gold mb-3">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                        ${ic(inst.icon,48,inst.color)}
                        <div>
                            <div class="font-bold" style="font-size:1.2rem;">${inst.symbol}</div>
                            <div class="text-muted">${inst.name}</div>
                        </div>
                        <button class="toggle-btn ${inst.isActive !== false ? 'active' : ''}" style="margin-left:auto;" onclick="toggleInstrumentActive('${instrumentId}'); openCalibrationModal('${instrumentId}');">
                            ${inst.isActive !== false ? t('active') : t('inactive')}
                        </button>
                    </div>
                    ${inst.isCalibrated ? `<div class="text-green" style="font-size:0.85rem;">✓ ${t('plFactor')}: ${fmtNum(inst.plFactor,4)} | ${t('lastCalibration')}: ${inst.lastCalibrated?formatDate(inst.lastCalibrated):'-'}</div>` : `<div class="text-orange" style="font-size:0.85rem;">${t('notCalibrated')}</div>`}
                </div>
                
                <!-- Lot Configuration Section -->
                <div class="card mb-3" style="background:var(--bg);">
                    <div class="card-title" style="font-size:0.85rem;margin-bottom:10px;">
                        ${ic('gold',16,inst.color)} ${t('lotConfiguration')}
                    </div>
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label style="font-size:0.8rem;">${t('baseLotSize')}</label>
                            <input type="number" id="cal-base-lots" class="form-input" value="${baseLots}" step="${lotStep}" min="${lotStep}">
                            <div style="font-size:0.7rem;color:var(--muted);">${t('lotStep')}: ${lotStep}</div>
                        </div>
                        <div class="form-group">
                            <label style="font-size:0.8rem;">${t('atBalance')}</label>
                            <input type="number" id="cal-base-balance" class="form-input" value="${data.settings.baseBalanceForLots || 15000}" readonly style="opacity:0.7;">
                            <div style="font-size:0.7rem;color:var(--muted);">${t('globalSetting')}</div>
                        </div>
                    </div>
                </div>
                
                <!-- P/L Factor Calibration Section -->
                <div style="font-size:0.85rem;color:var(--muted);margin-bottom:10px;">${t('plFactorCalibration')}:</div>
                <div class="grid grid-2">
                    <div class="form-group"><label>${t('size')}</label><input type="number" id="cal-size" class="form-input highlight" value="${inst.calibrationData?.size||inst.standardSize}" step="0.01"></div>
                    <div class="form-group"><label>${t('avgPriceShort')}</label><input type="number" id="cal-avg" class="form-input highlight" value="${inst.calibrationData?.avgPrice||''}" step="0.00001"></div>
                </div>
                <div class="grid grid-2">
                    <div class="form-group"><label>${t('lastPrice')}</label><input type="number" id="cal-last" class="form-input highlight" value="${inst.calibrationData?.lastPrice||''}" step="0.00001"></div>
                    <div class="form-group"><label>${t('unrealizedPL')}</label><input type="number" id="cal-pl" class="form-input highlight" value="${inst.calibrationData?.unrealizedPL||''}" step="0.01"></div>
                </div>
                <div class="card card-dark mb-3">
                    <div class="text-muted" style="font-size:0.8rem;">${t('calcFactor')}:</div>
                    <div id="cal-result" class="font-bold text-green" style="font-size:1.3rem;">---</div>
                    <div id="cal-pl-per-dollar" class="text-muted" style="font-size:0.85rem;"></div>
                </div>
                <button class="btn btn-success btn-block" onclick="saveCalibration('${instrumentId}')">${t('saveConfiguration')}</button>
                ${inst.isCustom ? `<button class="btn btn-danger btn-block mt-2" onclick="deleteCustomInstrument('${instrumentId}')">${t('deleteInstrument')}</button>` : ''}
            `;
            ['cal-size','cal-avg','cal-last','cal-pl'].forEach(id => document.getElementById(id)?.addEventListener('input', () => updateCalibrationPreview(instrumentId)));
            openModal('calibration-modal'); updateCalibrationPreview(instrumentId);
        }
        function updateCalibrationPreview(instrumentId) {
            const size = parseFloat(document.getElementById('cal-size').value)||0; const avg = parseFloat(document.getElementById('cal-avg').value)||0; const last = parseFloat(document.getElementById('cal-last').value)||0; const pl = parseFloat(document.getElementById('cal-pl').value)||0;
            const diff = last - avg; let factor = 0;
            if (Math.abs(diff) > 0.00001 && size > 0) factor = Math.abs(pl / (diff * size));
            const inst = data.instruments[instrumentId]; const plPerDollar = factor * (inst?.standardSize || size);
            document.getElementById('cal-result').textContent = factor > 0 ? fmtNum(factor, 4) + ' EUR/Unit/$1' : '---';
            document.getElementById('cal-pl-per-dollar').textContent = factor > 0 ? `${t('atSize')} ${inst?.standardSize||size}: ${fmt(plPerDollar)} ${t('perDollar')}` : '';
        }
        async function saveCalibration(instrumentId) {
            const size = parseFloat(document.getElementById('cal-size').value)||0; 
            const avgPrice = parseFloat(document.getElementById('cal-avg').value)||0; 
            const lastPrice = parseFloat(document.getElementById('cal-last').value)||0; 
            const unrealizedPL = parseFloat(document.getElementById('cal-pl').value)||0;
            const baseLots = parseFloat(document.getElementById('cal-base-lots').value) || 1;
            const inst = data.instruments[instrumentId];
            const lotStep = inst?.lotStep || 1;
            
            // Round baseLots to lotStep
            const roundedBaseLots = Math.max(lotStep, Math.round(baseLots / lotStep) * lotStep);
            
            const diff = lastPrice - avgPrice;
            let factor = inst?.plFactor || 0;
            
            // Only calculate factor if we have valid calibration data
            if (Math.abs(diff) > 0.00001 && size > 0) {
                factor = Math.abs(unrealizedPL / (diff * size));
            }
            
            data.instruments[instrumentId] = { 
                ...data.instruments[instrumentId], 
                plFactor: factor || inst?.plFactor, 
                isCalibrated: factor > 0 || inst?.isCalibrated,
                isActive: true,
                lastCalibrated: factor > 0 ? getLocalDateString(new Date()) : inst?.lastCalibrated, 
                baseLotSize: roundedBaseLots,
                calibrationData: factor > 0 ? { size, avgPrice, lastPrice, unrealizedPL, calculatedFactor: factor } : inst?.calibrationData
            };
            saveData(); render(); closeModal('calibration-modal'); 
            showToast(`${data.instruments[instrumentId].symbol}: ${factor > 0 ? t('calibrated') + ' (' + fmtNum(factor, 4) + ')' : ''} ${t('baseLots')}: ${roundedBaseLots}`);
        }
        
        // Custom Instrument Functions
        function openCustomInstrumentModal() {
            document.getElementById('ci-symbol').value = '';
            document.getElementById('ci-name').value = '';
            document.getElementById('ci-color').value = '#00d4aa';
            document.getElementById('ci-decimals').value = '2';
            document.getElementById('ci-lot-step').value = '1';
            document.getElementById('ci-base-lots').value = '1';
            document.getElementById('ci-standard-size').value = '1';
            openModal('custom-instrument-modal');
        }
        
        function saveCustomInstrument() {
            const symbol = document.getElementById('ci-symbol').value.trim().toUpperCase();
            const name = document.getElementById('ci-name').value.trim();
            const color = document.getElementById('ci-color').value;
            const priceDecimals = parseInt(document.getElementById('ci-decimals').value) || 2;
            const lotStep = parseFloat(document.getElementById('ci-lot-step').value) || 1;
            const baseLots = parseFloat(document.getElementById('ci-base-lots').value) || 1;
            const standardSize = parseFloat(document.getElementById('ci-standard-size').value) || 1;
            
            if (!symbol || !name) {
                showToast(t('symbolNameRequired'), 'error');
                return;
            }
            
            const id = 'custom_' + symbol.toLowerCase().replace(/[^a-z0-9]/g, '');
            
            if (data.instruments[id]) {
                showToast(t('instrumentExists'), 'error');
                return;
            }
            
            data.instruments[id] = {
                id,
                symbol,
                name,
                icon: 'stock',
                color,
                priceDecimals,
                calculationType: 'factor',
                standardSize,
                lotStep,
                defaultBaseLots: baseLots,
                baseLotSize: baseLots,
                isCustom: true,
                isActive: true,
                isCalibrated: false,
                plFactor: null,
                category: 'custom'
            };
            
            saveData();
            closeModal('custom-instrument-modal');
            switchInstrumentTab('custom');
            showToast(`${symbol} ${t('added')}`);
        }
        
        function deleteCustomInstrument(instrumentId) {
            const inst = data.instruments[instrumentId];
            if (!inst?.isCustom) return;
            
            if (!confirm(`${t('deleteInstrument')}: ${inst.symbol}?`)) return;
            
            // Remove any positions with this instrument
            data.positions = data.positions.filter(p => p.instrumentId !== instrumentId);
            
            delete data.instruments[instrumentId];
            saveData();
            closeModal('calibration-modal');
            render();
            showToast(`${inst.symbol} ${t('deleted')}`);
        }
        function exportData() { const exp = { ...data, exportDate: new Date().toISOString(), version: VERSION }; const blob = new Blob([JSON.stringify(exp, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `trading-tracker-backup-${getLocalDateString(new Date())}.json`; a.click(); URL.revokeObjectURL(url); showToast(t('backupCreated')); }
        
        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            let y = 20;
            
            // Farben
            const colors = {
                primary: [59, 130, 246],
                green: [16, 185, 129],
                gold: [251, 191, 36],
                red: [239, 68, 68],
                gray: [107, 114, 128],
                dark: [30, 39, 54],
                lightGray: [245, 247, 250]
            };
            
            // Helper
            const addLine = () => { doc.setDrawColor(...colors.gray); doc.line(20, y, pageWidth - 20, y); y += 5; };
            const checkPage = (needed = 30) => { if (y + needed > pageHeight - 20) { doc.addPage(); y = 20; } };
            const moodText = (mood) => { const m = { great: '++', good: '+', neutral: 'o', bad: '-' }; return m[mood] || 'o'; };
            // PDF Format mit Leerzeichen
            const fmtPDF = (n, d = 2) => 'EUR ' + (n||0).toLocaleString('de-DE', { minimumFractionDigits: d, maximumFractionDigits: d });
            
            // === HEADER ===
            doc.setFillColor(...colors.dark);
            doc.rect(0, 0, pageWidth, 45, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text('Trading Target Tracker', 20, 18);
            
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text('Performance Report', 20, 28);
            
            doc.setFontSize(10);
            doc.text(new Date().toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }), 20, 38);
            
            // Kontostand rechts
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...colors.green);
            doc.text(fmtPDF(getBalance()), pageWidth - 20, 25, { align: 'right' });
            doc.setFontSize(9);
            doc.setTextColor(200, 200, 200);
            doc.text('Kontostand', pageWidth - 20, 35, { align: 'right' });
            
            y = 55;
            
            // === ÜBERSICHT ===
            doc.setTextColor(...colors.dark);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('UBERSICHT', 20, y);
            y += 10;
            
            const balance = getBalance();
            const start = data.settings.startCapital;
            const total = balance - start;
            const totalPct = (total / start) * 100;
            
            // Boxen
            const boxWidth = (pageWidth - 50) / 3;
            const boxes = [
                { label: 'Startkapital', value: fmtPDF(start), color: colors.gray },
                { label: 'Aktueller Stand', value: fmtPDF(balance), color: colors.primary },
                { label: 'Gesamtgewinn', value: (total >= 0 ? '+' : '') + fmtPDF(total), color: total >= 0 ? colors.green : colors.red }
            ];
            
            boxes.forEach((box, i) => {
                const x = 20 + i * (boxWidth + 5);
                doc.setFillColor(...colors.lightGray);
                doc.roundedRect(x, y, boxWidth, 25, 3, 3, 'F');
                doc.setFontSize(8);
                doc.setTextColor(...colors.gray);
                doc.text(box.label, x + 5, y + 8);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...box.color);
                doc.text(box.value, x + 5, y + 19);
            });
            
            y += 35;
            
            // === EQUITY CURVE CHART ===
            const sortedLogs = [...data.dailyLogs].sort((a, b) => a.date.localeCompare(b.date));
            if (sortedLogs.length >= 2) {
                doc.setTextColor(...colors.dark);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('EQUITY CURVE', 20, y);
                y += 8;
                
                const chartX = 30;
                const chartY = y;
                const chartW = pageWidth - 60;
                const chartH = 40;
                
                // Chart Hintergrund
                doc.setFillColor(...colors.lightGray);
                doc.roundedRect(chartX - 5, chartY - 3, chartW + 10, chartH + 10, 3, 3, 'F');
                
                const values = sortedLogs.map(l => l.endingBalance);
                const minVal = Math.min(...values) * 0.995;
                const maxVal = Math.max(...values) * 1.005;
                const range = maxVal - minVal || 1;
                
                // Grid Linien
                doc.setDrawColor(220, 220, 220);
                doc.setLineWidth(0.2);
                for (let i = 0; i <= 3; i++) {
                    const gy = chartY + (chartH / 3) * i;
                    doc.line(chartX, gy, chartX + chartW, gy);
                }
                
                // Y-Achsen Labels
                doc.setFontSize(7);
                doc.setTextColor(...colors.gray);
                doc.text((maxVal/1000).toFixed(1) + 'k', chartX - 2, chartY + 3, { align: 'right' });
                doc.text((minVal/1000).toFixed(1) + 'k', chartX - 2, chartY + chartH, { align: 'right' });
                
                // Linie zeichnen
                const points = values.map((v, i) => ({
                    x: chartX + (i / (values.length - 1)) * chartW,
                    y: chartY + chartH - ((v - minVal) / range) * chartH
                }));
                
                // Fläche füllen
                doc.setFillColor(200, 240, 220);
                const areaPoints = [...points, {x: points[points.length-1].x, y: chartY + chartH}, {x: chartX, y: chartY + chartH}];
                doc.moveTo(areaPoints[0].x, areaPoints[0].y);
                for (let i = 1; i < areaPoints.length; i++) {
                    doc.lineTo(areaPoints[i].x, areaPoints[i].y);
                }
                doc.fill();
                
                // Linie
                doc.setDrawColor(...colors.green);
                doc.setLineWidth(1);
                for (let i = 1; i < points.length; i++) {
                    doc.line(points[i-1].x, points[i-1].y, points[i].x, points[i].y);
                }
                
                // Punkte
                doc.setFillColor(...colors.green);
                [points[0], points[points.length-1]].forEach(p => {
                    doc.circle(p.x, p.y, 2, 'F');
                });
                
                y += chartH + 15;
            }
            
            // === P/L BALKENDIAGRAMM (letzte 7 Tage) ===
            const last7 = sortedLogs.slice(-7);
            if (last7.length > 0) {
                doc.setTextColor(...colors.dark);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(t('plLast7Days').toUpperCase(), 20, y);
                y += 8;
                
                const barChartX = 30;
                const barChartY = y;
                const barChartW = pageWidth - 60;
                const barChartH = 30;
                const barWidth = (barChartW - 10) / last7.length - 3;
                
                // Hintergrund
                doc.setFillColor(...colors.lightGray);
                doc.roundedRect(barChartX - 5, barChartY - 3, barChartW + 10, barChartH + 18, 3, 3, 'F');
                
                const pls = last7.map(l => l.realizedPL || 0);
                const maxPL = Math.max(...pls.map(Math.abs), 1);
                
                // Nulllinie
                const zeroY = barChartY + barChartH / 2;
                doc.setDrawColor(...colors.gray);
                doc.setLineWidth(0.3);
                doc.line(barChartX, zeroY, barChartX + barChartW, zeroY);
                
                // Balken
                last7.forEach((log, i) => {
                    const pl = log.realizedPL || 0;
                    const barH = (Math.abs(pl) / maxPL) * (barChartH / 2 - 2);
                    const x = barChartX + 5 + i * (barWidth + 3);
                    const barY = pl >= 0 ? zeroY - barH : zeroY;
                    
                    doc.setFillColor(...(pl >= 0 ? colors.green : colors.red));
                    doc.roundedRect(x, barY, barWidth, Math.max(barH, 1), 1, 1, 'F');
                    
                    // Label
                    doc.setFontSize(6);
                    doc.setTextColor(...colors.gray);
                    const d = new Date(log.date + 'T12:00:00');
                    const label = d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
                    doc.text(label, x + barWidth/2, barChartY + barChartH + 8, { align: 'center' });
                    
                    // Wert
                    doc.setFontSize(5);
                    doc.setTextColor(...(pl >= 0 ? colors.green : colors.red));
                    doc.text((pl >= 0 ? '+' : '') + Math.round(pl), x + barWidth/2, pl >= 0 ? barY - 1 : barY + barH + 4, { align: 'center' });
                });
                
                y += barChartH + 22;
            }
            
            addLine();
            y += 3;
            
            // === STATISTIKEN ===
            doc.setTextColor(...colors.dark);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(t('statistics').toUpperCase(), 20, y);
            y += 10;
            
            const profit = data.dailyLogs.filter(l => l.realizedPL > 0).length;
            const loss = data.dailyLogs.filter(l => l.realizedPL < 0).length;
            const winRate = data.dailyLogs.length > 0 ? (profit / data.dailyLogs.length) * 100 : 0;
            const avgPL = data.dailyLogs.length > 0 ? data.dailyLogs.reduce((s, l) => s + (l.realizedPL || 0), 0) / data.dailyLogs.length : 0;
            const targetHits = data.dailyLogs.filter(l => l.targetHit).length;
            
            const stats = [
                [t('tradingDays'), data.dailyLogs.length.toString()],
                [t('profitDays'), profit.toString()],
                [t('lossDays'), loss.toString()],
                [t('winRate'), fmtPct(winRate)],
                [t('avgDailyPL'), fmtPDF(avgPL)],
                [t('targetHit'), targetHits + '/' + data.dailyLogs.length]
            ];
            
            doc.setFontSize(10);
            stats.forEach((stat, i) => {
                const x = 20 + (i % 3) * 63;
                const row = Math.floor(i / 3);
                doc.setTextColor(...colors.gray);
                doc.setFont('helvetica', 'normal');
                doc.text(stat[0] + ':', x, y + row * 10);
                doc.setTextColor(...colors.dark);
                doc.setFont('helvetica', 'bold');
                doc.text(stat[1], x + 30, y + row * 10);
            });
            
            y += 25;
            addLine();
            y += 3;
            
            // === ZIEL-PROJEKTION ===
            checkPage(40);
            doc.setTextColor(...colors.dark);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(t('projection').toUpperCase(), 20, y);
            y += 10;
            
            const targetCap = data.settings.targetCapital;
            const dailyRate = data.settings.dailyTargetPercent / 100;
            const daysToTarget = balance > 0 && dailyRate > 0 ? Math.ceil(Math.log(targetCap / balance) / Math.log(1 + dailyRate)) : 0;
            const progressPct = (balance / targetCap) * 100;
            
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(...colors.gray);
            doc.text(t('targetCapital') + ': ' + fmtPDF(targetCap), 20, y);
            doc.text(t('dailyTarget') + ': ' + fmtPct(data.settings.dailyTargetPercent), 80, y);
            doc.text(t('remaining') + ': ~' + daysToTarget + ' ' + t('days') + ' (' + (daysToTarget / 21).toFixed(1) + ' ' + t('months') + ')', 125, y);
            y += 8;
            
            // Progress Bar
            doc.setFillColor(230, 230, 230);
            doc.roundedRect(20, y, pageWidth - 40, 6, 2, 2, 'F');
            doc.setFillColor(...colors.green);
            doc.roundedRect(20, y, (pageWidth - 40) * Math.min(progressPct / 100, 1), 6, 2, 2, 'F');
            doc.setFontSize(7);
            doc.setTextColor(...colors.dark);
            doc.text(fmtPct(progressPct), pageWidth - 20, y + 5, { align: 'right' });
            
            y += 15;
            addLine();
            y += 3;
            
            // === LETZTE EINTRÄGE ===
            checkPage(60);
            doc.setTextColor(...colors.dark);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text('LETZTE EINTRAGE', 20, y);
            y += 8;
            
            const recentLogs = [...data.dailyLogs].sort((a, b) => b.date.localeCompare(a.date)).slice(0, 8);
            
            if (recentLogs.length > 0) {
                // Header
                doc.setFillColor(...colors.lightGray);
                doc.rect(20, y, pageWidth - 40, 7, 'F');
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(...colors.gray);
                doc.text(t('date'), 25, y + 5);
                doc.text('Kontostand', 55, y + 5);
                doc.text(t('pl'), 105, y + 5);
                doc.text('Ziel', 145, y + 5);
                doc.text('Stimmung', 165, y + 5);
                y += 9;
                
                // Rows
                doc.setFont('helvetica', 'normal');
                recentLogs.forEach(log => {
                    checkPage(8);
                    doc.setTextColor(...colors.dark);
                    doc.setFontSize(8);
                    doc.text(formatDate(log.date), 25, y + 4);
                    doc.text(fmtPDF(log.endingBalance), 55, y + 4);
                    doc.setTextColor(...(log.realizedPL >= 0 ? colors.green : colors.red));
                    doc.text((log.realizedPL >= 0 ? '+' : '') + fmtPDF(log.realizedPL), 105, y + 4);
                    doc.setTextColor(...(log.targetHit ? colors.green : colors.red));
                    doc.text(log.targetHit ? 'JA' : 'NEIN', 148, y + 4);
                    doc.setTextColor(...colors.dark);
                    doc.text(moodText(log.mood), 172, y + 4);
                    y += 7;
                });
            }
            
            y += 3;
            
            // === OFFENE POSITIONEN ===
            const activePos = data.positions.filter(p => p.active);
            if (activePos.length > 0) {
                checkPage(40);
                addLine();
                y += 3;
                
                doc.setTextColor(...colors.dark);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text('OFFENE POSITIONEN', 20, y);
                y += 10;
                
                activePos.forEach(pos => {
                    const inst = data.instruments[pos.instrumentId];
                    const pl = calculatePL(pos);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(...colors.dark);
                    doc.text((inst?.symbol || pos.instrumentId) + ' - ' + pos.size + ' x ' + pos.direction.toUpperCase(), 25, y + 4);
                    doc.setTextColor(...(pl >= 0 ? colors.green : colors.red));
                    doc.text((pl >= 0 ? '+' : '') + fmtPDF(pl), 140, y + 4);
                    y += 8;
                });
            }
            
            // === FOOTER ===
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(7);
                doc.setTextColor(...colors.gray);
                doc.text('TargetTrader v' + VERSION + ' | ' + new Date().toLocaleString('de-DE'), 20, pageHeight - 10);
                doc.text('Seite ' + i + '/' + totalPages, pageWidth - 20, pageHeight - 10, { align: 'right' });
            }
            
            // Speichern
            const filename = 'Trading-Report-' + getLocalDateString(new Date()) + '.pdf';
            doc.save(filename);
            showToast('PDF erstellt: ' + filename);
        }
        function importData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const imported = JSON.parse(e.target.result); if (!imported.version) { showToast('Ungültige Datei', 'error'); return; } if (!confirm('Alle Daten überschreiben?')) return; data = deepMerge(DEFAULT_DATA, imported); saveData(); render(); showToast(t('imported')); } catch (err) { showToast('Fehler', 'error'); } }; reader.readAsText(file); event.target.value = ''; }
        function resetAllData() { if (!confirm('ALLE DATEN LÖSCHEN?')) return; if (!confirm('Wirklich sicher?')) return; localStorage.removeItem(STORAGE_KEY); data = JSON.parse(JSON.stringify(DEFAULT_DATA)); initializeInstruments(); saveData(); render(); showToast(t('deleted')); }
        function openUserMenu() {
            document.getElementById('user-modal-content').innerHTML = currentUser ? `<div class="text-center mb-3"><div class="user-avatar" style="width:60px;height:60px;font-size:1.5rem;margin:0 auto 12px;">${(currentUser.user_metadata?.full_name||currentUser.email||'?').charAt(0).toUpperCase()}</div><div class="font-bold">${currentUser.user_metadata?.full_name||'User'}</div><div class="text-muted" style="font-size:0.85rem;">${currentUser.email}</div></div><div class="card card-dark mb-3"><div style="display:flex;align-items:center;gap:8px;"><div class="sync-dot ${isOnline?'online':'offline'}"></div><span>${isOnline?'Cloud verbunden':'Offline'}</span></div></div><button class="btn btn-danger btn-block" onclick="logout()">Abmelden</button>` : `<div class="text-center mb-3"><div class="text-muted">Offline-Modus</div></div><button class="btn btn-primary btn-block" onclick="closeModal('user-modal');showAuthScreen();">${ic('cloud',16)} Anmelden</button>`;
            openModal('user-modal');
        }

        // ============================================================
        // HELPERS
        // ============================================================
        function openModal(id) { document.getElementById(id).classList.add('show'); }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        function showToast(msg, type = 'success') { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast show ' + type; setTimeout(() => t.className = 'toast', 3000); }
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme === 'dark' ? '' : 'light');
            document.getElementById('theme-btn').innerHTML = newTheme === 'light' ? '<span class="i i-20">'+I.moon+'</span>' : '<span class="i i-20">'+I.sun+'</span>';
            localStorage.setItem('theme', newTheme);
        }
        function loadTheme() {
            const saved = localStorage.getItem('theme') || 'dark';
            if (saved === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                const btn = document.getElementById('theme-btn');
                if (btn) btn.innerHTML = '<span class="i i-20">'+I.moon+'</span>';
            }
        }

        // ============================================================
        // EVENT LISTENERS
        // ============================================================
        document.querySelectorAll('.tab').forEach(tab => { tab.addEventListener('click', () => { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); tab.classList.add('active'); document.getElementById(tab.dataset.tab).classList.add('active'); }); });
        document.getElementById('entry-balance')?.addEventListener('input', function() {
            const newBalance = parseFloat(this.value); const preview = document.getElementById('entry-preview');
            if (newBalance) { const prevBalance = getBalance(); const pl = newBalance - prevBalance; const target = getDailyTarget(); const variance = pl - target; const variancePct = (variance / target) * 100;
            preview.classList.remove('hidden'); preview.innerHTML = `<div class="card-title">${ic('eye',20,'var(--accent)')} ${t('preview')}</div><div class="grid grid-4 text-center"><div><div class="stat-label">${t('current')}</div><div class="font-bold">${fmt(prevBalance)}</div></div><div><div class="stat-label">${t('new')}</div><div class="font-bold">${fmt(newBalance)}</div></div><div><div class="stat-label">${t('pl')}</div><div class="font-bold ${pl>=0?'text-green':'text-red'}">${pl>=0?'+':''}${fmt(pl)}</div></div><div><div class="stat-label">${t('vsTarget')}</div><div class="font-bold ${variance>=0?'text-green':'text-orange'}">${variance>=0?'+':''}${fmtPct(variancePct)}</div></div></div><div class="text-center mt-2">${pl>=target?`<span class="text-green font-bold">${ic('check',16,'#10b981')} ${t('targetReachedYes')}</span>`:`<span class="text-orange">${ic('warn',16,'#fbbf24')} ${t('target')}: ${fmt(target)}</span>`}</div>`; } else { preview.classList.add('hidden'); }
        });
        document.querySelectorAll('.modal-overlay').forEach(overlay => { overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('show'); }); });

        // ============================================================
        // SERVICE WORKER & PWA INSTALL
        // ============================================================
        let swRegistration = null;
        let swUpdateAvailable = false;
        let deferredInstallPrompt = null;
        
        async function registerServiceWorker() {
            if (!('serviceWorker' in navigator)) return;
            try {
                swRegistration = await navigator.serviceWorker.register('./sw.js');
                console.log('SW registered:', swRegistration.scope);
                swRegistration.addEventListener('updatefound', () => {
                    const newWorker = swRegistration.installing;
                    newWorker.addEventListener('statechange', () => {
                        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            swUpdateAvailable = true;
                            showUpdateNotification();
                        }
                    });
                });
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (swUpdateAvailable) window.location.reload();
                });
            } catch (error) { console.error('SW registration failed:', error); }
        }
        
        function showUpdateNotification() {
            const existing = document.getElementById('sw-update-banner');
            if (existing) existing.remove();
            const banner = document.createElement('div');
            banner.id = 'sw-update-banner';
            banner.innerHTML = `<div style="position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--card);border:1px solid var(--accent);border-radius:12px;padding:12px 20px;display:flex;align-items:center;gap:12px;z-index:10000;box-shadow:0 4px 20px rgba(0,0,0,0.3);max-width:90%;animation:slideUp 0.3s ease;"><span style="font-size:1.2rem;">🔄</span><span style="color:var(--text);font-size:0.9rem;">${t('updateAvailable') || 'Neue Version verfügbar!'}</span><button onclick="applyUpdate()" style="background:var(--accent);color:#0f1419;border:none;padding:8px 16px;border-radius:8px;font-weight:600;cursor:pointer;font-size:0.85rem;">${t('update') || 'Aktualisieren'}</button><button onclick="dismissUpdate()" style="background:transparent;color:var(--muted);border:none;padding:8px;cursor:pointer;font-size:1rem;">✕</button></div>`;
            document.body.appendChild(banner);
        }
        
        function applyUpdate() {
            if (swRegistration && swRegistration.waiting) swRegistration.waiting.postMessage({ type: 'SKIP_WAITING' });
            dismissUpdate();
        }
        
        function dismissUpdate() {
            const banner = document.getElementById('sw-update-banner');
            if (banner) banner.remove();
        }
        
        // PWA Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredInstallPrompt = e;
            const dismissed = localStorage.getItem('pwa-install-dismissed');
            if (dismissed) {
                const daysSince = (Date.now() - new Date(dismissed).getTime()) / (1000 * 60 * 60 * 24);
                if (daysSince < 7) return;
            }
            let visitCount = parseInt(localStorage.getItem('pwa-visit-count') || '0') + 1;
            localStorage.setItem('pwa-visit-count', visitCount.toString());
            if (visitCount >= 2) setTimeout(() => showInstallBanner(), 2000);
        });
        
        function showInstallBanner() {
            if (!deferredInstallPrompt) return;
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) return;
            const existing = document.getElementById('pwa-install-banner');
            if (existing) existing.remove();
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const banner = document.createElement('div');
            banner.id = 'pwa-install-banner';
            banner.innerHTML = `<div style="position:fixed;bottom:0;left:0;right:0;background:linear-gradient(135deg,var(--card),#1a2332);border-top:2px solid var(--accent);padding:16px 20px;z-index:9999;animation:slideUp 0.3s ease;padding-bottom:calc(16px + var(--safe-bottom,0px));"><div style="max-width:600px;margin:0 auto;display:flex;align-items:center;gap:16px;"><div style="width:48px;height:48px;background:var(--bg);border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;"><svg width="32" height="32" viewBox="0 0 64 64" fill="none"><circle cx="32" cy="32" r="28" stroke="#00d4aa" stroke-width="2"/><circle cx="32" cy="32" r="4" fill="#00d4aa"/><line x1="32" y1="4" x2="32" y2="12" stroke="#00d4aa" stroke-width="2.5"/><line x1="32" y1="52" x2="32" y2="60" stroke="#00d4aa" stroke-width="2.5"/><line x1="4" y1="32" x2="12" y2="32" stroke="#00d4aa" stroke-width="2.5"/><line x1="52" y1="32" x2="60" y2="32" stroke="#00d4aa" stroke-width="2.5"/></svg></div><div style="flex:1;min-width:0;"><div style="font-weight:600;color:var(--text);font-size:0.95rem;">${t('installApp') || 'TargetTrader installieren'}</div><div style="color:var(--muted);font-size:0.8rem;margin-top:2px;">${isIOS ? (t('installIosHint') || 'Tippe auf Teilen ⬆ dann "Zum Home-Bildschirm"') : (t('installAppDesc') || 'Schneller Zugriff vom Homescreen')}</div></div><div style="display:flex;gap:8px;flex-shrink:0;">${isIOS ? '' : `<button onclick="triggerInstall()" style="background:var(--accent);color:#0f1419;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;font-size:0.85rem;">${t('install') || 'Installieren'}</button>`}<button onclick="dismissInstallBanner()" style="background:var(--bg);color:var(--muted);border:1px solid var(--border);padding:10px 16px;border-radius:8px;cursor:pointer;font-size:0.85rem;">${t('later') || 'Später'}</button></div></div></div>`;
            document.body.appendChild(banner);
            if (!document.getElementById('pwa-banner-style')) {
                const style = document.createElement('style');
                style.id = 'pwa-banner-style';
                style.textContent = '@keyframes slideUp{from{opacity:0;transform:translateY(100%)}to{opacity:1;transform:translateY(0)}}';
                document.head.appendChild(style);
            }
        }
        
        async function triggerInstall() {
            if (!deferredInstallPrompt) return;
            deferredInstallPrompt.prompt();
            const { outcome } = await deferredInstallPrompt.userChoice;
            if (outcome === 'accepted') { showToast('🎉 App installiert!', 'success'); localStorage.removeItem('pwa-visit-count'); }
            deferredInstallPrompt = null;
            dismissInstallBanner();
        }
        
        function dismissInstallBanner() {
            const banner = document.getElementById('pwa-install-banner');
            if (banner) { banner.style.animation = 'slideDown 0.3s ease forwards'; setTimeout(() => banner.remove(), 300); }
            localStorage.setItem('pwa-install-dismissed', new Date().toISOString());
        }
        
        window.addEventListener('appinstalled', () => { deferredInstallPrompt = null; dismissInstallBanner(); });
        
        // ============================================================
        // KEYBOARD SHORTCUTS
        // ============================================================
        const SHORTCUTS = {
            'n': { action: () => openClosedTradeModal(), desc: 'Neuer Trade' },
            'p': { action: () => openAddPositionModal(), desc: 'Neue Position' },
            'd': { action: () => switchTab('dashboard'), desc: 'Dashboard' },
            'o': { action: () => switchTab('positions'), desc: 'Positionen' },
            'i': { action: () => switchTab('instruments'), desc: 'Instrumente' },
            'h': { action: () => switchTab('history'), desc: 'Historie' },
            's': { action: () => switchTab('settings'), desc: 'Einstellungen' },
            'Escape': { action: () => closeAllModals(), desc: 'Modal schließen' },
            '?': { action: () => showShortcutHelp(), desc: 'Hilfe' }
        };
        
        document.addEventListener('keydown', (e) => {
            if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) return;
            if (e.ctrlKey || e.altKey || e.metaKey) return;
            const shortcut = SHORTCUTS[e.key];
            if (shortcut) { e.preventDefault(); shortcut.action(); }
        });
        
        function closeAllModals() {
            document.querySelectorAll('.modal-overlay.show').forEach(m => m.classList.remove('show'));
        }
        
        function showShortcutHelp() {
            const shortcuts = [
                ['N', t('addClosedTrade') || 'Neuer Trade'],
                ['P', t('addPosition') || 'Neue Position'],
                ['D', t('tabDashboard') || 'Dashboard'],
                ['O', t('tabPositions') || 'Positionen'],
                ['I', t('tabInstruments') || 'Instrumente'],
                ['H', t('tabHistory') || 'Historie'],
                ['S', t('tabSettings') || 'Einstellungen'],
                ['ESC', t('close') || 'Modal schließen'],
                ['?', t('help') || 'Diese Hilfe']
            ];
            const html = `<div class="modal-header"><h3 class="modal-title">⌨️ ${t('keyboardShortcuts') || 'Tastaturkürzel'}</h3><button class="modal-close" onclick="closeModal('shortcut-modal')">×</button></div><div style="display:grid;gap:8px;">${shortcuts.map(([key, desc]) => `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--bg);border-radius:8px;"><span style="color:var(--muted);font-size:0.9rem;">${desc}</span><kbd style="background:var(--card);border:1px solid var(--border);padding:4px 10px;border-radius:6px;font-family:monospace;font-size:0.85rem;color:var(--accent);">${key}</kbd></div>`).join('')}</div>`;
            let modal = document.getElementById('shortcut-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'shortcut-modal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `<div class="modal" style="max-width:360px;">${html}</div>`;
                modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('show'); });
                document.body.appendChild(modal);
            } else {
                modal.querySelector('.modal').innerHTML = html;
            }
            modal.classList.add('show');
        }
        
        // ============================================================
        // CONFETTI ANIMATION
        // ============================================================
        function triggerConfetti() {
            const today = getLocalDateString(new Date());
            if (localStorage.getItem('confetti-date') === today) return;
            localStorage.setItem('confetti-date', today);
            
            const canvas = document.createElement('canvas');
            canvas.id = 'confetti-canvas';
            canvas.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:99999';
            document.body.appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const colors = ['#00d4aa', '#fbbf24', '#3b82f6', '#10b981', '#ef4444', '#8b5cf6'];
            const particles = [];
            
            for (let i = 0; i < 150; i++) {
                particles.push({
                    x: canvas.width / 2 + (Math.random() - 0.5) * 200,
                    y: canvas.height / 2,
                    vx: (Math.random() - 0.5) * 15,
                    vy: Math.random() * -20 - 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 8 + 4,
                    rotation: Math.random() * 360,
                    rotationSpeed: (Math.random() - 0.5) * 10
                });
            }
            
            let frame = 0;
            const maxFrames = 180;
            
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => {
                    p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.rotation += p.rotationSpeed; p.vx *= 0.99;
                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rotation * Math.PI / 180);
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = Math.max(0, 1 - frame / maxFrames);
                    ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size * 0.6);
                    ctx.restore();
                });
                frame++;
                if (frame < maxFrames) requestAnimationFrame(animate);
                else canvas.remove();
            }
            animate();
            showToast('🎯 ' + (t('targetReached') || 'Tagesziel erreicht!'), 'success');
        }
        
        // Register SW on load
        registerServiceWorker();
        
        // ============================================================
        // INIT
        // ============================================================
        init();
    </script>
</body>
</html>
