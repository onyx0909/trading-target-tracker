<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Trading Tracker">
    <meta name="theme-color" content="#0f1419">
    <title>Trading Target Tracker</title>
    
    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/icon_dark_16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/icon_dark_32.png">
    <link rel="icon" type="image/png" sizes="48x48" href="assets/icon_dark_48.png">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        :root{--bg:#0f1419;--card:#1e2736;--card-hover:#252f3f;--border:#2d3748;--text:#fff;--muted:#9ca3af;--dark:#6b7280;--blue:#3b82f6;--green:#10b981;--gold:#fbbf24;--red:#ef4444;--orange:#f59e0b;--purple:#8b5cf6;--header-bg:linear-gradient(135deg,#1e2736,#1a2332);--safe-top:env(safe-area-inset-top);--safe-bottom:env(safe-area-inset-bottom)}
        [data-theme="light"]{--bg:#f8fafc;--card:#ffffff;--card-hover:#f1f5f9;--border:#e2e8f0;--text:#1e293b;--muted:#64748b;--dark:#94a3b8;--header-bg:linear-gradient(135deg,#ffffff,#f1f5f9)}
        [data-theme="light"] .header{border-color:#cbd5e1;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1)}
        [data-theme="light"] .header-brand h1{background:linear-gradient(90deg,#0369a1,#059669);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        [data-theme="light"] .sl-tp-box.stop{background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff}
        [data-theme="light"] .sl-tp-box.tp{background:linear-gradient(135deg,#16a34a,#15803d);color:#fff}
        [data-theme="light"] .sl-tp-box.target{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff}
        [data-theme="light"] .sl-tp-label{color:rgba(255,255,255,0.9)}
        [data-theme="light"] .sl-tp-value{color:#fff}
        [data-theme="light"] .sl-tp-dist{color:rgba(255,255,255,0.8)}
        [data-theme="light"] .tab.active{background:#0284c7}
        [data-theme="light"] .card-blue{border-color:#0284c7;background:linear-gradient(135deg,rgba(2,132,199,0.1),transparent)}
        [data-theme="light"] .card-green{border-color:#059669;background:linear-gradient(135deg,rgba(5,150,105,0.1),transparent)}
        [data-theme="light"] .card-gold{border-color:#d97706;background:linear-gradient(135deg,rgba(217,119,6,0.1),transparent)}
        [data-theme="light"] .card-purple{border-color:#7c3aed;background:linear-gradient(135deg,rgba(124,58,237,0.1),transparent)}
        [data-theme="light"] .week-day{background:#f8fafc}
        [data-theme="light"] .circle-progress .bg{stroke:#e2e8f0}
        body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:12px;padding-top:calc(12px + var(--safe-top));padding-bottom:calc(80px + var(--safe-bottom))}
        .container{max-width:1200px;margin:0 auto}
        .header{background:var(--header-bg);border-radius:16px;padding:16px 20px;margin-bottom:16px;border:1px solid var(--blue);display:grid;grid-template-columns:auto 1fr auto;gap:20px;align-items:center}
        .header-left{display:flex;align-items:center;gap:12px}
        .header-left img{width:48px;height:48px}
        .header-brand h1{font-size:1.1rem;font-weight:700;background:linear-gradient(90deg,var(--gold),var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent;line-height:1.2}
        .header-brand p{color:var(--muted);font-size:0.7rem;margin-top:2px}
        .header-center{text-align:center}
        .header-date{color:var(--text);font-size:1rem;font-weight:600}
        .header-separator{height:2px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:8px 0}
        .header-right{display:flex;align-items:center;gap:12px;justify-content:flex-end}
        .header-balance{color:var(--green);font-size:1.2rem;font-weight:700}
        .header-balance-sub{color:var(--muted);font-size:0.7rem}
        .sync-status{display:flex;align-items:center;gap:6px;font-size:0.75rem;color:var(--muted)}
        .sync-dot{width:8px;height:8px;border-radius:50%}
        .sync-dot.online{background:var(--green)}
        .sync-dot.offline{background:var(--orange)}
        .sync-dot.syncing{background:var(--blue);animation:pulse 1s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .theme-toggle{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px;cursor:pointer;font-size:1rem;transition:all 0.2s}
        .theme-toggle:hover{background:var(--card-hover)}
        .user-badge{display:flex;align-items:center;gap:8px;background:var(--card);padding:6px 12px;border-radius:20px;font-size:0.8rem;cursor:pointer;border:1px solid var(--border)}
        .user-badge:hover{background:var(--card-hover)}
        .user-avatar{width:24px;height:24px;border-radius:50%;background:var(--blue);display:flex;align-items:center;justify-content:center;font-size:0.7rem}
        .tabs{display:flex;gap:6px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px}
        .tabs::-webkit-scrollbar{display:none}
        .tab{padding:10px 14px;background:var(--card);border:1px solid var(--border);border-radius:10px;color:var(--muted);cursor:pointer;font-weight:500;font-size:0.8rem;white-space:nowrap;transition:all 0.2s}
        .tab:hover{background:var(--card-hover)}
        .tab.active{background:var(--blue);color:white;border-color:var(--blue)}
        .tab-content{display:none;animation:fadeIn 0.3s}
        .tab-content.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .grid{display:grid;gap:12px;margin-bottom:12px}
        .grid-2{grid-template-columns:repeat(2,1fr)}
        .grid-3{grid-template-columns:repeat(3,1fr)}
        .grid-4{grid-template-columns:repeat(4,1fr)}
        .card{background:var(--card);border-radius:12px;padding:16px;border:1px solid var(--border);margin-bottom:12px}
        .card-dark{background:var(--bg)}
        .card-blue{border-color:var(--blue);background:linear-gradient(135deg,rgba(59,130,246,0.1),transparent)}
        .card-gold{border-color:var(--gold);background:linear-gradient(135deg,rgba(251,191,36,0.1),transparent)}
        .card-green{border-color:var(--green);background:linear-gradient(135deg,rgba(16,185,129,0.1),transparent)}
        .card-red{border-color:var(--red);background:linear-gradient(135deg,rgba(239,68,68,0.1),transparent)}
        .card-purple{border-color:var(--purple);background:linear-gradient(135deg,rgba(139,92,246,0.1),transparent)}
        .card-title{font-size:0.85rem;color:var(--muted);margin-bottom:12px;display:flex;align-items:center;gap:8px}
        .card-title span{font-size:1rem}
        .stat-box{text-align:center;padding:12px 8px}
        .stat-label{color:var(--muted);font-size:0.7rem;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.5px}
        .stat-value{font-size:1.15rem;font-weight:700}
        .stat-sub{color:var(--dark);font-size:0.7rem;margin-top:2px}
        .form-group{margin-bottom:14px}
        .form-group label{display:block;color:var(--muted);font-size:0.8rem;margin-bottom:6px;font-weight:500}
        .form-input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 12px;color:var(--text);font-size:0.9rem;transition:border-color 0.2s}
        .form-input:focus{outline:none;border-color:var(--blue)}
        .form-input.highlight{border-color:var(--gold);background:rgba(251,191,36,0.05)}
        .form-error{color:var(--red);font-size:0.75rem;margin-top:4px}
        select.form-input{cursor:pointer}
        .btn{padding:10px 20px;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:0.9rem;transition:all 0.2s;display:inline-flex;align-items:center;justify-content:center;gap:6px}
        .btn:active{transform:scale(0.98)}
        .btn:disabled{opacity:0.6;cursor:not-allowed}
        .btn-primary{background:var(--blue);color:white}
        .btn-primary:hover:not(:disabled){background:#2563eb}
        .btn-success{background:var(--green);color:white}
        .btn-danger{background:var(--red);color:white}
        .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--muted)}
        .btn-sm{padding:6px 12px;font-size:0.8rem}
        .btn-block{width:100%}
        .btn-add{width:100%;padding:14px;background:var(--card);border:2px dashed var(--border);color:var(--muted);font-size:0.9rem}
        .btn-add:hover{border-color:var(--blue);color:var(--blue)}
        .auth-container{max-width:400px;margin:60px auto;padding:0 20px}
        .auth-card{background:var(--card);border-radius:16px;padding:32px;border:1px solid var(--border);text-align:center}
        .auth-logo{font-size:3rem;margin-bottom:16px}
        .auth-title{font-size:1.5rem;font-weight:700;margin-bottom:8px}
        .auth-subtitle{color:var(--muted);font-size:0.9rem;margin-bottom:24px}
        .auth-tabs{display:flex;margin-bottom:24px;background:var(--bg);border-radius:8px;padding:4px}
        .auth-tab{flex:1;padding:10px;background:none;border:none;color:var(--muted);cursor:pointer;border-radius:6px;font-weight:500}
        .auth-tab.active{background:var(--blue);color:white}
        .auth-divider{display:flex;align-items:center;gap:12px;margin:20px 0;color:var(--muted);font-size:0.8rem}
        .auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border)}
        .auth-footer{margin-top:20px;font-size:0.8rem;color:var(--muted)}
        .auth-footer a{color:var(--blue);text-decoration:none}
        .btn-google{background:white;color:#333;border:1px solid #ddd;width:100%;display:flex;align-items:center;justify-content:center;gap:10px}
        .btn-google:hover{background:#f5f5f5}
        .btn-google svg{width:18px;height:18px}
        .rec-card{padding:14px;margin-bottom:10px;border-radius:10px;position:relative}
        .rec-card.medium{background:linear-gradient(135deg,rgba(251,191,36,0.15),rgba(251,191,36,0.05));border:1px solid var(--gold)}
        .rec-card.info{background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(16,185,129,0.05));border:1px solid var(--green)}
        .rec-card.low{background:linear-gradient(135deg,rgba(59,130,246,0.15),rgba(59,130,246,0.05));border:1px solid var(--blue)}
        .rec-header{display:flex;align-items:center;gap:10px;margin-bottom:6px}
        .rec-icon{font-size:1.3rem}
        .rec-title{font-weight:600;font-size:0.95rem}
        .rec-message{color:var(--muted);font-size:0.85rem;line-height:1.4}
        .rec-dismiss{position:absolute;top:10px;right:10px;background:none;border:none;color:var(--dark);cursor:pointer;font-size:1.1rem}
        .week-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin:12px 0}
        .week-day{text-align:center;padding:10px 6px;background:var(--bg);border-radius:8px;border:1px solid var(--border)}
        .week-day.today{border-color:var(--blue)}
        .week-day.profit{border-color:var(--green);background:rgba(16,185,129,0.1)}
        .week-day.loss{border-color:var(--red);background:rgba(239,68,68,0.1)}
        .week-day-name{font-size:0.7rem;color:var(--dark);margin-bottom:4px}
        .week-day-value{font-size:0.9rem;font-weight:600}
        .week-day-value.positive{color:var(--green)}
        .week-day-value.negative{color:var(--red)}
        .week-day-value.empty{color:var(--dark)}
        .progress-container{margin:12px 0}
        .progress-header{display:flex;justify-content:space-between;margin-bottom:6px;font-size:0.8rem}
        .progress-bar{background:var(--bg);border-radius:10px;height:12px;overflow:hidden;border:1px solid var(--border)}
        .progress-fill{height:100%;border-radius:10px;transition:width 0.5s ease}
        .progress-fill.green{background:linear-gradient(90deg,var(--green),#34d399)}
        .progress-fill.blue{background:linear-gradient(90deg,var(--blue),#60a5fa)}
        .progress-fill.gold{background:linear-gradient(90deg,var(--gold),#fcd34d)}
        .circle-progress{position:relative;width:120px;height:120px;margin:0 auto}
        .circle-progress svg{transform:rotate(-90deg);width:120px;height:120px}
        .circle-progress .bg{fill:none;stroke:var(--border);stroke-width:10}
        .circle-progress .progress{fill:none;stroke-width:10;stroke-linecap:round;transition:stroke-dashoffset 0.5s ease}
        .circle-progress .progress.green{stroke:var(--green)}
        .circle-progress .progress.blue{stroke:var(--blue)}
        .circle-progress .progress.gold{stroke:var(--gold)}
        .circle-progress .progress.purple{stroke:var(--purple)}
        .circle-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
        .circle-value{font-size:1.4rem;font-weight:700;line-height:1.2}
        .circle-label{font-size:0.7rem;color:var(--muted)}
        .progress-grid{display:grid;grid-template-columns:120px 1fr;gap:20px;align-items:center}
        .progress-grid-compact{display:flex;flex-direction:column;align-items:center;gap:12px}
        .progress-details{display:flex;flex-direction:column;gap:8px}
        .progress-details-compact{display:grid;grid-template-columns:1fr 1fr;gap:6px 12px;width:100%;font-size:0.85rem}
        .progress-details-compact .detail-item{display:flex;flex-direction:column;text-align:center;padding:6px;background:var(--bg);border-radius:6px}
        .progress-details-compact .detail-label{font-size:0.7rem;color:var(--muted)}
        .progress-details-compact .detail-value{font-weight:600;font-size:0.9rem}
        .progress-detail-row{display:flex;justify-content:space-between;font-size:0.9rem}
        .progress-detail-row .label{color:var(--muted)}
        .progress-detail-row .value{font-weight:600}
        .progress-detail-row .value.green{color:var(--green)}
        .progress-detail-row .value.gold{color:var(--gold)}
        .progress-detail-row .value.blue{color:var(--blue)}
        .tomorrow-hint{margin-top:12px;padding:8px;background:var(--bg);border-radius:8px;border:1px solid var(--border);text-align:center;font-size:0.8rem}
        .mini-chart{height:120px;display:flex;align-items:flex-end;gap:4px;padding:10px 0}
        .mini-chart-bar{flex:1;border-radius:4px 4px 0 0;transition:all 0.3s;min-height:4px;position:relative}
        .mini-chart-bar.positive{background:linear-gradient(180deg,var(--green),#059669)}
        .mini-chart-bar.negative{background:linear-gradient(180deg,var(--red),#dc2626)}
        .mini-chart-bar.neutral{background:var(--border)}
        .mini-chart-label{position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);font-size:0.65rem;color:var(--muted);white-space:nowrap}
        .mini-chart-value{position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-size:0.7rem;font-weight:600;white-space:nowrap}
        .equity-line{height:120px;position:relative;margin-top:20px}
        .equity-line svg{width:100%;height:100%}
        .equity-line .line{fill:none;stroke:var(--green);stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
        .equity-line .area{fill:url(#equityGradient);opacity:0.3}
        .equity-line .dot{fill:var(--green);stroke:var(--card);stroke-width:2}
        .equity-line .grid-line{stroke:var(--border);stroke-width:1;stroke-dasharray:4}
        .equity-labels{display:flex;justify-content:space-between;font-size:0.7rem;color:var(--muted);margin-top:8px}
        .streak-container{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .streak-box{text-align:center;padding:16px;background:var(--bg);border-radius:10px;border:1px solid var(--border)}
        .streak-value{font-size:2rem;font-weight:700;line-height:1}
        .streak-label{font-size:0.75rem;color:var(--muted);margin-top:4px}
        .streak-fire{color:var(--orange)}
        .streak-ice{color:var(--blue)}
        .position-card{border-left:4px solid var(--gold)}
        .position-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .position-info{display:flex;align-items:center;gap:10px}
        .position-icon{font-size:1.5rem}
        .position-symbol{font-weight:700;font-size:1.1rem}
        .position-name{color:var(--dark);font-size:0.8rem}
        .position-pl-value{font-size:1.2rem;font-weight:700}
        .sl-tp-row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
        .sl-tp-box{padding:10px;border-radius:8px;text-align:center}
        .sl-tp-box.stop{background:linear-gradient(135deg,#7f1d1d,#991b1b)}
        .sl-tp-box.tp{background:linear-gradient(135deg,#14532d,#166534)}
        .sl-tp-box.target{background:linear-gradient(135deg,#1e3a5f,#1e40af)}
        .sl-tp-label{font-size:0.65rem;opacity:0.8;margin-bottom:2px}
        .sl-tp-value{font-size:1rem;font-weight:700}
        .sl-tp-dist{font-size:0.7rem;opacity:0.7;margin-top:2px}
        .instrument-card{display:flex;align-items:center;gap:12px;padding:14px;cursor:pointer;transition:all 0.2s}
        .instrument-card:hover{background:var(--card-hover)}
        .instrument-icon{font-size:2rem;width:50px;text-align:center}
        .instrument-info{flex:1}
        .instrument-symbol{font-weight:700;font-size:1rem}
        .instrument-name{color:var(--muted);font-size:0.8rem}
        .instrument-factor{font-size:0.85rem;font-weight:600}
        .calibrated{color:var(--green)}
        .not-calibrated{color:var(--orange)}
        table{width:100%;border-collapse:collapse;font-size:0.85rem}
        th{padding:10px 8px;text-align:left;color:var(--muted);background:var(--bg);border-bottom:1px solid var(--border);font-weight:500}
        td{padding:10px 8px;border-bottom:1px solid var(--border)}
        tr:hover{background:var(--card-hover)}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px}
        .modal-overlay.show{display:flex}
        .modal{background:var(--card);border-radius:16px;padding:24px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;border:1px solid var(--border)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .modal-title{font-size:1.1rem;font-weight:700}
        .modal-close{background:none;border:none;color:var(--muted);font-size:1.5rem;cursor:pointer}
        .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);padding:12px 24px;border-radius:10px;font-weight:600;background:var(--green);color:white;opacity:0;transition:all 0.3s;z-index:2000;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,0.3)}
        .toast.show{transform:translateX(-50%) translateY(0);opacity:1}
        .toast.error{background:var(--red)}
        .toast.warning{background:var(--orange)}
        .toast.info{background:var(--blue)}
        .loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px}
        .spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .text-green{color:var(--green)}
        .text-red{color:var(--red)}
        .text-gold{color:var(--gold)}
        .text-purple{color:var(--purple)}
        .text-blue{color:var(--blue)}
        .text-muted{color:var(--muted)}
        .text-center{text-align:center}
        .text-right{text-align:right}
        .font-bold{font-weight:700}
        .mt-2{margin-top:8px}
        .mt-3{margin-top:12px}
        .mb-2{margin-bottom:8px}
        .mb-3{margin-bottom:12px}
        .hidden{display:none!important}
        @media(max-width:768px){.grid-4,.grid-3{grid-template-columns:repeat(2,1fr)}.sl-tp-row{grid-template-columns:1fr}.header{grid-template-columns:1fr;gap:12px;text-align:center}.header-left{justify-content:center}.header-right{justify-content:center;flex-wrap:wrap}.header-center{order:-1}}
    </style>
</head>
<body>
    <div id="loading-screen" class="loading"><div class="spinner"></div><p class="text-muted mt-3">Laden...</p></div>
    
    <div id="auth-screen" class="auth-container hidden">
        <div class="auth-card">
            <div class="auth-logo"><img src="assets/icon-192.png" alt="Logo" style="width:80px;height:80px;" onerror="this.outerHTML='üéØ'"></div>
            <h1 class="auth-title">Trading Target Tracker</h1>
            <p class="auth-subtitle">Multi-Asset Portfolio & Risk Management</p>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Anmelden</button>
                <button class="auth-tab" onclick="showAuthTab('register')">Registrieren</button>
            </div>
            <div id="login-form">
                <div class="form-group"><input type="email" id="login-email" class="form-input" placeholder="Email-Adresse"></div>
                <div class="form-group"><input type="password" id="login-password" class="form-input" placeholder="Passwort"></div>
                <div id="login-error" class="form-error hidden"></div>
                <button class="btn btn-primary btn-block" onclick="loginWithEmail()" id="login-btn">Anmelden</button>
            </div>
            <div id="register-form" class="hidden">
                <div class="form-group"><input type="text" id="register-name" class="form-input" placeholder="Name"></div>
                <div class="form-group"><input type="email" id="register-email" class="form-input" placeholder="Email-Adresse"></div>
                <div class="form-group"><input type="password" id="register-password" class="form-input" placeholder="Passwort (min. 6 Zeichen)"></div>
                <div id="register-error" class="form-error hidden"></div>
                <button class="btn btn-primary btn-block" onclick="registerWithEmail()" id="register-btn">Konto erstellen</button>
            </div>
            <div class="auth-divider">oder</div>
            <button class="btn btn-google" onclick="loginWithGoogle()">
                <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Mit Google anmelden
            </button>
            <div class="auth-footer">
                <p>Oder <a href="#" onclick="continueOffline()">ohne Anmeldung fortfahren</a></p>
                <p class="mt-2" style="font-size:0.7rem;">Daten werden lokal gespeichert (kein Cloud-Sync)</p>
            </div>
        </div>
    </div>

    <div id="main-app" class="container hidden">
        <div class="header">
            <div class="header-left">
                <img src="assets/icon_dark_64.png" alt="Logo" onerror="this.outerHTML='üéØ'">
                <div class="header-brand">
                    <h1>Trading Target<br>Tracker</h1>
                </div>
            </div>
            <div class="header-center">
                <div class="header-date" id="header-date">-</div>
                <div class="header-separator"></div>
            </div>
            <div class="header-right">
                <div style="text-align:right;">
                    <div class="header-balance" id="header-balance">‚Ç¨0,00</div>
                    <div class="header-balance-sub" id="header-balance-sub">+‚Ç¨0,00 gesamt</div>
                </div>
                <div class="sync-status"><div class="sync-dot" id="sync-dot"></div><span id="sync-status-text">Offline</span></div>
                <button class="theme-toggle" onclick="toggleTheme()" title="Design wechseln">‚òÄÔ∏è</button>
                <div class="user-badge" onclick="openUserMenu()">
                    <div class="user-avatar" id="user-avatar">?</div>
                    <span id="user-name">Gast</span>
                </div>
            </div>
        </div>
        <div class="tabs">
            <button class="tab active" data-tab="dashboard">üìä Dashboard</button>
            <button class="tab" data-tab="positions">üìç Positionen</button>
            <button class="tab" data-tab="entry">üìù Eintrag</button>
            <button class="tab" data-tab="performance">üìà Performance</button>
            <button class="tab" data-tab="instruments">üé∏ Instrumente</button>
            <button class="tab" data-tab="history">üìÖ Historie</button>
            <button class="tab" data-tab="settings">‚öôÔ∏è Settings</button>
        </div>
        <div id="dashboard" class="tab-content active">
            <div class="grid grid-4" id="dashboard-stats"></div>
            <div id="recommendations-container"></div>
            <div class="card card-blue">
                <div class="card-title"><span>üìÖ</span> Diese Woche (KW <span id="week-number">-</span>)</div>
                <div class="week-grid" id="week-grid"></div>
                <div class="progress-container">
                    <div class="progress-header"><span>Wochenziel: <span id="week-target">‚Ç¨0</span></span><span id="week-progress-pct">0%</span></div>
                    <div class="progress-bar"><div class="progress-fill green" id="week-progress-fill" style="width:0%"></div></div>
                </div>
            </div>
            <div class="grid grid-2">
                <div class="card card-green">
                    <div class="card-title"><span>üéØ</span> Heutiger Fortschritt</div>
                    <div id="today-progress-content"></div>
                </div>
                <div class="card card-purple">
                    <div class="card-title"><span>üè¶</span> Reserve / Buffer</div>
                    <div id="buffer-content"></div>
                    <div id="buffer-history" class="mt-2" style="font-size:0.8rem;color:var(--muted);"></div>
                </div>
            </div>
            <div class="card"><div class="card-title"><span>üìç</span> Offene Positionen</div><div id="dashboard-positions"></div></div>
            <div class="grid grid-2">
                <div class="card"><div class="card-title"><span>üìà</span> Equity Curve (7 Tage)</div><div id="mini-equity-chart"></div></div>
                <div class="card"><div class="card-title"><span>üî•</span> Streak & Statistiken</div><div id="streak-stats"></div></div>
            </div>
            <div class="card"><div class="card-title"><span>üèÜ</span> N√§chste Meilensteine</div><div class="grid grid-4" id="milestones"></div></div>
        </div>
        <div id="positions" class="tab-content">
            <div class="grid grid-4" id="position-stats"></div>
            <div id="positions-list"></div>
            <button class="btn btn-add" onclick="openAddPositionModal()">+ Neue Position hinzuf√ºgen</button>
            <div class="card card-gold mt-3"><div class="card-title"><span>üìã</span> Quick Copy</div><div class="grid grid-2" id="quick-copy-list"></div></div>
        </div>
        <div id="entry" class="tab-content">
            <div class="card">
                <div class="card-title"><span>üìù</span> T√§glicher Eintrag</div>
                <div class="grid grid-2">
                    <div class="form-group"><label>Datum</label><input type="date" id="entry-date" class="form-input"></div>
                    <div class="form-group"><label>Neuer Kontostand (‚Ç¨) *</label><input type="number" step="0.01" id="entry-balance" class="form-input" placeholder="z.B. 15365.00"></div>
                </div>
                <div class="grid grid-3">
                    <div class="form-group"><label>Realisierter P/L (‚Ç¨)</label><input type="number" step="0.01" id="entry-realized" class="form-input" placeholder="0.00"></div>
                    <div class="form-group"><label>Unrealisierter P/L (‚Ç¨)</label><input type="number" step="0.01" id="entry-unrealized" class="form-input" placeholder="0.00"></div>
                    <div class="form-group"><label>Anzahl Trades</label><input type="number" id="entry-trades" class="form-input" placeholder="0"></div>
                </div>
                <div class="form-group"><label>Stimmung</label><select id="entry-mood" class="form-input"><option value="great">üöÄ Hervorragend</option><option value="good">üòä Gut</option><option value="neutral" selected>üòê Neutral</option><option value="bad">üòî Schlecht</option></select></div>
                <div class="form-group"><label>Notizen</label><textarea id="entry-notes" class="form-input" rows="2" placeholder="z.B. Gold Breakout..."></textarea></div>
                <div id="entry-preview" class="card card-dark hidden"></div>
                <button class="btn btn-success btn-block mt-2" onclick="saveEntry()">üíæ Eintrag speichern</button>
            </div>
        </div>
        <div id="performance" class="tab-content">
            <div class="grid grid-3">
                <div class="card card-green"><div class="stat-box"><div class="stat-label">Diese Woche</div><div class="stat-value" id="perf-week">‚Ç¨0</div><div class="stat-sub" id="perf-week-pct">0%</div></div></div>
                <div class="card card-blue"><div class="stat-box"><div class="stat-label">Dieser Monat</div><div class="stat-value" id="perf-month">‚Ç¨0</div><div class="stat-sub" id="perf-month-pct">0%</div></div></div>
                <div class="card card-gold"><div class="stat-box"><div class="stat-label">Gesamt</div><div class="stat-value" id="perf-total">‚Ç¨0</div><div class="stat-sub" id="perf-total-pct">0%</div></div></div>
            </div>
            <div class="card"><div class="card-title"><span>üìä</span> Statistiken</div><div class="grid grid-4" id="performance-stats"></div></div>
            <div class="card"><div class="card-title"><span>üéØ</span> Ziel-Projektion</div><div id="projection-content"></div></div>
        </div>
        <div id="instruments" class="tab-content">
            <div class="card"><div class="card-title"><span>ü•á</span> Edelmetalle</div><div id="instruments-metals"></div></div>
            <div class="card" style="opacity:0.6;"><div class="card-title"><span>üìà</span> Aktien <span class="text-muted" style="font-size:0.75rem;">(Phase 3)</span></div><p class="text-muted" style="font-size:0.85rem;">üîí Kommt bald</p></div>
        </div>
        <div id="history" class="tab-content">
            <div class="card"><div class="card-title"><span>üìÖ</span> Trading Historie</div><div style="overflow-x:auto;"><table><thead><tr><th>Datum</th><th style="text-align:right">Start</th><th style="text-align:right">Ende</th><th style="text-align:right">P/L</th><th style="text-align:center">Ziel</th><th style="text-align:center">Stimmung</th><th></th></tr></thead><tbody id="history-table"></tbody></table></div></div>
        </div>
        <div id="settings" class="tab-content">
            <div class="card card-blue" id="cloud-sync-card"><div class="card-title"><span>‚òÅÔ∏è</span> Cloud-Sync</div><div id="cloud-sync-content"></div></div>
            <div class="card"><div class="card-title"><span>üí∞</span> Kapital & Ziele</div><div class="grid grid-3"><div class="form-group"><label>Startkapital (‚Ç¨)</label><input type="number" step="0.01" id="set-start-capital" class="form-input"></div><div class="form-group"><label>Aktueller Stand (‚Ç¨)</label><input type="number" step="0.01" id="set-current-balance" class="form-input"></div><div class="form-group"><label>Zielkapital (‚Ç¨)</label><input type="number" step="0.01" id="set-target-capital" class="form-input"></div></div></div>
            <div class="card"><div class="card-title"><span>üìä</span> Risk Management</div><div class="grid grid-4"><div class="form-group"><label>Tagesziel (%)</label><input type="number" step="0.01" id="set-daily-target" class="form-input"></div><div class="form-group"><label>Risiko/Trade (%)</label><input type="number" step="0.01" id="set-risk-per-trade" class="form-input"></div><div class="form-group"><label>Max. Tagesverlust (%)</label><input type="number" step="0.01" id="set-max-daily-loss" class="form-input"></div><div class="form-group"><label>Risk:Reward</label><input type="number" step="0.1" id="set-rr-ratio" class="form-input"></div></div></div>
            <div class="card"><div class="card-title"><span>üè¶</span> Buffer-System</div><div class="grid grid-2"><div class="form-group"><label>Buffer aktiviert</label><select id="set-buffer-enabled" class="form-input"><option value="true">Ja</option><option value="false">Nein</option></select></div><div class="form-group"><label>Max. Buffer (Tage)</label><input type="number" id="set-buffer-max-days" class="form-input"></div></div></div>
            <button class="btn btn-primary btn-block mb-3" onclick="saveSettings()">üíæ Einstellungen speichern</button>
            <div class="card"><div class="card-title"><span>üíæ</span> Backup & Restore</div><div class="grid grid-2"><button class="btn btn-ghost btn-block" onclick="exportData()">üì§ Exportieren</button><label class="btn btn-ghost btn-block" style="cursor:pointer;">üì• Importieren<input type="file" accept=".json" onchange="importData(event)" style="display:none;"></label></div></div>
            <div class="card card-red"><div class="card-title"><span>‚ö†Ô∏è</span> Gefahrenzone</div><button class="btn btn-danger" onclick="resetAllData()">üóëÔ∏è Alle Daten l√∂schen</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="user-modal"><div class="modal" style="max-width:350px;"><div class="modal-header"><h3 class="modal-title">üë§ Benutzer</h3><button class="modal-close" onclick="closeModal('user-modal')">&times;</button></div><div id="user-modal-content"></div></div></div>
    <div class="modal-overlay" id="calibration-modal"><div class="modal"><div class="modal-header"><h3 class="modal-title">üîß Instrument kalibrieren</h3><button class="modal-close" onclick="closeModal('calibration-modal')">&times;</button></div><div id="calibration-content"></div></div></div>
    <div class="modal-overlay" id="position-modal"><div class="modal"><div class="modal-header"><h3 class="modal-title">üìç Position hinzuf√ºgen</h3><button class="modal-close" onclick="closeModal('position-modal')">&times;</button></div><div class="form-group"><label>Instrument</label><select id="pos-instrument" class="form-input"></select></div><div class="grid grid-2"><div class="form-group"><label>Position Size</label><input type="number" step="0.01" id="pos-size" class="form-input"></div><div class="form-group"><label>Richtung</label><select id="pos-direction" class="form-input"><option value="long">Long</option><option value="short">Short</option></select></div></div><div class="grid grid-2"><div class="form-group"><label>Avg. Einstiegspreis</label><input type="number" step="0.00001" id="pos-avg-price" class="form-input"></div><div class="form-group"><label>Aktueller Preis</label><input type="number" step="0.00001" id="pos-current-price" class="form-input"></div></div><button class="btn btn-success btn-block" onclick="savePosition()">üíæ Position speichern</button></div></div>
    <div id="toast" class="toast"></div>
    
    <!-- Migration Modal -->
    <div class="modal-overlay" id="migration-modal">
        <div class="modal" style="max-width:420px;">
            <div class="modal-header">
                <h3 class="modal-title">üì¶ Lokale Daten gefunden</h3>
            </div>
            <div id="migration-content">
                <p style="margin-bottom:12px;">Auf diesem Ger√§t gibt es <strong>lokale Daten</strong>:</p>
                <div class="card card-dark mb-3" id="migration-summary"></div>
                
                <div class="card card-gold mb-3" style="padding:12px;">
                    <p style="font-size:0.85rem; margin-bottom:8px;"><strong>‚ö†Ô∏è Was m√∂chtest du tun?</strong></p>
                    <p style="font-size:0.8rem; color:var(--muted); line-height:1.4;">
                        ‚Ä¢ <strong>"Lokale hochladen"</strong> = Diese Daten in die Cloud speichern<br>
                        ‚Ä¢ <strong>"Cloud laden"</strong> = Daten aus der Cloud holen (empfohlen wenn du auf einem anderen Ger√§t bereits Daten hast)
                    </p>
                </div>
                
                <div class="grid grid-2" style="gap:12px;">
                    <button class="btn btn-success btn-block" onclick="migrateLocalData()">‚¨ÜÔ∏è Lokale hochladen</button>
                    <button class="btn btn-primary btn-block" onclick="skipMigration()">‚¨áÔ∏è Cloud laden</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Onboarding Modal -->
    <div class="modal-overlay" id="onboarding-modal">
        <div class="modal" style="max-width:450px;">
            <div class="modal-header">
                <h3 class="modal-title">üöÄ Willkommen bei Trading Target Tracker!</h3>
            </div>
            <div id="onboarding-content">
                <p style="margin-bottom:16px; color:var(--muted);">Bitte gib deine Startparameter ein:</p>
                
                <div class="form-group">
                    <label>üí∞ Anfangskapital (‚Ç¨)</label>
                    <input type="number" id="onboard-start-capital" class="form-input highlight" placeholder="z.B. 10000" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>üéØ Zielkapital (‚Ç¨)</label>
                    <input type="number" id="onboard-target-capital" class="form-input highlight" placeholder="z.B. 1000000" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>üìÖ Startdatum</label>
                    <input type="date" id="onboard-start-date" class="form-input highlight">
                </div>
                
                <div class="form-group">
                    <label>üìà Tagesziel (%)</label>
                    <input type="number" id="onboard-daily-target" class="form-input" value="1.03" step="0.01">
                    <small class="text-muted">Empfohlen: 1.0 - 1.5%</small>
                </div>
                
                <div class="card card-dark mb-3" id="onboard-preview" style="display:none;">
                    <div class="card-title"><span>üìä</span> Berechnung</div>
                    <div id="onboard-calc"></div>
                </div>
                
                <button class="btn btn-success btn-block" onclick="completeOnboarding()">‚úÖ Starten</button>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================================
        // SUPABASE CONFIG
        // ============================================================
        const SUPABASE_URL = 'https://dxlrljzxyxlmcbndjuze.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4bHJsanp4eXhsbWNibmRqdXplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MzE0MTEsImV4cCI6MjA4NDQwNzQxMX0.PS7YyRI5AQLTJd9TXzYQLxliN-NsXQ3o2W_nZRVFSg4';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ============================================================
        // DATA
        // ============================================================
        const STORAGE_KEY = 'trading-tracker-pro-v5';
        const VERSION = '3.7.1';
        const INSTRUMENT_LIBRARY = {
            metals: [
                { id: 'xauusd', symbol: 'XAUUSD', name: 'Gold', icon: 'ü•á', color: '#fbbf24', priceDecimals: 2, calculationType: 'factor', standardSize: 5 },
                { id: 'xagusd', symbol: 'XAGUSD', name: 'Silber', icon: 'ü•à', color: '#9ca3af', priceDecimals: 4, calculationType: 'factor', standardSize: 50 },
                { id: 'xptusd', symbol: 'XPTUSD', name: 'Platin', icon: '‚ö™', color: '#e5e7eb', priceDecimals: 2, calculationType: 'factor', standardSize: 5 },
                { id: 'xpdusd', symbol: 'XPDUSD', name: 'Palladium', icon: 'üîò', color: '#6b7280', priceDecimals: 2, calculationType: 'factor', standardSize: 1 }
            ]
        };
        const DEFAULT_DATA = {
            version: VERSION,
            settings: { 
                accountCurrency: 'EUR', 
                broker: 'IBKR', 
                startCapital: 0, 
                currentBalance: 0, 
                targetCapital: 0, 
                dailyTargetPercent: 1.03, 
                riskPerTradePercent: 2.0, 
                maxDailyLossPercent: 3.0, 
                rrRatio: 2, 
                tradingDaysPerWeek: 5, 
                weekStartDay: 1,
                startDate: null,
                onboardingComplete: false
            },
            instruments: {},
            positions: [],
            dailyLogs: [],
            buffer: { currentBuffer: 0, history: [], settings: { enabled: true, autoUse: true, maxBufferDays: 10 } },
            dismissedRecommendations: []
        };
        let data = JSON.parse(JSON.stringify(DEFAULT_DATA));
        let currentUser = null;
        let isOnline = navigator.onLine;
        let localDataBeforeLogin = null; // Speichert lokale Daten vor Login

        // ============================================================
        // INIT
        // ============================================================
        async function init() {
            loadTheme();
            const { data: { session } } = await db.auth.getSession();
            if (session) {
                currentUser = session.user;
                await loadUserData();
                showMainApp();
            } else {
                const offline = localStorage.getItem('trading-tracker-offline-mode');
                if (offline === 'true') { loadLocalData(); showMainApp(); }
                else { showAuthScreen(); }
            }
            db.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session) { 
                    currentUser = session.user;
                    // Pr√ºfe ob Cloud bereits Daten hat
                    const cloudHasData = await checkCloudHasData();
                    // Pr√ºfe ob lokale Daten vorhanden
                    const localData = getLocalDataForMigration();
                    
                    if (localData.hasData) {
                        // Lokale Daten gefunden
                        localDataBeforeLogin = localData;
                        localDataBeforeLogin.cloudHasData = cloudHasData;
                        showMigrationModal(localData, cloudHasData);
                    } else {
                        // Keine lokalen Daten ‚Üí einfach Cloud laden
                        await loadUserData(); 
                        showMainApp();
                    }
                }
                else if (event === 'SIGNED_OUT') { currentUser = null; showAuthScreen(); }
            });
            window.addEventListener('online', () => { isOnline = true; updateSyncStatus(); if (currentUser) syncToCloud(); });
            window.addEventListener('offline', () => { isOnline = false; updateSyncStatus(); });
        }
        
        async function checkCloudHasData() {
            if (!currentUser) return false;
            try {
                // Pr√ºfe ob daily_logs oder instruments existieren
                const { data: logs } = await db.from('daily_logs').select('id').eq('user_id', currentUser.id).limit(1);
                const { data: instruments } = await db.from('instruments').select('id').eq('user_id', currentUser.id).limit(1);
                return (logs && logs.length > 0) || (instruments && instruments.length > 0);
            } catch (e) {
                console.error('Check cloud error:', e);
                return false;
            }
        }
        
        function getLocalDataForMigration() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return { hasData: false };
                const parsed = JSON.parse(saved);
                const calibratedInstruments = Object.values(parsed.instruments || {}).filter(i => i.isCalibrated);
                const positions = parsed.positions || [];
                const dailyLogs = parsed.dailyLogs || [];
                const hasData = calibratedInstruments.length > 0 || positions.length > 0 || dailyLogs.length > 0;
                return {
                    hasData,
                    data: parsed,
                    summary: {
                        instruments: calibratedInstruments.length,
                        positions: positions.length,
                        dailyLogs: dailyLogs.length,
                        buffer: parsed.buffer?.currentBuffer || 0
                    }
                };
            } catch (e) { return { hasData: false }; }
        }
        
        function showMigrationModal(localData, cloudHasData) {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('auth-screen').classList.add('hidden');
            
            const cloudHint = cloudHasData 
                ? `<div class="card card-blue mb-3" style="padding:10px;"><p style="font-size:0.85rem;margin:0;">‚òÅÔ∏è <strong>Die Cloud hat bereits Daten!</strong><br><span style="font-size:0.8rem;color:var(--muted);">Wenn du auf einem anderen Ger√§t schon Daten eingegeben hast, klicke "Cloud laden".</span></p></div>`
                : `<div class="card card-dark mb-3" style="padding:10px;"><p style="font-size:0.85rem;margin:0;color:var(--muted);">‚òÅÔ∏è Die Cloud ist leer. Klicke "Lokale hochladen" um diese Daten zu synchronisieren.</p></div>`;
            
            document.getElementById('migration-summary').innerHTML = `
                <div style="font-size:0.9rem;">
                    <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);"><span>üìä Kalibrierte Instrumente:</span><strong>${localData.summary.instruments}</strong></div>
                    <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);"><span>üìç Offene Positionen:</span><strong>${localData.summary.positions}</strong></div>
                    <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);"><span>üìÖ Tageseintr√§ge:</span><strong>${localData.summary.dailyLogs}</strong></div>
                    <div style="display:flex;justify-content:space-between;padding:6px 0;"><span>üè¶ Buffer:</span><strong>${fmt(localData.summary.buffer)}</strong></div>
                </div>
                ${cloudHint}
            `;
            openModal('migration-modal');
        }
        
        async function migrateLocalData() {
            if (!localDataBeforeLogin || !currentUser) return;
            
            closeModal('migration-modal');
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('loading-screen').querySelector('p').textContent = 'Migriere Daten...';
            
            try {
                const localData = localDataBeforeLogin.data;
                console.log('Starting migration with:', localData);
                
                // 1. Profile/Settings migrieren (inkl. Buffer)
                console.log('Migrating buffer:', localData.buffer?.currentBuffer);
                const { error: profileError } = await db.from('profiles').update({
                    start_capital: localData.settings?.startCapital,
                    current_balance: localData.settings?.currentBalance,
                    target_capital: localData.settings?.targetCapital,
                    daily_target_percent: localData.settings?.dailyTargetPercent,
                    risk_per_trade_percent: localData.settings?.riskPerTradePercent,
                    max_daily_loss_percent: localData.settings?.maxDailyLossPercent,
                    rr_ratio: localData.settings?.rrRatio,
                    trading_days_per_week: localData.settings?.tradingDaysPerWeek,
                    buffer_enabled: localData.buffer?.settings?.enabled,
                    buffer_max_days: localData.buffer?.settings?.maxBufferDays,
                    buffer_current: localData.buffer?.currentBuffer || 0,
                    start_date: localData.settings?.startDate,
                    onboarding_complete: localData.settings?.onboardingComplete
                }).eq('id', currentUser.id);
                if (profileError) console.error('Profile error:', profileError);
                
                // 2. Instrumente migrieren
                for (const [id, inst] of Object.entries(localData.instruments || {})) {
                    if (inst.isCalibrated && inst.plFactor) {
                        console.log('Migrating instrument:', inst.symbol, inst.plFactor);
                        // Erst l√∂schen falls vorhanden, dann neu einf√ºgen
                        await db.from('instruments').delete().eq('user_id', currentUser.id).eq('symbol', inst.symbol);
                        const { error } = await db.from('instruments').insert({
                            user_id: currentUser.id,
                            symbol: inst.symbol,
                            name: inst.name,
                            asset_class: 'metal',
                            icon: inst.icon,
                            color: inst.color,
                            price_decimals: inst.priceDecimals,
                            calculation_type: inst.calculationType,
                            pl_factor: inst.plFactor,
                            standard_size: inst.standardSize,
                            is_calibrated: true,
                            last_calibrated: inst.lastCalibrated,
                            calibration_data: inst.calibrationData
                        });
                        if (error) console.error('Instrument insert error:', error);
                    }
                }
                
                // 3. Daily Logs migrieren
                console.log('Migrating daily logs:', localData.dailyLogs?.length);
                for (const log of (localData.dailyLogs || [])) {
                    const { error } = await db.from('daily_logs').upsert({
                        user_id: currentUser.id,
                        date: log.date,
                        starting_balance: log.startingBalance,
                        ending_balance: log.endingBalance,
                        realized_pl: log.realizedPL,
                        unrealized_pl: log.unrealizedPL,
                        daily_target: log.dailyTarget,
                        variance: log.variance,
                        variance_percent: log.variancePercent,
                        days_equivalent: log.daysEquivalent,
                        target_hit: log.targetHit,
                        trades_count: log.tradesCount,
                        mood: log.mood,
                        notes: log.notes
                    }, { onConflict: 'user_id,date' });
                    if (error) console.error('Daily log error:', error);
                }
                
                // 4. Positionen migrieren
                console.log('Migrating positions:', localData.positions?.length);
                for (const pos of (localData.positions || [])) {
                    const inst = localData.instruments?.[pos.instrumentId];
                    const { error } = await db.from('positions').insert({
                        user_id: currentUser.id,
                        instrument_symbol: inst?.symbol || pos.instrumentId?.toUpperCase() || 'UNKNOWN',
                        size: pos.size,
                        avg_price: pos.avgPrice,
                        current_price: pos.currentPrice || pos.avgPrice,
                        direction: pos.direction || 'long',
                        is_active: pos.active !== false,
                        open_date: pos.openDate
                    });
                    if (error) console.error('Position insert error:', error);
                }
                
                // Lokale Daten √ºbernehmen
                data = deepMerge(DEFAULT_DATA, localData);
                localStorage.removeItem('trading-tracker-offline-mode');
                
                showMainApp();
                showToast('Daten erfolgreich migriert! üéâ');
                
            } catch (e) {
                console.error('Migration error:', e);
                showToast('Fehler bei Migration', 'error');
                await loadUserData();
                showMainApp();
            }
            
            localDataBeforeLogin = null;
        }
        
        function skipMigration() {
            closeModal('migration-modal');
            localDataBeforeLogin = null;
            // Lokale Daten l√∂schen damit beim n√§chsten Login kein Dialog mehr kommt
            localStorage.removeItem(STORAGE_KEY);
            data = JSON.parse(JSON.stringify(DEFAULT_DATA));
            loadUserData().then(() => showMainApp());
            showToast('Lokale Daten gel√∂scht - Cloud wird geladen', 'info');
        }
        
        function showAuthScreen() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }
        function showMainApp() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            initializeInstruments();
            updateSyncStatus();
            updateUserBadge();
            render();
            document.getElementById('entry-date').valueAsDate = new Date();
            
            // Pr√ºfe ob Onboarding n√∂tig
            if (!data.settings.onboardingComplete && data.settings.startCapital === 0) {
                showOnboarding();
            }
        }
        
        function showOnboarding() {
            document.getElementById('onboard-start-date').valueAsDate = new Date();
            
            // Live-Berechnung bei Eingabe
            ['onboard-start-capital', 'onboard-target-capital', 'onboard-daily-target'].forEach(id => {
                document.getElementById(id)?.addEventListener('input', updateOnboardingPreview);
            });
            
            openModal('onboarding-modal');
        }
        
        function updateOnboardingPreview() {
            const startCapital = parseFloat(document.getElementById('onboard-start-capital').value) || 0;
            const targetCapital = parseFloat(document.getElementById('onboard-target-capital').value) || 0;
            const dailyTargetPct = parseFloat(document.getElementById('onboard-daily-target').value) || 1;
            
            const preview = document.getElementById('onboard-preview');
            const calc = document.getElementById('onboard-calc');
            
            if (startCapital > 0 && targetCapital > startCapital && dailyTargetPct > 0) {
                const dailyTarget = startCapital * (dailyTargetPct / 100);
                const toGo = targetCapital - startCapital;
                const tradingDays = Math.ceil(Math.log(targetCapital / startCapital) / Math.log(1 + dailyTargetPct / 100));
                const months = (tradingDays / 21).toFixed(1);
                const years = (tradingDays / 252).toFixed(1);
                
                preview.style.display = 'block';
                calc.innerHTML = `
                    <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);">
                        <span>Tagesziel (Tag 1):</span>
                        <strong class="text-green">${fmt(dailyTarget)}</strong>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);">
                        <span>Noch zu erreichen:</span>
                        <strong>${fmt(toGo)}</strong>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);">
                        <span>Gesch√§tzte Handelstage:</span>
                        <strong>${tradingDays}</strong>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:6px 0;">
                        <span>Gesch√§tzte Dauer:</span>
                        <strong>${months} Monate (${years} Jahre)</strong>
                    </div>
                `;
            } else {
                preview.style.display = 'none';
            }
        }
        
        async function completeOnboarding() {
            const startCapital = parseFloat(document.getElementById('onboard-start-capital').value);
            const targetCapital = parseFloat(document.getElementById('onboard-target-capital').value);
            const startDate = document.getElementById('onboard-start-date').value;
            const dailyTargetPct = parseFloat(document.getElementById('onboard-daily-target').value);
            
            if (!startCapital || startCapital <= 0) {
                showToast('Bitte Anfangskapital eingeben', 'error');
                return;
            }
            if (!targetCapital || targetCapital <= startCapital) {
                showToast('Zielkapital muss gr√∂√üer als Anfangskapital sein', 'error');
                return;
            }
            if (!startDate) {
                showToast('Bitte Startdatum eingeben', 'error');
                return;
            }
            
            data.settings.startCapital = startCapital;
            data.settings.currentBalance = startCapital;
            data.settings.targetCapital = targetCapital;
            data.settings.startDate = startDate;
            data.settings.dailyTargetPercent = dailyTargetPct || 1.03;
            data.settings.onboardingComplete = true;
            
            saveData();
            closeModal('onboarding-modal');
            render();
            showToast('Setup abgeschlossen! üöÄ');
        }

        // ============================================================
        // AUTH
        // ============================================================
        function showAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach((t,i) => t.classList.toggle('active', (tab==='login'?i===0:i===1)));
            document.getElementById('login-form').classList.toggle('hidden', tab !== 'login');
            document.getElementById('register-form').classList.toggle('hidden', tab !== 'register');
        }
        async function loginWithEmail() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            const btn = document.getElementById('login-btn');
            if (!email || !password) { errorEl.textContent = 'Bitte Email und Passwort eingeben'; errorEl.classList.remove('hidden'); return; }
            btn.disabled = true; btn.textContent = 'Anmelden...'; errorEl.classList.add('hidden');
            try {
                const { error } = await db.auth.signInWithPassword({ email, password });
                if (error) throw error;
                localStorage.removeItem('trading-tracker-offline-mode');
                showToast('Erfolgreich angemeldet!');
            } catch (error) {
                errorEl.textContent = error.message === 'Invalid login credentials' ? 'Ung√ºltige Email oder Passwort' : error.message;
                errorEl.classList.remove('hidden');
            } finally { btn.disabled = false; btn.textContent = 'Anmelden'; }
        }
        async function registerWithEmail() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const errorEl = document.getElementById('register-error');
            const btn = document.getElementById('register-btn');
            if (!email || !password) { errorEl.textContent = 'Bitte alle Felder ausf√ºllen'; errorEl.classList.remove('hidden'); return; }
            if (password.length < 6) { errorEl.textContent = 'Passwort muss min. 6 Zeichen haben'; errorEl.classList.remove('hidden'); return; }
            btn.disabled = true; btn.textContent = 'Erstellen...'; errorEl.classList.add('hidden');
            try {
                const { data: d, error } = await db.auth.signUp({ email, password, options: { data: { full_name: name || email.split('@')[0] } } });
                if (error) throw error;
                localStorage.removeItem('trading-tracker-offline-mode');
                if (d.user && !d.session) showToast('Bitte best√§tige deine Email', 'info');
                else showToast('Konto erstellt!');
            } catch (error) { errorEl.textContent = error.message; errorEl.classList.remove('hidden'); }
            finally { btn.disabled = false; btn.textContent = 'Konto erstellen'; }
        }
        async function loginWithGoogle() {
            try { await db.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.origin } }); }
            catch (e) { showToast('Google-Login fehlgeschlagen', 'error'); }
        }
        function continueOffline() { localStorage.setItem('trading-tracker-offline-mode', 'true'); loadLocalData(); showMainApp(); showToast('Offline-Modus', 'info'); }
        async function logout() { await db.auth.signOut(); localStorage.removeItem('trading-tracker-offline-mode'); currentUser = null; data = JSON.parse(JSON.stringify(DEFAULT_DATA)); closeModal('user-modal'); showToast('Abgemeldet'); }

        // ============================================================
        // DATA SYNC
        // ============================================================
        async function loadUserData() {
            if (!currentUser) { loadLocalData(); return; }
            try {
                // Profile laden - wird automatisch vom Trigger erstellt
                const { data: profiles, error: profileError } = await db.from('profiles').select('*').eq('id', currentUser.id);
                const profile = profiles && profiles.length > 0 ? profiles[0] : null;
                
                if (profile) {
                    data.settings = { accountCurrency: profile.account_currency||'EUR', broker: profile.broker||'IBKR', startCapital: parseFloat(profile.start_capital)||0, currentBalance: parseFloat(profile.current_balance)||0, targetCapital: parseFloat(profile.target_capital)||0, dailyTargetPercent: parseFloat(profile.daily_target_percent)||1.03, riskPerTradePercent: parseFloat(profile.risk_per_trade_percent)||2.0, maxDailyLossPercent: parseFloat(profile.max_daily_loss_percent)||3.0, rrRatio: parseFloat(profile.rr_ratio)||2, tradingDaysPerWeek: profile.trading_days_per_week||5, weekStartDay: 1, startDate: profile.start_date, onboardingComplete: profile.onboarding_complete || false };
                    data.buffer.settings.enabled = profile.buffer_enabled !== false;
                    data.buffer.settings.maxBufferDays = profile.buffer_max_days || 10;
                    data.buffer.currentBuffer = parseFloat(profile.buffer_current) || 0;
                }
                // Kein INSERT hier - Trigger erstellt das Profil automatisch
                
                const { data: instruments } = await db.from('instruments').select('*').eq('user_id', currentUser.id);
                if (instruments) instruments.forEach(i => { data.instruments[i.symbol.toLowerCase()] = { id: i.symbol.toLowerCase(), symbol: i.symbol, name: i.name, icon: i.icon, color: i.color, priceDecimals: i.price_decimals, calculationType: i.calculation_type, plFactor: i.pl_factor ? parseFloat(i.pl_factor) : null, standardSize: parseFloat(i.standard_size)||1, isCalibrated: i.is_calibrated, lastCalibrated: i.last_calibrated, calibrationData: i.calibration_data }; });
                
                const { data: logs } = await db.from('daily_logs').select('*').eq('user_id', currentUser.id).order('date', { ascending: false }).limit(100);
                if (logs) data.dailyLogs = logs.map(l => ({ id: l.id, date: l.date, startingBalance: parseFloat(l.starting_balance)||0, endingBalance: parseFloat(l.ending_balance)||0, realizedPL: parseFloat(l.realized_pl)||0, unrealizedPL: parseFloat(l.unrealized_pl)||0, dailyTarget: parseFloat(l.daily_target)||0, variance: parseFloat(l.variance)||0, variancePercent: parseFloat(l.variance_percent)||0, daysEquivalent: parseFloat(l.days_equivalent)||0, targetHit: l.target_hit, tradesCount: l.trades_count||0, mood: l.mood, notes: l.notes }));
                
                const { data: positions } = await db.from('positions').select('*').eq('user_id', currentUser.id).eq('is_active', true);
                if (positions) data.positions = positions.map(p => ({ id: p.id, instrumentId: p.instrument_symbol?.toLowerCase(), size: parseFloat(p.size), avgPrice: parseFloat(p.avg_price), currentPrice: parseFloat(p.current_price)||parseFloat(p.avg_price), direction: p.direction, active: p.is_active, openDate: p.open_date }));
                
                saveLocalData();
            } catch (e) { console.error('Load error:', e); loadLocalData(); showToast('Cloud-Daten nicht geladen', 'warning'); }
        }
        async function syncToCloud() {
            if (!currentUser || !isOnline) return;
            updateSyncStatus('syncing');
            try {
                const { error: profileError } = await db.from('profiles').update({ 
                    email: currentUser.email, 
                    account_currency: data.settings.accountCurrency, 
                    broker: data.settings.broker, 
                    start_capital: data.settings.startCapital, 
                    current_balance: data.settings.currentBalance, 
                    target_capital: data.settings.targetCapital, 
                    daily_target_percent: data.settings.dailyTargetPercent, 
                    risk_per_trade_percent: data.settings.riskPerTradePercent, 
                    max_daily_loss_percent: data.settings.maxDailyLossPercent, 
                    rr_ratio: data.settings.rrRatio, 
                    trading_days_per_week: data.settings.tradingDaysPerWeek, 
                    buffer_enabled: data.buffer.settings.enabled, 
                    buffer_max_days: data.buffer.settings.maxBufferDays, 
                    buffer_current: data.buffer.currentBuffer, 
                    start_date: data.settings.startDate, 
                    onboarding_complete: data.settings.onboardingComplete 
                }).eq('id', currentUser.id);
                if (profileError) console.error('Profile sync error:', profileError);
                for (const [id, inst] of Object.entries(data.instruments)) {
                    if (inst.isCalibrated) await db.from('instruments').upsert({ user_id: currentUser.id, symbol: inst.symbol, name: inst.name, asset_class: 'metal', icon: inst.icon, color: inst.color, price_decimals: inst.priceDecimals, calculation_type: inst.calculationType, pl_factor: inst.plFactor, standard_size: inst.standardSize, is_calibrated: inst.isCalibrated, last_calibrated: inst.lastCalibrated, calibration_data: inst.calibrationData }, { onConflict: 'user_id,symbol' });
                }
                updateSyncStatus('online');
            } catch (e) { console.error('Sync error:', e); updateSyncStatus('offline'); }
        }
        async function syncDailyLog(log) {
            if (!currentUser || !isOnline) return;
            try { await db.from('daily_logs').upsert({ user_id: currentUser.id, date: log.date, starting_balance: log.startingBalance, ending_balance: log.endingBalance, realized_pl: log.realizedPL, unrealized_pl: log.unrealizedPL, daily_target: log.dailyTarget, variance: log.variance, variance_percent: log.variancePercent, days_equivalent: log.daysEquivalent, target_hit: log.targetHit, trades_count: log.tradesCount, mood: log.mood, notes: log.notes }, { onConflict: 'user_id,date' }); } catch (e) { console.error(e); }
        }
        async function syncPosition(pos, action = 'upsert') {
            if (!currentUser || !isOnline) return;
            console.log('syncPosition called:', action, pos.id);
            try {
                if (action === 'delete') {
                    await db.from('positions').delete().eq('id', pos.id);
                } else {
                    const posData = { 
                        id: pos.id, 
                        user_id: currentUser.id, 
                        instrument_symbol: data.instruments[pos.instrumentId]?.symbol || pos.instrumentId?.toUpperCase(), 
                        size: pos.size, 
                        avg_price: pos.avgPrice, 
                        current_price: pos.currentPrice, 
                        direction: pos.direction || 'long', 
                        is_active: pos.active !== false, 
                        open_date: pos.openDate 
                    };
                    console.log('Position data to insert:', posData);
                    // Erst l√∂schen, dann neu einf√ºgen (vermeidet Duplikate)
                    console.log('Deleting position:', pos.id);
                    await db.from('positions').delete().eq('id', pos.id);
                    console.log('Inserting position...');
                    const { data: insertedData, error } = await db.from('positions').insert(posData).select();
                    if (error) {
                        console.error('Position INSERT error:', error);
                    } else {
                        console.log('Position inserted successfully:', insertedData);
                    }
                }
            } catch (e) { console.error('Position sync error:', e); }
        }
        
        async function syncBuffer() {
            if (!currentUser || !isOnline) return;
            try {
                await db.from('profiles').update({ 
                    buffer_current: data.buffer.currentBuffer 
                }).eq('id', currentUser.id);
            } catch (e) { console.error('Buffer sync error:', e); }
        }
        
        async function syncBufferHistory(entry) {
            if (!currentUser || !isOnline) return;
            try {
                const { error } = await db.from('buffer_history').insert({
                    user_id: currentUser.id,
                    date: entry.date,
                    type: entry.type,
                    amount: entry.amount,
                    reason: entry.reason,
                    balance_after: entry.balanceAfter
                });
                if (error) console.error('Buffer history sync error:', error);
            } catch (e) { console.error('Buffer history sync error:', e); }
        }
        function updateSyncStatus(status) {
            const dot = document.getElementById('sync-dot');
            const text = document.getElementById('sync-status-text');
            if (!dot) return;
            dot.className = 'sync-dot';
            if (!currentUser) { dot.classList.add('offline'); text.textContent = 'Offline-Modus'; }
            else if (status === 'syncing') { dot.classList.add('syncing'); text.textContent = 'Synchronisiere...'; }
            else if (isOnline) { dot.classList.add('online'); text.textContent = 'Cloud verbunden'; }
            else { dot.classList.add('offline'); text.textContent = 'Offline'; }
        }
        function updateUserBadge() {
            const avatar = document.getElementById('user-avatar');
            const name = document.getElementById('user-name');
            if (currentUser) { const n = currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || 'User'; avatar.textContent = n.charAt(0).toUpperCase(); name.textContent = n; }
            else { avatar.textContent = '?'; name.textContent = 'Gast'; }
        }

        // ============================================================
        // LOCAL STORAGE
        // ============================================================
        function loadLocalData() { try { const s = localStorage.getItem(STORAGE_KEY); if (s) data = deepMerge(DEFAULT_DATA, JSON.parse(s)); } catch (e) { console.error(e); } }
        function saveLocalData() { try { data.version = VERSION; localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch (e) { console.error(e); } }
        function saveData() { saveLocalData(); if (currentUser && isOnline) syncToCloud(); }
        function deepMerge(t, s) { const r = { ...t }; for (const k in s) { if (s[k] && typeof s[k] === 'object' && !Array.isArray(s[k])) r[k] = deepMerge(t[k]||{}, s[k]); else r[k] = s[k]; } return r; }
        function initializeInstruments() { INSTRUMENT_LIBRARY.metals.forEach(i => { if (!data.instruments[i.id]) data.instruments[i.id] = { ...i, plFactor: null, isCalibrated: false, lastCalibrated: null, calibrationData: null }; }); }

        // ============================================================
        // CALCULATIONS
        // ============================================================
        function getBalance() { if (data.dailyLogs.length > 0) { const s = [...data.dailyLogs].sort((a, b) => b.date.localeCompare(a.date)); return s[0].endingBalance; } return data.settings.currentBalance; }
        function getDailyTarget() { return getBalance() * (data.settings.dailyTargetPercent / 100); }
        function getWeeklyTarget() { return getDailyTarget() * data.settings.tradingDaysPerWeek; }
        function getRiskPerTrade() { return getBalance() * (data.settings.riskPerTradePercent / 100); }
        function getMaxDailyLoss() { return getBalance() * (data.settings.maxDailyLossPercent / 100); }
        function calculatePL(pos) { const inst = data.instruments[pos.instrumentId]; if (!inst || !inst.plFactor) return 0; const diff = pos.direction === 'long' ? pos.currentPrice - pos.avgPrice : pos.avgPrice - pos.currentPrice; return diff * pos.size * inst.plFactor; }
        function calculateStopLimit(pos) { const inst = data.instruments[pos.instrumentId]; if (!inst || !inst.plFactor) return null; const plPerUnit = pos.size * inst.plFactor; const risk = getRiskPerTrade(); const target = getDailyTarget(); const rr = data.settings.rrRatio; const stopD = risk / plPerUnit; const tpDRR = stopD * rr; const tpDT = target / plPerUnit; const isLong = pos.direction === 'long'; return { stopPrice: isLong ? pos.avgPrice - stopD : pos.avgPrice + stopD, tpPriceRR: isLong ? pos.avgPrice + tpDRR : pos.avgPrice - tpDRR, tpPriceTarget: isLong ? pos.avgPrice + tpDT : pos.avgPrice - tpDT, potentialLoss: risk, potentialProfitRR: risk * rr, potentialProfitTarget: target }; }
        function getWeekNumber(d) { const dt = new Date(d); dt.setHours(0,0,0,0); dt.setDate(dt.getDate() + 4 - (dt.getDay()||7)); const ys = new Date(dt.getFullYear(),0,1); return Math.ceil((((dt-ys)/86400000)+1)/7); }
        function getWeekDates(d) { const dt = new Date(d); const day = dt.getDay(); const diff = dt.getDate() - day + (day === 0 ? -6 : 1); const mon = new Date(dt.setDate(diff)); const dates = []; for (let i = 0; i < 5; i++) { const x = new Date(mon); x.setDate(mon.getDate() + i); dates.push(x.toISOString().split('T')[0]); } return dates; }
        function getWeeklyData() { const today = new Date(); const dates = getWeekDates(today); const logs = data.dailyLogs.filter(l => dates.includes(l.date)); const realized = logs.reduce((s, l) => s + (l.realizedPL||0), 0); const target = getWeeklyTarget(); return { weekNumber: getWeekNumber(today), dates, logs, target, realized, variance: realized - target, progressPercent: target > 0 ? (realized / target) * 100 : 0, status: realized >= target ? 'exceeded' : (realized >= target * 0.5 ? 'on_track' : 'behind') }; }
        function processBuffer(realizedPL) { 
            console.log('processBuffer called with realizedPL:', realizedPL);
            if (!data.buffer.settings.enabled) { console.log('Buffer disabled'); return; }
            const target = getDailyTarget(); 
            console.log('Daily target:', target, 'realizedPL > target?', realizedPL > target);
            const max = target * data.buffer.settings.maxBufferDays; 
            const today = new Date().toISOString().split('T')[0]; 
            
            if (realizedPL > target) { 
                const surplus = realizedPL - target; 
                const space = max - data.buffer.currentBuffer; 
                const toAdd = Math.min(surplus, space); 
                console.log('Adding to buffer:', toAdd);
                if (toAdd > 0) { 
                    data.buffer.currentBuffer += toAdd; 
                    const entry = { date: today, type: 'add', amount: toAdd, reason: `√úberschuss ${formatDate(today)}`, balanceAfter: data.buffer.currentBuffer };
                    data.buffer.history.push(entry); 
                    syncBuffer();
                    syncBufferHistory(entry);
                } 
            } else if (realizedPL < 0 && data.buffer.settings.autoUse) { 
                const loss = Math.abs(realizedPL); 
                const toUse = Math.min(loss, data.buffer.currentBuffer); 
                console.log('Using from buffer:', toUse);
                if (toUse > 0) { 
                    data.buffer.currentBuffer -= toUse; 
                    const entry = { date: today, type: 'use', amount: toUse, reason: `Ausgleich ${formatDate(today)}`, balanceAfter: data.buffer.currentBuffer };
                    data.buffer.history.push(entry); 
                    syncBuffer();
                    syncBufferHistory(entry);
                } 
            } 
        }

        // ============================================================
        // FORMATTING
        // ============================================================
        function fmt(n, d = 2) { return '‚Ç¨' + (n||0).toLocaleString('de-DE', { minimumFractionDigits: d, maximumFractionDigits: d }); }
        function fmtNum(n, d = 2) { return (n||0).toLocaleString('de-DE', { minimumFractionDigits: d, maximumFractionDigits: d }); }
        function fmtPrice(n, inst) { return (n||0).toFixed(inst?.priceDecimals || 2); }
        function fmtPct(n) { return (n||0).toFixed(1) + '%'; }
        function formatDate(s) { if (!s) return '-'; const [y,m,d] = s.split('-'); return `${d}.${m}.${y}`; }
        function getMoodEmoji(m) { return { great: 'üöÄ', good: 'üòä', neutral: 'üòê', bad: 'üòî' }[m] || 'üòê'; }

        // ============================================================
        // RECOMMENDATIONS
        // ============================================================
        function generateRecommendations() {
            const recs = []; const weekData = getWeeklyData(); const target = getDailyTarget(); const todayLog = data.dailyLogs.find(l => l.date === new Date().toISOString().split('T')[0]);
            if (weekData.realized >= weekData.target) recs.push({ id: 'weekly_exceeded', priority: 'medium', icon: 'üéØ', title: 'Wochenziel erreicht!', message: `${fmt(weekData.realized)} von ${fmt(weekData.target)} (+${fmt(weekData.variance)})`, dismissable: true });
            if (todayLog && todayLog.variancePercent > 100) recs.push({ id: 'great_day_'+todayLog.date, priority: 'info', icon: 'üöÄ', title: 'Hervorragender Tag!', message: `+${todayLog.variancePercent.toFixed(0)}% √ºber Ziel`, dismissable: true });
            const bufferDays = data.buffer.currentBuffer / target;
            if (bufferDays < 2 && data.dailyLogs.length > 5) recs.push({ id: 'buffer_low', priority: 'low', icon: 'üí∞', title: 'Reserve aufbauen', message: `Reserve deckt nur ${bufferDays.toFixed(1)} Tage`, dismissable: true });
            if (!currentUser && data.dailyLogs.length > 3) recs.push({ id: 'enable_cloud', priority: 'low', icon: '‚òÅÔ∏è', title: 'Cloud-Sync aktivieren', message: 'Anmelden f√ºr Sync auf allen Ger√§ten', dismissable: true });
            return recs.filter(r => !data.dismissedRecommendations.includes(r.id));
        }
        function dismissRecommendation(id) { data.dismissedRecommendations.push(id); saveData(); render(); }

        // ============================================================
        // RENDER
        // ============================================================
        function render() { renderHeader(); renderDashboard(); renderPositions(); renderPerformance(); renderInstruments(); renderHistory(); renderSettings(); }
        function renderHeader() { 
            document.getElementById('header-date').textContent = new Date().toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }); 
            document.getElementById('header-balance').textContent = fmt(getBalance()); 
            const totalPL = getBalance() - data.settings.startCapital;
            document.getElementById('header-balance-sub').textContent = (totalPL >= 0 ? '+' : '') + fmt(totalPL) + ' gesamt';
        }
        function renderDashboard() {
            const balance = getBalance(); const target = getDailyTarget(); const weekData = getWeeklyData();
            const todayLog = data.dailyLogs.find(l => l.date === new Date().toISOString().split('T')[0]);
            const todayPL = todayLog ? todayLog.realizedPL : 0; const totalPL = balance - data.settings.startCapital;
            document.getElementById('dashboard-stats').innerHTML = `<div class="card stat-box"><div class="stat-label">Kontostand</div><div class="stat-value">${fmt(balance)}</div><div class="stat-sub">${totalPL>=0?'+':''}${fmt(totalPL)} gesamt</div></div><div class="card stat-box"><div class="stat-label">Heute</div><div class="stat-value ${todayPL>=0?'text-green':'text-red'}">${todayPL>=0?'+':''}${fmt(todayPL)}</div><div class="stat-sub">Ziel: ${fmt(target)}</div></div><div class="card stat-box"><div class="stat-label">Diese Woche</div><div class="stat-value ${weekData.realized>=0?'text-green':'text-red'}">${fmtPct(weekData.progressPercent)}</div><div class="stat-sub">${fmt(weekData.realized)} / ${fmt(weekData.target)}</div></div><div class="card stat-box"><div class="stat-label">Reserve</div><div class="stat-value text-gold">${fmt(data.buffer.currentBuffer)}</div><div class="stat-sub">${(data.buffer.currentBuffer/target).toFixed(1)} Tage</div></div>`;
            const recs = generateRecommendations();
            document.getElementById('recommendations-container').innerHTML = recs.length > 0 ? `<div class="card"><div class="card-title"><span>üí°</span> Empfehlungen</div>${recs.map(r => `<div class="rec-card ${r.priority}">${r.dismissable?`<button class="rec-dismiss" onclick="dismissRecommendation('${r.id}')">&times;</button>`:''}<div class="rec-header"><span class="rec-icon">${r.icon}</span><span class="rec-title">${r.title}</span></div><div class="rec-message">${r.message}</div></div>`).join('')}</div>` : '';
            document.getElementById('week-number').textContent = weekData.weekNumber;
            const dayNames = ['Mo','Di','Mi','Do','Fr']; const today = new Date().toISOString().split('T')[0];
            document.getElementById('week-grid').innerHTML = weekData.dates.map((d, i) => { const log = weekData.logs.find(l => l.date === d); const pl = log ? log.realizedPL : null; const isToday = d === today; const cls = pl !== null ? (pl >= 0 ? 'profit' : 'loss') : ''; return `<div class="week-day ${cls} ${isToday?'today':''}"><div class="week-day-name">${dayNames[i]}</div><div class="week-day-value ${pl!==null?(pl>=0?'positive':'negative'):'empty'}">${pl!==null?(pl>=0?'+':'')+fmtNum(pl,0):'-'}</div></div>`; }).join('');
            document.getElementById('week-target').textContent = fmt(weekData.target);
            document.getElementById('week-progress-pct').textContent = fmtPct(weekData.progressPercent);
            document.getElementById('week-progress-fill').style.width = Math.min(weekData.progressPercent, 100) + '%';
            
            // Buffer mit Kreisdiagramm
            const maxBuf = target * data.buffer.settings.maxBufferDays; 
            const bufDays = target > 0 ? data.buffer.currentBuffer / target : 0; 
            const bufPct = maxBuf > 0 ? (data.buffer.currentBuffer / maxBuf) * 100 : 0;
            const bufCircumference = 2 * Math.PI * 45;
            const bufDashOffset = bufCircumference - (bufCircumference * Math.min(bufPct, 100) / 100);
            const bufColor = bufPct >= 80 ? 'green' : (bufPct >= 40 ? 'gold' : 'purple');
            
            document.getElementById('buffer-content').innerHTML = `
                <div class="progress-grid-compact">
                    <div class="circle-progress">
                        <svg viewBox="0 0 100 100">
                            <circle class="bg" cx="50" cy="50" r="45"/>
                            <circle class="progress ${bufColor}" cx="50" cy="50" r="45" 
                                stroke-dasharray="${bufCircumference}" 
                                stroke-dashoffset="${bufDashOffset}"/>
                        </svg>
                        <div class="circle-center">
                            <div class="circle-value">${bufDays.toFixed(1)}</div>
                            <div class="circle-label">Tage</div>
                        </div>
                    </div>
                    <div class="progress-details-compact">
                        <div class="detail-item">
                            <span class="detail-label">Reserve</span>
                            <span class="detail-value text-green">${fmt(data.buffer.currentBuffer)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Maximum</span>
                            <span class="detail-value">${fmt(maxBuf)}</span>
                        </div>
                        <div class="detail-item" style="grid-column: span 2;">
                            <span class="detail-label">Kapazit√§t</span>
                            <span class="detail-value ${bufColor === 'green' ? 'text-green' : bufColor === 'gold' ? 'text-gold' : 'text-purple'}">${fmtPct(bufPct)}</span>
                        </div>
                    </div>
                </div>
            `;
            
            const bufHist = data.buffer.history.slice(-3).reverse();
            document.getElementById('buffer-history').innerHTML = bufHist.length > 0 ? bufHist.map(h => `<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border);"><span>${h.type==='add'?'‚ûï':'‚ûñ'} ${h.reason}</span><span class="${h.type==='add'?'text-green':'text-red'}">${h.type==='add'?'+':'-'}${fmt(h.amount)}</span></div>`).join('') : '<span class="text-muted">Keine Buffer-Aktivit√§t</span>';
            const activePos = data.positions.filter(p => p.active); const totalUnr = activePos.reduce((s, p) => s + calculatePL(p), 0);
            document.getElementById('dashboard-positions').innerHTML = activePos.length > 0 ? `<div class="grid grid-2">${activePos.map(pos => { const inst = data.instruments[pos.instrumentId]; const pl = calculatePL(pos); return `<div class="card card-dark" style="border-left:3px solid ${inst?.color||'#fff'};"><div style="display:flex;justify-content:space-between;align-items:center;"><span style="font-weight:700;">${inst?.icon||'üìä'} ${inst?.symbol||pos.instrumentId}</span><span class="${pl>=0?'text-green':'text-red'} font-bold">${pl>=0?'+':''}${fmt(pl)}</span></div><div style="font-size:0.8rem;color:var(--muted);margin-top:4px;">${pos.size} √ó ${pos.direction.toUpperCase()} @ ${fmtPrice(pos.avgPrice, inst)}</div></div>`; }).join('')}</div><div style="text-align:right;margin-top:8px;font-size:0.9rem;">Unrealisiert: <span class="${totalUnr>=0?'text-green':'text-red'} font-bold">${totalUnr>=0?'+':''}${fmt(totalUnr)}</span></div>` : '<p class="text-muted">Keine offenen Positionen</p>';
            const milestones = [25000,50000,100000,250000,500000,1000000].filter(m => m > balance).slice(0, 4);
            document.getElementById('milestones').innerHTML = milestones.map(m => `<div class="card card-dark text-center"><div class="text-gold font-bold">${m>=1000000?(m/1000000)+'M':(m/1000)+'k'}</div><div class="text-muted" style="font-size:0.75rem;">noch ${fmt(m-balance)}</div></div>`).join('');
            
            // Heutiger Fortschritt mit Kreisdiagramm
            const todayProgressPct = target > 0 ? Math.min((todayPL / target) * 100, 100) : 0;
            const remaining = target - todayPL;
            const progressColor = todayPL >= target ? 'green' : (todayPL >= target * 0.5 ? 'gold' : 'blue');
            const circumference = 2 * Math.PI * 45; // radius = 45
            const dashOffset = circumference - (circumference * Math.min(todayProgressPct, 100) / 100);
            
            // Tagesziel morgen (wenn heute erreicht)
            const tomorrowBalance = balance + target;
            const tomorrowTarget = tomorrowBalance * (data.settings.dailyTargetPercent / 100);
            
            document.getElementById('today-progress-content').innerHTML = `
                <div class="progress-grid-compact">
                    <div class="circle-progress">
                        <svg viewBox="0 0 100 100">
                            <circle class="bg" cx="50" cy="50" r="45"/>
                            <circle class="progress ${progressColor}" cx="50" cy="50" r="45" 
                                stroke-dasharray="${circumference}" 
                                stroke-dashoffset="${dashOffset}"/>
                        </svg>
                        <div class="circle-center">
                            <div class="circle-value ${todayPL >= target ? 'text-green' : ''}">${fmtPct(todayProgressPct)}</div>
                            <div class="circle-label">${todayPL >= target ? '‚úÖ Erreicht!' : 'Fortschritt'}</div>
                        </div>
                    </div>
                    <div class="progress-details-compact">
                        <div class="detail-item">
                            <span class="detail-label">Tagesziel</span>
                            <span class="detail-value">${fmt(target)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Realisiert</span>
                            <span class="detail-value ${todayPL>=0?'text-green':'text-red'}">${todayPL>=0?'+':''}${fmt(todayPL)}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">${todayPL >= target ? '√úberschuss' : 'Noch offen'}</span>
                            <span class="detail-value ${todayPL >= target ? 'text-green' : 'text-gold'}">${todayPL >= target ? '+' : ''}${fmt(Math.abs(remaining))}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">üìÖ Morgen</span>
                            <span class="detail-value text-blue">${fmt(tomorrowTarget)}</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Mini Equity Chart (letzte 7 Tage)
            renderMiniEquityChart();
            
            // Streak & Statistiken
            renderStreakStats();
        }
        
        function renderMiniEquityChart() {
            const last7 = [...data.dailyLogs].sort((a, b) => a.date.localeCompare(b.date)).slice(-7);
            if (last7.length === 0) {
                document.getElementById('mini-equity-chart').innerHTML = '<p class="text-muted text-center" style="padding:20px;">Noch keine Daten</p>';
                return;
            }
            
            // Werte
            const values = last7.map(l => l.endingBalance);
            const pls = last7.map(l => l.realizedPL || 0);
            const min = Math.min(...values) * 0.998;
            const max = Math.max(...values) * 1.002;
            const range = max - min || 1;
            
            // Farben f√ºr Balken basierend auf Performance
            const colors = ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e', '#10b981', '#059669'];
            
            // Labels
            const labels = last7.map(l => {
                const d = new Date(l.date + 'T12:00:00');
                return d.toLocaleDateString('de-DE', { weekday: 'short' }).substring(0, 2);
            });
            
            // SVG Dimensionen
            const width = 280;
            const height = 120;
            const barWidth = 28;
            const gap = 12;
            const startX = 20;
            
            // Berechne Balkenh√∂hen (prozentual zum Bereich)
            const bars = values.map((v, i) => {
                const heightPct = ((v - min) / range) * 80 + 15; // 15-95% H√∂he
                const x = startX + i * (barWidth + gap);
                const barHeight = (heightPct / 100) * height;
                const y = height - barHeight;
                const colorIndex = Math.min(Math.floor((heightPct - 15) / 12), 6);
                return { x, y, height: barHeight, color: colors[colorIndex], pl: pls[i], value: v };
            });
            
            // Trendlinie Punkte
            const linePoints = bars.map(b => `${b.x + barWidth/2},${b.y}`).join(' ');
            
            document.getElementById('mini-equity-chart').innerHTML = `
                <svg width="100%" height="${height + 30}" viewBox="0 0 ${width} ${height + 30}" preserveAspectRatio="xMidYMid meet">
                    <defs>
                        <linearGradient id="barGrad" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stop-color="var(--green)" stop-opacity="1"/>
                            <stop offset="100%" stop-color="var(--green)" stop-opacity="0.6"/>
                        </linearGradient>
                        <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                            <feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity="0.3"/>
                        </filter>
                    </defs>
                    
                    <!-- Balken -->
                    ${bars.map((b, i) => `
                        <rect x="${b.x}" y="${b.y}" width="${barWidth}" height="${b.height}" 
                              rx="4" fill="${b.color}" filter="url(#shadow)"/>
                        <text x="${b.x + barWidth/2}" y="${height + 12}" text-anchor="middle" 
                              fill="var(--muted)" font-size="10">${labels[i]}</text>
                        <text x="${b.x + barWidth/2}" y="${b.y - 5}" text-anchor="middle" 
                              fill="${b.pl >= 0 ? 'var(--green)' : 'var(--red)'}" font-size="9" font-weight="600">
                            ${b.pl >= 0 ? '+' : ''}${Math.round(b.pl)}
                        </text>
                    `).join('')}
                    
                    <!-- Trendlinie -->
                    <polyline points="${linePoints}" fill="none" stroke="var(--blue)" 
                              stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                              stroke-dasharray="none" opacity="0.8"/>
                    
                    <!-- Punkte auf der Linie -->
                    ${bars.map(b => `
                        <circle cx="${b.x + barWidth/2}" cy="${b.y}" r="4" fill="var(--blue)" stroke="var(--card)" stroke-width="2"/>
                    `).join('')}
                </svg>
                <div style="display:flex;justify-content:space-between;margin-top:4px;font-size:0.75rem;padding:0 8px;">
                    <span class="text-muted">üìâ ${fmt(min)}</span>
                    <span class="text-green font-bold">üìà ${fmt(max)}</span>
                </div>
            `;
        }
        
        function renderStreakStats() {
            // Berechne Streak
            const sortedLogs = [...data.dailyLogs].sort((a, b) => b.date.localeCompare(a.date));
            let currentStreak = 0;
            let maxStreak = 0;
            let tempStreak = 0;
            
            for (const log of sortedLogs) {
                if (log.targetHit) {
                    tempStreak++;
                    if (tempStreak > maxStreak) maxStreak = tempStreak;
                } else {
                    if (currentStreak === 0 && tempStreak > 0) currentStreak = 0; // Streak gebrochen
                    tempStreak = 0;
                }
                if (currentStreak === 0 && log.targetHit) currentStreak = tempStreak;
            }
            
            // Aktueller Streak (von heute r√ºckw√§rts)
            currentStreak = 0;
            for (const log of sortedLogs) {
                if (log.targetHit) currentStreak++;
                else break;
            }
            
            // Weitere Stats
            const totalDays = data.dailyLogs.length;
            const targetHitDays = data.dailyLogs.filter(l => l.targetHit).length;
            const hitRate = totalDays > 0 ? (targetHitDays / totalDays) * 100 : 0;
            
            // Bester/schlechtester Tag
            const bestDay = data.dailyLogs.reduce((best, l) => (l.realizedPL || 0) > (best?.realizedPL || -Infinity) ? l : best, null);
            const worstDay = data.dailyLogs.reduce((worst, l) => (l.realizedPL || 0) < (worst?.realizedPL || Infinity) ? l : worst, null);
            
            document.getElementById('streak-stats').innerHTML = `
                <div class="streak-container">
                    <div class="streak-box">
                        <div class="streak-value streak-fire">${currentStreak} üî•</div>
                        <div class="streak-label">Aktueller Streak</div>
                    </div>
                    <div class="streak-box">
                        <div class="streak-value">${maxStreak}</div>
                        <div class="streak-label">Bester Streak</div>
                    </div>
                    <div class="streak-box">
                        <div class="streak-value text-green">${fmtPct(hitRate)}</div>
                        <div class="streak-label">Ziel-Trefferquote</div>
                    </div>
                    <div class="streak-box">
                        <div class="streak-value">${targetHitDays}/${totalDays}</div>
                        <div class="streak-label">Tage mit Ziel</div>
                    </div>
                </div>
                ${bestDay ? `
                <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:0.8rem;">
                    <div class="streak-box" style="padding:10px;">
                        <div class="text-green font-bold">+${fmt(bestDay.realizedPL)}</div>
                        <div class="streak-label">Bester Tag (${formatDate(bestDay.date)})</div>
                    </div>
                    <div class="streak-box" style="padding:10px;">
                        <div class="text-red font-bold">${fmt(worstDay?.realizedPL || 0)}</div>
                        <div class="streak-label">Schlechtester (${worstDay ? formatDate(worstDay.date) : '-'})</div>
                    </div>
                </div>
                ` : ''}
            `;
        }
        function renderPositions() {
            const target = getDailyTarget(); const risk = getRiskPerTrade();
            document.getElementById('position-stats').innerHTML = `<div class="card stat-box"><div class="stat-label">Tagesziel</div><div class="stat-value text-green">${fmt(target)}</div></div><div class="card stat-box"><div class="stat-label">Risiko/Trade</div><div class="stat-value text-orange">${fmt(risk)}</div></div><div class="card stat-box"><div class="stat-label">Max. Tagesverl.</div><div class="stat-value text-red">${fmt(getMaxDailyLoss())}</div></div><div class="card stat-box"><div class="stat-label">R:R Ratio</div><div class="stat-value">1:${data.settings.rrRatio}</div></div>`;
            document.getElementById('positions-list').innerHTML = data.positions.length > 0 ? data.positions.map(pos => { const inst = data.instruments[pos.instrumentId]; const pl = calculatePL(pos); const sltp = calculateStopLimit(pos); return `<div class="card position-card" style="border-left-color:${inst?.color||'#fff'};"><div class="position-header"><div class="position-info"><span class="position-icon">${inst?.icon||'üìä'}</span><div><div class="position-symbol">${inst?.symbol||pos.instrumentId}</div><div class="position-name">${inst?.name||''} | ${pos.size} √ó ${pos.direction.toUpperCase()}</div></div></div><div class="position-pl"><div class="position-pl-value ${pl>=0?'text-green':'text-red'}">${pl>=0?'+':''}${fmt(pl)}</div><div style="font-size:0.8rem;color:var(--muted);">@ ${fmtPrice(pos.currentPrice, inst)}</div></div></div><div class="grid grid-4" style="font-size:0.85rem;margin-bottom:12px;"><div><span class="text-muted">Avg:</span> ${fmtPrice(pos.avgPrice, inst)}</div><div><span class="text-muted">Current:</span> ${fmtPrice(pos.currentPrice, inst)}</div><div><span class="text-muted">P/L/$1:</span> ${inst?.plFactor?fmt(pos.size*inst.plFactor):'N/A'}</div><div style="text-align:right;"><button class="btn btn-sm btn-ghost" onclick="updatePositionPrice('${pos.id}')">üìù</button><button class="btn btn-sm btn-danger" onclick="removePosition('${pos.id}')">‚úï</button></div></div>${sltp?`<div class="sl-tp-row"><div class="sl-tp-box stop"><div class="sl-tp-label">üõë STOP</div><div class="sl-tp-value">${fmtPrice(sltp.stopPrice, inst)}</div><div class="sl-tp-dist">-${fmt(sltp.potentialLoss)}</div></div><div class="sl-tp-box tp"><div class="sl-tp-label">‚úÖ TP R:R</div><div class="sl-tp-value">${fmtPrice(sltp.tpPriceRR, inst)}</div><div class="sl-tp-dist">+${fmt(sltp.potentialProfitRR)}</div></div><div class="sl-tp-box target"><div class="sl-tp-label">üéØ TP Ziel</div><div class="sl-tp-value">${fmtPrice(sltp.tpPriceTarget, inst)}</div><div class="sl-tp-dist">+${fmt(sltp.potentialProfitTarget)}</div></div></div>`:'<div class="card card-dark text-center" style="padding:10px;"><span class="text-orange">‚ö†Ô∏è Nicht kalibriert</span></div>'}</div>`; }).join('') : '<p class="text-muted text-center" style="padding:20px;">Keine Positionen</p>';
            const activePos = data.positions.filter(p => p.active);
            document.getElementById('quick-copy-list').innerHTML = activePos.length > 0 ? activePos.map(pos => { const inst = data.instruments[pos.instrumentId]; const sltp = calculateStopLimit(pos); if (!sltp) return ''; return `<div class="card card-dark"><div class="font-bold text-gold mb-2">${inst?.icon} ${inst?.symbol} (${pos.size})</div><table style="width:100%;font-size:0.85rem;"><tr><td class="text-muted">Avg:</td><td class="text-right">${fmtPrice(pos.avgPrice, inst)}</td></tr><tr><td class="text-red">Stop:</td><td class="text-right font-bold">${fmtPrice(sltp.stopPrice, inst)}</td></tr><tr><td class="text-green">TP:</td><td class="text-right font-bold">${fmtPrice(sltp.tpPriceRR, inst)}</td></tr></table></div>`; }).join('') : '<p class="text-muted">Keine aktiven Positionen</p>';
        }
        function renderPerformance() {
            const weekData = getWeeklyData(); const balance = getBalance(); const start = data.settings.startCapital; const total = balance - start;
            const month = new Date().toISOString().slice(0, 7); const monthLogs = data.dailyLogs.filter(l => l.date.startsWith(month)); const monthPL = monthLogs.reduce((s, l) => s + (l.realizedPL||0), 0);
            document.getElementById('perf-week').textContent = (weekData.realized>=0?'+':'')+fmt(weekData.realized);
            document.getElementById('perf-week-pct').textContent = fmtPct(weekData.progressPercent)+' vom Ziel';
            document.getElementById('perf-month').textContent = (monthPL>=0?'+':'')+fmt(monthPL);
            document.getElementById('perf-month-pct').textContent = monthLogs.length+' Handelstage';
            document.getElementById('perf-total').textContent = (total>=0?'+':'')+fmt(total);
            document.getElementById('perf-total-pct').textContent = fmtPct((total/start)*100);
            const profit = data.dailyLogs.filter(l => l.realizedPL > 0).length; const loss = data.dailyLogs.filter(l => l.realizedPL < 0).length;
            const winRate = data.dailyLogs.length > 0 ? (profit/data.dailyLogs.length)*100 : 0;
            const avgPL = data.dailyLogs.length > 0 ? data.dailyLogs.reduce((s,l) => s+(l.realizedPL||0), 0)/data.dailyLogs.length : 0;
            document.getElementById('performance-stats').innerHTML = `<div class="stat-box"><div class="stat-label">Handelstage</div><div class="stat-value">${data.dailyLogs.length}</div></div><div class="stat-box"><div class="stat-label">Gewinn/Verlust</div><div class="stat-value">${profit}/${loss}</div></div><div class="stat-box"><div class="stat-label">Erfolgsquote</div><div class="stat-value ${winRate>=50?'text-green':'text-red'}">${fmtPct(winRate)}</div></div><div class="stat-box"><div class="stat-label">√ò Tages-P/L</div><div class="stat-value ${avgPL>=0?'text-green':'text-red'}">${fmt(avgPL)}</div></div>`;
            
            // Exponentielle Projektion (Zinseszins-Effekt)
            const targetCap = data.settings.targetCapital; 
            const dailyRate = data.settings.dailyTargetPercent / 100;
            const remaining = targetCap - balance;
            const todayTarget = getDailyTarget();
            
            // Korrekte exponentielle Formel: Tage = log(Ziel/Aktuell) / log(1+Rate)
            const daysToTarget = balance > 0 && dailyRate > 0 
                ? Math.ceil(Math.log(targetCap / balance) / Math.log(1 + dailyRate))
                : 0;
            const monthsToTarget = (daysToTarget / 21).toFixed(1);
            const yearsToTarget = (daysToTarget / 252).toFixed(1);
            
            document.getElementById('projection-content').innerHTML = `
                <div class="grid grid-2 mb-2">
                    <div class="stat-box"><div class="stat-label">Heutiges Tagesziel</div><div class="stat-value text-green">${fmt(todayTarget)}</div></div>
                    <div class="stat-box"><div class="stat-label">Noch zu erreichen</div><div class="stat-value">${fmt(remaining)}</div></div>
                </div>
                <div class="grid grid-3">
                    <div class="stat-box"><div class="stat-label">Handelstage</div><div class="stat-value">${daysToTarget}</div></div>
                    <div class="stat-box"><div class="stat-label">Ca. Monate</div><div class="stat-value">${monthsToTarget}</div></div>
                    <div class="stat-box"><div class="stat-label">Ca. Jahre</div><div class="stat-value">${yearsToTarget}</div></div>
                </div>
                <div class="progress-container mt-3">
                    <div class="progress-header"><span>Fortschritt zum Ziel (${fmt(targetCap)})</span><span>${fmtPct((balance/targetCap)*100)}</span></div>
                    <div class="progress-bar"><div class="progress-fill blue" style="width:${Math.min((balance/targetCap)*100,100)}%"></div></div>
                </div>`;
        }
        function renderInstruments() {
            document.getElementById('instruments-metals').innerHTML = INSTRUMENT_LIBRARY.metals.map(libInst => { const inst = data.instruments[libInst.id] || libInst; const cal = inst.isCalibrated && inst.plFactor; return `<div class="instrument-card" onclick="openCalibrationModal('${inst.id}')"><div class="instrument-icon">${inst.icon}</div><div class="instrument-info"><div class="instrument-symbol">${inst.symbol}</div><div class="instrument-name">${inst.name}</div></div><div class="instrument-status"><div class="instrument-factor ${cal?'text-green':'text-orange'}">${cal?fmtNum(inst.plFactor,4):'---'}</div><div style="font-size:0.75rem;" class="${cal?'calibrated':'not-calibrated'}">${cal?'‚úì Kalibriert':'‚ö†Ô∏è Nicht kalibriert'}</div></div></div>`; }).join('');
        }
        function renderHistory() {
            const sorted = [...data.dailyLogs].sort((a, b) => b.date.localeCompare(a.date));
            document.getElementById('history-table').innerHTML = sorted.length > 0 ? sorted.map(log => `<tr><td>${formatDate(log.date)}</td><td class="text-right">${fmt(log.startingBalance)}</td><td class="text-right">${fmt(log.endingBalance)}</td><td class="text-right ${log.realizedPL>=0?'text-green':'text-red'} font-bold">${log.realizedPL>=0?'+':''}${fmt(log.realizedPL)}</td><td class="text-center">${log.targetHit?'‚úÖ':'‚ö†Ô∏è'}</td><td class="text-center">${getMoodEmoji(log.mood)}</td><td class="text-center"><button class="btn btn-sm btn-danger" onclick="deleteLog('${log.id}')">üóëÔ∏è</button></td></tr>`).join('') : '<tr><td colspan="7" class="text-center text-muted" style="padding:20px;">Noch keine Eintr√§ge</td></tr>';
        }
        function renderSettings() {
            document.getElementById('set-start-capital').value = data.settings.startCapital;
            document.getElementById('set-current-balance').value = data.settings.currentBalance;
            document.getElementById('set-target-capital').value = data.settings.targetCapital;
            document.getElementById('set-daily-target').value = data.settings.dailyTargetPercent;
            document.getElementById('set-risk-per-trade').value = data.settings.riskPerTradePercent;
            document.getElementById('set-max-daily-loss').value = data.settings.maxDailyLossPercent;
            document.getElementById('set-rr-ratio').value = data.settings.rrRatio;
            document.getElementById('set-buffer-enabled').value = data.buffer.settings.enabled.toString();
            document.getElementById('set-buffer-max-days').value = data.buffer.settings.maxBufferDays;
            document.getElementById('cloud-sync-content').innerHTML = currentUser ? `<div style="display:flex;align-items:center;gap:12px;"><div class="sync-dot ${isOnline?'online':'offline'}" style="width:12px;height:12px;"></div><div><div class="font-bold">${currentUser.email}</div><div class="text-muted" style="font-size:0.8rem;">${isOnline?'Verbunden':'Offline'}</div></div></div><button class="btn btn-ghost btn-sm mt-3" onclick="syncToCloud()">üîÑ Jetzt synchronisieren</button>` : `<div class="text-muted mb-2">Offline-Modus - Daten nur lokal gespeichert.</div><button class="btn btn-primary btn-sm" onclick="showAuthScreen()">‚òÅÔ∏è Cloud-Sync aktivieren</button>`;
        }

        // ============================================================
        // ACTIONS
        // ============================================================
        function saveSettings() { data.settings.startCapital = parseFloat(document.getElementById('set-start-capital').value)||0; data.settings.currentBalance = parseFloat(document.getElementById('set-current-balance').value)||0; data.settings.targetCapital = parseFloat(document.getElementById('set-target-capital').value)||0; data.settings.dailyTargetPercent = parseFloat(document.getElementById('set-daily-target').value)||1; data.settings.riskPerTradePercent = parseFloat(document.getElementById('set-risk-per-trade').value)||2; data.settings.maxDailyLossPercent = parseFloat(document.getElementById('set-max-daily-loss').value)||3; data.settings.rrRatio = parseFloat(document.getElementById('set-rr-ratio').value)||2; data.buffer.settings.enabled = document.getElementById('set-buffer-enabled').value === 'true'; data.buffer.settings.maxBufferDays = parseInt(document.getElementById('set-buffer-max-days').value)||10; saveData(); render(); showToast('Einstellungen gespeichert'); }
        async function saveEntry() {
            const balanceInput = document.getElementById('entry-balance').value; if (!balanceInput) { showToast('Bitte Kontostand eingeben', 'error'); return; }
            const newBalance = parseFloat(balanceInput); const prevBalance = getBalance(); const realizedPL = newBalance - prevBalance; const dailyTarget = getDailyTarget();
            const variance = realizedPL - dailyTarget; const variancePercent = dailyTarget > 0 ? (variance / dailyTarget) * 100 : 0; const daysEquivalent = dailyTarget > 0 ? realizedPL / dailyTarget : 0; const entryDate = document.getElementById('entry-date').value;
            const newLog = { id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(), date: entryDate, startingBalance: prevBalance, endingBalance: newBalance, realizedPL, unrealizedPL: parseFloat(document.getElementById('entry-unrealized').value)||0, dailyTarget, variance, variancePercent, daysEquivalent, targetHit: realizedPL >= dailyTarget, tradesCount: parseInt(document.getElementById('entry-trades').value)||0, mood: document.getElementById('entry-mood').value, notes: document.getElementById('entry-notes').value };
            const existingIndex = data.dailyLogs.findIndex(l => l.date === newLog.date);
            if (existingIndex >= 0) { if (!confirm('Eintrag √ºberschreiben?')) return; data.dailyLogs[existingIndex] = newLog; }
            else data.dailyLogs.push(newLog);
            processBuffer(realizedPL); data.settings.currentBalance = newBalance;
            saveData(); await syncDailyLog(newLog);
            document.getElementById('entry-balance').value = ''; document.getElementById('entry-realized').value = ''; document.getElementById('entry-unrealized').value = ''; document.getElementById('entry-trades').value = ''; document.getElementById('entry-notes').value = ''; document.getElementById('entry-mood').value = 'neutral'; document.getElementById('entry-preview').classList.add('hidden');
            render(); showToast(`Eintrag gespeichert: ${realizedPL>=0?'+':''}${fmt(realizedPL)}`);
        }
        async function deleteLog(id) { if (!confirm('Eintrag l√∂schen?')) return; data.dailyLogs = data.dailyLogs.filter(l => l.id !== id); saveData(); if (currentUser && isOnline) try { await db.from('daily_logs').delete().eq('id', id); } catch(e){} render(); showToast('Gel√∂scht'); }
        function openAddPositionModal() {
            const calibrated = Object.values(data.instruments).filter(i => i.isCalibrated);
            if (calibrated.length === 0) { showToast('Bitte erst Instrument kalibrieren', 'warning'); return; }
            document.getElementById('pos-instrument').innerHTML = calibrated.map(inst => `<option value="${inst.id}">${inst.icon} ${inst.symbol} - ${inst.name}</option>`).join('');
            document.getElementById('pos-size').value = ''; document.getElementById('pos-avg-price').value = ''; document.getElementById('pos-current-price').value = ''; document.getElementById('pos-direction').value = 'long';
            openModal('position-modal');
        }
        async function savePosition() {
            const instrumentId = document.getElementById('pos-instrument').value; const size = parseFloat(document.getElementById('pos-size').value); const avgPrice = parseFloat(document.getElementById('pos-avg-price').value); const currentPrice = parseFloat(document.getElementById('pos-current-price').value); const direction = document.getElementById('pos-direction').value;
            if (!instrumentId || !size || !avgPrice || !currentPrice) { showToast('Bitte alle Felder ausf√ºllen', 'error'); return; }
            const newPos = { id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(), instrumentId, size, avgPrice, currentPrice, direction, openDate: new Date().toISOString().split('T')[0], active: true };
            data.positions.push(newPos); saveData(); await syncPosition(newPos);
            render(); closeModal('position-modal'); showToast('Position hinzugef√ºgt');
        }
        function updatePositionPrice(id) { const newPrice = prompt('Neuer Preis:'); if (newPrice === null) return; const pos = data.positions.find(p => p.id === id); if (pos) { pos.currentPrice = parseFloat(newPrice); saveData(); syncPosition(pos); render(); } }
        async function removePosition(id) { 
            const pos = data.positions.find(p => p.id === id);
            if (!pos) return;
            const inst = data.instruments[pos.instrumentId];
            const pl = calculatePL(pos);
            const plText = pl >= 0 ? `+${fmt(pl)} Gewinn` : `${fmt(pl)} Verlust`;
            
            const confirmed = confirm(`Position ${inst?.symbol || pos.instrumentId} entfernen?\n\nUnrealisierter P/L: ${plText}\n\n‚ö†Ô∏è Hinweis: Falls du diese Position geschlossen hast, stelle sicher dass der Gewinn/Verlust bereits im heutigen Tageseintrag (Kontostand) erfasst wurde.`);
            if (!confirmed) return;
            
            data.positions = data.positions.filter(p => p.id !== id); 
            saveData(); 
            await syncPosition(pos, 'delete'); 
            render(); 
            showToast('Position entfernt'); 
        }
        function openCalibrationModal(instrumentId) {
            const inst = data.instruments[instrumentId]; if (!inst) return;
            document.getElementById('calibration-content').innerHTML = `<div class="card card-gold mb-3"><div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;"><span style="font-size:2.5rem;">${inst.icon}</span><div><div class="font-bold" style="font-size:1.2rem;">${inst.symbol}</div><div class="text-muted">${inst.name}</div></div></div>${inst.isCalibrated?`<div class="text-green" style="font-size:0.85rem;">‚úì Faktor: ${fmtNum(inst.plFactor,4)} | Letzte: ${inst.lastCalibrated?formatDate(inst.lastCalibrated):'-'}</div>`:'<div class="text-orange" style="font-size:0.85rem;">‚ö†Ô∏è Noch nicht kalibriert</div>'}</div><p class="text-muted mb-3" style="font-size:0.85rem;">Werte aus IBKR Screenshot eingeben:</p><div class="grid grid-2"><div class="form-group"><label>Position Size</label><input type="number" id="cal-size" class="form-input highlight" value="${inst.calibrationData?.size||inst.standardSize}" step="0.01"></div><div class="form-group"><label>Average Price</label><input type="number" id="cal-avg" class="form-input highlight" value="${inst.calibrationData?.avgPrice||''}" step="0.00001"></div></div><div class="grid grid-2"><div class="form-group"><label>Current/Last Price</label><input type="number" id="cal-last" class="form-input highlight" value="${inst.calibrationData?.lastPrice||''}" step="0.00001"></div><div class="form-group"><label>Unrealisierter P/L (‚Ç¨)</label><input type="number" id="cal-pl" class="form-input highlight" value="${inst.calibrationData?.unrealizedPL||''}" step="0.01"></div></div><div class="card card-dark mb-3"><div class="text-muted" style="font-size:0.8rem;">Berechneter Faktor:</div><div id="cal-result" class="font-bold text-green" style="font-size:1.3rem;">---</div><div id="cal-pl-per-dollar" class="text-muted" style="font-size:0.85rem;"></div></div><button class="btn btn-success btn-block" onclick="saveCalibration('${instrumentId}')">üíæ Faktor speichern</button>`;
            ['cal-size','cal-avg','cal-last','cal-pl'].forEach(id => document.getElementById(id)?.addEventListener('input', () => updateCalibrationPreview(instrumentId)));
            openModal('calibration-modal'); updateCalibrationPreview(instrumentId);
        }
        function updateCalibrationPreview(instrumentId) {
            const size = parseFloat(document.getElementById('cal-size').value)||0; const avg = parseFloat(document.getElementById('cal-avg').value)||0; const last = parseFloat(document.getElementById('cal-last').value)||0; const pl = parseFloat(document.getElementById('cal-pl').value)||0;
            const diff = last - avg; let factor = 0;
            if (Math.abs(diff) > 0.00001 && size > 0) factor = Math.abs(pl / (diff * size));
            const inst = data.instruments[instrumentId]; const plPerDollar = factor * (inst?.standardSize || size);
            document.getElementById('cal-result').textContent = factor > 0 ? fmtNum(factor, 4) + ' EUR/Einheit/$1' : '---';
            document.getElementById('cal-pl-per-dollar').textContent = factor > 0 ? `Bei ${inst?.standardSize||size} Einheiten: ${fmt(plPerDollar)} pro $1` : '';
        }
        async function saveCalibration(instrumentId) {
            const size = parseFloat(document.getElementById('cal-size').value)||0; const avgPrice = parseFloat(document.getElementById('cal-avg').value)||0; const lastPrice = parseFloat(document.getElementById('cal-last').value)||0; const unrealizedPL = parseFloat(document.getElementById('cal-pl').value)||0;
            const diff = lastPrice - avgPrice;
            if (Math.abs(diff) < 0.00001 || size <= 0) { showToast('Ung√ºltige Werte', 'error'); return; }
            const factor = Math.abs(unrealizedPL / (diff * size));
            data.instruments[instrumentId] = { ...data.instruments[instrumentId], plFactor: factor, isCalibrated: true, lastCalibrated: new Date().toISOString().split('T')[0], calibrationData: { size, avgPrice, lastPrice, unrealizedPL, calculatedFactor: factor } };
            saveData(); render(); closeModal('calibration-modal'); showToast(`${data.instruments[instrumentId].symbol} kalibriert: ${fmtNum(factor, 4)}`);
        }
        function exportData() { const exp = { ...data, exportDate: new Date().toISOString(), version: VERSION }; const blob = new Blob([JSON.stringify(exp, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `trading-tracker-backup-${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(url); showToast('Backup erstellt'); }
        function importData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const imported = JSON.parse(e.target.result); if (!imported.version) { showToast('Ung√ºltige Datei', 'error'); return; } if (!confirm('Alle Daten √ºberschreiben?')) return; data = deepMerge(DEFAULT_DATA, imported); saveData(); render(); showToast('Importiert'); } catch (err) { showToast('Fehler', 'error'); } }; reader.readAsText(file); event.target.value = ''; }
        function resetAllData() { if (!confirm('ALLE DATEN L√ñSCHEN?')) return; if (!confirm('Wirklich sicher?')) return; localStorage.removeItem(STORAGE_KEY); data = JSON.parse(JSON.stringify(DEFAULT_DATA)); initializeInstruments(); saveData(); render(); showToast('Gel√∂scht'); }
        function openUserMenu() {
            document.getElementById('user-modal-content').innerHTML = currentUser ? `<div class="text-center mb-3"><div class="user-avatar" style="width:60px;height:60px;font-size:1.5rem;margin:0 auto 12px;">${(currentUser.user_metadata?.full_name||currentUser.email||'?').charAt(0).toUpperCase()}</div><div class="font-bold">${currentUser.user_metadata?.full_name||'User'}</div><div class="text-muted" style="font-size:0.85rem;">${currentUser.email}</div></div><div class="card card-dark mb-3"><div style="display:flex;align-items:center;gap:8px;"><div class="sync-dot ${isOnline?'online':'offline'}"></div><span>${isOnline?'Cloud verbunden':'Offline'}</span></div></div><button class="btn btn-danger btn-block" onclick="logout()">üö™ Abmelden</button>` : `<div class="text-center mb-3"><div class="text-muted">Offline-Modus</div></div><button class="btn btn-primary btn-block" onclick="closeModal('user-modal');showAuthScreen();">‚òÅÔ∏è Anmelden</button>`;
            openModal('user-modal');
        }

        // ============================================================
        // HELPERS
        // ============================================================
        function openModal(id) { document.getElementById(id).classList.add('show'); }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        function showToast(msg, type = 'success') { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast show ' + type; setTimeout(() => t.className = 'toast', 3000); }
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme === 'dark' ? '' : 'light');
            document.querySelector('.theme-toggle').textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            // Logo wechseln
            const headerLogo = document.querySelector('.header-left img');
            if (headerLogo) {
                headerLogo.src = newTheme === 'light' ? 'assets/icon_light_64.png' : 'assets/icon_dark_64.png';
            }
            localStorage.setItem('theme', newTheme);
        }
        function loadTheme() {
            const saved = localStorage.getItem('theme') || 'dark';
            if (saved === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                const btn = document.querySelector('.theme-toggle');
                if (btn) btn.textContent = 'üåô';
                const headerLogo = document.querySelector('.header-left img');
                if (headerLogo) headerLogo.src = 'assets/icon_light_64.png';
            }
        }

        // ============================================================
        // EVENT LISTENERS
        // ============================================================
        document.querySelectorAll('.tab').forEach(tab => { tab.addEventListener('click', () => { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); tab.classList.add('active'); document.getElementById(tab.dataset.tab).classList.add('active'); }); });
        document.getElementById('entry-balance')?.addEventListener('input', function() {
            const newBalance = parseFloat(this.value); const preview = document.getElementById('entry-preview');
            if (newBalance) { const prevBalance = getBalance(); const pl = newBalance - prevBalance; const target = getDailyTarget(); const variance = pl - target; const variancePct = (variance / target) * 100;
            preview.classList.remove('hidden'); preview.innerHTML = `<div class="card-title"><span>üëÅÔ∏è</span> Vorschau</div><div class="grid grid-4 text-center"><div><div class="stat-label">Aktuell</div><div class="font-bold">${fmt(prevBalance)}</div></div><div><div class="stat-label">Neu</div><div class="font-bold">${fmt(newBalance)}</div></div><div><div class="stat-label">P/L</div><div class="font-bold ${pl>=0?'text-green':'text-red'}">${pl>=0?'+':''}${fmt(pl)}</div></div><div><div class="stat-label">vs. Ziel</div><div class="font-bold ${variance>=0?'text-green':'text-orange'}">${variance>=0?'+':''}${fmtPct(variancePct)}</div></div></div><div class="text-center mt-2">${pl>=target?'<span class="text-green font-bold">‚úÖ Tagesziel erreicht!</span>':`<span class="text-orange">‚ö†Ô∏è Ziel: ${fmt(target)}</span>`}</div>`; } else { preview.classList.add('hidden'); }
        });
        document.querySelectorAll('.modal-overlay').forEach(overlay => { overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('show'); }); });

        // ============================================================
        // INIT
        // ============================================================
        init();
    </script>
</body>
</html>
